Backbone.View.prototype.close=function(){if(this.onClose)this.onClose();this.childViews&&_.each(this.childViews,function(a){a.close()});for(var a in this)this.hasOwnProperty(a)&&"parent"!=a&&(this[a]instanceof Backbone.View||this[a]instanceof Backbone.Form)&&(this[a].close(),this[a]=null);this.undelegateEvents();this.stopListening();this.el=void 0;this.remove();this.afterClose&&this.afterClose()};Backbone.Collection.prototype.originalReset=Backbone.Collection.prototype.reset;
Backbone.Collection.prototype.reset=function(a,b){null!=this.models&&0<this.models.length&&this.models.forEach(function(a){a.stopListening()});return Backbone.Collection.prototype.originalReset.call(this,a,b)};Backbone.AssociatedModel.prototype.clone=function(a){return new this.constructor(this.toJSONFull(a))};Backbone.Model.prototype.originalGet=Backbone.Model.prototype.get;
Backbone.Model.prototype.get=function(a){if("string"!==typeof a)Backbone.Model.prototype.originalGet.apply(this,a);else return _.reduce(a.split("."),function(a,c){return a instanceof Backbone.Model?a.attributes[c]:a[c]},this.attributes)};
var ModalView=Backbone.View.extend({className:function(){return ETM.is_mobile&&!ETM.is_tablet?"modal fade modal-fullscreen":"modal fade"},onClose:function(){},getModalElement:function(){var a=$("#"+this.modal_id,ETM.$modal_content.el);0==a.length&&(ETM.$modal_content.append('<div id="'+this.modal_id+'"></div>'),a=$("#"+this.modal_id,ETM.$modal_content.el));0.1>Math.random()&&amplitude.logEvent("modal_opened_"+this.modal_id);return a}});Backbone.Flash.initialize({el:"#flashes",stayDuration:8E3});
Backbone.Tastypie.csrfToken=$.cookie("csrftoken");Backbone.Collection.prototype.save=function(a){Backbone.sync("save",this,a)};Backbone.Form.validators.errMessages.required="This field is required.";$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy(function(a){$(a.target).hasClass("ignoreEnforceFocus")||this.$element[0]===a.target||this.$element.has(a.target).length||this.$element.trigger("focus")},this))};
Backbone.Collection.prototype.modelIds=function(){var a=[];this.forEach(function(b){a.push(b.id)});return a};Backbone.Collection.prototype.byIdKeys=function(){var a=[],b;for(b in this._byId)this._byId.hasOwnProperty(b)&&a.push(b);return a};Array.prototype.insert=function(a,b){this.splice(a,0,b)};Date.locale={en:{month_names:"January February March April May June July August September October November December".split(" "),month_names_short:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")}};
Date.prototype.getMonthName=function(a){a=a&&a in Date.locale?a:"en";return Date.locale[a].month_names[this.getMonth()]};Date.prototype.getMonthNameShort=function(a){a=a&&a in Date.locale?a:"en";return Date.locale[a].month_names_short[this.getMonth()]};void 0===Array.prototype.revEach&&Object.defineProperty(Array.prototype,"revEach",{writable:!1,enumerable:!1,configurable:!1,value:function(a){var b;for(b=this.length-1;0<=b;b--)a(this[b],b,this)}});
Store.prototype.generateId=function(){return-1*Math.floor(1E9*Math.random())};Backbone.Model.prototype.hasTempId=function(){return 0>this.id};
Backbone.CollectionView.prototype._receive=function(a,b){var c=b.sender,d=this._getContainerEl(),e=null,f=null,e=$(b.helper).data("model_json"),f=this.collection.useCustomAdd?this.collection.useCustomAdd(b):!1;if(this.collection.customAdd&&f&&"function"===typeof this.collection.customAdd){c=e?this.collection.customAdd(d,e):this.collection.customAdd(d);if(!c)return;e=c.modelToAdd;f=c.newIndex;this.collection.add(e,{at:f})}else{c=c.data("view");if(!c||!c.collection)return;f=this._getContainerEl().children().index(b.item);
e=c.collection.get(b.item.attr("data-model-cid"));this.collection.add(e,{at:f});c.collection.remove(e)}e.collection=this.collection;this.setSelectedModel(e);this.trigger("sortReceive",e);this.collection.trigger("sortReceive",e)};
jQuery(document).ajaxSend(function(a,b,c){function d(a){var b=null;if(document.cookie&&""!=document.cookie)for(var c=document.cookie.split(";"),d=0;d<c.length;d++){var e=jQuery.trim(c[d]);if(e.substring(0,a.length+1)==a+"="){b=decodeURIComponent(e.substring(a.length+1));break}}return b}function e(a){var b="//"+document.location.host,c=document.location.protocol+b;return a==c||a.slice(0,c.length+1)==c+"/"||a==b||a.slice(0,b.length+1)==b+"/"||!/^(\/\/|http:|https:).*/.test(a)}!/^(GET|HEAD|OPTIONS|TRACE)$/.test(c.type)&&
e(c.url)&&b.setRequestHeader("X-CSRFToken",d("csrftoken"));null!=document.beforeAjaxSend&&"function"===typeof document.beforeAjaxSend&&document.beforeAjaxSend(a,b,c)});var ROOT="/api/v1",TEMPLATES;
window.isMobileOrTablet=function(){var a=!1,b=navigator.userAgent||navigator.vendor||window.opera;if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,
4)))a=!0;return a};
var ETM={current_scheme:{},last_scheme:{},scheme_changed:!0,is_logged_in:is_logged_in,is_mobile:is_logged_in?is_mobile:window.isMobileOrTablet(),is_tablet:is_tablet,is_premium:"undefined"!==typeof is_premium?is_premium:is_subscriber,is_staff:is_staff,is_superuser:is_superuser,is_embedded:!1,editing_user_settings:!1,guided_planner_enabled:!0,router_functions:{},router_view_functions:{},views:{},use_local_storage:!(is_logged_in||app),local_storage_failed:!1,currently_generating:!1,setup_user_profile:!1,
logout_occurred:!1,LOW_FAT_PRESET_KEY:"low-fat",LOW_CARB_PRESET_KEY:"low-carb",HIGH_PROTEIN_PRESET_KEY:"high-protein",GLUTEN_FREE_PRESET_KEY:"gluten-free",dispatcher:_.clone(Backbone.Events),startedGenerating:function(){ETM.currently_generating=!0;ETM.dispatcher.trigger("startedGenerating")},stoppedGenerating:function(){ETM.currently_generating=!1;ETM.dispatcher.trigger("stoppedGenerating")},toggleLocalStorage:function(){if(ETM.use_local_storage)try{localStorage.setItem("localStorage",1),localStorage.removeItem("localStorage")}catch(a){ETM.use_local_storage=
!1,ETM.local_storage_failed=!0,"undefined"!==typeof Storage&&(Storage.prototype._setItem=Storage.prototype.setItem,Storage.prototype.setItem=function(){}),alert('Your web browser does not support storing settings locally. In Mobile Safari, the most common cause of this is using "Private Browsing Mode".  In Chrome, the most common cause is using "Block sites from setting any data".  In Opera Mini, this feature is not available at all.  Some settings may not save or some features may not work properly for you.')}ETM.use_local_storage?
(Backbone.Model.prototype.local=!0,Backbone.Model.prototype.remote=!1,Backbone.Collection.prototype.local=!0,Backbone.Collection.prototype.remote=!1):(Backbone.Model.prototype.remote=!0,Backbone.Model.prototype.local=!1,Backbone.Collection.prototype.remote=!0,Backbone.Collection.prototype.local=!1)},loadTemplate:function(a){return Helper.createTemplateFunction(ETM.global_templates.filter(a).text())},loadNestedTemplate:function(a,b){var c=$(ETM.global_templates.filter(a).text());return Helper.createTemplateFunction(_.unescape(c.filter(b).add(c.find(b)).html()))},
loadTemplates:function(a){"undefined"===typeof CLIENT_VERSION&&(CLIENT_VERSION="");$.when($.get(ETM.is_logged_in?"/static_files/etm"+CLIENT_VERSION+".html":"/static_files/logged_out_etm"+CLIENT_VERSION+".html",function(a){ETM.global_templates=$(a);ETM.global_templates.each(function(){var a=$(this).attr("id");a in ETM&&(ETM[a].prototype.template=Helper.createTemplateFunction($(this).text()))})})).done(function(){ETM.header_view=new ETM.HeaderView;ETM.router_functions.renderHeader();ETM.router=new ETM.Router;
app||ETM.food_object_modal.getModalElement().html(ETM.food_object_modal.render().el);a()})},logout:function(){ETM.current_scheme={};ETM.last_scheme={};ETM.scheme_changed=!0;ETM.views={};ETM.models={};ETM.currently_generating=!1;ETM.fetch_complete=!1;ETM.current_user_profile=null;ETM.calendar_list=null;ETM.groceries_and_pantry=null;ETM.browse_collections_model=null;ETM.logout_occurred=!0;ETM.router=new ETM.Router},default_user_choices_list:[]};
function initialize(a){ETM.toggleLocalStorage();!window.location.hash||"#_=_"!=window.location.hash&&"_=_"!=window.location.hash||(window.location.hash="");ETM.loadTemplates(function(){Backbone.history.start({pushState:!0});Backbone.history.on("route",sendPageview);null!=a&&a()});ETM.is_mobile&&$(".body-container").addClass("mobile-body phone-body");Helper.$text_measuring_span=$("#amount_measuring_div");$(document).on("show.bs.modal",".modal",function(){var a=1040+10*$(".modal:visible").length;$(this).css("z-index",
a);setTimeout(function(){$(".modal-backdrop").not(".modal-stack").css("z-index",a-1).addClass("modal-stack")},0)});$(document).on("hidden.bs.modal",".modal",function(){$(".modal:visible").length&&$(document.body).addClass("modal-open");0===$(".modal:visible").length&&$("#groove-iframe-element").parent().fadeIn();ETM.is_mobile&&Helper.hideAllTooltips()});$(document).on("shown.bs.modal",".modal",function(){ETM.is_mobile&&setTimeout(function(){Helper.hideAllTooltips()},0);$("#groove-iframe-element").parent().fadeOut()});
$("body").on("click",".tooltip",function(a){$(a.target).closest(".tooltip").remove()});$("body").on("click",".popover:not(.show)",function(a){$(a.target).closest(".popover").remove()});if(!ETM.is_mobile&&!app&&0<$("#load_groove_widget").length)try{setTimeout(function(){window.groove.widget=window.groove.createWidget();window.groove.widget.init("102cc98b-f6d4-4b7c-b839-3237e7a5c740",{})},100)}catch(b){}}
jQuery.fn.extend({getHighestZ:function(){var a,b;jQuery(this).each(function(c){if(0===c||$(this).css("z-index")>a)a=$(this).css("z-index"),b=$(this)});return b}});function sendPageview(){var a=Backbone.history.getFragment();"undefined"!==typeof googleanalytics&&googleanalytics("send","pageview","/"+a)}function stopRKey(a){a=a?a:event?event:null;var b=a.target?a.target:a.srcElement?a.srcElement:null;if(13==a.keyCode&&"text"==b.type)return!1}document.onkeypress=stopRKey;$(document).ajaxStart(function(){$("#spinner").show()}).ajaxStop(function(){$("#spinner").hide()});
$.fn.serializeObject=function(){var a={},b=this.serializeArray();$.each(b,function(){a[this.name]?(a[this.name].push||(a[this.name]=[a[this.name]]),a[this.name].push(this.value||"")):a[this.name]=this.value||""});return a};
ETM.router_functions.applyProfileCompletenessListeners=function(){!1===ETM.current_profile_completeness.get("add_recurring_food")&&ETM.router.listenToOnce(ETM.recurring_foods_list,"add",function(){ETM.current_profile_completeness.save({add_recurring_food:!0},{patch:!0})});!1===ETM.current_profile_completeness.get("favorite_food")&&ETM.router.listenTo(ETM.food_rating_list,"add",function(a){a.attributes.rating===THUMB_RATINGS.THUMBS_UP&&!1===ETM.current_profile_completeness.get("favorite_food")&&ETM.current_profile_completeness.save({favorite_food:!0},
{patch:!0})});!1===ETM.current_profile_completeness.get("block_food")&&ETM.router.listenTo(ETM.food_rating_list,"add",function(a){a.attributes.rating===THUMB_RATINGS.THUMBS_DOWN&&!1===ETM.current_profile_completeness.get("block_food")&&ETM.current_profile_completeness.save({block_food:!0},{patch:!0})});!1===ETM.current_profile_completeness.get("customized_meal_types")&&(ETM.router.listenToOnce(ETM.meal_type_list,"add remove",function(){!1===ETM.current_profile_completeness.get("customized_meal_types")&&
ETM.current_profile_completeness.save({customized_meal_types:!0},{patch:!0})}),ETM.meal_type_list.each(function(a){ETM.router.listenToOnce(a,"change",function(){!1===ETM.current_profile_completeness.get("customized_meal_types")&&ETM.current_profile_completeness.save({customized_meal_types:!0},{patch:!0})})}));!1===ETM.current_profile_completeness.get("edited_food_preferences")&&ETM.router.listenToOnce(ETM.current_user_profile,"change:exclusions",function(){ETM.current_profile_completeness.save({edited_food_preferences:!0},
{patch:!0})});!1===ETM.current_profile_completeness.get("set_weight_goal")&&(0<ETM.current_user_profile.attributes.weight_goal?ETM.current_profile_completeness.save({set_weight_goal:!0},{patch:!0}):ETM.router.listenToOnce(ETM.current_user_profile,"change:weight_goal",function(){ETM.current_profile_completeness.save({set_weight_goal:!0},{patch:!0})}));ETM.is_premium&&!1===ETM.current_profile_completeness.get("setup_weekly_layout")&&ETM.template_diet_list.each(function(a){ETM.router.listenToOnce(a.get("diet"),
"change",function(){!1===ETM.current_profile_completeness.get("setup_weekly_layout")&&ETM.current_profile_completeness.save({setup_weekly_layout:!0},{patch:!0})})})};ETM.router_functions.redirectLoggedOutUsers=function(){ETM.is_logged_in||window.location.replace("http://"+window.location.host+"/user/login/")};
ETM.router_functions.standardNavigationView=function(a,b,c){this.redirectLoggedOutUsers();ETM.router_functions.loadUserDataV3(function(){Helper.lockPageHeight();ETM.logged_in_nav_view.selectMenuItem(a);"undefined"!==typeof ETM[b]&&ETM[b]||(ETM[b]=c());ETM.router_functions.updateCurrentView(ETM[b]);ETM.$content.html(ETM[b].render().el);ETM[b].delegateEvents();Helper.unlockPageHeight()})};
ETM.router_functions.updateCurrentView=function(a){if(this.currentView){"function"===typeof this.currentView.beforeClose&&this.currentView.beforeClose();for(var b in this.currentView)this.currentView.hasOwnProperty(b)&&"parent"!=b&&this.currentView[b]instanceof Backbone.View&&"function"===typeof this.currentView[b].beforeClose&&this.currentView[b].beforeClose();this.currentView.unbind();this.currentView.remove()}this.currentView=a};
ETM.router_functions.renderHeader=function(){app||($("#fill_container").html(ETM.header_view.render().el),ETM.header_view.delegateEvents())};
ETM.router_functions.setupUserProfile=function(){var a=ETM.user_profiles_list.at(0);"undefined"!=typeof a?(bugsnagClient.leaveBreadcrumb("User profile set"),ETM.current_user_profile=a):(bugsnagClient.leaveBreadcrumb("Blank User profile created"),ETM.current_user_profile=new ETM.UserProfile,ETM.user_profiles_list.add(ETM.current_user_profile));ETM.setup_user_profile=!0;ETM.is_logged_in&&(bugsnagClient.user={id:ETM.current_user_profile.attributes.user_id,name:ETM.current_user_profile.attributes.username,
email:ETM.current_user_profile.attributes.email});!0==ETM.current_user_profile.attributes.is_client&&$("body").addClass("hide_all_clients");!1==ETM.current_user_profile.attributes.allow_week_regenerates&&$("body").addClass("hide_week_regenerates");!1==ETM.current_user_profile.attributes.allow_day_regenerates&&$("body").addClass("hide_day_regenerates");!1==ETM.current_user_profile.attributes.allow_meal_regenerates&&$("body").addClass("hide_meal_regenerates");!1==ETM.current_user_profile.attributes.allow_food_refresh&&
$("body").addClass("hide_food_refresh");!1==ETM.current_user_profile.attributes.allow_add_delete&&$("body").addClass("hide_add_delete");!1==ETM.current_user_profile.attributes.allow_save_load_plan&&$("body").addClass("hide_save_load_plan");!1==ETM.current_user_profile.attributes.allow_create_plan&&$("body").addClass("hide_create_plan");!1==ETM.current_user_profile.attributes.allow_less_used_features&&$("body").addClass("hide_less_used_features");!1==ETM.current_user_profile.attributes.allow_settings_edit&&
$("body").addClass("hide_settings_edit");setTimeout(function(){Helper.setupGrooveWidget()})};ETM.router_functions.setupProfileCompleteness=function(){var a=ETM.profile_completeness_list.at(0);"undefined"!=typeof a?ETM.current_profile_completeness=a:(ETM.current_profile_completeness=new ETM.ProfileCompleteness,ETM.profile_completeness_list.add(ETM.current_profile_completeness))};
ETM.router_functions.runAfterUserDataFetch=function(a){(ETM.is_logged_in?ETM.template_diet_list:ETM.local_storage_diet_list).fetch({success:function(b){bugsnagClient.leaveBreadcrumb("template fetch success");ETM.current_diet=null;ETM.is_logged_in&&0<ETM.template_diet_list.length?(b=ETM.template_diet_list.at(ETM.template_diet_list.length-1),ETM.template_diet_list.remove(b,{silent:!0}),ETM.template_diet_list.add(b,{at:0,silent:!0}),ETM.current_diet=ETM.template_diet_list.at(ETM.template_diet_list.SINGLE_TEMPLATE_INDEX).attributes.diet,
null!=ETM.current_diet?bugsnagClient.leaveBreadcrumb("Current diet set to single template"):bugsnagClient.notify(Error("Current diet null after templates fetch"),{metaData:{template_diet_list_len:ETM.template_diet_list.length}})):!ETM.is_logged_in&&0<ETM.local_storage_diet_list.length&&(ETM.current_diet=ETM.local_storage_diet_list.at(0),bugsnagClient.leaveBreadcrumb("Current diet set from local storage"));null==ETM.current_diet&&(bugsnagClient.leaveBreadcrumb("Setting up blank current diet"),ETM.current_diet=
new ETM.Diet,ETM.current_diet.setupBlankDiet());ETM.current_diet.calculateStats();ETM.router_functions.setupUserProfile();ETM.router_functions.setupProfileCompleteness();ETM.router_functions.applyProfileCompletenessListeners();ETM.fetch_complete=!0;app||"undefined"===typeof ETM.global_templates||(ETM.router_functions.initializeNavView(),ETM.is_logged_in&&ETM.router_functions.initializeFoodBankSidebar());ETM.meal_type_list.sort();a()},error:function(a,c,d){bugsnagClient.leaveBreadcrumb("template fetch error");
bugsnagClient.notify(d)}})};
ETM.router_functions.oldFetchUserData=function(a,b){var c=[ETM.nutrition_profile_list.fetch(),ETM.meal_type_list.fetch(),ETM.user_profiles_list.fetch(),ETM.favorite_foods_list.fetch(),ETM.profile_completeness_list.fetch()],d=JSON.parse(localStorage.getItem("food_info_object_ids"));d&&(ETM.food_info_object_list.add(d),c.push(ETM.food_info_object_list.fetch()));app&&!demo_app&&(c=c.concat([ETM.recurring_foods_list.fetch(),ETM.recurring_collections_list.fetch(),ETM.diet_set_list.fetch(),ETM.manager_profile.fetch(),
ETM.meal_rating_list.fetch(),ETM.food_rating_list.fetch()]),ETM.custom_foods_list=new ETM.CustomFoodList([],{url:ROOT+"/customfood/"}),ETM.custom_recipes_list=new ETM.CustomRecipeList([],{url:ROOT+"/customrecipe/"}),c=c.concat([ETM.custom_foods_list.food_info_object_list.fetch(),ETM.custom_recipes_list.food_info_object_list.fetch()]));$.when.all(c).then(function(b){bugsnagClient.leaveBreadcrumb("load user data fetch success");ETM.router_functions.runAfterUserDataFetch(a)},function(c){bugsnagClient.leaveBreadcrumb("load user data fetch error");
if(ETM.local_storage_failed)"undefined"!=typeof b&&b||ETM.router_functions.loadUserDataV3(a,!0);else{var d=ETM.is_logged_in?" logged in ":" logged out ";null!=c[0].responseText&&(bugsnagClient.leaveBreadcrumb(c[0].responseText.substring(0,100)),bugsnagClient.leaveBreadcrumb(c[0].responseText.substring(0,2E3)));bugsnagClient.notify(Error("Error fetching"+d+"user information: "+c[2]+" - "+c[1]+" - "+c[0].status))}})};
ETM.router_functions.loadUserDataV3=function(a,b){ETM.fetch_complete?a():ETM.is_logged_in&&!demo_app?ETM.router_functions.fetchCombinedUserData(function(){bugsnagClient.leaveBreadcrumb("combined load user data fetch success");ETM.router_functions.runAfterUserDataFetch(a)},function(a,b,e){bugsnagClient.leaveBreadcrumb("combined load user data fetch error");bugsnagClient.notify(Error("Error fetching combined logged in user information: "+a+" - "+b+" - "+e))}):ETM.router_functions.oldFetchUserData(a,
b)};
ETM.router_functions.fetchCombinedUserData=function(a,b){user_data=new ETM.CombinedUserData;app&&(user_data.urlRoot=ROOT+"/appcombineduserdata/");user_data.fetch({success:function(){ETM.nutrition_profile_list=user_data.attributes.nutrition_profiles;ETM.meal_type_list=user_data.attributes.meal_types;ETM.user_profiles_list=user_data.attributes.user_profile;ETM.favorite_foods_list=user_data.attributes.favorite_foods;ETM.profile_completeness_list=new ETM.ProfileCompletenessList(user_data.attributes.profile_completeness);ETM.recurring_foods_list=
user_data.attributes.recurring_foods;ETM.recurring_collections_list=user_data.attributes.recurring_collections;ETM.diet_set_list=user_data.attributes.diet_sets;null!=user_data.attributes.manager_profile&&(ETM.manager_profile=user_data.attributes.manager_profile);ETM.meal_rating_list=user_data.attributes.meal_ratings;ETM.food_rating_list=user_data.attributes.food_ratings;app&&(ETM.custom_foods_list=new ETM.CustomFoodList([],{url:ROOT+"/customfood/"}),ETM.custom_foods_list.food_info_object_list.reset(user_data.attributes.custom_foods),
ETM.custom_recipes_list=new ETM.CustomRecipeList([],{url:ROOT+"/customrecipe/"}),ETM.custom_recipes_list.food_info_object_list.reset(user_data.attributes.custom_recipes));a()},error:function(a,d,e){b(a,d,e)}})};
ETM.router_functions.loadManagerData=function(a){ETM.loading_view||(ETM.loading_view=new ETM.LoadingView);ETM.router_functions.updateCurrentView(ETM.loading_view);ETM.$content.html(ETM.loading_view.render().el);null==ETM.managed_accounts||null==ETM.managed_external_accounts||null==ETM.manager_profile||null==ETM.manager_invited_users?(ETM.managed_accounts=new ETM.ManagedAccountList,ETM.managed_external_accounts=new ETM.ManagedExternalAccountList,ETM.manager_invited_users=new ETM.ManagerInvitedUserList,
$.when(ETM.managed_accounts.fetch(),ETM.managed_external_accounts.fetch(),ETM.manager_invited_users.fetch()).done(function(){ETM.logged_in_nav_view.addManagedAccountsEvents();a()})):(ETM.logged_in_nav_view.addManagedAccountsEvents(),a());if(ETM.current_user_profile.hasManagerSubscription()&&ETM.manager_profile.attributes.show_changes){var b=new ETM.ManagerV2UpdatesWelcomeModal;b.getModalElement().html(b.render().el);b.$el.modal({backdrop:"static",show:!0});ETM.manager_profile.save({show_changes:!1},
{patch:!0})}};
ETM.router_functions.loadClientDietSets=function(a){null==ETM.client_diet_set_list_fetched?ETM.client_diet_set_list.fetch({url:ROOT+"/clientdietplanset/",success:function(){ETM.client_diet_set_list_fetched=!0;ETM.diet_set_list.models.forEach(function(a){a.attributes.client_user={};a.attributes.client_user.is_current_user=!0;a.attributes.client_user.full_name="You";a.attributes.client_user.email=ETM.current_user_profile.attributes.email;a.attributes.client_user.full_name_email="You "+ETM.current_user_profile.attributes.email;
a.attributes.client_user.exclusions=ETM.current_user_profile.getExclusionsString()});ETM.full_diet_set_list.add(ETM.diet_set_list.models);ETM.full_diet_set_list.add(ETM.client_diet_set_list.models);a()}}):a()};ETM.router_functions.loadPublicDiet=function(a,b){var c=new ETM.Diet({id:a},{silent:!0});c.remote=!0;c.fetch({async:!1,silent:!0,url:ROOT+"/publicdiet/"+a+"/"});c.calculateStats();ETM.current_diet=c;b()};
ETM.router_functions.initializeNavView=function(){!ETM.is_logged_in||0<$("#dont_show_nav").length||(ETM.logged_in_nav_view||(ETM.current_user_profile.hasManagerV2Subscription()?ETM.logged_in_nav_view=new ETM.ManagerNavigationView:ETM.logged_in_nav_view=new ETM.LoggedInNavigationView),ETM.$sidebar_nav.html(ETM.logged_in_nav_view.render().el),ETM.logged_in_nav_view.delegateEvents())};
ETM.router_functions.initializeFoodBankSidebar=function(){ETM.food_bank_sidebar||(ETM.food_bank_sidebar=new ETM.FoodBankSidebar({model:ETM.search_model}));ETM.$sidebar_content.html(ETM.food_bank_sidebar.render().el);ETM.food_bank_sidebar.delegateEvents()};ETM.ACCOUNT_MANAGEMENT_ALLOW_FIELDS="allow_week_regenerates allow_day_regenerates allow_meal_regenerates allow_food_refresh allow_add_delete allow_save_load_plan allow_create_plan allow_less_used_features allow_settings_edit".split(" ");
ETM.MAP_SEARCH_MEAL_CHOSEN="map_search";ETM.ALTERNATE_MEAL_CHOSEN="alternate_meal";ETM.CONTENT_TYPES={};ETM.CONTENT_TYPES.JSON="application/json; charset=UTF-8";ETM.CONTENT_TYPES.URL_ENCODED="application/x-www-form-urlencoded; charset=UTF-8";ETM.FSQUARE_CLIENT_ID="YBRPJX40G03UCIN2YDHNZQXE4OW1L2SDBHWPET0UFK2KXIPK";ETM.FSQUARE_CLIENT_SECRET="YOZIHNYJMG3GKAHBSDHZUWPMDJHDO4P1ZRHHZK41JMM1MN4T";ETM.FSQUARE_VERSION_DATE="20161026";ETM.FSQUARE_RESULT_LIMIT=50;ETM.FSQUARE_FOOD_CATEGORY="4d4b7105d754a06374d81259";
ETM.FSQUARE_RESTAURANT_CATEGORY="4bf58dd8d48988d1c4941735";ETM.FSQUARE_FAST_FOOD_CATEGORY="4bf58dd8d48988d16e941735";ETM.FSQUARE_GROCERY_STORE_CATEGORY="4bf58dd8d48988d118951735";ETM.FSQUARE_BBQ_CATEGORY="4bf58dd8d48988d1df931735";ETM.FSQUARE_BAGEL_CATEGORY="4bf58dd8d48988d179941735";ETM.FSQUARE_BAKERY_CATEGORY="4bf58dd8d48988d16a941735";ETM.FSQUARE_BURGER_CATEGORY="4bf58dd8d48988d16c941735";ETM.FSQUARE_CAFE_CATEGORY="4bf58dd8d48988d16d941735";ETM.FSQUARE_DELI_CATEGORY="4bf58dd8d48988d146941735";
ETM.FSQUARE_DINER_CATEGORY="4bf58dd8d48988d147941735";ETM.FSQUARE_GASTROPUB_CATEGORY="4bf58dd8d48988d155941735";ETM.FSQUARE_DINER_CATEGORY="4bf58dd8d48988d147941735";ETM.FSQUARE_PIZZA_CATEGORY="4bf58dd8d48988d1ca941735";ETM.FSQUARE_SALAD_CATEGORY="4bf58dd8d48988d1bd941735";ETM.FSQUARE_SANDWICH_CATEGORY="4bf58dd8d48988d1c5941735";ETM.FSQUARE_SEAFOOD_CATEGORY="4bf58dd8d48988d1ce941735";ETM.FSQUARE_SNACK_CATEGORY="4bf58dd8d48988d1c7941735";ETM.FSQUARE_SOUP_CATEGORY="4bf58dd8d48988d1dd931735";
ETM.FSQUARE_STEAKHOUSE_CATEGORY="4bf58dd8d48988d1cc941735";ETM.FSQUARE_VEGAN_CATEGORY="4bf58dd8d48988d1d3941735";ETM.FSQUARE_SEARCH_CATEGORIES_1=""+ETM.FSQUARE_FOOD_CATEGORY;ETM.FSQUARE_SEARCH_CATEGORIES_2=""+ETM.FSQUARE_FAST_FOOD_CATEGORY;ETM.FSQUARE_SEARCH_CATEGORIES_3=[ETM.FSQUARE_RESTAURANT_CATEGORY,ETM.FSQUARE_GROCERY_STORE_CATEGORY,ETM.FSQUARE_SANDWICH_CATEGORY,ETM.FSQUARE_BURGER_CATEGORY,ETM.FSQUARE_PIZZA_CATEGORY].join();
ETM.FSQUARE_SPECIFIC_SEARCH_CATEGORIES=[ETM.FSQUARE_FOOD_CATEGORY,ETM.FSQUARE_RESTAURANT_CATEGORY,ETM.FSQUARE_FAST_FOOD_CATEGORY,ETM.FSQUARE_GROCERY_STORE_CATEGORY,ETM.FSQUARE_SANDWICH_CATEGORY,ETM.FSQUARE_PIZZA_CATEGORY,ETM.FSQUARE_BURGER_CATEGORY].join();ETM.PRESET_DIET_TYPES=["atkins / ketogenic","paleo","mediterranean","vegetarian","vegan"];ETM.PRESET_DIET_SYNONYMS={"atkins-ketogenic":"atkins / ketogenic",keto:"atkins / ketogenic"};ETM.POSSIBLE_URL_DIET_TYPES="atkins-ketogenic keto paleo gluten-free mediterranean vegetarian vegan zone low-fat low-carb high-protein".split(" ");
ETM.MIN_IMAGE_WIDTH=200;ETM.MIN_IMAGE_HEIGHT=200;ETM.MAX_IMAGE_WIDTH=1E4;ETM.MAX_IMAGE_HEIGHT=1E4;ETM.GLOBAL_CONTEXT_VARIABLES={CURRENT_SITE_URL:CURRENT_SITE_URL};ETM.ACTIVITY_LEVELS={"1.2":"Sedentary","1.375":"Lightly Active","1.55":"Moderately Active","1.725":"Very Active","1.9":"Extremely Active"};ETM.PYTHON_DAY_LIST="Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" ");ETM.JS_DAY_LIST="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" ");ETM.ANALYTICS_ENABLED=!0;
ETM.NUTRIENT_LIST="price alanine alcohol arginine aspartic_acid betaine caffeine calcium calories carbs cholesterol choline copper cystine fats fiber fluoride folate fructose galactose glucose glutamic_acid glycine histidine hydroxyproline iron isoleucine lactose leucine lycopene lysine magnesium maltose manganese methionine monounsaturated_fats niacin phenylalanine phosphorus polyunsaturated_fats potassium proline proteins retinol riboflavin saturated_fats selenium serine sodium thiamine threonine trans_fats tryptophan tyrosine valine vit_a vit_b6 vit_b12 vit_c vit_d vit_d2 vit_d3 vit_e vit_k water zinc alpha_carotene beta_carotene pantothenic_acid vit_a_iu vit_d_iu starch sucrose sugar theobromine ala_fatty_acid dha_fatty_acid epa_fatty_acid dpa_fatty_acid total_omega_3 total_omega_6".split(" ");
ETM.GENERATOR_NUTRIENTS="carbs fats proteins fiber cholesterol sodium price calories".split(" ");
ETM.NUTRIENT_DICTIONARY={alanine:{display_name:"Alanine",daily_value:null,units:"g"},alcohol:{display_name:"Alcohol",daily_value:null,units:"g"},arginine:{display_name:"Arginine",daily_value:null,units:"g"},aspartic_acid:{display_name:"Aspartic acid",daily_value:null,units:"g"},betaine:{display_name:"Betaine",daily_value:null,units:"mg"},caffeine:{display_name:"Caffeine",daily_value:null,units:"mg"},calcium:{display_name:"Calcium",daily_value:1E3,units:"mg"},calories:{display_name:"Calories",daily_value:null,
units:"kcal"},carbs:{display_name:"Carbs",daily_value:null,units:"g"},cholesterol:{display_name:"Cholesterol",daily_value:null,units:"mg"},choline:{display_name:"Choline",daily_value:550,units:"mg"},copper:{display_name:"Copper",daily_value:2,units:"mg"},cystine:{display_name:"Cystine",daily_value:null,units:"g"},fats:{display_name:"Fats",daily_value:null,units:"g"},fiber:{display_name:"Fiber",daily_value:25,units:"g"},fluoride:{display_name:"Fluoride",daily_value:null,units:"\u03bcg"},folate:{display_name:"Folate (B9)",
daily_value:400,units:"\u03bcg"},fructose:{display_name:"Fructose",daily_value:null,units:"g"},galactose:{display_name:"Galactose",daily_value:null,units:"g"},glucose:{display_name:"Glucose",daily_value:null,units:"g"},glutamic_acid:{display_name:"Glutamic acid",daily_value:null,units:"g"},glycine:{display_name:"Glycine",daily_value:null,units:"g"},histidine:{display_name:"Histidine",daily_value:null,units:"g"},hydroxyproline:{display_name:"Hydroxyproline",daily_value:null,units:"g"},iron:{display_name:"Iron",
daily_value:8,units:"mg"},isoleucine:{display_name:"Isoleucine",daily_value:null,units:"g"},lactose:{display_name:"Lactose",daily_value:null,units:"g"},leucine:{display_name:"Leucine",daily_value:null,units:"g"},lycopene:{display_name:"Lycopene",daily_value:null,units:"\u03bcg"},lysine:{display_name:"Lysine",daily_value:null,units:"g"},magnesium:{display_name:"Magnesium",daily_value:350,units:"mg"},maltose:{display_name:"Maltose",daily_value:null,units:"g"},manganese:{display_name:"Manganese",daily_value:2,
units:"mg"},methionine:{display_name:"Methionine",daily_value:null,units:"g"},monounsaturated_fats:{display_name:"Monounsaturated fats",daily_value:null,units:"g"},niacin:{display_name:"Niacin",daily_value:20,units:"mg"},phenylalanine:{display_name:"Phenylalanine",daily_value:null,units:"g"},phosphorus:{display_name:"Phosphorus",daily_value:1E3,units:"mg"},polyunsaturated_fats:{display_name:"Polyunsaturated fats",daily_value:null,units:"g"},potassium:{display_name:"Potassium",daily_value:4700,units:"mg"},
price:{display_name:"Price",daily_value:null,units:"USD"},proline:{display_name:"Proline",daily_value:null,units:"g"},proteins:{display_name:"Proteins",daily_value:null,units:"g"},retinol:{display_name:"Retinol",daily_value:null,units:"\u03bcg"},riboflavin:{display_name:"Riboflavin (B2)",daily_value:1.7,units:"mg"},saturated_fats:{display_name:"Saturated fats",daily_value:null,units:"g"},selenium:{display_name:"Selenium",daily_value:70,units:"\u03bcg"},serine:{display_name:"Serine",daily_value:null,
units:"g"},sodium:{display_name:"Sodium",daily_value:2400,units:"mg"},thiamine:{display_name:"Thiamine",daily_value:1.5,units:"mg"},threonine:{display_name:"Threonine",daily_value:null,units:"g"},trans_fats:{display_name:"Trans fats",daily_value:null,units:"g"},tryptophan:{display_name:"Tryptophan",daily_value:null,units:"g"},tyrosine:{display_name:"Tyrosine",daily_value:null,units:"g"},valine:{display_name:"Valine",daily_value:null,units:"g"},vit_a:{display_name:"Vit A",daily_value:900,units:"\u03bcg"},
vit_b6:{display_name:"Vit B6",daily_value:1.3,units:"mg"},vit_b12:{display_name:"Vit B12",daily_value:2.4,units:"\u03bcg"},vit_c:{display_name:"Vit C",daily_value:60,units:"mg"},vit_d:{display_name:"Vit D",daily_value:15,units:"\u03bcg"},vit_d2:{display_name:"Vit D2",daily_value:null,units:"\u03bcg"},vit_d3:{display_name:"Vit D3",daily_value:null,units:"\u03bcg"},vit_e:{display_name:"Vit E",daily_value:20,units:"mg"},vit_k:{display_name:"Vit K",daily_value:120,units:"\u03bcg"},water:{display_name:"Water",
daily_value:null,units:"g"},zinc:{display_name:"Zinc",daily_value:15,units:"mg"},alpha_carotene:{display_name:"Alpha carotene",daily_value:null,units:"\u03bcg"},beta_carotene:{display_name:"Beta carotene",daily_value:null,units:"\u03bcg"},pantothenic_acid:{display_name:"Pantothenic acid",daily_value:null,units:"mg"},vit_a_iu:{display_name:"Vit A IU",daily_value:null,units:"IU"},vit_d_iu:{display_name:"Vit D IU",daily_value:null,units:"IU"},starch:{display_name:"Starch",daily_value:null,units:"g"},
sucrose:{display_name:"Sucrose",daily_value:null,units:"g"},sugar:{display_name:"Sugar",daily_value:null,units:"g"},theobromine:{display_name:"Theobromine",daily_value:null,units:"mg"},ala_fatty_acid:{display_name:"ALA",daily_value:null,units:"g"},dha_fatty_acid:{display_name:"DHA",daily_value:null,units:"g"},epa_fatty_acid:{display_name:"EPA",daily_value:null,units:"g"},dpa_fatty_acid:{display_name:"DPA",daily_value:null,units:"g"},total_omega_3:{display_name:"Total omega 3",daily_value:null,units:"g"},
total_omega_6:{display_name:"Total omega 6",daily_value:null,units:"g"}};ETM.MICRONUTRIENT_DISPLAY_ORDER="more_nutrients_header fiber sodium potassium cholesterol sugars_header sugar sucrose glucose fructose lactose maltose galactose starch fats_header saturated_fats monounsaturated_fats polyunsaturated_fats trans_fats fatty_acids_header total_omega_3 total_omega_6 ala_fatty_acid dha_fatty_acid epa_fatty_acid dpa_fatty_acid vitamins_and_minerals_header caffeine theobromine calcium choline copper fluoride folate iron lycopene magnesium manganese niacin phosphorus retinol riboflavin selenium thiamine alpha_carotene beta_carotene pantothenic_acid vit_a vit_a_iu vit_b6 vit_b12 vit_c vit_d vit_d_iu vit_d2 vit_d3 vit_e vit_k zinc amino_acids_header tryptophan threonine isoleucine leucine lysine methionine cystine phenylalanine tyrosine valine arginine histidine alanine aspartic_acid glutamic_acid glycine proline serine hydroxyproline".split(" ");
var THUMB_RATINGS={NO_RATING:0,THUMBS_DOWN:1,THUMBS_UP:2};
ETM.generator_results_cache={cache_index:0,cache_list:null,cache_key:null,getNextResult:function(){if(!this.cache_list||0===this.cache_list.length)return!1;this.cache_index++;this.cache_index>=this.cache_list.length&&(this.cache_index=0);return this.cache_list[this.cache_index]},hasCachedResults:function(a){return this.cache_key===a&&null!==this.cache_list&&!ETM.any_settings.hasChanged()},updateCachedResults:function(a,b){this.cache_index=0;this.cache_key=a;this.cache_list=b;ETM.any_settings.previous_hash=
ETM.any_settings.getHash()},clearCache:function(){this.cache_list=this.cache_key=null}};
ETM.any_settings={previous_hash:null,hasChanged:function(){return null===this.previous_hash?!1:this.getHash()!==this.previous_hash},getHash:function(){var a=[];if(ETM.is_logged_in){a.push(ETM.current_user_profile.usingSingleTemplateDiet());for(var b=0;b<ETM.template_diet_list.length;b++){var c=ETM.template_diet_list.getTemplateDietAtIndex(b);a.push(c.attributes.diet.attributes.nutrition_profile);c.attributes.diet.attributes.meals.each(function(b){a.push(b.attributes.meal_type)})}}else a.push(ETM.current_diet.attributes.nutrition_profile),ETM.current_diet.attributes.meals.each(function(b){a.push(b.attributes.meal_type)});
a.push(ETM.current_user_profile.attributes.exclusions);a.push(ETM.current_user_profile.attributes.preset_diet);a.push(ETM.current_user_profile.attributes.daily_price_limit);a.push(ETM.current_user_profile.attributes.use_leftovers);a.push(ETM.current_user_profile.attributes.units);a.push(ETM.current_user_profile.attributes.use_net_carbs);a.push(ETM.current_user_profile.attributes.use_partial_servings);a.push(ETM.current_user_profile.attributes.algorithm);return JSON.stringify(a)}};
ETM.GeneratorClass=function(a){this.model=a};ETM.GeneratorClass.extend=Backbone.Model.extend;ETM.GoGenerators={};
ETM.GoGenerators.DayGenerator=ETM.GeneratorClass.extend({algorithm:1,url:"/weeklyplanner/regenerate-day/",getRequestObj:function(){return{cal_entry_id:this.model.parent.attributes.id,existing_food_ids:Helper.getExistingFoodInfoIds()}},validate:function(){var a=!0;this.model.attributes.meals.forEach(function(b){b.attributes.eaten||(a=!1)});return a?(Backbone.trigger("flash",{message:"We were unable to regenerate the diet because all its meals are already marked as eaten.  Please try unmarking I ate this on at least one meal if you wish to regenerate.",type:"warning"}),
this.model.trigger("finishedGeneratingSaved"),!1):!0},run:function(a){var b=this;ETM.startedGenerating();b.validate()?(previous_stats=b.initAnalytics(),ETM.generator_results_cache.hasCachedResults(b.getGeneratorCacheKey())?(this.loadNextDayResultFromCache(),this.saveAfterPlanUpdate(a,previous_stats)):(b.model.setProgress(100,"very-slow"),$.ajax({type:"POST",url:b.url,contentType:ETM.CONTENT_TYPES.JSON,dataType:"json",data:JSON.stringify(b.getRequestObj()),statusCode:{504:ETM.RegenerateMessage.Timeout,
500:ETM.RegenerateMessage.Error},success:function(c){b.model.setProgress(100,"fast");c&&!_.isEmpty(c)&&0<c.result_list.length?(add_food_info_objects(c.food_info_objects),c=c.result_list,0<c.length&&(ETM.generator_results_cache.updateCachedResults(b.getGeneratorCacheKey(),c),b.loadMealsFromJson(c[0]),ETM.use_local_storage?b.saveAfterPlanUpdate(a,previous_stats):(b.model.attributes.meals.each(function(a){a.updateFoodsChildLeftovers()}),ETM.analytics.logGenerate(previous_stats,b.model)))):(b.model.trigger("generateError"),
Backbone.trigger("flash",{message:"We were unable to refresh the diet.  Please try loosening some of your restrictions.",type:"danger"}));ETM.use_local_storage||b.model.trigger("finishedGeneratingSaved");"undefined"!==typeof a&&a();ETM.stoppedGenerating()},error:function(c){b.model.trigger("generateError");b.model.trigger("finishedGeneratingSaved");"undefined"!==typeof a&&a();ETM.stoppedGenerating()}}))):ETM.stoppedGenerating()},loadMealsFromJson:function(a){ETM.calendar_list.loadCalendarJson(a)},
resetLocalStorageIDs:function(){},loadNextDayResultFromCache:function(){this.model.setProgress(10,"fast");var a=ETM.generator_results_cache.getNextResult();this.loadMealsFromJson(a)},saveAfterPlanUpdate:function(a,b){var c=this;c.model.trigger("showMealOverlays");c.model.attributes.meals.each(function(a){var b=[];a.attributes.foods.each(function(a){0<a.attributes.id&&b.push(a.attributes.id);a.attributes.has_leftovers&&(a.attributes.update_leftovers=!0)});a.set("delete_other_foods_except",b)});c.model.setProgress(80,
"slow");c.resetLocalStorageIDs();c.model.save(null,{success:function(){c.model.setProgress(100,"fast");c.model.trigger("finishedGeneratingSaved");c.model.trigger("hideMealOverlays");c.model.attributes.meals.each(function(a){delete a.attributes.delete_other_foods;delete a.attributes.delete_other_foods_except_leftovers;a.updateFoodsChildLeftovers()});"undefined"!==typeof a&&a();ETM.analytics.logGenerate(b,c.model);ETM.stoppedGenerating()}})},getGeneratorCacheKey:function(){return"day"+this.model.attributes.resource_uri},
initAnalytics:function(){googleanalytics("send","event","button","click","generate_diet");ETM.is_logged_in||"undefined"===typeof dataLayer||dataLayer.push({event:"generate_diet"});return this.model.stats&&this.model.stats.calories&&0<this.model.stats.calories?$.extend({},this.model.stats):{calories:0,carbs:0,fats:0,proteins:0}}});
ETM.GoGenerators.DayGeneratorDietSet=ETM.GoGenerators.DayGenerator.extend({url:"/weeklyplanner/regenerate-day-diet-set/",getRequestObj:function(){return{diet_set_id:ETM.diet_plan_set.attributes.id,diet_id:this.model.attributes.id,existing_food_ids:Helper.getExistingFoodInfoIds()}},validate:function(){return!0},loadMealsFromJson:function(a){ETM.diet_plan_set.updateFromJson(a)}});
ETM.GoGenerators.DayGeneratorJson=ETM.GoGenerators.DayGenerator.extend({url:"/weeklyplanner/regenerate-day-json/",getRequestObj:function(){var a=this.model.getGenerateRequestObject();a.is_day_regenerate=!0;return{day_json:a,existing_food_ids:Helper.getExistingFoodInfoIds(),use_meal_pools:Helper.mealPoolsAreEnabled()}},validate:function(){return!0},resetLocalStorageIDs:function(){ETM.use_local_storage&&(this.model.updateDietAfterGenerating(),Helper.resetLocalFoodInfoIDs(this.model),this.model.calculateStats())},
loadMealsFromJson:function(a){var b=this;_.each(a[0].diet.meals,function(a,d){b.model.get("meals").at(d).get("foods").reset(a.foods)})}});
ETM.GoGenerators.FoodGenerator=ETM.GeneratorClass.extend({algorithm:1,url:"/weeklyplanner/regenerate-food/",getRequestObj:function(){return{food_id:this.model.attributes.id,existing_food_ids:Helper.getExistingFoodInfoIds()}},run:function(a){var b=this;ETM.startedGenerating();ETM.generator_results_cache.hasCachedResults(b.getGeneratorCacheKey())?(b.model.attributes.has_leftovers&&(b.model.attributes.update_leftovers=!0),b.loadNextFoodResultFromCache(),b.saveAfterPlanUpdate(a)):$.ajax({type:"POST",
url:b.url,contentType:ETM.CONTENT_TYPES.JSON,dataType:"json",data:JSON.stringify(b.getRequestObj()),statusCode:{504:ETM.RegenerateMessage.Timeout,500:ETM.RegenerateMessage.Error},success:function(c){c&&!_.isEmpty(c)&&0<c.result_list.length?(add_food_info_objects(c.food_info_objects),0<c.result_list.length&&(ETM.generator_results_cache.updateCachedResults(b.getGeneratorCacheKey(),c.result_list),b.model.set(c.result_list[0]),b.model.attributes.has_leftovers?b.model.updateChildLeftovers():b.model.attributes.is_leftovers&&
(b.model.set({is_leftovers:!1}),b.model.updateRelatedLeftovers("delete")),ETM.use_local_storage&&b.saveAfterPlanUpdate(function(){}))):ETM.RegenerateMessage.NoFoods();"undefined"!==typeof a&&a();ETM.stoppedGenerating()},error:function(c){b.model.trigger("generateError");"undefined"!==typeof a&&a();ETM.stoppedGenerating()}})},getGeneratorCacheKey:function(){return"food"+this.model.attributes.resource_uri},loadNextFoodResultFromCache:function(){var a=ETM.generator_results_cache.getNextResult();this.model.set(a)},
saveAfterPlanUpdate:function(a){var b=this;b.model.save(null,{success:function(){b.model.attributes.has_leftovers&&b.model.updateChildLeftovers();ETM.stoppedGenerating();"undefined"!==typeof a&&a()}})}});ETM.GoGenerators.FoodGeneratorDietSet=ETM.GoGenerators.FoodGenerator.extend({url:"/weeklyplanner/regenerate-food-diet-set/",getRequestObj:function(){return{diet_set_id:ETM.diet_plan_set.attributes.id,food_id:this.model.attributes.id,existing_food_ids:Helper.getExistingFoodInfoIds()}}});
ETM.GoGenerators.FoodGeneratorJson=ETM.GoGenerators.FoodGenerator.extend({url:"/weeklyplanner/regenerate-food-json/",getRequestObj:function(){var a=this.model.getGenerateRequestObject();a.is_food_regenerate=!0;return{day_json:a,existing_food_ids:Helper.getExistingFoodInfoIds()}},saveAfterPlanUpdate:function(a){Helper.resetLocalFoodInfoIDs(this.model.getParentDiet());this.model.getParentDiet().save();ETM.stoppedGenerating();"undefined"!==typeof a&&a()}});
ETM.GoGenerators.MealGenerator=ETM.GeneratorClass.extend({algorithm:1,url:"/weeklyplanner/regenerate-meal/",getRequestObj:function(){return{meal_id:this.model.attributes.id,existing_food_ids:Helper.getExistingFoodInfoIds()}},run:function(a){var b=this;ETM.startedGenerating();ETM.finish_profile_completeness_key("refresh_meal");ETM.generator_results_cache.hasCachedResults(b.getGeneratorCacheKey())?(b.loadNextMealResultFromCache(),b.saveAfterPlanUpdate(a)):(b.model.clearFoodsRelatedLeftovers(),$.ajax({type:"POST",
url:b.url,contentType:ETM.CONTENT_TYPES.JSON,dataType:"json",data:JSON.stringify(b.getRequestObj()),statusCode:{504:ETM.RegenerateMessage.Timeout,500:ETM.RegenerateMessage.Error},success:function(c){c&&!_.isEmpty(c)&&0<c.result_list.length?(add_food_info_objects(c.food_info_objects),c=c.result_list,0<c.length&&(ETM.generator_results_cache.updateCachedResults(b.getGeneratorCacheKey(),c),b.loadMealsFromJson(c[0]),ETM.use_local_storage?b.saveAfterPlanUpdate(function(){}):b.model.updateFoodsChildLeftovers())):
Backbone.trigger("flash",{message:"We were unable to find other potential meals.  Please try loosening some of your restrictions or try refreshing the day.",type:"danger"});"undefined"!==typeof a&&a();ETM.stoppedGenerating()},error:function(c){b.model.trigger("generateError");"undefined"!==typeof a&&a();ETM.stoppedGenerating()}}))},loadMealsFromJson:function(a){ETM.calendar_list.loadCalendarJson(a)},getGeneratorCacheKey:function(){return"meal"+this.model.attributes.resource_uri},loadNextMealResultFromCache:function(){var a=
ETM.generator_results_cache.getNextResult();this.loadMealsFromJson(a)},saveAfterPlanUpdate:function(a){var b=this,c=[];b.model.attributes.foods.each(function(a){0<a.attributes.id&&c.push(a.attributes.id);a.attributes.has_leftovers&&(a.attributes.update_leftovers=!0)});b.model.set("delete_other_foods_except",c);b.model.save(null,{success:function(){delete b.model.attributes.delete_other_foods_except;delete b.model.attributes.delete_other_foods_except_leftovers;b.model.updateFoodsChildLeftovers();"undefined"!==
typeof a&&a();ETM.stoppedGenerating()}})}});ETM.GoGenerators.MealGeneratorDietSet=ETM.GoGenerators.MealGenerator.extend({url:"/weeklyplanner/regenerate-meal-diet-set/",getRequestObj:function(){return{diet_set_id:ETM.diet_plan_set.attributes.id,meal_id:this.model.attributes.id,existing_food_ids:Helper.getExistingFoodInfoIds()}},loadMealsFromJson:function(a){ETM.diet_plan_set.updateFromJson(a)}});
ETM.GoGenerators.MealGeneratorJson=ETM.GoGenerators.MealGenerator.extend({url:"/weeklyplanner/regenerate-meal-json/",getRequestObj:function(){var a=this.model.getGenerateRequestObject();a.is_meal_regenerate=!0;return{day_json:a,existing_food_ids:Helper.getExistingFoodInfoIds(),use_meal_pools:Helper.mealPoolsAreEnabled()}},loadMealsFromJson:function(a){var b=this;_.each(a[0].diet.meals,function(a,d){d===b.model.attributes.meal_number&&b.model.get("foods").reset(a.foods)})},saveAfterPlanUpdate:function(a){var b=
this.model.getParentDiet();b.updateDietAfterGenerating();Helper.resetLocalFoodInfoIDs(b);b.save();ETM.stoppedGenerating();a()}});
ETM.GoGenerators.V2DayGenerator=ETM.GeneratorClass.extend({algorithm:2,url:"/g/generate/day/",contentType:ETM.CONTENT_TYPES.URL_ENCODED,getPostData:function(){return{date:this.model.parent.attributes.date,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds())}},validate:function(){var a=!0;this.model.attributes.meals.forEach(function(b){b.attributes.eaten||(a=!1)});return a?(Backbone.trigger("flash",{message:"We were unable to regenerate the diet because all its meals are already marked as eaten.  Please try unmarking I ate this on at least one meal if you wish to regenerate.",
type:"warning"}),this.model.trigger("finishedGeneratingSaved"),!1):!0},run:function(a){var b=this;ETM.startedGenerating();b.validate()?(previous_stats=b.initAnalytics(),ETM.generator_results_cache.hasCachedResults(b.getGeneratorCacheKey())?(this.loadNextDayResultFromCache(),this.saveAfterPlanUpdate(a,previous_stats)):(b.model.setProgress(100,"very-slow"),$.ajax({type:"POST",url:b.url,contentType:b.contentType,dataType:"json",data:b.getPostData(),statusCode:{504:ETM.RegenerateMessage.Timeout},success:function(c){b.model.setProgress(100,
"fast");c&&!_.isEmpty(c)&&0<c.results.length?(add_v2_food_info_objects(c.food_infos),Helper.displayIssues(c.issues),0<c.results.length&&(ETM.generator_results_cache.updateCachedResults(b.getGeneratorCacheKey(),c.results),b.loadDay(c.results[0]),ETM.use_local_storage?b.saveAfterPlanUpdate(a,previous_stats):(b.model.attributes.meals.each(function(a){a.updateFoodsChildLeftovers()}),ETM.analytics.logGenerate(previous_stats,b.model)))):Backbone.trigger("flash",{message:"We were unable to refresh the diet.  Please try loosening some of your restrictions.",
type:"danger"});ETM.use_local_storage||b.model.trigger("finishedGeneratingSaved");"undefined"!==typeof a&&a();ETM.stoppedGenerating()},error:function(c){b.model.trigger("generateError");"string"===typeof c.responseJSON&&Backbone.trigger("flash",{message:c.responseJSON,type:"danger"});b.model.trigger("finishedGeneratingSaved");"undefined"!==typeof a&&a(c.responseJSON);ETM.stoppedGenerating()}}))):ETM.stoppedGenerating()},loadDay:function(a){var b=this;this.model.clone();_.each(a.meals,function(a,d){b.model.get("meals").at(d).get("foods").reset(a.foods)});
this.model.attributes.meals.models.forEach(function(a){a.parent=b.model;a.attributes.foods.models.forEach(function(b){b.parent=a})});this.model.calculateStats();b.model.attributes.meals.models.forEach(function(a){a.trigger("rerender")})},resetLocalStorageIDs:function(){},loadNextDayResultFromCache:function(){this.model.setProgress(10,"fast");var a=ETM.generator_results_cache.getNextResult();this.loadDay(a)},saveAfterPlanUpdate:function(a,b){var c=this;c.model.trigger("showMealOverlays");c.model.attributes.meals.each(function(a){a.set("delete_other_foods_except_leftovers",
!0);a.attributes.foods.each(function(a){a.attributes.has_leftovers&&(a.attributes.update_leftovers=!0)})});c.model.setProgress(80,"slow");c.resetLocalStorageIDs();c.model.save(null,{success:function(){c.model.setProgress(100,"fast");c.model.trigger("finishedGeneratingSaved");c.model.trigger("hideMealOverlays");c.model.attributes.meals.each(function(a){delete a.attributes.delete_other_foods_except_leftovers;a.trigger("rerender");a.updateFoodsChildLeftovers()});"undefined"!==typeof a&&a();ETM.analytics.logGenerate(b,
c.model);ETM.stoppedGenerating()}})},getGeneratorCacheKey:function(){return"day"+this.model.attributes.resource_uri},initAnalytics:function(){googleanalytics("send","event","button","click","generate_diet");ETM.is_logged_in||"undefined"===typeof dataLayer||dataLayer.push({event:"generate_diet"});return this.model.stats&&this.model.stats.calories&&0<this.model.stats.calories?$.extend({},this.model.stats):{calories:0,carbs:0,fats:0,proteins:0}}});
ETM.GoGenerators.V2DayGeneratorDietSet=ETM.GoGenerators.V2DayGenerator.extend({url:"/g/generate/day/",contentType:ETM.CONTENT_TYPES.URL_ENCODED,getPostData:function(){var a={diet_set_id:ETM.diet_plan_set.attributes.id,diet_id:this.model.attributes.id,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds())};ETM.diet_plan_set.managed_account&&(a.client_user_id=ETM.diet_plan_set.managed_account.attributes.client_id);return a},validate:function(){return!0}});
ETM.GoGenerators.V2DayGeneratorJson=ETM.GoGenerators.V2DayGenerator.extend({url:"/g/generate/day-json/",contentType:ETM.CONTENT_TYPES.JSON,getPostData:function(){var a=this.model.getV2GenerateJson();return JSON.stringify({days:[a],swole_user:ETM.getV2UserProfileJson(),diet_json_id:this.model.getV2JsonId(),existing_food_info_ids:Helper.getExistingFoodInfoIds()})},validate:function(){return!0},resetLocalStorageIDs:function(){ETM.use_local_storage&&(this.model.updateDietAfterGenerating(),Helper.resetLocalFoodInfoIDs(this.model),
this.model.calculateStats())}});
ETM.GoGenerators.V2FoodGenerator=ETM.GeneratorClass.extend({algorithm:2,url:"/g/generate/foodobject/",contentType:ETM.CONTENT_TYPES.URL_ENCODED,getPostData:function(){return{date:this.model.parent.parent.parent.attributes.date,meal_id:this.model.parent.attributes.id,food_obj_id:this.model.attributes.id,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds())}},run:function(a){var b=this;ETM.startedGenerating();ETM.generator_results_cache.hasCachedResults(b.getGeneratorCacheKey())?(b.model.attributes.has_leftovers&&
(b.model.attributes.update_leftovers=!0),b.loadNextFoodResultFromCache(),b.saveAfterPlanUpdate(a)):$.ajax({type:"POST",url:b.url,contentType:b.contentType,dataType:"json",data:b.getPostData(),statusCode:{504:ETM.RegenerateMessage.Timeout},success:function(c){c&&!_.isEmpty(c)&&0<c.results.length?(add_v2_food_info_objects(c.food_infos),Helper.displayIssues(c.issues),0<c.results.length&&(ETM.generator_results_cache.updateCachedResults(b.getGeneratorCacheKey(),c.results),b.model.set(c.results[0]),b.model.attributes.has_leftovers?
b.model.updateChildLeftovers():b.model.attributes.is_leftovers&&(b.model.set({is_leftovers:!1}),b.model.updateRelatedLeftovers("delete")),ETM.use_local_storage&&b.saveAfterPlanUpdate(function(){}))):ETM.RegenerateMessage.NoFoods();"undefined"!==typeof a&&a();ETM.stoppedGenerating()},error:function(c){b.model.trigger("generateError");"string"===typeof c.responseJSON&&Backbone.trigger("flash",{message:c.responseJSON,type:"danger"});"undefined"!==typeof a&&a(c.responseJSON);ETM.stoppedGenerating()}})},
getGeneratorCacheKey:function(){return"food"+this.model.attributes.resource_uri},loadNextFoodResultFromCache:function(){var a=ETM.generator_results_cache.getNextResult();this.model.set(a)},saveAfterPlanUpdate:function(a){var b=this;b.model.save(null,{success:function(){b.model.attributes.has_leftovers&&b.model.updateChildLeftovers();ETM.stoppedGenerating();"undefined"!==typeof a&&a()}})}});
ETM.GoGenerators.V2FoodGeneratorDietSet=ETM.GoGenerators.V2FoodGenerator.extend({url:"/g/generate/foodobject/",contentType:ETM.CONTENT_TYPES.URL_ENCODED,getPostData:function(){var a={diet_set_id:ETM.diet_plan_set.attributes.id,diet_id:this.model.getParentMeal().getParentDiet().attributes.id,meal_id:this.model.getParentMeal().attributes.id,food_obj_id:this.model.attributes.id,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds())};ETM.diet_plan_set.managed_account&&(a.client_user_id=
ETM.diet_plan_set.managed_account.attributes.client_id);return a}});
ETM.GoGenerators.V2FoodGeneratorJson=ETM.GoGenerators.V2FoodGenerator.extend({url:"/g/generate/foodobject-json/",contentType:ETM.CONTENT_TYPES.JSON,getPostData:function(){var a=this.model.getParentMeal().getParentDiet(),b=a.getV2GenerateJson();return JSON.stringify({days:[b],swole_user:ETM.getV2UserProfileJson(),diet_json_id:a.getV2JsonId(),meal_json_id:this.model.getParentMeal().getV2JsonId(),food_json_id:this.model.getV2JsonId(),existing_food_info_ids:Helper.getExistingFoodInfoIds()})},saveAfterPlanUpdate:function(a){Helper.resetLocalFoodInfoIDs(this.model.getParentDiet());
this.model.getParentDiet().save();ETM.stoppedGenerating();"undefined"!==typeof a&&a()}});
ETM.GoGenerators.V2MealGenerator=ETM.GeneratorClass.extend({algorithm:2,url:"/g/generate/meal/",contentType:ETM.CONTENT_TYPES.URL_ENCODED,getPostData:function(){return{date:this.model.parent.parent.attributes.date,meal_id:this.model.attributes.id,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds())}},run:function(a){var b=this;ETM.startedGenerating();ETM.finish_profile_completeness_key("refresh_meal");ETM.generator_results_cache.hasCachedResults(b.getGeneratorCacheKey())?(b.loadNextMealResultFromCache(),
b.saveAfterPlanUpdate(a)):(b.model.clearFoodsRelatedLeftovers(),$.ajax({type:"POST",url:b.url,contentType:b.contentType,dataType:"json",data:b.getPostData(),statusCode:{504:ETM.RegenerateMessage.Timeout},success:function(c){c&&!_.isEmpty(c)&&0<c.results.length?(add_v2_food_info_objects(c.food_infos),Helper.displayIssues(c.issues),0<c.results.length&&(ETM.generator_results_cache.updateCachedResults(b.getGeneratorCacheKey(),c.results),b.loadMeal(c.results[0]),ETM.use_local_storage?b.saveAfterPlanUpdate(function(){}):
b.model.updateFoodsChildLeftovers())):Backbone.trigger("flash",{message:"We were unable to refresh the meal.  Please try loosening some of your restrictions.",type:"danger"});"undefined"!==typeof a&&a();ETM.stoppedGenerating()},error:function(c){b.model.trigger("generateError");"string"===typeof c.responseJSON&&Backbone.trigger("flash",{message:c.responseJSON,type:"danger"});"undefined"!==typeof a&&a(c.responseJSON);ETM.stoppedGenerating()}}))},loadMeal:function(a){var b=this;this.model.get("foods").reset(a.foods);
b.model.calculateStats();this.model.attributes.foods.models.forEach(function(a){a.parent=b.model})},getGeneratorCacheKey:function(){return"meal"+this.model.attributes.resource_uri},loadNextMealResultFromCache:function(){var a=ETM.generator_results_cache.getNextResult();this.loadMeal(a)},saveAfterPlanUpdate:function(a){var b=this;b.model.attributes.foods.each(function(a){a.attributes.has_leftovers&&(a.attributes.update_leftovers=!0)});b.model.set("delete_other_foods_except_leftovers",!0);b.model.save(null,
{success:function(){delete b.model.attributes.delete_other_foods_except_leftovers;b.model.updateFoodsChildLeftovers();"undefined"!==typeof a&&a();b.model.calculateStats();ETM.stoppedGenerating()}})}});
ETM.GoGenerators.V2MealGeneratorDietSet=ETM.GoGenerators.V2MealGenerator.extend({url:"/g/generate/meal/",contentType:ETM.CONTENT_TYPES.URL_ENCODED,getPostData:function(){var a={diet_set_id:ETM.diet_plan_set.attributes.id,meal_id:this.model.attributes.id,diet_id:this.model.getParentDiet().attributes.id,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds())};ETM.diet_plan_set.managed_account&&(a.client_user_id=ETM.diet_plan_set.managed_account.attributes.client_id);return a}});
ETM.GoGenerators.V2MealGeneratorJson=ETM.GoGenerators.V2MealGenerator.extend({url:"/g/generate/meal-json/",contentType:ETM.CONTENT_TYPES.JSON,getPostData:function(){var a=this.model.getParentDiet(),b=a.getV2GenerateJson();return JSON.stringify({days:[b],swole_user:ETM.getV2UserProfileJson(),diet_json_id:a.getV2JsonId(),meal_json_id:this.model.getV2JsonId(),existing_food_info_ids:Helper.getExistingFoodInfoIds()})},saveAfterPlanUpdate:function(a){var b=this.model.getParentDiet();b.updateDietAfterGenerating();
Helper.resetLocalFoodInfoIDs(b);b.save();ETM.stoppedGenerating();a()}});function parseIntIdFromResourceURI(a){return"string"===typeof a?(a=/\/\w+\/(\-?\d+)/.exec(a),null!=a&&2==a.length?parseInt(a[1]):0):a}function parseIdFromResourceURI(a){return"string"===typeof a?(a=/\/\w+\/(\-?\d+)/.exec(a),null!=a&&2==a.length?a[1]:!1):a}
var AccountManagementHelper={toggleBulkActions:function(a,b){$("button",b).html('<i class="fa fa-ellipsis-v" aria-hidden="true"></i> Actions ('+a.length+")");0==a.length?(b.prop("disabled","true"),b.addClass("disabled"),b.find(".btn").removeClass("btn-primary"),b.find(".btn").addClass("btn-secondary")):(b.prop("disabled",!1),b.removeClass("disabled"),b.find(".btn").removeClass("btn-secondary"),b.find(".btn").addClass("btn-primary"))}};
ETM.getNextBillingDate=function(a){$.ajax({url:"/payments/next-billing-date/",type:"GET",success:function(b){if(null!=b&&_.has(b,"current_period_end")){var c=new Date(0);c.setUTCSeconds(b.current_period_end);b=String(c.getMonthNameShort("en"));var d=String(c.getDate());a(b+" "+d+", "+c.getFullYear())}else a("")},error:function(){a("")}})};
var Fraction={parseFractionToFloat:function(a){a=a.split(" ");if(1<a.length){var b=a[1].split("/");0===b[1].length&&(b[1]=1);return+a[0]+b[0]/b[1]}b=a[0].split("/");return 1<b.length?(0===b[1].length&&(b[1]=1),b[0]/b[1]):b[0]},getKeys:function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(c);return b}};Fraction.getFractionObject=function(){for(var a={0:"0",1:"1"},b=20,c=21,d;--b;){for(;1<--c;)d=(b/c).toFixed(3),1>d&&(a[d]=b+"/"+c);c=21}a.keys=Fraction.getKeys(a);return function(){return a}}();
Fraction.getClosestNum=function(a,b){if("object"!==typeof a||!a.hasOwnProperty("length")||isNaN(b))return!1;for(var c=a.length,d=c-1,e=Math.abs(+b-a[d]),f;c--;)f=Math.abs(+b-a[c]),f<e&&(e=f,d=c);return a[d]};
Fraction.getFractionFromDecimal=function(a){if(isNaN(a)||!isFinite(a))return!1;if(!/\./.test(a))return a;var b=Fraction.getFractionObject(),c=a.toString().match(/(\d+)(\.\d+)/),b=b[Fraction.getClosestNum(b.keys,Math.abs(+c[2]))],d=0<a||"0"==b&&1>Math.abs(a)?"":"-";if("0"==b)return a;1<Math.abs(a)&&(b=isNaN(b)?+c[1]+" "+b:+c[1]+ +b);return d+b};
var Helper={deleteCookie:function(a,b,c){document.cookie=encodeURIComponent(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; domain="+c:"")+(b?"; path="+b:"")},displayIssues:function(a){if(null!=a){var b=[];a.forEach(function(a){b.push(a.message)});Helper.multiToast(b,"warning",5E3)}},updateTemplateFromDiet:function(a,b){var c=a-1;-1===c&&(c=6);var d=b.clone();d.attributes.sandbox=0;Helper.clearIDs(d);d.attributes.meals=new ETM.MealList;b.attributes.meals.each(function(a,c){var g=new ETM.MealObject({diet_plan_id:b.id,
meal_type:a.attributes.meal_type,meal_number:a.attributes.meal_number});d.attributes.meals.add(g)});ETM.template_diet_list.getTemplateDietForWeekday(c).attributes.diet.save(d.attributes,{silent:!0})},createTemplatesOnServer:function(a){$.get("/weeklyplanner/create-templates/",function(b){b=JSON.parse(b);ETM.template_diet_list.reset();b.forEach(function(a){a=new ETM.TemplateDiet(a);ETM.template_diet_list.add(a,{silent:!0})});a()})},localStorageExists:function(){try{return localStorage.setItem("test",
"test"),localStorage.removeItem("test"),!0}catch(a){return!1}},deleteLocalStorageKeys:function(){Object.keys(localStorage).forEach(function(a){localStorage.removeItem(a)})},deleteLocalStorageKeysWithPrefix:function(a){var b=a.length;Object.keys(localStorage).forEach(function(c){c.substring(0,b)==a&&localStorage.removeItem(c)})},deleteLocalStorageKeysWithOutPrefix:function(a){var b=a.length;Object.keys(localStorage).forEach(function(c){c.substring(0,b)!=a&&localStorage.removeItem(c)})},randomNumber:function(a){return Math.floor(Math.random()*
a)},randomNumberInRange:function(a,b){var c=b-a;return Math.floor(Math.random()*c)+a},clearIDs:function(a){delete a.id;delete a.pk;a.attributes&&(delete a.attributes.id,delete a.attributes.diet_plan,delete a.attributes.meal,delete a.attributes.resource_uri,delete a.attributes.food_resource_uri,delete a.attributes.pk,delete a.attributes.extra_info_id,delete a.attributes.nutrition_id)},clearImageIDs:function(a){delete a.id;delete a.pk;a.attributes&&(delete a.attributes.id,delete a.attributes.resource_uri,
delete a.attributes.food_id)},clearIDsRecursive:function(a){Helper.clearIDs(a);if(a.attributes)for(var b in a.attributes){var c=a.attributes[b];c&&"object"===typeof c&&Helper.clearIDsRecursive(c)}},clearUserIDs:function(a){a.attributes&&delete a.attributes.user_id},clearUserIDsRecursive:function(a){Helper.clearUserIDs(a);if(a.attributes)for(var b in a.attributes){var c=a.attributes[b];c&&"object"===typeof c&&Helper.clearIDsRecursive(c)}},resetLocalFoodInfoIDs:function(a){localStorage.setItem("food_info_object_ids",
JSON.stringify([]));var b=[];a.attributes.meals.each(function(a){a.attributes.foods.each(function(a){b.push({id:a.attributes.food.attributes.id})})});b.unique();localStorage.setItem("food_info_object_ids",JSON.stringify(b))},resetMacroSettings:function(){var a=ETM.current_diet.attributes.nutrition_profile;100<!a.attributes.calories&&(a.attributes.calories=2E3);var b=a.attributes.calories;a.attributes.min_carbs=parseInt(0.2*b/4);a.attributes.max_carbs=parseInt(0.6*b/4);a.attributes.min_fats=parseInt(0.2*
b/9);a.attributes.max_fats=parseInt(0.6*b/9);a.attributes.min_proteins=parseInt(0.2*b/4);a.attributes.max_proteins=parseInt(0.6*b/4);a.save();ETM.toast.clear()},convertDateToString:function(a){var b=String(a.getMonth()+1);1===b.length&&(b="0"+b);var c=String(a.getDate());1===c.length&&(c="0"+c);return a.getFullYear()+"-"+b+"-"+c},convertDateToShortString:function(a){var b=String(a.getMonth()+1);a=String(a.getDate());return b+"-"+a},parseDateString:function(a){var b=a.indexOf("T");-1!=b&&(a=a.substr(0,
b));a=a.split("-");return new Date(a[0],a[1]-1,a[2])},parseDateStringSlashes:function(a){a=a.split("/");return new Date(a[2],a[0]-1,a[1])},days_between:function(a,b){var c=a.getTime(),d=b.getTime(),c=Math.abs(c-d);return Math.round(c/864E5)},isTodayOrInFuture:function(a){var b=new Date;b.setHours(0);b.setMinutes(0);b.setSeconds(0);b.setMilliseconds(0);return a>=b},retainPageHeight:function(a){Helper.lockPageHeight();a();Helper.unlockPageHeight()},lockPageHeight:function(){var a=$(".body-container"),
b=a.height();a.css("min-height",b)},unlockPageHeight:function(){$(".body-container").css("min-height","")},lockDivHeight:function(a){var b=a.height();a.css("min-height",b)},unlockDivHeight:function(a){a.css("min-height","")}};Array.prototype.unique=function(){for(var a=this.concat(),b=0;b<a.length;++b)for(var c=b+1;c<a.length;++c)a[b]===a[c]&&a.splice(c--,1);return a};
Helper.formatFoodAmount=function(a){return"number"==typeof a?100<a?a.toFixed(0):1<=a?0!=a.toFixed(1)%1?a.toFixed(1):a.toFixed(0):a.toPrecision(2):a};Helper.getRoundedFractionFromDecimal=function(a){for(var b=99999999999,c=0,d=[1,2,3,4,8,16],e=0;e<d.length;e++){var f=d[e],f=Math.round(a*f)/f,g=Math.abs(a-f);g<b&&(b=g,c=f)}0===c&&(c=a);return Fraction.getFractionFromDecimal(c)};
Helper.calculateMacrosFromProfile=function(a,b){if(0<a.validationErrorsForCalculator(b).length)return!1;var c=Helper.calculateMacros(a.attributes.age,a.attributes.weight,a.attributes.height,a.attributes.gender,a.attributes.goal,a.attributes.bodyfat,a.attributes.activity_level,a.attributes.preset_diet,a.attributes.use_weight_goal?a.attributes.weight_goal:null,a.attributes.use_weight_goal&&a.attributes.weight_goal_weekly_rate?a.attributes.weight_goal_weekly_rate/7:null);null!=b&&b(c);return c};
Helper.calculateMacros=function(a,b,c,d,e,f,g,h,m,k){var n;n=parseInt((10*(1/2.2046)*b+15.875*c-5*a+("M"===d?5:"F"===d?-161:-78))*g);var l=c=a=0;d=!1;!isNaN(k)&&0>k&&(k=Math.abs(k));m&&(m<b?isNaN(k)||0==k?e="L":k*=-1:m===b?(k=0,e="M"):e="G");null!=k&&0>k||"L"==e?(a=1.5>g?0.1*b:1.7>g?0.3*b:1*b,c=0.3*b,l=g/1.7,l=10==f?0.7*b*l:20==f?0.6*b*l:30==f?0.5*b*l:0.6*b*l,null!=k&&0!=k?(b=n+3400*k,b/=n,0.5>=b&&(d=!0,b=0.5)):b=0.8):null!=k&&0<k||"G"==e?(a=1.5>g?0.8*b:1.7>g?1.5*b:1.8>g?2*b:3*b,c=0.5*b,l=10==f?1.1*
b:20==f?0.9*b:30==f?0.8*b:0.9*b,null!=k&&0!=k?(b=n+3500*k,b/=n):b=1.15):(a=1.5>g?0.3*b:1.7>g?0.8*b:1.8>g?2*b:3*b,c=0.5*b,l=g/1.7,l=10==f?0.8*b*l:20==f?0.7*b*l:30==f?0.6*b*l:0.7*b*l,b=1);b=Math.max(Math.ceil(n*b),200);f=0.5*b/4;k=0.5*b/9;n=0.5*b/4;"atkins / ketogenic"==h?(a=0,f=40,k=0.8*b/9,n=0.3*b/4,c=(b-4*n-4*f)/9):"paleo"==h?150<a?(f=a,a=100):(100<a&&150>a&&(a=100),f=150):"mediterranean"==h?(a*=0.9,l*=0.9):"zone"==h?(a=Math.max(0,0.4*b/4-5),f=0.4*b/4+5,c=Math.max(0,0.3*b/9-3),k=0.3*b/9+3,l=Math.max(0,
0.3*b/4-5),n=0.3*b/4+5):"vegetarian"==h?l*=0.8:"vegan"==h&&(l*=0.8);"zone"!=h&&250<l&&(l=250);g=Helper.getCaloriesFromMacros(a,c,l);g>=b&&(h=4*a/g,e=9*c/g,g=4*l/g,0.2<h&&(a=(h-0.03)*b/4),0.2<e&&(c=(e-0.03)*b/9),0.2<g&&(l=(g-0.03)*b/4));a=Math.floor(a);c=Math.floor(c);l=Math.floor(l);f=Math.ceil(f);k=Math.ceil(k);n=Math.ceil(n);a>=f&&(a=2>=a?0:roundNumber(0.75*f,0));c>=k&&(c=2>=c?0:roundNumber(0.75*k,0));l>=n&&(l=2>=l?0:roundNumber(0.75*n,0));return{calories:b,min_carbs:a,min_fats:c,min_proteins:l,
max_carbs:f,max_fats:k,max_proteins:n,capped_min_calories:d}};Helper.getCaloriesFromMacros=function(a,b,c){return 4*a+9*b+4*c};Helper.getMobileOperatingSystem=function(){var a=navigator.userAgent||navigator.vendor||window.opera;return a.match(/iPad/i)||a.match(/iPhone/i)||a.match(/iPod/i)?"iOS":a.match(/Android/i)?"Android":"unknown"};Helper.capitalizeFirstLetter=function(a){return null==a||0==a.length?"":a.charAt(0).toUpperCase()+a.slice(1)};
Helper.getListOfNextDates=function(a){return day_list=[{val:0,label:"Current day, "+moment(a).format("dddd, MMM Do")},{val:1,label:"Tomorrow, "+moment(a).add(1,"days").format("dddd, MMM Do")},{val:2,label:moment(a).add(2,"days").format("dddd, MMM Do")},{val:3,label:moment(a).add(3,"days").format("dddd, MMM Do")},{val:4,label:moment(a).add(4,"days").format("dddd, MMM Do")},{val:5,label:moment(a).add(5,"days").format("dddd, MMM Do")},{val:6,label:moment(a).add(6,"days").format("dddd, MMM Do")}]};
Helper.getListOfNextDayNumbers=function(a,b){for(var c=[],d=0,e=a;e<b&&!(c.push({val:e,label:e===a?"Current plan, Day "+(a+1):"Day "+(e+1)}),d++,14<d);e++);return c};Helper.toHex=function(a){return("0"+Number(a).toString(16)).slice(-2).toUpperCase()};
Helper.hsvToRgb=function(a,b,c){var d,e,f;a=Math.max(0,Math.min(360,a));b=Math.max(0,Math.min(100,b));c=Math.max(0,Math.min(100,c));b/=100;c/=100;if(0==b)return d=b=c,[Math.round(255*d),Math.round(255*b),Math.round(255*c)];a/=60;d=Math.floor(a);e=a-d;a=c*(1-b);f=c*(1-b*e);e=c*(1-b*(1-e));switch(d){case 0:d=c;b=e;c=a;break;case 1:d=f;b=c;c=a;break;case 2:d=a;b=c;c=e;break;case 3:d=a;b=f;break;case 4:d=e;b=a;break;default:d=c,b=a,c=f}return"#"+Helper.toHex(Math.round(255*d))+Helper.toHex(Math.round(255*
b))+Helper.toHex(Math.round(255*c))};Helper.rgbColors=function(a){a=parseInt(a);if(2>a)throw Error("'t' must be greater than 1.");for(var b=360/(a-1),c=[],d=70,e=0;e<a;e++)d=90<d?70:d+10,c.push(Helper.hsvToRgb(b*e,d,d));return c};Helper.removePunctuationAndLowerCase=function(a){return a.replace(/[^\w]|_/g,"").replace(/\s+/g," ").toLowerCase()};
Helper.oneTimeTooltip=function(a,b,c,d){a.tooltip({placement:b,html:!0,title:c,trigger:"manual",template:'<div class="tooltip helper_tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>'}).on("hidden.bs.tooltip",function(a){$(this).off("hidden.bs.tooltip");$(this).tooltip("dispose")});a.tooltip("show");setTimeout(function(){a.tooltip("hide")},d)};
Helper.oneTimePopover=function(a){var b=a.message||"",c=a.button_dismiss||!1,d=a.position||"right",e=a.title||"",f=a.custom_class||"",g=a.dismiss_callback||!1,h=a.zindex||1060,m=a.container||a.element.parent();c&&(b+="<div class='popover_footer'><div class='dismiss_popover btn btn-primary'>Okay, got it</div></div>");a.element.popover({placement:d,html:!0,title:e,container:m,content:b,template:'<div style="z-index:'+h+';" class="helper_tooltip popover '+f+'" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',
trigger:"manual"}).on("hidden.bs.popover",function(a){$(this).off("hidden.bs.popover");$(this).popover("dispose")}).on("shown.bs.popover",function(a,b,c){popover_obj=$(this).data("bs.popover");$(popover_obj.tip).find(".dismiss_popover").click(function(a){g&&g();try{popover_obj.dispose()}catch(b){}})});a.element.popover("show");c||setTimeout(function(){a.element.popover("hide")},3500)};
Helper.confirmationPopover=function(a){var b=a.message||"",c=a.position||"right",d=a.title||"",e=a.footer_message||!1,f=a.custom_class||"",g=a.hide_cancel||!1,h=a.cancel_text||"No",m=a.confirm_text||"Yes",k=a.cancelCallback||!1,n=a.confirmCallback||!1,l=a.zindex||1060;popover_footer="<div class='popover_footer'>";e&&(popover_footer=popover_footer+"<div class='footer_text'>"+e+"</div>");g||(popover_footer=popover_footer+" <div class='cancel_popover btn btn-outline-secondary'>"+h+"</div> ");popover_footer=
popover_footer+"<div class='confirm_popover btn btn-primary'>"+m+"</div></div>";var b=b+popover_footer,p=null;a.element.popover({placement:c,html:!0,title:d,content:b,template:'<div style="z-index:'+l+';" class="helper_tooltip popover '+f+'" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',trigger:"manual"}).on("shown.bs.popover",function(){p=$(this).data("bs.popover");$(p.tip).find(".confirm_popover").click(function(a){try{p.dispose()}catch(b){}n&&
n()});g||$(p.tip).find(".cancel_popover").click(function(a){try{p.dispose()}catch(b){}k&&k()})});a.element.popover("show")};Helper.fixNullCaloriesInNutritionProfiles=function(a){var b=0,c=[];ETM.nutrition_profile_list.each(function(a){if(3<=b)return!1;null==a.attributes.calories&&c.push(a.save({calories:2E3}));b++});$.when.all(c).then(function(b){a()})};
Helper.copyPermalink=function(a,b){var c=$("<input>");$("body").append(c);c.val(a.val()).select();try{if(document.execCommand("copy"),Helper.oneTimeTooltip(a,"top","Copied to clipboard",1E3),"undefined"!==typeof b)Helper.oneTimeTooltip(b,"bottom","Copied to clipboard",1E3)}catch(d){}c.remove()};
Helper.validateSingleDayDiet=function(a){var b=[],c=[];if("blank"===a||"downloading"===a)return c.push("diet"+Helper.convertDateToString(new Date)),c;a.attributes.meals.models.forEach(function(a){var c=[];a.attributes.foods.models.forEach(function(a){c.push(a.attributes.food.attributes.resource_uri)});b.push(c)});_.each(b,function(a,b){0===a.length&&c.push("meal"+b);a.forEach(function(a){null==a&&c.push("food"+b)})});return c};
Helper.createTemplateFunction=function(a){var b=_.template(a);return function(a){if("undefined"===typeof a||null==a)a={};a=$.extend({},a,ETM.GLOBAL_CONTEXT_VARIABLES);return b(a)}};Helper.generateMealRatingHash=function(a,b){b=b||!1;var c=0;_.each(a,function(a){c+=Math.pow(a,2)});b&&(c*=b);return c};Helper.event_timers={};
Helper.waitForFinalEvent=function(a,b,c){c||(c="Don't call this twice without a uniqueId");Helper.event_timers[c]&&clearTimeout(Helper.event_timers[c]);Helper.event_timers[c]=setTimeout(a,b)};
Helper.dates={convert:function(a){return a.constructor===Date?a:a.constructor===Array?new Date(a[0],a[1],a[2]):a.constructor===Number?new Date(a):a.constructor===String?new Date(a):"object"===typeof a?new Date(a.year,a.month,a.date):NaN},compare:function(a,b){return isFinite(a=this.convert(a).valueOf())&&isFinite(b=this.convert(b).valueOf())?(a>b)-(a<b):NaN},inRange:function(a,b,c){return isFinite(a=this.convert(a).valueOf())&&isFinite(b=this.convert(b).valueOf())&&isFinite(c=this.convert(c).valueOf())?
b<=a&&a<=c:NaN}};Helper.$text_measuring_span=null;Helper.resizeInputs=function(a){if(null!=Helper.$text_measuring_span){var b=a.val().replace(/\s+/g," "),c=9;""!==b?Helper.$text_measuring_span.text(b):Helper.$text_measuring_span.text("0");c=Helper.$text_measuring_span.width();b=a.hasClass("modal_amount_input")?24:10;a.css("width",c+b);a.css("min-width",c+b);a.css("max-width",c+b)}};Helper.getWidthOfText=function(a){Helper.$text_measuring_span.text(a);return Helper.$text_measuring_span.width()};
Helper.getTargetDisplay=function(a,b){var c="";"grams"===a.attributes.macro_scheme?c=roundNumber(a.attributes["min_"+b],0)+"g - "+roundNumber(a.attributes["max_"+b],0)+"g":(c="fats"===b?9:4,c="~ "+roundNumber(a.attributes.calories*(parseInt(a.attributes["percent_"+b])/100/c),0)+"g ("+a.attributes["percent_"+b]+"%)");return c};Helper.findNextAvailableTitle=function(a,b){for(var c=2;null!=a.findWhere({title:b+c});)c++;return b+c};
Helper.getColorForProgressPercentage=function(a){for(var b=[{pct:0,color:{r:211,g:211,b:211}},{pct:1,color:{r:30,g:144,b:255}}],c=1;c<b.length-1&&!(a<b[c].pct);c++);var d=b[c-1],b=b[c];a=(a-d.pct)/(b.pct-d.pct);c=1-a;return"rgb("+[Math.floor(d.color.r*c+b.color.r*a),Math.floor(d.color.g*c+b.color.g*a),Math.floor(d.color.b*c+b.color.b*a)].join()+")"};Helper.setupGrooveWidget=function(){try{ETM.is_logged_in&&window.groove.widget.setContact({email:ETM.current_user_profile.attributes.email})}catch(a){}};
Helper.removeHiddenTooltips=function(){$(".tooltip").not(".show").remove();$(".popover").not(".show").remove()};Helper.hideAllTooltips=function(){$(".tooltip:not(.helper_tooltip)").remove();$(".popover:not(.helper_tooltip)").remove()};Helper.parseDirectionForRender=function(a){return a.replace(/\n/g,"<br \\>")};Helper.addDays=function(a,b){var c=new Date(a.valueOf());c.setDate(c.getDate()+b);return c};
Helper.shouldShowCollections=function(){return moment(ETM.current_user_profile.attributes.date_joined).isBefore(moment().add(-1,"days"))};Helper.getExistingFoodInfoIds=function(){var a=[];ETM.food_info_object_list.each(function(b){a.push(parseInt(parseIdFromResourceURI(b.attributes.id)))});return a};Helper.parseSecretUrlFromResourceUri=function(a){return a.split("/").slice(-2)[0]};
Helper.mealPoolsAreEnabled=function(){try{var a=amplitude.getInstance().options.deviceId;if(0<="01234567".split("").indexOf(a[0]))return amplitude.getInstance().setUserProperties({meal_pool_logged_out:!0}),!0;amplitude.getInstance().setUserProperties({meal_pool_logged_out:!1});return!1}catch(b){return!1}};Helper.getNumKeys=function(a){var b=[],c;for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&b.push(c);return b.length};
Helper.stripIdsFromPlanJson=function(a){_.each(a,function(a){_.each(a,function(a){delete a.date;delete a.user;delete a.diet.nutrition_profile;delete a.diet.nutrition_profile_id;_.each(a.diet.meals,function(a,b){delete a.meal_type;delete a.meal_type_id;delete a.eaten;a.meal_number=b})})})};Helper.truncateString=function(a,b){return a.length>b?a.substr(0,b-1)+"&hellip;":a};Helper.getLoadingSpinnerHTML=function(){return'<div class="browser_spinner">\n        <svg class="etm-icon etm-icon-md">\n            <use xlink:href="#hungry-puck-loader"></use>\n        </svg>\n        Loading \u2022 \u2022 \u2022\n    </div>'};
Helper.getWeekday=function(a){-1===a&&(a=6);return ETM.JS_DAY_LIST[a]};Helper.getTemplateWeekday=function(a){-1===a&&(a=6);return ETM.PYTHON_DAY_LIST[a]};Helper.toast=function(a,b,c){var d=Backbone.Flash.config.stayDuration;Backbone.Flash.config.stayDuration=c;Backbone.trigger("flash",{message:a,type:b});Backbone.Flash.config.stayDuration=d};Helper.successToast=function(a,b){Helper.toast(a,"success",b)};Helper.errorToast=function(a,b){Helper.toast(a,"danger",b)};
Helper.warnToast=function(a,b){Helper.toast(a,"warning",b)};Helper.multiToast=function(a,b,c){if(0<a.length&&(Helper.toast(a[0],b,c),1<a.length))var d=1,e=a.length,f=setInterval(function(){Helper.toast(a[d],b,c);d++;d==e&&clearInterval(f)},c+200)};ETM.finish_profile_completeness_key=function(a){if(ETM.is_logged_in&&"undefined"!=typeof ETM.current_profile_completeness&&!1===ETM.current_profile_completeness.attributes[a]){var b={};b[a]=!0;ETM.current_profile_completeness.save(b,{patch:!0})}};
Helper.lazyLoadYoutubeIframes=function(){window.setTimeout(function(){var a=document.querySelectorAll(".lazy-youtube");if(null!==a)for(var b=0;b<a.length;b++)a[b].src=a[b].getAttribute("data-src")},2E3)};
ETM.writeContentToDocument=function(a,b,c){var d;d="toolbar=yes,location=no,directories=yes,menubar=yes,scrollbars=yes,width=800, height=800, left=50, top=25,_blank";"Microsoft Internet Explorer"!=navigator.appName&&(d="");d=window.open("","",d);try{return d.document.open(),d.document.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'),d.document.write("<head><title>"+b+"</title>"),c?d.document.write('</head><body style="padding:0;margin-top:0 !important;margin-bottom:0!important;"   onLoad="self.print();">'):
d.document.write('</head><body style="padding:0;margin-top:0 !important;margin-bottom:0!important;">'),d.document.write(a),d.document.write("</body></html>"),d.document.close(),d.focus(),!0}catch(e){return!1}};ETM.getFilenameFromHeader=function(a,b){var c=b?b:"downloaded_plan.pdf",d=a.getResponseHeader("Content-Disposition");d&&-1!==d.indexOf("attachment")&&(d=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(d),null!=d&&d[1]&&(c=d[1].replace(/['"]/g,"")));return c};
ETM.getGinLogging=function(){$.ajax({type:"GET",url:"/g/admin/get-logging/",success:function(a){console.log(a)}})};ETM.resetGinLogging=function(){$.ajax({type:"GET",url:"/g/admin/reset-logging/"})};ETM.enableGinLogger=function(a){var b={debug_log_level:"debug",release_log_level:"debug"};b[a]=!0;$.ajax({type:"POST",url:"/g/admin/change-logging/",contentType:"json",data:JSON.stringify(b),success:function(a){console.log("success")},error:function(a){console.log(a)}})};
function getMicroHTML(a){html_output="";for(var b=0;b<ETM.MICRONUTRIENT_DISPLAY_ORDER.length;b++){var c=ETM.MICRONUTRIENT_DISPLAY_ORDER[b];if("more_nutrients_header"==c)html_output+="<div class='micro_details_header'>Detailed Nutrition Info:</div>";else if("sugars_header"==c)html_output+="<div class='micro_details_header'>Sugars</div>";else if("fats_header"==c)html_output+="<div class='micro_details_header'>Fats</div>";else if("fatty_acids_header"==c)html_output+="<div class='micro_details_header'>Fatty Acids</div>";
else if("vitamins_and_minerals_header"==c)html_output+="<div class='micro_details_header'>Vitamins and Minerals</div>";else if("amino_acids_header"==c)html_output+="<div class='micro_details_header'>Amino Acids</div>";else{var d=ETM.NUTRIENT_DICTIONARY[c].daily_value,d=null==d||0==d?"N/A":Math.ceil(100*(a[c]/d))+"%";html_output=html_output+"<strong>"+ETM.NUTRIENT_DICTIONARY[c].display_name+"</strong>: "+Math.round(a[c]*Math.pow(10,1))/Math.pow(10,1)+""+ETM.NUTRIENT_DICTIONARY[c].units+"<div class='perc_daily_val'>"+
d+"</div><br />"}}return html_output}ETM.RegenerateMessage={};ETM.RegenerateMessage.Timeout=function(){Backbone.trigger("flash",{message:"The regenerate request timed out.  This may be due to heavy load or a technical issue.  We've been notified and will look into it!  Please wait and try again.",type:"danger"})};ETM.RegenerateMessage.Error=function(){Backbone.trigger("flash",{message:"There was an error regenerating.  We've been notified and will look into it!",type:"danger"})};
ETM.RegenerateMessage.NoFoods=function(){Backbone.trigger("flash",{message:"We were unable to find other potential foods.  Please try loosening some of your restrictions or try refreshing the meal/day.",type:"danger"})};
ETM.openWeeklyLayoutModal=function(){ETM.weekly_layout_modal||(ETM.weekly_layout_modal=new ETM.WeeklySettingsModalView({collection:ETM.template_diet_list}),ETM.weekly_layout_modal.getModalElement().html(ETM.weekly_layout_modal.render().el));ETM.weekly_layout_modal.$el.modal("show");return ETM.weekly_layout_modal};
ETM.renderWeightModal=function(){ETM.weight_modal||app||(ETM.weight_modal=new ETM.WeightModalView,ETM.weight_modal.rendered=!1);ETM.weight_modal.rendered||(ETM.weight_modal.getModalElement().html(ETM.weight_modal.render().el),ETM.weight_modal.delegateEvents(),ETM.weight_modal.rendered=!0)};
ETM.openSuggestedTargetsModal=function(){ETM.suggested_targets_modal||app||(ETM.suggested_targets_modal=new ETM.SuggestedTargetsModal,ETM.suggested_targets_modal.getModalElement().html(ETM.suggested_targets_modal.render().el),ETM.suggested_targets_modal.delegateEvents());ETM.suggested_targets_modal.$el.modal("show");ETM.suggested_targets_modal.renderForm()};ETM.router_view_functions.accountView=function(){ETM.router_functions.standardNavigationView(".user-profile","account_view",function(){return new ETM.AccountView({model:ETM.current_user_profile})})};
ETM.router_view_functions.accountInfoView=function(){ETM.router_functions.standardNavigationView(".user-profile","account_info_view",function(){return new ETM.AccountInfoView({model:ETM.current_user_profile})})};ETM.router_view_functions.profileCompletenessView=function(){ETM.router_functions.standardNavigationView(".user-profile","profile_completeness_view",function(){return new ETM.ProfileCompletenessView({model:ETM.current_profile_completeness})})};
ETM.router_view_functions.editUserProfileView=function(){ETM.router_functions.standardNavigationView(".user-profile","edit_user_profile_view",function(){user_profile_view_options={shopping_day_enabled:!0,autosave:!0,display_weight_goal:!0};return new ETM.UserProfileView({model:ETM.current_user_profile},this.user_profile_view_options)})};ETM.router_view_functions.affiliateStatsView=function(){ETM.router_functions.standardNavigationView(".user-profile","affiliate_view",function(){return new ETM.AffiliateView({model:ETM.current_user_profile})})};
ETM.router_view_functions.accountManagementEditPlansView=function(){ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".manage_client_plans_nav");ETM.router_functions.loadManagerData(function(){ETM.account_management_manage_clients_view||(ETM.account_management_manage_clients_view=new ETM.AccountManagementManageClientsView);ETM.router_functions.updateCurrentView(ETM.account_management_manage_clients_view);ETM.$content.html(ETM.account_management_manage_clients_view.render().el);
ETM.account_management_manage_clients_view.delegateEvents()})})};
ETM.router_view_functions.accountManagementEmailPlansView=function(){ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".manage_email_plans_nav");ETM.router_functions.loadManagerData(function(){ETM.account_management_email_plans_view||(ETM.account_management_email_plans_view=new ETM.AccountManagementEmailPlansView);ETM.router_functions.updateCurrentView(ETM.account_management_email_plans_view);ETM.$content.html(ETM.account_management_email_plans_view.render().el);ETM.account_management_email_plans_view.delegateEvents()})})};
ETM.router_view_functions.accountManagementCreatePdfsView=function(){ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".manage_create_pdfs_nav");ETM.router_functions.loadManagerData(function(){ETM.account_management_create_pdfs_view||(ETM.account_management_create_pdfs_view=new ETM.AccountManagementCreatePdfsView);ETM.router_functions.updateCurrentView(ETM.account_management_create_pdfs_view);ETM.$content.html(ETM.account_management_create_pdfs_view.render().el);
ETM.account_management_create_pdfs_view.delegateEvents()})})};
ETM.router_view_functions.accountManagementAccountsView=function(){ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".manage_accounts_nav");ETM.router_functions.loadManagerData(function(){ETM.account_management_accounts_view||(ETM.account_management_accounts_view=new ETM.AccountManagementAccountsView);ETM.router_functions.updateCurrentView(ETM.account_management_accounts_view);ETM.$content.html(ETM.account_management_accounts_view.render().el);ETM.account_management_accounts_view.delegateEvents()})})};
ETM.router_view_functions.accountManagementSavedPlansView=function(){ETM.router_functions.redirectLoggedOutUsers();ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".manage_saved_plans_nav");ETM.router_functions.loadManagerData(function(){ETM.saved_plans_view||(ETM.saved_plans_view=new ETM.SavedPlansView({model:ETM.current_user_profile,manager_saved_plans:!0}));ETM.router_functions.updateCurrentView(ETM.saved_plans_view);ETM.$content.html('<div class="main_column container-fluid"></div>');
$(".main_column",ETM.$content).html(ETM.saved_plans_view.render().el);ETM.saved_plans_view.delegateEvents()})})};
ETM.router_view_functions.accountManagementProfileView=function(){ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".manage_profile");ETM.router_functions.loadManagerData(function(){ETM.account_management_profile_view||(ETM.account_management_profile_view=new ETM.AccountManagementProfileView);ETM.router_functions.updateCurrentView(ETM.account_management_profile_view);ETM.$content.html(ETM.account_management_profile_view.render().el);ETM.account_management_profile_view.delegateEvents()})})};
ETM.router_view_functions.accountManagementV2ManageClientsView=function(a){a=ETM.router.search_name;delete ETM.router.search_name;ETM.router_functions.redirectLoggedOutUsers();ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".manage_accounts_v2_nav");ETM.router_functions.loadManagerData(function(){ETM.manage_clients_v2_view||(ETM.manage_clients_v2_view=new ETM.AccountManagementV2ManageAccountsView);ETM.router_functions.updateCurrentView(ETM.manage_clients_v2_view);
ETM.$content.html(ETM.manage_clients_v2_view.render(a).el);ETM.manage_clients_v2_view.delegateEvents();if("undefined"!=typeof ETM.show_manager_updates_welcome&&ETM.show_manager_updates_welcome){ETM.show_manager_updates_welcome=!1;var b=new ETM.ManagerV2UpdatesWelcomeModal;b.getModalElement().html(b.render().el);b.$el.modal({backdrop:"static",show:!0})}})})};
ETM.router_view_functions.accountManagementV2MealPlansView=function(){var a=ETM.router.search_name;delete ETM.router.search_name;ETM.router_functions.redirectLoggedOutUsers();ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".meal_plans_v2_nav");ETM.router_functions.loadManagerData(function(){ETM.meal_plans_v2_view||(ETM.meal_plans_v2_view=new ETM.AccountManagementV2MealPlansView);ETM.router_functions.updateCurrentView(ETM.meal_plans_v2_view);ETM.$content.html(ETM.meal_plans_v2_view.render(a).el);
ETM.meal_plans_v2_view.delegateEvents()})})};
ETM.router_view_functions.applyTargetsOrPlanToClient=function(){ETM.router_functions.redirectLoggedOutUsers();ETM.router_functions.loadUserDataV3(function(){function a(){ETM.apply_targets_or_plan_view||(ETM.apply_targets_or_plan_view=new ETM.ApplyTargetsOrPlanView(b));ETM.router_functions.updateCurrentView(ETM.apply_targets_or_plan_view);ETM.$content.html(ETM.apply_targets_or_plan_view.render().el);ETM.apply_targets_or_plan_view.delegateEvents()}var b={};if("undefined"!==typeof preset_user_settings&&
preset_user_settings&&(b.preset_user_settings=preset_user_settings,preset_user_settings.meal_plan_id)){var c=parseInt(preset_user_settings.meal_plan_id.toString().slice(3));ETM.load_affiliate_diet_set=new ETM.BasicDietPlanSet({id:c});ETM.load_affiliate_diet_set.urlRoot=ROOT+"/publicbasicdietset/"}ETM.load_affiliate_diet_set?ETM.load_affiliate_diet_set.fetch({silent:!0,success:function(){a()}}):a()})};ETM.router_view_functions.appView=function(){};
ETM.router_view_functions.browseCollectionsView=function(){ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".collections_nav, .foods_tab_nav");ETM.browse_collections_model||(ETM.browse_collections_model=new ETM.BrowseCollectionsModel);ETM.browse_collections_view||(ETM.browse_collections_view=new ETM.BrowseCollectionsView({model:ETM.browse_collections_model}));ETM.router_functions.updateCurrentView(ETM.browse_collections_view);ETM.$content.html(ETM.browse_collections_view.render().el);
ETM.local_variables.save({seen_collections_info:!0})})};
ETM.router_view_functions.singleCollectionView=function(a){ETM.router_functions.loadUserDataV3(function(){ETM.is_logged_in?ETM.logged_in_nav_view.selectMenuItem(".collections_nav, .foods_tab_nav"):(ETM.logged_out_collection_header||(ETM.logged_out_collection_header=new ETM.FoodCollectionLoggedOutHeader({secret_url:a})),ETM.$content.html(ETM.logged_out_collection_header.render().el));ETM.single_collection_model=new ETM.FoodCollection({secret_url:a});ETM.single_collection_model.fetch({error:function(a,
c,d){404===c.status?ETM.$content.append(ETM.loadTemplate("#CollectionNotFound")):ETM.$content.append(ETM.loadTemplate("#CollectionError"))}}).done(function(){ETM.single_collection_view?(ETM.single_collection_view.model=ETM.single_collection_model,ETM.single_collection_view.initializeFollowing()):ETM.single_collection_view=new ETM.FoodCollectionView({model:ETM.single_collection_model});ETM.router_functions.updateCurrentView(ETM.single_collection_view);ETM.$content.html(ETM.single_collection_view.render().el);
ETM.single_collection_view.delegateEvents()})})};
ETM.router_view_functions.calendarView=function(a,b){ETM.diet_plan_set=null;var c=b;c&&ETM.is_premium&&ETM.MealPlanViewState.setState(ETM.MULTI_DAY_VIEW_LABEL,!0);ETM.router_functions.loadUserDataV3(function(){ETM.is_premium||ETM.current_user_profile.attributes.welcome_complete||!moment(ETM.current_user_profile.attributes.date_joined).isAfter(moment().subtract(2,"days"))||(c=!0);Helper.lockPageHeight();var b=new Date,e=!1;UrlFunctions.getUrlParameter("date")&&-1!=Backbone.history.fragment.indexOf("date")&&
(b=Helper.parseDateString(UrlFunctions.getUrlParameter("date")),e=!0);ETM.calendar_list?e&&(ETM.calendar_list.selected_date=b):ETM.calendar_list=new ETM.CalendarDietList([],{selected_date:b});ETM.logged_in_nav_view.selectMenuItem(".diet_planner_nav, .manager_planner_dropdown");ETM.calendar_view?(ETM.calendar_view.collection=ETM.calendar_list,ETM.calendar_view.current_plan=b,ETM.MealPlanViewState.isWeekView()&&(a?ETM.calendar_view.loadDateRange(a):e?ETM.calendar_view.setDefaultDateRange(b):ETM.calendar_view.setDefaultDateRange())):
ETM.MealPlanViewState.isWeekView()?ETM.calendar_view=new ETM.MealPlanWeekView({collection:ETM.calendar_list,meal_plan_source:"calendar",daterange:a,current_plan:b}):ETM.calendar_view=new ETM.MealPlanCarousel({collection:ETM.calendar_list,meal_plan_source:"calendar",current_plan:b});ETM.calendar_list.view=ETM.calendar_view;ETM.router_functions.updateCurrentView(ETM.calendar_view);ETM.$content.html(ETM.calendar_view.render().el);ETM.calendar_view.delegateEvents();b=!1;"undefined"!=typeof ETM.show_managed_account_welcome&&
ETM.show_managed_account_welcome?(ETM.show_managed_account_welcome=!1,b=new ETM.ManagedAccountPremiumWelcomeModal):"undefined"!=typeof ETM.show_manager_account_welcome&&ETM.show_manager_account_welcome?(ETM.show_manager_account_welcome=!1,dataLayer.push({event:"pro_signup"}),b=new ETM.ManagerAccountPremiumWelcomeModal):null!=c&&c&&(ETM.is_premium?("undefined"!==typeof dataLayer&&dataLayer.push({event:"premium_signup"}),b=new ETM.PremiumWelcomeModal):b=new ETM.FreeWelcomeModal);b&&(b.getModalElement().html(b.render().el),
b.$el.modal({backdrop:"static",show:!0}));Helper.unlockPageHeight()})};ETM.router_view_functions.singleDietView=function(a){ETM.logged_out_day_view||(ETM.logged_out_day_view=new ETM.LoggedOutDayView({model:ETM.current_diet},{hide_prompts:a}));ETM.router_functions.updateCurrentView(ETM.logged_out_day_view);return ETM.logged_out_day_view};
ETM.router_view_functions.dietView=function(a){ETM.router_functions.loadUserDataV3(function(){ETM.router_functions.loadPublicDiet(a,function(){var a=ETM.router_view_functions.singleDietView(!0);a.single_plan_view=new ETM.ReadOnlySinglePlanView({model:ETM.current_diet});ETM.$content.html(a.render(!0).el);a.delegateEvents();a.single_plan_view.printGraph();ETM.logged_in_free_day_view=null;ETM.logged_out_day_view=null})})};
ETM.renderDietSet=function(){ETM.diet_plan_set_view?(ETM.diet_plan_set_view.model=ETM.diet_plan_set,ETM.diet_plan_set_view.checkIfUserIsOwner()):ETM.MealPlanViewState.isWeekView()?ETM.diet_plan_set_view=new ETM.MealPlanWeekView({model:ETM.diet_plan_set,meal_plan_source:"diet_set"}):ETM.diet_plan_set_view=new ETM.MealPlanCarousel({model:ETM.diet_plan_set,meal_plan_source:"diet_set"});ETM.diet_plan_set.view=ETM.diet_plan_set_view;ETM.email_plan_set_modal&&(ETM.email_plan_set_modal.diet_set_id=ETM.diet_plan_set.attributes.id);
ETM.logged_in_nav_view&&ETM.logged_in_nav_view.selectMenuItem();ETM.router_functions.updateCurrentView(ETM.diet_plan_set_view);ETM.$content.html(ETM.diet_plan_set_view.render().el);ETM.diet_plan_set_view.delegateEvents();Helper.unlockPageHeight()};ETM.updateAndRenderDietSet=function(a){null!=ETM.diet_plan_set?(_.each(a,function(a,c){ETM.diet_plan_set.attributes.diets.at(c).set(a)}),ETM.renderDietSet()):bugsnagClient.notify(Error("attempting to update diet set when ETM.diet_plan_set doesn't exist"))};
ETM.fetchAndRenderDietSet=function(a,b){ETM.diet_plan_set&&ETM.diet_plan_set.attributes.id==a.slice(3)?ETM.renderDietSet():ETM.is_logged_in?$.get("/weeklyplanner/check-owner/",{is_diet_set:!0,diet_id:a},function(c){c=JSON.parse(c);var d=ROOT+"/publicdietset/"+a+"/",e=null;c.is_owners_manager?(d=ROOT+"/managerdietset/"+a+"/",e=new ETM.ManagedAccount({id:c.managed_account_id})):c.is_owner&&(d=ROOT+"/fulldietset/"+a+"/");ETM.diet_plan_set=new ETM.DietPlanSet({id:a});c=[ETM.diet_plan_set.fetch({url:d})];
e&&c.push(e.fetch());$.when.apply($,c).done(function(){ETM.diet_plan_set.managed_account=e;ETM.diet_plan_set.attributes.diets.forEach(function(a){ETM.client_nutrition_profile_list.add(a.attributes.nutrition_profile);a.attributes.meals.forEach(function(a){ETM.client_meal_type_list.add(a.attributes.meal_type)})});ETM.renderDietSet();"undefined"!==typeof b&&b()})}).fail(function(){ETM.$content.html("<div class='text-center big_top_margin big_bottom_spacer'><button class='btn btn-secondary' onclick='ETM.router.navigate(\"\", {trigger: true});'><i class='fa fa-arrow-left'></i> Back to the Planner</button><h1>Saved plan not found :(</h1></div>")}):
(diet_url=ROOT+"/publicdietset/"+a+"/",ETM.diet_plan_set=new ETM.DietPlanSet({id:a}),ETM.diet_plan_set.remote=!0,$.when(ETM.diet_plan_set.fetch({url:diet_url})).done(function(){ETM.renderDietSet()}))};
ETM.router_view_functions.dietSetView=function(a){$("#main_container").html(Helper.getLoadingSpinnerHTML());ETM.router_functions.loadUserDataV3(function(){Helper.lockPageHeight();ETM.current_user_profile.hasManagerV2Subscription()?ETM.router_functions.loadManagerData(function(){ETM.fetchAndRenderDietSet(a)}):ETM.fetchAndRenderDietSet(a)})};
ETM.router_view_functions.foodBrowserView=function(){ETM.router_functions.redirectLoggedOutUsers();ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".browse_foods_nav, .manager_planner_dropdown");ETM.food_browser_model=new ETM.FoodBrowserModel;ETM.food_browser_view=new ETM.FoodBrowserViewV3({model:ETM.food_browser_model});ETM.food_browser_view.render();ETM.router_functions.updateCurrentView(ETM.food_browser_view);ETM.$content.html(ETM.food_browser_view.el)})};
ETM.router_view_functions.groceryListView=function(){ETM.router_functions.redirectLoggedOutUsers();ETM.router_functions.loadUserDataV3(function(){ETM.logged_in_nav_view.selectMenuItem(".pantry_grocery_nav, .manager_planner_dropdown");ETM.is_premium?(ETM.grocery_pantry_view||(ETM.grocery_pantry_view=new ETM.GroceryAndPantryView({model:ETM.groceries_and_pantry})),ETM.grocery_pantry_view.render(),ETM.router_functions.updateCurrentView(ETM.grocery_pantry_view),ETM.$content.html(ETM.grocery_pantry_view.el),
ETM.grocery_pantry_view.delegateEvents(),ETM.grocery_pantry_view.initializeEvents(),ETM.grocery_pantry_view.pantry_up_to_date=!1,ETM.grocery_pantry_view.loadAndRenderGroceryFoods()):(ETM.grocery_pantry_teaser_view||(ETM.grocery_pantry_teaser_view=new ETM.GroceryAndPantryTeaserView),ETM.router_functions.updateCurrentView(ETM.grocery_pantry_teaser_view),ETM.$content.html(ETM.grocery_pantry_teaser_view.render().el),ETM.grocery_pantry_teaser_view.delegateEvents())})};
ETM.router_view_functions.helpPageView=function(){ETM.router_functions.standardNavigationView(".help_page","help_page",function(){return new ETM.HelpPageView})};ETM.router_view_functions.inviteFriendsView=function(){ETM.router_functions.standardNavigationView(".invite-friends","invite_friends",function(){return new ETM.InviteFriendsView})};
ETM.router_view_functions.focusCalorieInput=function(){if(UrlFunctions.getUrlParameter("generate")){var a=$("input[id=cal_input]");a.val(parseInt(UrlFunctions.getUrlParameter("cals")));a.trigger("change");UrlFunctions.getUrlParameter("diet_type")&&(a=decodeURI(UrlFunctions.getUrlParameter("diet_type")),$("ul.preset_selector a").removeClass("active"),$("ul.preset_selector").find("[data-value='"+a+"'] a").addClass("active"));UrlFunctions.getUrlParameter("nummeals")&&$("#num_meals_selector").val(UrlFunctions.getUrlParameter("nummeals"));
if(2==UrlFunctions.getUrlParameter("generate"))ETM.logged_out_day_view.autoStartGenerator();else if(ETM.is_mobile)Helper.oneTimeTooltip($(".generator_header_div"),"top","Enter your desired calories and diet type, then hit Generate!",1E4);else if(0===ETM.logged_out_day_view.single_plan_view.plan_stats_view.model.stats.calories)Helper.oneTimeTooltip($(".gen_button"),"top","Click to run the generator",5E3);else Helper.oneTimeTooltip($(".gen_button"),"top","Click here to re-run the generator",4E3)}else ETM.is_mobile||
$("#cal_input").focus()};ETM.router_view_functions.mainViewNoDate=function(){ETM.router_view_functions.mainView()};ETM.router_view_functions.mainViewWithDaterange=function(a,b){ETM.router_view_functions.mainView(a,b)};
ETM.router_view_functions.mainView=function(a,b){ETM.is_logged_in?ETM.router_view_functions.calendarView(a):ETM.router_functions.loadUserDataV3(function(){var a=ETM.router_view_functions.singleDietView(!1);ETM.$content.html(a.render(!0).el);a.delegateEvents();a.single_plan_view.printGraph();ETM.router_view_functions.focusCalorieInput()})};
ETM.router_view_functions.handleSpecialPremadeDiets=function(a,b){var c=ETM.current_diet.attributes.nutrition_profile;if(a)if(c.attributes.calories=a,c.scaleMacrosFromCalories(a,0),b===ETM.LOW_FAT_PRESET_KEY)c.attributes.max_fats=roundNumber(0.3*a/9,0),c.attributes.min_fats=0;else if(b===ETM.LOW_CARB_PRESET_KEY)c.attributes.max_carbs=roundNumber(0.3*a/4,0),c.attributes.min_carbs=0;else if(b===ETM.HIGH_PROTEIN_PRESET_KEY){var d=roundNumber(0.3*a/4,0);c.attributes.min_proteins=d;c.attributes.max_proteins=
2*d}else b===ETM.GLUTEN_FREE_PRESET_KEY&&(ETM.current_user_profile.attributes.exclusions='[{"value":"gluten","label":"Gluten"}]')};
ETM.router_view_functions.premadeMainView=function(a,b){var c=parseInt(a.split("-")[0]);isNaN(c)&&!b&&_.contains(ETM.POSSIBLE_URL_DIET_TYPES,a)&&(b=a,c=!1);null!=ETM.PRESET_DIET_SYNONYMS[b]&&(b=ETM.PRESET_DIET_SYNONYMS[b]);ETM.is_logged_in?ETM.router_view_functions.calendarView():ETM.router_functions.loadUserDataV3(function(){ETM.router_view_functions.handleSpecialPremadeDiets(c,b);ETM.logged_out_day_view||(ETM.logged_out_day_view=new ETM.LoggedOutDayView({model:ETM.current_diet},{hide_prompts:!1,
calories:c,diet_type:b,load_premade_diet:!0}));ETM.router_functions.updateCurrentView(ETM.logged_out_day_view);ETM.$content.html(ETM.logged_out_day_view.render(!0).el);ETM.logged_out_day_view.delegateEvents();ETM.logged_out_day_view.single_plan_view.printGraph();ETM.is_mobile||$("#cal_input").focus()})};
ETM.router_view_functions.recurringFoodView=function(){ETM.router_functions.redirectLoggedOutUsers();ETM.router_functions.loadUserDataV3(function(){Helper.lockPageHeight();ETM.logged_in_nav_view.selectMenuItem(".recurring_foods_nav, .manager_planner_dropdown");ETM.recurring_food_view||(ETM.recurring_food_view=new ETM.RecurringFoodSettingsView);ETM.router_functions.updateCurrentView(ETM.recurring_food_view);ETM.$content.html(ETM.recurring_food_view.render().el);ETM.recurring_food_view.delegateEvents();
Helper.unlockPageHeight()})};
ETM.router_view_functions.resultsView=function(){ETM.router_functions.redirectLoggedOutUsers();ETM.router_functions.loadUserDataV3(function(){ETM.results_view?ETM.results_view.formatCalendarData():ETM.results_view=new ETM.ResultsView({user_profile:ETM.current_user_profile,calendar_list:ETM.calendar_list,show_container:!0,client_user_id:null});$(".main_site_nav button").removeClass("active");ETM.router_functions.updateCurrentView(ETM.results_view);ETM.$content.html(ETM.results_view.render().el);app&&
$(".update_weight_button").hide();ETM.results_view.drawGraphs();ETM.results_view.delegateEvents()})};ETM.router_view_functions.preferencesView=function(a){ETM.router_functions.standardNavigationView(".preferences_nav","settings_view_"+a,function(){return new ETM.PreferencesView({section:a})})};
ETM.router_view_functions.freeSignupView=function(){ETM.user_profiles_list.fetch({async:!1});ETM.router_functions.setupUserProfile();ETM.router_functions.loadUserDataV3(function(){var a={};"undefined"!==typeof preset_user_settings&&preset_user_settings&&(a.preset_user_settings=preset_user_settings);ETM.free_signup_view=new ETM.FreeSignupView(a);ETM.free_signup_view.render();ETM.router_functions.updateCurrentView(ETM.free_signup_view)})};
ETM.router_view_functions.premiumSignupView=function(){ETM.router_functions.loadUserDataV3(function(){7!==ETM.template_diet_list.length?Helper.createTemplatesOnServer(function(){ETM.premium_signup_view=new ETM.PremiumSignupView;ETM.premium_signup_view.render();ETM.router_functions.updateCurrentView(ETM.premium_signup_view)}):(ETM.premium_signup_view=new ETM.PremiumSignupView,ETM.premium_signup_view.render(),ETM.router_functions.updateCurrentView(ETM.premium_signup_view))})};
ETM.router_view_functions.welcomeView=function(a){ETM.is_logged_in?(ETM.router.navigate("",{replace:!0}),ETM.router_view_functions.calendarView(a,!0)):ETM.router.navigate("",{trigger:!0})};ETM.router_view_functions.managedWelcomeView=function(a){ETM.show_managed_account_welcome=!0;ETM.router_view_functions.welcomeView(a)};ETM.router_view_functions.managerWelcomeView=function(a){ETM.show_manager_account_welcome=!0;ETM.router_view_functions.welcomeView(a)};
ETM.router_view_functions.managerUpdatesWelcomeView=function(a){ETM.show_manager_updates_welcome=!0;ETM.router.navigate("/account-management/manage-clients-v2/",{trigger:!0})};
ETM.Router=Backbone.Router.extend({routes:{"":ETM.router_view_functions.mainViewNoDate,"_=_":ETM.router_view_functions.mainViewNoDate,"#_=_":ETM.router_view_functions.mainViewNoDate,"v2/":ETM.router_view_functions.mainViewNoDate,"?date=:date":ETM.router_view_functions.mainViewNoDate,"dates/:daterange/?date=:date":ETM.router_view_functions.mainViewWithDaterange,"dates/":ETM.router_view_functions.mainViewNoDate,"dates(/:daterange)(/)":ETM.router_view_functions.mainViewWithDaterange,"diet-plan/:calories/:diet_type(/)":ETM.router_view_functions.premadeMainView,
"diet-plan/:calories(/)":ETM.router_view_functions.premadeMainView,"welcome/":ETM.router_view_functions.welcomeView,"managed-welcome/":ETM.router_view_functions.managedWelcomeView,"manager-welcome/":ETM.router_view_functions.managerWelcomeView,"new-pro-interface-welcome/":ETM.router_view_functions.managerUpdatesWelcomeView,"app/":ETM.router_view_functions.appView,"account-management/accounts/":ETM.router_view_functions.accountManagementAccountsView,"account-management/profile/":ETM.router_view_functions.accountManagementProfileView,
"account-management/edit-plans/":ETM.router_view_functions.accountManagementEditPlansView,"account-management/email-plans/":ETM.router_view_functions.accountManagementEmailPlansView,"account-management/create-pdfs/":ETM.router_view_functions.accountManagementCreatePdfsView,"account-management/saved-plans/":ETM.router_view_functions.accountManagementSavedPlansView,"account-management/manage-clients-v2/":ETM.router_view_functions.accountManagementV2ManageClientsView,"account-management/meal-plans-v2/":ETM.router_view_functions.accountManagementV2MealPlansView,
"account-management/apply-targets-or-plan/":ETM.router_view_functions.applyTargetsOrPlanToClient,"groceries/":ETM.router_view_functions.groceryListView,"recurring-foods/":ETM.router_view_functions.recurringFoodView,"diet/:id":ETM.router_view_functions.dietView,"diet/:id/":ETM.router_view_functions.dietView,"dietset/:id/":ETM.router_view_functions.dietSetView,"food-browser/":ETM.router_view_functions.foodBrowserView,"collections/":ETM.router_view_functions.browseCollectionsView,"collections/:id/":ETM.router_view_functions.singleCollectionView,
"create-free-profile/":ETM.router_view_functions.freeSignupView,"create-free-and-premium-profile/":ETM.router_view_functions.freeSignupView,"create-premium-profile/":ETM.router_view_functions.premiumSignupView,"results/":ETM.router_view_functions.resultsView,"results_app/":ETM.router_view_functions.resultsView,"account/":ETM.router_view_functions.accountView,"account/membership/":ETM.router_view_functions.accountInfoView,"account/profile-completeness/":ETM.router_view_functions.profileCompletenessView,
"account/edit-profile/":ETM.router_view_functions.editUserProfileView,"account/affiliate/":ETM.router_view_functions.affiliateStatsView,"preferences/":ETM.router_view_functions.preferencesView,"preferences(/:section)(/)":ETM.router_view_functions.preferencesView,"help/":ETM.router_view_functions.helpPageView,"invite-friends/":ETM.router_view_functions.inviteFriendsView},initialize:function(){ETM.$sidebar_nav=$("#sidebar_nav");ETM.$top_nav=$("#top_nav");ETM.$modal_content=$("#modals");ETM.$content=
$("#main_container");ETM.$fill_container=$("#fill_container");ETM.$sidebar_content=$("#sidebar_container");ETM.local_variables=new ETM.LocalVariables;ETM.local_variables.fetch();ETM.notifications=new ETM.NotificationViews({model:ETM.local_variables});ETM.food_info_object_list=new ETM.FoodInfoObjectList;ETM.food_object_modal=new ETM.FoodObjectModalView;ETM.generator_status=new ETM.GeneratorStatus;ETM.toast=new ETM.ToastNotifications;ETM.nutrition_profile_list=new ETM.NutritionProfileList;ETM.meal_type_list=
new ETM.MealTypeList;ETM.favorite_foods_list=new ETM.FavoriteFoodList;ETM.blocked_foods_list=new ETM.BlockedFoodList;ETM.recurring_foods_list=new ETM.GlobalRecurringFoodList;ETM.recurring_collections_list=new ETM.GlobalRecurringFoodCollectionList;ETM.user_profiles_list=new ETM.UserProfileList;ETM.profile_completeness_list=new ETM.ProfileCompletenessList;ETM.client_nutrition_profile_list=new ETM.NutritionProfileList;ETM.client_meal_type_list=new ETM.MealTypeList;ETM.saved_diet_list=new ETM.DietList;
ETM.diet_list=ETM.saved_diet_list;ETM.local_storage_diet_list=new ETM.LocalStorageDietList;ETM.diet_set_list=new ETM.BasicDietPlanSetList;ETM.client_diet_set_list=new ETM.UserSortedDietPlanSetList;ETM.full_diet_set_list=new ETM.UserSortedDietPlanSetList;ETM.template_diet_list=new ETM.TemplateDietList;ETM.manager_profile=new ETM.ManagerProfile;ETM.meal_rating_list=new ETM.MealRatingList;ETM.meal_tag_list=new ETM.MealTagList;ETM.food_rating_list=new ETM.FoodRatingList;this.listenTo(ETM.recurring_foods_list,
"change add remove",function(){ETM.reload_food_pool=!0});ETM.search_model=new ETM.SearchBar;ETM.ingredients_search_model=new ETM.IngredientsOnlySearchBar;ETM.is_premium&&(ETM.groceries_and_pantry=new ETM.GroceriesAndPantry)},navigate:function(a,b){ETM.router.trigger("willNavigate",a);Backbone.history.navigate(a,b);return this},navigateAndScroll:function(a,b){Helper.removeHiddenTooltips();ETM.router.navigate(a,b);$(window).scrollTop(0)},navigateAndScrollTo:function(a,b,c){Helper.removeHiddenTooltips();
ETM.router.navigate(a,c);$("html, body").animate({scrollTop:$(b).offset().top-20},300)}});ETM.HeaderView=Backbone.View.extend({events:{},initialize:function(){},render:function(){this.$el.html(this.template());return this},selectMenuItem:function(a){$("#profile_nav .nav li").removeClass("active");a&&$("."+a).addClass("active")}});
ETM.NotificationViews=Backbone.View.extend({events:{},initialize:function(){this.current_modal=null},initializeEvents:function(a){var b=this;this.current_modal.$el.one("hide.bs.modal",function(a){a=$("input#dont_show_me_again",b.current_modal.$el).is(":checked");b.current_modal.closingNotification(a)});this.current_modal.$el.one("hidden.bs.modal",function(c){b.current_modal.remove();a()})},showRefreshLeftoversInfo:function(a){app||this.model.attributes.seen_refresh_leftovers_info&&(!this.model.attributes.seen_refresh_leftovers_info||
this.model.attributes.dont_show_refresh_leftovers_info)?a():(this.current_modal=new ETM.RefreshLeftoversInfoModal({model:this.model}),this.current_modal.getModalElement().html(this.current_modal.render().el),this.current_modal.$el.modal("show"),this.initializeEvents(a))}});
ETM.RefreshLeftoversInfoModal=ModalView.extend({modal_id:"notifications_modal",events:{},initialize:function(a){this.dont_show_again=this.model.attributes.dont_show_refresh_leftovers_info;this.is_diet=a.is_diet},render:function(){this.$el.html(this.template({dont_show_again:this.dont_show_again,is_diet:this.is_diet}));this.$el.modal({show:!1});return this},closingNotification:function(a){this.model.attributes.seen_refresh_leftovers_info=!0;this.model.attributes.dont_show_refresh_leftovers_info=a;
this.model.save()}});
ETM.ToastNotifications=Backbone.View.extend({defaults:{closeButton:!0,debug:!1,newestOnTop:!1,progressBar:!1,positionClass:"toast-top-center",preventDuplicates:!1,showDuration:300,hideDuration:500,timeOut:5E3,extendedTimeOut:3E3,showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},showNotification:function(a){var b=a.extendedTimeout||this.defaults.extendedTimeout,c=a.message||"",d=a.type||"info",e=a.title||null,f=a.position||this.defaults.positionClass;toastr.options.timeOut=
a.timeout||this.defaults.timeOut;toastr.options.extendedTimeOut=b;toastr.options.positionClass=f;toastr[d](c,e);this.resetDefaults()},clear:function(){toastr.clear()},initialize:function(){this.resetDefaults()},resetDefaults:function(){toastr.options=this.defaults}});
ETM.RegenerateWeekModalView=ModalView.extend({modal_id:"regenerate_week_modal",events:{"click .submit_regenerate_week":"submitRegenerateWeek","click .interactive_submit_regenerate_week":"submitInteractiveRegenerateWeek","click .reset_weekly_planner":function(){this.render()},"change .generator_focus input":function(){ETM.current_user_profile.save({generator_focus:this.form.getValue().generator_focus},{patch:!0})},"change .shopping_day_row select":function(){ETM.current_user_profile.save({shopping_day:this.form.getValue().shopping_day},
{patch:!0})},"change #regenerate_weeks input":function(){this.renderDatePreview()}},initialize:function(){var a=this;this.form_template=ETM.loadNestedTemplate("#RegenerateWeekModalTemplates","#regenerateWeekForm");this.status_template=ETM.loadNestedTemplate("#RegenerateWeekModalTemplates","#regenerateStatusView");this.error_template=ETM.loadNestedTemplate("#RegenerateWeekModalTemplates","#regenerateErrorView");this.listenTo(ETM.generator_status,"weeklyProgressUpdated",function(b){"SUCCESS"===b?(is_debug&&
show_planner_log&&(window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.host),window.open(window.location.origin+"/view-planner-log/","_blank")),a.$el.modal("hide"),a.renderForm()):"ERROR"===b?a.renderErrorView():$(".progress_percent",this.el).html(ETM.generator_status.getCurrentProgress())});this.listenTo(ETM.current_user_profile,"change:shopping_day",function(){a.renderForm()})},render:function(){ETM.is_premium?(this.$el.html(this.template({})),this.renderForm(),
$(".last_updated_eaten_foods .explanation",this.el).popover({title:"<strong>Updating the pantry</strong>",content:"<p>To regenerate future meal plans, your pantry has to be up-to-date so that the generator knows what foods it can use up. We update the pantry for you automatically every time a weekly meal plan is generated by deducting the foods from your previous meal plans.</p><p>For this to be accurate, it trusts that your previous meal plans accurately reflect what you actually ate. So if you care about the pantry being accurate, make sure you remove any foods you didn't eat from the meal plans and add things you did.</p><p><strong>If you don't have anything in the pantry, don't worry.</strong> The generator will make sure your grocery list has everything you need.</p>",
trigger:"hover",placement:"right",html:!0})):this.$el.html(this.template({}));return this},checkPantryStatus:function(){ETM.current_user_profile.attributes.last_updated_eaten_foods!==moment().format("YYYY-MM-DD")?($(".update_pantry_text",this.el).html(pantryUpdateStringRegenerateWeekModal()),$(".last_updated_eaten_foods",this.el).show()):$(".last_updated_eaten_foods",this.el).hide()},renderForm:function(){var a=ETM.current_user_profile.attributes.shopping_day+1;7===a&&(a=0);for(var b,c=0,d=new Date;d.getDay()!=
a&&7>=c;d.setDate(d.getDate()+1))b=d,c++;var e,f,a=moment();e=moment(b);d=moment(e).add(1,"days");f=moment(e).add(7,"days");b=[a.format("YYYY-MM-DD"),e.format("YYYY-MM-DD")];c="Current week, "+a.format("MMM D")+" to "+e.format("MMM D");a=[d.format("YYYY-MM-DD"),f.format("YYYY-MM-DD")];d="Next week, "+d.format("MMM D")+" to "+f.format("MMM D");if(ETM.current_user_profile.hasManagerSubscription()){week_3_start=moment(e).add(8,"days");week_3_end=moment(e).add(14,"days");week_4_start=moment(e).add(15,
"days");week_4_end=moment(e).add(21,"days");e=[week_3_start.format("YYYY-MM-DD"),week_3_end.format("YYYY-MM-DD")];f="Third week, "+week_3_start.format("MMM D")+" to "+week_3_end.format("MMM D");var g=[week_4_start.format("YYYY-MM-DD"),week_4_end.format("YYYY-MM-DD")],h="Fourth week, "+week_4_start.format("MMM D")+" to "+week_4_end.format("MMM D");b=[{val:b,label:c},{val:a,label:d},{val:e,label:f},{val:g,label:h}]}else b=[{val:b,label:c},{val:a,label:d}];this.form&&this.form.close();this.form=(new Backbone.Form({schema:{regenerate_weeks:{type:"AnimatedCheckboxes",
options:b},shopping_day:{type:"Select",value_type:"Number",options:[{val:6,label:"Sunday"},{val:0,label:"Monday"},{val:1,label:"Tuesday"},{val:2,label:"Wednesday"},{val:3,label:"Thursday"},{val:4,label:"Friday"},{val:5,label:"Saturday"}]},reset_groceries:{type:"Checkbox"},send_email:{type:"Checkbox"},generator_focus:{type:"SegmentedRadio",value_type:"Number",options:[{val:0,label:"Balanced"},{val:1,label:"Variety"},{val:2,label:"Macros"},{val:3,label:"Groceries"}]}},data:{regenerate_weeks:[a],shopping_day:ETM.current_user_profile.attributes.shopping_day,
reset_groceries:!0,send_email:!1,generator_focus:ETM.current_user_profile.attributes.generator_focus},template:this.form_template})).render();$(".generator_focus_tooltip",this.form.el).popover({placement:"left",html:!0,trigger:"hover",content:ETM.current_user_profile.generator_focus_toolip_text()});$(".shopping_day_tooltip",this.form.el).popover({placement:"left",trigger:"hover",content:ETM.current_user_profile.regenerate_week_shopping_day_text(),html:!0});$("#modal_body_template",this.el).html(this.form.el);
this.renderDatePreview();$(".modal-footer",this.el).show()},renderDatePreview:function(){var a=this,b=this.form.getValue(),c=$(".date_preview",this.form.el);if(0===b.regenerate_weeks.length)c.html("<span class='text-danger'>No dates selected to regenerate</span>");else{var d="You are about to regenerate plans from:<br/><strong>",e=null,f=null,g=null;_.each(b.regenerate_weeks,function(b){b=b.split(",");e?moment(e[1]).add(1,"days").isSame(moment(b[0]))||(d+=a.getDayRangeString(f,g)+",<br/><span style='font-weight: normal;'>then</span> ",
f=b[0]):f=b[0];g=b[1];e=b});d+=this.getDayRangeString(f,g);d+="</strong>";c.html(d)}},getDayRangeString:function(a,b){return moment(a).isSame(moment(b),"day")?this.getDayString(a):this.getDayString(a)+" <span style='font-weight: normal;'>to</span> "+this.getDayString(b)},getDayString:function(a){return moment(a).isSame(moment(),"day")?"Today":moment(a).isBefore(moment().add(7,"days"),"day")?moment(a).format("dddd")+", "+moment(a).format("MMM D"):moment(a).isBetween(moment().add(7,"days"),moment().add(14,
"days"),"day","[)")?"Next "+moment(a).format("dddd")+", "+moment(a).format("MMM D"):moment(a).format("MMM D")},renderErrorView:function(){$("#modal_body_template",this.el).html(this.error_template)},renderLoadingInfo:function(){$(".regenerate_info",this.el).hide();$("#regenerate_week_form",this.el).hide();$(".modal-footer",this.el).hide();$("#modal_body_template",this.el).html(this.status_template)},validateRegenerateWeek:function(){$(".regenerate_week_validation_error",this.el).remove();var a=!1;
if(0===this.form.getValue().regenerate_weeks.length)return $('[data-editors="regenerate_weeks"]').append('<div class="alert alert-danger regenerate_week_validation_error" style="float:left">Please select at least one time period</div>'),!1;for(var b=0;b<ETM.template_diet_list.length;b++){var c=ETM.template_diet_list.getTemplateDietAtIndex(b);0<c.attributes.diet.attributes.meals.length&&(a=!0);current_scheme=ETM.food_pool.compileSchemeForDiet(c.attributes.diet);if(!ETM.food_pool.schemeIsValid(current_scheme,
$("#scheme_validation",this.el),Helper.getTemplateWeekday(c.attributes.weekday)))return!1}return a?!0:($('[data-editors="regenerate_weeks"]').append('<div class="alert alert-danger regenerate_week_validation_error" style="float:left">You weekly templates have no meals.  Add at least one meal to one template to regenerate.</div>'),!1)},submitRegenerateWeek:function(){if(this.validateRegenerateWeek()){var a=this.form.getValue();ETM.calendar_list.regenerateWeeks(a);var b=a.regenerate_weeks[0].split(",")[0],
c=moment(b).toDate(),d=a.regenerate_weeks[a.regenerate_weeks.length-1].split(",")[1];a.regenerate_weeks=JSON.stringify(a.regenerate_weeks);ETM.analytics.logRegenerate(a);this.$el.modal("hide");ETM.generator_results_cache.clearCache();ETM.current_user_profile.v2AlgorithmEnabled()?$.ajax({type:"POST",url:"/g/generate/week/",dataType:"json",data:{week_gen_start_date:b,week_gen_end_date:d,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds()),reset_groceries:a.reset_groceries,send_email:a.send_email},
success:function(a){add_v2_food_info_objects(a.food_infos);ETM.calendar_list.finishedWeeklyPlannerV2(a.results);ETM.MealPlanViewState.isWeekView()||ETM.calendar_view.goToDate(c);Helper.displayIssues(a.issues)},error:function(a){ETM.generator_status.trigger("finishedWeeklyPlanner",a.responseJSON)}}):$.ajax({type:"POST",url:"/regenerate-weeks/",data:a,success:function(a){ETM.generator_status.trigger("finishedWeeklyPlanner",a);ETM.MealPlanViewState.isWeekView()||ETM.calendar_view.goToDate(c)},error:function(){ETM.generator_status.trigger("finishedWeeklyPlanner",
"ERROR")}})}},submitInteractiveRegenerateWeek:function(){if(this.validateRegenerateWeek()){var a=this.form.getValue();this.$el.one("hidden.bs.modal",function(b){b=new ETM.GuidedPlanningToolModalView({model:a});b.getModalElement().html(b.render().el);b.$el.modal({show:!0,backdrop:"static"})}).modal("hide")}}});
ETM.RegenerateDietSetModalView=ModalView.extend({modal_id:"regenerate_diet_set_modal",events:{"click .submit_regenerate_diet_set":"submitRegenerateDietSet","click .reset_weekly_planner":function(){this.render()}},initialize:function(){var a=this;this.form_template=ETM.loadNestedTemplate("#RegenerateWeekModalTemplates","#regenerateDietSetForm");this.status_template=ETM.loadNestedTemplate("#RegenerateWeekModalTemplates","#regenerateStatusView");this.error_template=ETM.loadNestedTemplate("#RegenerateWeekModalTemplates",
"#regenerateErrorView");this.listenTo(ETM.generator_status,"weeklyProgressUpdated",function(b){"SUCCESS"===b?(is_debug&&show_planner_log&&(window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.host),window.open(window.location.origin+"/view-planner-log/","_blank")),a.$el.modal("hide"),a.renderForm()):"ERROR"===b?a.renderErrorView():$(".progress_percent",this.el).html(ETM.generator_status.getCurrentProgress())})},render:function(){ETM.is_premium?(this.$el.html(this.template({})),
this.renderForm()):this.$el.html(this.template({}));return this},renderForm:function(){this.form=(new Backbone.Form({schema:{generator_focus:{type:"SegmentedRadio",value_type:"Number",options:[{val:0,label:"Balanced"},{val:1,label:"Variety"},{val:2,label:"Macros"},{val:3,label:"Groceries"}]}},data:{generator_focus:ETM.current_user_profile.attributes.generator_focus},template:this.form_template})).render();$("#modal_body_template",this.el).html(this.form.el);$(".generator_focus_tooltip",this.form.el).popover({placement:"left",
html:!0,trigger:"hover",content:ETM.current_user_profile.generator_focus_toolip_text()});$(".modal-footer",this.el).show()},renderErrorView:function(){$("#modal_body_template",this.el).html(this.error_template)},renderLoadingInfo:function(){$(".regenerate_info",this.el).hide();$("#regenerate_diet_set_form",this.el).hide();$(".modal-footer",this.el).hide();$("#modal_body_template",this.el).html(this.status_template)},submitRegenerateDietSet:function(){var a=this;$(".regenerate_diet_set_validation_error",
this.el).remove();var b=this.form.validate();b?_.each(b,function(a){selector.append('<div class="regenerate_diet_set_validation_error alert alert-danger">'+a.message+"</div>")}):(ETM.generator_results_cache&&ETM.generator_results_cache.clearCache(),ETM.current_user_profile.v2AlgorithmEnabled()?(b={diet_set_id:a.model.attributes.id,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds())},a.model.managed_account&&(b.client_user_id=a.model.managed_account.attributes.client_id),$.ajax({type:"POST",
url:"/g/generate/week/",data:b,success:function(b){a.$el.modal("hide");if(b&&!_.isEmpty(b)&&0<b.results.length&&(add_v2_food_info_objects(b.food_infos),Helper.displayIssues(b.issues),0<b.results.length)){ETM.updateAndRenderDietSet(b.results);return}Backbone.trigger("flash",{message:"We were unable to regenerate this saved plan.",type:"danger"});ETM.renderDietSet()},error:function(){Backbone.trigger("flash",{message:"We were unable to regenerate this saved plan.",type:"danger"});ETM.renderDietSet()}})):
$.ajax({type:"POST",url:"/weeklyplanner/regenerate-diet-set/",data:{diet_set_id:a.model.attributes.id},success:function(b){a.$el.modal("hide");ETM.diet_plan_set=null;ETM.fetchAndRenderDietSet(a.model.attributes.diet_key+a.model.attributes.id)},error:function(){console.log("error")}}))}});ETM.status_tracker=!1;
var progress_comments=[[20,"Wiping down counter top;Preheating oven;Rinsing vegetables;Getting mentally prepared;Sharpening knives;Spinning saucers".split(";")],[85,"Slicing salty sauerkraut;Peeling prickly potatoes;Saut\u00e9ing summer squash;Sizzling succotash;Mincing onions;Finely filleting fresh figs;Folding fine fondue;Buttering blue beets;Flattening fettuccini;Thinking about Stir Friday;Tenderizing tomatoes;Crying because of onions;Creaming crispy cranberries;Turning turbid turnips".split(";")],[101,
["Cleaning dishes","Wrapping up","Counting calories","Setting the table","Taking out the trash"]]];
ETM.GeneratorStatus=Backbone.Model.extend({initialize:function(){this.weeks={};this.past_progress=0;this.current_comment="";this.available_comments=$.extend(!0,[],progress_comments)},newRun:function(a){var b=this;this.weeks={};this.past_progress=0;this.current_comment="";this.available_comments=$.extend(!0,[],progress_comments);_.each(a,function(a){b.weeks[a]=0})},setProgressAndComment:function(a){if(!isNaN(a)&&a>this.past_progress)for(var b=0;b<this.available_comments.length;b++)if(a<this.available_comments[b][0]){var c=
Helper.randomNumber(this.available_comments[b][1].length);this.current_comment=this.available_comments[b][1][c];1<this.available_comments[b][1].length&&this.available_comments[b][1].splice(c,1);break}this.past_progress=a},progressError:function(){},updateProgress:function(a){"PENDING"===a&&0==this.past_progress?this.setProgressAndComment(0):"ERROR"===a?this.progressError():"SUCCESS"!==a&&a.hasOwnProperty("progress0")&&this.setProgressAndComment(a.progress0)},getCurrentProgress:function(){return 0===
this.past_progress?"Preparing ingredients...":this.current_comment+"..."},getCurrentProgressShort:function(){return"..."}});
ETM.StatusTracker={failed:0,interval:2E3,init:function(){!1!=ETM.status_tracker&&clearTimeout(ETM.status_tracker);ETM.status_tracker=setTimeout($.proxy(this.getData,this),this.interval)},getData:function(){var a=this;$.ajax({url:"/check-generator-progress/",success:function(b){"SUCCESS"===b||"ERROR"===b?(ETM.generator_status.updateProgress(b),ETM.generator_status.trigger("weeklyProgressUpdated",b),ETM.generator_status.trigger("finishedWeeklyPlanner",b),a.stopPolling()):(ETM.generator_status.updateProgress(b),
ETM.generator_status.trigger("weeklyProgressUpdated",b),a.init())},error:$.proxy(a.errorHandler,a)})},errorHandler:function(){10>++this.failed&&(this.interval+=1E3,this.init())},stopPolling:function(){clearTimeout(ETM.status_tracker);ETM.status_tracker=!1}};
ETM.UserProfileView=ModalView.extend({className:"",events:{'click div[name="units"] .btn':"changeUnits","click [name='gender']":"showBfatPercent","click .update_weight_from_profile":"openWeightModal",'click [name="use_weight_goal"] .btn':"showWeightGoalForm","click .view_results_button":function(){ETM.router.navigateAndScroll("results/",{trigger:!0})}},initialize:function(a,b){var c=this;this.waiting_to_save=null;this.save_delay=2E3;this.shopping_day_enabled=ETM.is_premium;this.autosave=!0;this.display_weight_goal=
!1;"undefined"!=typeof b&&("undefined"!=typeof b.shopping_day_enabled&&(this.shopping_day_enabled=b.shopping_day_enabled),"undefined"!=typeof b.autosave&&(this.autosave=b.autosave),"undefined"!=typeof b.display_weight_goal&&(this.display_weight_goal=b.display_weight_goal));this.listenTo(this.model,"update_weight",function(){c.render()});this.profile_completeness_view=new ETM.ProfileCompletenessView({model:ETM.current_profile_completeness})},showBfatPercent:function(a){"F"==(a?$(a.target).find("input").val():
this.model.attributes.gender)?($(".female_bfat_percent",this.el).show(),$(".male_bfat_percent",this.el).hide()):($(".male_bfat_percent",this.el).show(),$(".female_bfat_percent",this.el).hide())},render:function(){this.$el.html(this.template({attributes:this.model.attributes,shopping_day_enabled:this.shopping_day_enabled,display_weight_goal:this.display_weight_goal}));this.renderForm();$(".profile_completeness_display",this.el).html(this.profile_completeness_view.render().el);this.profile_completeness_view.delegateEvents();
this.showWeightGoalForm();return this},showWeightGoalForm:function(a){a?$(a.currentTarget).hasClass("active")||("true"===$("input",a.currentTarget).val()?$(".weight_goal_form",this.form.el).show():$(".weight_goal_form",this.form.el).hide()):this.model.attributes.use_weight_goal?$(".weight_goal_form",this.form.el).show():$(".weight_goal_form",this.form.el).hide()},openWeightModal:function(){ETM.renderWeightModal();ETM.weight_modal.$el.modal("show");setTimeout('$(".update_weight_input input").focus()',
400)},renderForm:function(){var a=this;this.form=(new Backbone.Form({model:this.model,template:Helper.createTemplateFunction($("#user_profile_form",this.el).html()),schema:this.display_weight_goal?this.model.weight_goal_schema():this.model.schema})).render();this.display_weight_goal&&(this.listenTo(this.model,"change:weight_goal",function(){this.form.fields.weight_goal.editor.setImperialValue(ETM.current_user_profile.attributes.weight_goal)},this),this.listenTo(this.model,"change:weight_goal_weekly_rate",
function(){this.form.fields.weight_goal_weekly_rate.editor.setImperialValue(ETM.current_user_profile.attributes.weight_goal_weekly_rate)},this),this.listenTo(this.form,"weight_goal:change",function(){this.updateWeeklyRateLabels()},this),this.listenTo(this.model,"change:goal",function(){this.updateWeeklyRateLabels()},this),this.listenTo(this.form,"weight_goal_weekly_rate:change",function(){this.updateWeeklyRateLabels()},this));$(".user_profile_form_div",this.el).html(this.form.el);this.autosave&&(this.listenTo(this.form,
"change",function(){this.autosaveProfile()},this),$('input[name="height_primary"]',this.el).change(function(){a.autosaveProfile()}),$('input[name="height_secondary"]',this.el).change(function(){a.autosaveProfile()}),$('input[name="weight"]',this.el).change(function(){a.autosaveProfile()}),$('input[name="age"]',this.el).change(function(){a.autosaveProfile()}));$(".activity_tooltip",this.el).tooltip({placement:"right",html:!0,title:ETM.current_user_profile.activity_level_tooltip_text(),template:'<div class="tooltip wide-tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>'});
$(".shopping_day_tooltip",this.el).tooltip({placement:"bottom",title:ETM.current_user_profile.shopping_day_tooltip_text(),html:!0});$(".bfat_help_tooltip",this.form.el).tooltip({placement:"right",title:ETM.current_user_profile.bodyfat_tooltip_text(),html:!0,template:'<div class="tooltip wide-tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner text-left"></div></div>'});$(".goal_help_tooltip",this.form.el).tooltip({placement:"right",title:ETM.current_user_profile.goal_tooltip_text(),
html:!0,template:'<div class="tooltip wide-tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner text-left"></div></div>'});this.renderHeightWeightAge();this.updateWeeklyRateLabels();"I"===this.model.attributes.units?($(".imperial_inputs",this.form.el).show(),$(".metric_inputs",this.form.el).hide(),$('input[name="height_primary"]',this.form.el).show(),$(".weight_units",this.form.el).html("lbs")):"M"===this.model.attributes.units&&($(".imperial_inputs",this.form.el).hide(),$(".metric_inputs",
this.form.el).show(),$('input[name="height_primary"]',this.form.el).hide(),$(".weight_units",this.form.el).html("kgs"));this.showBfatPercent()},renderHeightWeightAge:function(){var a=this.model.get("height"),b=this.model.get("weight");"M"===this.model.get("units")?(a&&(a*=2.54,$('input[name="height_secondary"]',this.el).val(roundNumber(a,0))),b&&$('input[name="weight"]',this.el).val(roundNumber(0.453592*b,1))):(a&&($('input[name="height_primary"]',this.el).val(Math.floor(a/12)),$('input[name="height_secondary"]',
this.el).val(roundNumber(a%12,0))),b&&$('input[name="weight"]',this.el).val(roundNumber(b,1)));$('input[name="age"]',this.el).val(this.model.get("age"))},changeUnits:function(a){if(!$(a.currentTarget).hasClass("active")){var b=parseFloat($('input[name="height_primary"]',this.el).val()),c=parseFloat($('input[name="height_secondary"]',this.el).val()),d=parseFloat($('input[name="weight"]',this.el).val());"I"==$("input",a.currentTarget).val()?(a=0.393701*c,d=roundNumber(2.20462*d,0),$(".imperial_inputs",
this.el).show(),$(".metric_inputs",this.el).hide(),$('input[name="height_primary"]',this.el).show(),null==a||isNaN(a)||($('input[name="height_primary"]',this.el).val(Math.floor(a/12)),$('input[name="height_secondary"]',this.el).val(roundNumber(a%12,0))),null==d||isNaN(d)||$('input[name="weight"]',this.el).val(d),this.display_weight_goal&&(this.form.fields.weight_goal.editor.toggleUnits("I"),this.form.fields.weight_goal_weekly_rate.editor.toggleUnits("I")),$(".weight_units",this.el).html("lbs")):"M"==
$("input",a.currentTarget).val()&&(a=roundNumber(2.54*(12*b+c),0),d=roundNumber(0.453592*d,0),$(".imperial_inputs",this.el).hide(),$(".metric_inputs",this.el).show(),$('input[name="height_primary"]',this.el).hide(),null==a||isNaN(a)||$('input[name="height_secondary"]',this.el).val(a),null==d||isNaN(d)||$('input[name="weight"]',this.el).val(d),this.display_weight_goal&&(this.form.fields.weight_goal.editor.toggleUnits("M"),this.form.fields.weight_goal_weekly_rate.editor.toggleUnits("M")),$(".weight_units",
this.el).html("kgs"))}},updateWeeklyRateLabels:function(){var a=this.scrapeForm(),b=a.weight;if(b&&a.weight_goal){var b=a.weight_goal-b,c=$('input[name="weight_goal_weekly_rate"]',this.form.el);c.attr("min","0");"M"===a.units?c.attr("max","0.9"):c.attr("max","2");0>b||"L"===a.goal?$(".gain_lose_label",this.form.el).html("Lose"):(0<b||"G"===a.goal)&&$(".gain_lose_label",this.form.el).html("Gain");this.validateWeightGoal();this.printGoalDate()}},printGoalDate:function(){var a=this.scrapeForm().weight,
b=$(".expected_weight_goal_date",this.form.el);if(a&&this.form.getValue().weight_goal&&this.form.getValue().weight_goal_weekly_rate){var a=this.form.getValue().weight_goal-a,c=0>a?-1*Math.abs(this.form.getValue().weight_goal_weekly_rate):Math.abs(this.form.getValue().weight_goal_weekly_rate),a=a/(c/7),a=moment().add(a,"days").format("MMM YYYY");b.html("You should reach your goal in "+a+".")}else b.html("")},validateWeightGoal:function(){$(".weight_goal_update_error",this.el).hide();$(".weight_goal_weekly_rate_note",
this.el).hide();$(".weight_goal_weekly_rate_warning",this.el).hide();$(".weight_goal_bmi_warning",this.el).hide();$(".low_calorie_warning",this.el).hide();var a=this.scrapeForm();if(null==a.weight_goal||!a.use_weight_goal)return!0;var b=!0;0<!a.weight_goal&&($(".weight_goal_update_error",this.el).show(),$(".weight_goal_update_error",this.el).html("Please enter a weight goal greater than 0."),b=!1);var c=this.calculateGoalBMI(a);18.5>c&&40<a.weight_goal&&($(".weight_goal_bmi_warning",this.el).show(),
$(".weight_goal_bmi_warning",this.el).html('Note: Your weight goal will put your BMI at <span class="bmi-display">'+c+"</span> which is classified as <strong>underweight</strong>. You can find more info about BMI here: <a href='https://www.cdc.gov/healthyweight/assessing/bmi/adult_bmi/index.html' target='_blank'>CDC.gov</a>"));"M"===a.units?a.weight_goal_weekly_rate&&0.9<Math.abs(this.form.fields.weight_goal_weekly_rate.editor.getRawValue())?($(".weight_goal_weekly_rate_warning",this.el).show(),$(".weight_goal_weekly_rate_warning",
this.el).html("The CDC and health professionals strongly advise against weight changes of more than 0.9 kgs a week.")):a.weight_goal_weekly_rate&&0.454<Math.abs(this.form.fields.weight_goal_weekly_rate.editor.getRawValue())&&("L"===a.goal||a.weight_goal<a.weight)&&($(".weight_goal_weekly_rate_warning",this.el).show(),$(".weight_goal_weekly_rate_warning",this.el).html("A weight loss rate of 0.45 kg per week will give you a Calorie deficit of around 500 Calories per day. You may find faster weight loss harder to stick with, and therefore less effective long-term.")):
a.weight_goal_weekly_rate&&2<Math.abs(a.weight_goal_weekly_rate)?($(".weight_goal_weekly_rate_warning",this.el).show(),$(".weight_goal_weekly_rate_warning",this.el).html("The CDC and health professionals strongly advise against weight changes of more than 2 lbs a week.")):a.weight_goal_weekly_rate&&1<Math.abs(a.weight_goal_weekly_rate)&&("L"===a.goal||a.weight_goal<a.weight)&&($(".weight_goal_weekly_rate_warning",this.el).show(),$(".weight_goal_weekly_rate_warning",this.el).html("A weight loss rate of 1 lb per week will give you a Calorie deficit of around 500 Calories per day. You may find faster weight loss harder to stick with, and therefore less effective long-term."));
return b},calculateGoalBMI:function(a){return roundNumber(703*(a.weight_goal/(a.height*a.height)),1)},validate:function(a){$(".user_profile_errors",this.el).remove();var b=this.validateWeightGoal();0<!a.height&&($("#height-inputs",this.el).append("<div class='user_profile_errors alert alert-danger inline'>Height must be greater than 0.</div>"),b=!1);0<!a.weight&&($("#weight-input",this.el).append("<div class='user_profile_errors alert alert-danger inline'>Weight must be greater than 0.</div>"),b=
!1);18>a.age&&$("#age-input",this.el).parent().append("<div class='col-12 user_profile_errors alert alert-danger inline'>The equations we use for estimating calorie intake are calibrated for people 18 and older. If you are under 18, please do not use this calculator and consult a medical professional for dietary advice.</div>");0<!a.age&&($("#age-input",this.el).append("<div class='user_profile_errors alert alert-danger inline'>Age must be greater than 0.</div>"),b=!1);0<!a.bodyfat&&($("#bodyfat-radio",
this.el).parent().append("<div class='user_profile_errors wide_user_profile_error alert alert-danger inline'>Please select a bodyfat amount. If you don't know, an estimation is fine, and you can easily change this later.</div>"),b=!1);if(a=this.form.validate()){for(var c in a)$('[data-editors="'+c+'"]').append('<div class="user_profile_errors alert alert-danger">'+a[c].message+"</div>");b=!1}return b},scrapeForm:function(){var a=this.form.getValue();a.height_primary=parseFloat($('input[name="height_primary"]',
this.el).val());a.height_secondary=parseFloat($('input[name="height_secondary"]',this.el).val());a.weight=parseFloat($('input[name="weight"]',this.el).val());a.age=parseInt($('input[name="age"]',this.el).val());"I"===a.units?(a.height=roundNumber(12*a.height_primary+a.height_secondary,1),a.weight=parseFloat(a.weight)):(a.height=roundNumber(0.393701*a.height_secondary,1),a.weight=roundNumber(2.2046*a.weight,1));this.model.attributes.weight!=a.weight&&(a.last_updated_weight=moment().format("YYYY-MM-DD"));
delete a.height_primary;delete a.height_secondary;return a},autosaveProfile:function(){var a=this;if(null==this.waiting_to_save)this.saveProfile();else if(!this.waiting_to_save){var b=this.scrapeForm();this.validate(b)&&this.model.set(b);this.waiting_to_save=!0;setTimeout(function(){a.saveProfile()},this.save_delay)}},saveProfile:function(){this.waiting_to_save=!1;var a=this.scrapeForm();return this.validate(a)?(this.model.save(a,{patch:!0}),!0):!1},beforeClose:function(){this.waiting_to_save&&this.saveProfile()}});
ETM.NutritionCalculatorView=ETM.UserProfileView.extend({modal_id:"nutrition_calculator_modal",events:{"click #open_edit_nutrition_targets":"openEditNutritionTargets",'click div[name="units"] .btn':"changeUnits","click #calculate_button":"calculate","click .use_calculated_settings":"useCalculatedSettings","click [name='gender']":"showBfatPercent",'click [name="use_weight_goal"] .btn':"showWeightGoalForm"},className:function(){return ETM.is_mobile&&!ETM.is_tablet?"modal fade modal-fullscreen":"modal fade"},
id:"nutrition_calculator_view",initialize:function(a,b){"undefined"!==typeof b&&(this.go_back_enabled=b.go_back_enabled,this.nutrition_profile=b.nutrition_profile,this.save_user_profile=b.save_user_profile,this.display_weight_goal=!0,this.show_profile_alert=b.show_profile_alert)},render:function(){this.$el.html(this.template({attributes:this.model.attributes,go_back_button_enabled:this.go_back_enabled,logged_in:ETM.is_logged_in,show_profile_alert:this.show_profile_alert}));this.$el.modal({show:!1});
this.renderForm();return this},renderForm:function(){this.form=(new Backbone.Form({model:this.model,schema:this.model.nutrition_calculator_schema(),template:Helper.createTemplateFunction($("#nutritionCalculatorFormTemplate",this.el).html())})).render();$(".calculator_form",this.el).html(this.form.el);$(".bfat_help_tooltip",this.form.el).tooltip({placement:"right",title:ETM.current_user_profile.bodyfat_tooltip_text(),html:!0});$(".goal_help_tooltip",this.form.el).tooltip({placement:"right",title:ETM.current_user_profile.goal_tooltip_text(),
html:!0});this.renderHeightWeightAge();this.listenTo(this.form,"weight_goal:change",function(){this.updateWeeklyRateLabels()},this);this.listenTo(this.form,"weight_goal_weekly_rate:change",function(){this.updateWeeklyRateLabels()},this);"I"===this.model.attributes.units?($(".imperial_inputs",this.el).show(),$(".metric_inputs",this.el).hide(),$('input[name="height_primary"]',this.el).show(),$(".weight_units",this.el).html("lbs")):"M"===this.model.attributes.units&&($(".imperial_inputs",this.el).hide(),
$(".metric_inputs",this.el).show(),$('input[name="height_primary"]',this.el).hide(),$(".weight_units",this.el).html("kgs"));$(".activity_tooltip",this.el).tooltip({placement:"left",html:!0,title:ETM.current_user_profile.activity_level_tooltip_text()});this.updateWeeklyRateLabels();this.showBfatPercent();this.showWeightGoalForm()},openEditNutritionTargets:function(a){a.preventDefault();var b=this;this.$el.modal("hide");this.$el.one("hidden.bs.modal",function(){b.trigger("openEditNutritionTargets")})},
calculate:function(a){null!=a&&a.preventDefault();a=this.scrapeForm();if(this.validate(a)){this.save_user_profile&&this.model.save(a);var b=a.use_weight_goal?a.weight_goal:null,c=a.use_weight_goal?a.weight_goal_weekly_rate/7:null;this.calculated_values=Helper.calculateMacros(a.age,a.weight,a.height,a.gender,a.goal,a.bodyfat,a.activity_level,this.model.get("preset_diet"),b,c);this.renderCalculatedValues()}},renderCalculatedValues:function(){var a,b,c,d;a=this.calculated_values.calories+" kcal";b=1E4>
this.calculated_values.max_carbs?this.calculated_values.min_carbs+"g - "+this.calculated_values.max_carbs+"g":"at least "+this.calculated_values.min_carbs+"g";c=1E4>this.calculated_values.max_fats?this.calculated_values.min_fats+"g - "+this.calculated_values.max_fats+"g":"at least "+this.calculated_values.min_fats+"g";d=1E4>this.calculated_values.max_proteins?this.calculated_values.min_proteins+"g - "+this.calculated_values.max_proteins+"g":"at least "+this.calculated_values.min_proteins+"g";1200>
this.calculated_values.calories&&($(".low_calorie_warning",this.el).show(),$(".low_calorie_warning",this.el).html("Based on your entries, our equations came up with a target under 1200 Calories. Eating under 1200 Calories per day is generally considered extreme, and you should consult a health professional before doing so."));$(".suggested_calories",this.el).html(a);$(".suggested_carbs",this.el).html(b);$(".suggested_fats",this.el).html(c);$(".suggested_proteins",this.el).html(d);$(".macro_recommendation").show()},
useCalculatedSettings:function(a){a.preventDefault();var b=this;delete this.calculated_values.capped_min_calories;this.nutrition_profile.set(this.calculated_values);this.$el.modal("hide");this.$el.one("hidden.bs.modal",function(){b.trigger("useCalculatedSettings")})}});ETM.ManagerUserSettingsUserProfileView=ETM.UserProfileView.extend({});
ETM.GeneratingDietView=Backbone.View.extend({events:{},initialize:function(a){var b=this;this.parent=a.parent;this.listenTo(ETM.generator_status,"weeklyProgressUpdated",function(a){"SUCCESS"===a?$(".loading_percent",this.el).html("Finishing..."):"ERROR"===a?($(".diet_currently_generating h4",this.el).html('Uh oh, something went wrong generating.  <button class="regenerate_weeks_meals_btn btn btn-secondary" style="float:none">Retry<i class="fa fa-random"></i></button>'),$(".loading_percent",this.el).html(""),
$(".loading_status",this.el).html("")):$(".loading_percent",this.el).html(ETM.generator_status.getCurrentProgress())},this);ETM.current_user_profile.triggered_regenerate_week||(this.timeout=setTimeout(function(){("generating"===ETM.calendar_list.date_index[b.parent.date_string]||ETM.calendar_list.date_index[b.parent.date_string].attributes.currently_generating)&&$.ajax({type:"POST",url:"/weeklyplanner/create-blank-day/",data:{date:b.parent.date_string},success:function(a){a=new ETM.CalendarDiet(a);
ETM.calendar_list.add(a);ETM.calendar_list.date_index[a.attributes.date]=a;ETM.calendar_list.trigger(a.attributes.date,{status:"okay",diet_object:a.attributes.diet})}})},1E4))},onClose:function(){null!=this.timeout&&clearTimeout(this.timeout)},render:function(){this.$el.html(this.template({generator_progress:ETM.generator_status.getCurrentProgress()}));return this}});
ETM.NoDietView=Backbone.View.extend({events:{"click .load_saved_plan":"loadSavedDiet","click .generate_day_btn":function(){this.parent.generatePlan()},"click .load_template_plan":function(){this.parent.loadFromTemplate()},"click .load_previous_plan":"loadPreviousPlan","click .load_previous_blank_plan":"loadPreviousBlankPlan","click .open_weekly_layout":function(){ETM.router.navigateAndScrollTo("preferences/meals/","#week_layout_settings",{trigger:!0})}},initialize:function(a){this.parent=a.parent;
this.listening_for_load=!1;this.temp_calendar_event=new ETM.CalendarDiet({date:this.parent.plan_date,diet:ETM.current_diet})},loadSavedDiet:function(){ETM.load_plans_modal&&ETM.load_plans_modal.close();ETM.load_plans_modal=new ETM.LoadPlansModalView;ETM.load_plans_modal.getModalElement().html(ETM.load_plans_modal.render().el);ETM.load_plans_modal.setLoadDate(this.parent.plan_date);ETM.load_plans_modal.showLoadDates();ETM.load_plans_modal.delegateEvents();ETM.load_plans_modal.$el.modal("show");googleanalytics("send",
"event","button","click","load_diet");amplitude.logEvent("load_diet")},loadPreviousPlan:function(){this.parent.loadPreviousDiet(!1)},loadPreviousBlankPlan:function(){this.parent.loadPreviousDiet(!0)},render:function(){this.$el.html(this.template({current_weekday:Helper.getWeekday(this.parent.plan_date.getDay()),email_weekday:Helper.getWeekday(ETM.current_user_profile.attributes.shopping_day),today:this.parent.isCalendar()&&moment().isSame(moment(this.parent.plan_date),"day")}));return this}});
ETM.LockedPremiumDayView=Backbone.View.extend({events:{"click .link_to_share":function(){ETM.router.navigateAndScroll("invite-friends/",{trigger:!0})}},initialize:function(a){this.parent=a.parent;this.listening_for_load=!1;this.temp_calendar_event=new ETM.CalendarDiet({date:this.parent.plan_date,diet:ETM.current_diet})},render:function(){this.$el.html(this.template({is_tomorrow:moment(this.parent.plan_date).isSame(moment().add(1,"day"),"day")}));return this}});
ETM.LoadingDayView=Backbone.View.extend({events:{},initialize:function(a){this.parent=a.parent},render:function(){this.$el.html(this.template());return this}});ETM.PlaceholderDayView=Backbone.View.extend({events:{},initialize:function(a){this.parent=a.parent},render:function(){this.$el.html(this.template());return this}});ETM.SINGLE_DAY_VIEW_LABEL="singleday";ETM.MULTI_DAY_VIEW_LABEL="multiday";ETM.MONTHLY_VIEW_LABEL="monthly";
ETM.BaseMealPlanView=Backbone.View.extend({events:{"click .next_plan_button":function(){this.showArrowKeyNotification();this.loadNextPlan()},"click .previous_plan_button":function(){this.showArrowKeyNotification();this.loadPreviousPlan()},"click .calendar_today_button":"jumpToToday","click .open_calendar_preview":"toggleCalendar","click .open_weekly_layout":function(){ETM.router.navigateAndScroll("preferences/meals/",{trigger:!0})},"click .share_diet_set_btn":"openShareModal","click .import_diet_set_btn":"openImportModal",
"click .save_diet_range":"showSaveDietRange","click .load_diet_range":"showLoadDietRange","click .email_date_range":"showEmailDietRange","change .carousel_view_selector":function(a){this.changeMealPlanView($(a.currentTarget).val())},"click .edit_client_settings":function(){var a=ETM.diet_plan_set.managed_account;ETM.generator_results_cache&&ETM.generator_results_cache.clearCache();ETM.displayEditUserSettingsModal(a,function(){a.fetch()})},"click .edit_meal_layout":function(){ETM.weekly_layout_modal||
(ETM.weekly_layout_modal=new ETM.WeeklySettingsModalView({collection:ETM.template_diet_list,show_day_numbers:!0}),ETM.weekly_layout_modal.getModalElement().html(ETM.weekly_layout_modal.render().el));ETM.weekly_layout_modal.$el.modal("show");ETM.weekly_layout_modal.$el.one("hidden.bs.modal",function(a){ETM.weekly_layout_modal.close();ETM.weekly_layout_modal=null})}},isCalendar:function(){return"calendar"===this.meal_plan_source},getRegenerateWeekText:function(){var a=ETM.is_mobile&&!ETM.is_tablet?
"Regen ":"Regenerate ",b=this.isCalendar()?"Week":"Plan";return a+b},scrollToCarouselIndex:function(a){ETM.MealPlanViewState.isWeekView()||(a>this.carousel_obj.getDotCount()&&(a=this.carousel_obj.getDotCount()),this.plan_carousel_div.slick("slickGoTo",a))},changeMealPlanView:function(a){amplitude.logEvent("change_view_to_"+a,{previous_view:ETM.MealPlanViewState.getCarouselViewType()});ETM.MealPlanViewState.needsRerender(a)?(ETM.MealPlanViewState.setState(a),this.close(),this.isCalendar()?(ETM.calendar_view=
null,Backbone.history.loadUrl("/")):(ETM.diet_plan_set_view=null,Backbone.history.loadUrl(Backbone.history.fragment))):(ETM.MealPlanViewState.setState(a),this.renderCarousel())},showArrowKeyNotification:function(){ETM.MealPlanViewState.isWeekView()||ETM.local_variables.attributes.seen_arrow_key_info||ETM.is_mobile||(Helper.oneTimeTooltip($(".calendar_today_button",this.el),"bottom",'<span class=\'badge badge-info arrow-key-tooltip\'>Tip</span><br/>Use your <i class="fa fa-arrow-left" aria-hidden="true"></i> left and <i class="fa fa-arrow-right" aria-hidden="true"></i> right arrow keys to navigate the days.',
7E3),ETM.local_variables.save({seen_arrow_key_info:!0}))},checkIfUserIsOwner:function(){this.isCalendar()?this.user_is_owner=!0:this.user_is_owner=this.model.attributes.diet_set_owner_username===ETM.current_user_profile.attributes.username;this.show_back_to_meal_plans=this.user_is_owner&&ETM.current_user_profile.hasManagerV2Subscription();ETM.current_user_profile.hasManagerV2Subscription()&&null!=ETM.managed_accounts.findWhere({client_username:this.model.attributes.diet_set_owner_username})&&(this.show_back_to_meal_plans=
this.user_is_owner=!0)},applyGeneratorListeners:function(){this.listenTo(ETM.dispatcher,"startedGenerating",function(){$(".disable_during_generate",this.el).prop("disabled",!0);$(".disable_during_generate",this.el).addClass("disabled")});this.listenTo(ETM.dispatcher,"stoppedGenerating",function(){$(".disable_during_generate",this.el).prop("disabled",!1);$(".disable_during_generate",this.el).removeClass("disabled");$(".eaten_lock_icon").hide()})},showWalkthroughPopover:function(){var a=this;setTimeout(function(){Helper.confirmationPopover({element:$(".carousel_header_text",
a.el),message:"Want a quick walkthrough of the meal planner features?",cancel_text:"No thanks",custom_class:"tutorial_popover",confirm_text:"Start the tour",position:"bottom",zindex:1038,cancelCallback:function(){ETM.current_user_profile.save({show_walkthrough_prompt:!1},{patch:!0});$(".tutorial_popover").remove()},confirmCallback:function(){ETM.start_free_walkthrough();$(".tutorial_popover").remove()}})},100)},openRegenerateModal:function(a){this.isCalendar()?(amplitude.logEvent("regenerate_week_planner_modal"),
this.regenerate_week_modal||(this.regenerate_week_modal=new ETM.RegenerateWeekModalView,this.regenerate_week_modal.getModalElement().html(this.regenerate_week_modal.render().el)),this.regenerate_week_modal.$el.modal("show"),this.regenerate_week_modal.delegateEvents()):ETM.diet_plan_set.confirmRegenerate($(a.currentTarget),function(a){if(ETM.current_user_profile.v2AlgorithmEnabled()){if(a&&!_.isEmpty(a)&&0<a.results.length&&(add_v2_food_info_objects(a.food_infos),0<a.results.length)){ETM.updateAndRenderDietSet(a.results);
return}Backbone.trigger("flash",{message:"We were unable to regenerate this saved plan.  Please try loosening some of your restrictions.",type:"danger"})}else a=ETM.diet_plan_set.attributes.diet_key+ETM.diet_plan_set.attributes.id,ETM.diet_plan_set=null,ETM.fetchAndRenderDietSet(a)})},openImportModal:function(){this.import_diet_set_modal&&this.import_diet_set_modal.close();this.import_diet_set_modal=ETM.is_premium?new ETM.ImportDietSetModalView({model:this.model}):new ETM.ImportSingleDietModalView({model:this.model});
this.import_diet_set_modal.getModalElement().html(this.import_diet_set_modal.render().el);this.import_diet_set_modal.$el.modal("show");this.import_diet_set_modal.delegateEvents();ETM.is_premium||this.import_diet_set_modal.selectCurrentDiet()},openShareModal:function(){this.share_diet_set_modal||(this.share_diet_set_modal=new ETM.ShareDietModalView({model:this.model}));this.share_diet_set_modal.getModalElement().html(this.share_diet_set_modal.render().el);this.share_diet_set_modal.$el.modal("show");
this.share_diet_set_modal.delegateEvents()},clearDietPlanItemList:function(){var a=this;_.each(this.meal_plan_view_list,function(b){b.date_string&&_.has(a.date_view_index,b.date_string)&&delete a.date_view_index[b.date_string];b.close()});this.meal_plan_view_list=[];this.date_view_index={}},showSaveDietRange:function(){ETM.save_plans_modal||(ETM.save_plans_modal=new ETM.SavePlansModalView,ETM.save_plans_modal.getModalElement().html(ETM.save_plans_modal.render().el));ETM.save_plans_modal.$el.modal("show");
ETM.save_plans_modal.queryPlanSummary();ETM.save_plans_modal.updateSaveTitle();googleanalytics("send","event","button","click","save_diet");amplitude.logEvent("save_diet")},showLoadDietRange:function(){ETM.load_plans_modal&&ETM.load_plans_modal.close();ETM.load_plans_modal=new ETM.LoadPlansModalView;ETM.load_plans_modal.getModalElement().html(ETM.load_plans_modal.render().el);ETM.load_plans_modal.showLoadDates();ETM.load_plans_modal.delegateEvents();ETM.load_plans_modal.$el.modal("show");googleanalytics("send",
"event","button","click","load_diet");amplitude.logEvent("load_diet")},showEmailDietRange:function(){this.isCalendar()?(ETM.email_plans_modal||(ETM.email_plans_modal=new ETM.EmailPlansModalView,ETM.email_plans_modal.getModalElement().html(ETM.email_plans_modal.render().el),ETM.email_plans_modal.form.selectCalendarSource()),ETM.email_plans_modal.$el.modal("show")):ETM.email_plan_set_modal&&(ETM.email_plan_set_modal.getModalElement().html(ETM.email_plan_set_modal.render().el),ETM.email_plan_set_modal.delegateEvents(),
ETM.email_plan_set_modal.$el.modal("show"))},getFirstVisiblePlan:function(){var a=!1;if(this.isCalendar()){var b=Helper.convertDateToString(this.current_plan);this.hasDateViewWithPlan(b)&&(a=this.date_view_index[b]);if(!a)for(var c=this.getStringDatesToRender(),b=0;b<c.length;b++){var d=c[b];if(this.hasDateViewWithPlan(d)){a=this.date_view_index[d];break}}if(!a)for(b=0;b<this.meal_plan_view_list.length;b++)if(c=this.meal_plan_view_list[b],this.hasDateViewWithPlan(c.date_string)){a=c;break}a&&this.goToDate(a.plan_date)}return a}});
ETM.MealPlanCarousel=ETM.BaseMealPlanView.extend({events:function(){return _.extend({},ETM.BaseMealPlanView.prototype.events,{"click .regenerate_weeks_meals_btn":"openRegenerateModal"})},rendered_view_buffer:1,download_buffer:2,placeholder_buffer:3,multiday_breakpoint_settings:[{breakpoint:999999,settings:{slidesToShow:7},slide_offset:1,placeholder_buffer_range:25,placeholder_selected_index:12},{breakpoint:2878,settings:{slidesToShow:6},slide_offset:1,placeholder_buffer_range:21,placeholder_selected_index:10},
{breakpoint:2500,settings:{slidesToShow:5},slide_offset:1,placeholder_buffer_range:21,placeholder_selected_index:10},{breakpoint:2200,settings:{slidesToShow:4},slide_offset:1,placeholder_buffer_range:17,placeholder_selected_index:8},{breakpoint:1830,settings:{slidesToShow:3},slide_offset:1,placeholder_buffer_range:17,placeholder_selected_index:8},{breakpoint:1360,settings:{slidesToShow:2},slide_offset:0,placeholder_buffer_range:17,placeholder_selected_index:8},{breakpoint:990,settings:{slidesToShow:1},
slide_offset:0,placeholder_buffer_range:17,placeholder_selected_index:8}],singleday_breakpoint_settings:[{breakpoint:999999,settings:{slidesToShow:1},slide_offset:0,placeholder_buffer_range:11,placeholder_selected_index:5}],placeholder_buffer_range:30,placeholder_selected_index:8,showMultiDaySwitchNotification:function(){ETM.local_variables.attributes.seen_multi_day_view_info||ETM.is_mobile||$(".arrow-key-tooltip").is(":visible")||(Helper.oneTimeTooltip($(".carousel_view_selector",this.el),"bottom",
"<span class='badge badge-info'>Tip</span><br/>Try switching between the Single and Multi Day View to see which one suits your needs best.",7E3),ETM.local_variables.save({seen_multi_day_view_info:!0}))},getCurrentBreakpoint:function(){var a=this.getBreakpointSettings().concat();a.sort(function(a,b){return a.breakpoint-b.breakpoint});for(var b=$(window).width(),c=a[0],d=0;d<a.length;d++)if(a[d].breakpoint>=b){c=a[d];break}return c},getBreakpointSettings:function(){return this[ETM.MealPlanViewState.getCarouselViewType()+
"_breakpoint_settings"]},getVisiblePlans:function(){var a=[];if(this.isCalendar())for(var b=this.getStringDatesToRender(),c=0;c<b.length;c++){var d=b[c];this.hasDateViewWithPlan(d)&&a.push(this.date_view_index[d])}return a},hasDateViewWithPlan:function(a){return _.has(this.date_view_index,a)&&_.has(this.date_view_index[a],"model")&&0<this.date_view_index[a].model.stats.calories},hasDateViewWithNoPlan:function(a){return _.has(this.date_view_index,a)&&(!_.has(this.date_view_index[a],"model")||0===this.date_view_index[a].model.stats.calories)},
moveCarousel:function(a){if(!$(":input").not(".btn").is(":focus")&&!$(".modal.show").is(":visible")){switch(a.which){case 37:this.loadPreviousPlan();break;case 39:this.loadNextPlan();break;default:return}a.preventDefault()}},toggleCalendar:function(){},initCalendar:function(){var a=this,b=moment(ETM.current_user_profile.attributes.date_joined).subtract(1,"months");b.isBefore(moment().subtract(2,"years"))&&(b=moment().subtract(2,"years"));$(".open_calendar_preview",this.el).daterangepicker({singleDatePicker:!0,
alwaysShowCalendars:!0,autoApply:!0,opens:"left",startDate:moment().format("MM/DD/YYYY"),maxDate:moment().add(3,"months").format("MM/DD/YYYY"),minDate:b,isCustomDate:function(a){if(a.isSame(moment(),"day"))return"date_is_today"}},function(b,d,e){a.goToDate(b.toDate())});a.datepicker=$(".open_calendar_preview",this.el).data("daterangepicker")},initialize:function(a){this.meal_plan_view_list=[];this.show_invite_notification=!0;this.meal_plan_source=a.meal_plan_source;this.read_only=a.read_only;a.current_plan?
(this.todays_date=moment(),this.current_plan=a.current_plan,this.date_view_index={}):this.isCalendar()?(this.todays_date=moment(),this.current_plan=new Date,this.date_view_index={}):this.current_plan=0;_.bindAll(this,"moveCarousel");$(document).on("keydown",this.moveCarousel);this.applyGeneratorListeners();this.isCalendar()?ETM.current_user_profile.attributes.currently_generating&&this.collection.listenToWeeklyPlannerComplete():(this.checkIfUserIsOwner(),ETM.is_premium&&(ETM.email_plan_set_modal?
ETM.email_plan_set_modal.diet_set_id=this.model.attributes.id:ETM.email_plan_set_modal=new ETM.EmailPlanSetModalView({diet_set_id:this.model.attributes.id})))},onClose:function(){$(document).off("keydown",this.moveCarousel)},beforeClose:function(){$(".tutorial_popover").remove()},getPlaceholderDatesList:function(){for(var a=this.getCurrentBreakpoint(),b=a.placeholder_buffer_range-(a.placeholder_selected_index+1),a=Helper.addDays(this.current_plan,-1*a.placeholder_selected_index),b=Helper.addDays(this.current_plan,
b),c=[];a<=b;a.setDate(a.getDate()+1))c.push(Helper.convertDateToString(new Date(a)));return c},getIndexBufferStartEnd:function(){var a=this.getCurrentBreakpoint();return[this.current_plan-this.rendered_view_buffer,this.current_plan+(a.settings.slidesToShow+this.rendered_view_buffer-1)]},getPlaceholderBufferStartEnd:function(){var a=this.getCurrentBreakpoint(),b=a.settings.slidesToShow+this.placeholder_buffer-a.slide_offset-1,a=Helper.addDays(this.current_plan,-1*(a.slide_offset+this.placeholder_buffer)),
b=Helper.addDays(this.current_plan,b);return[Helper.convertDateToString(a),Helper.convertDateToString(b)]},getDownloadBufferStartEnd:function(){var a=this.getCurrentBreakpoint(),b=a.settings.slidesToShow+this.download_buffer-a.slide_offset-1,a=Helper.addDays(this.current_plan,-1*(a.slide_offset+this.download_buffer)),b=Helper.addDays(this.current_plan,b);return[a,b]},getStringDatesToRender:function(){for(var a=this.getCurrentBreakpoint(),b=a.settings.slidesToShow+this.rendered_view_buffer-a.slide_offset-
1,a=Helper.addDays(this.current_plan,-1*(a.slide_offset+this.rendered_view_buffer)),b=Helper.addDays(this.current_plan,b),c=[];a<=b;a.setDate(a.getDate()+1))c.push(Helper.convertDateToString(new Date(a)));return c},loadNextPlan:function(){this.updateTodayLabel();this.showMultiDaySwitchNotification();this.carousel_obj.slickNext()},loadPreviousPlan:function(){this.updateTodayLabel();this.showMultiDaySwitchNotification();this.carousel_obj.slickPrev()},jumpToToday:function(){this.isCalendar()?this.goToDate(new Date):
this.plan_carousel_div.slick("slickGoTo",0)},goToDate:function(a){this.updateTodayLabel();var b=Helper.convertDateToString(a);b!==Helper.convertDateToString(this.current_plan)&&(_.has(this.date_view_index,b)?(a=this.getIndexOfDateString(b)-this.getCurrentBreakpoint().slide_offset,this.plan_carousel_div.slick("slickGoTo",a)):this.updateCarouselItemsFromDate(a))},updateTodayLabel:function(){if(this.isCalendar()){var a=moment();this.todays_date.isSame(a,"day")||(this.todays_date=a,this.trigger("currentDateChanged"))}},
updateCarouselItemsFromDate:function(a){var b=this.current_plan;this.current_plan=a;this.datepicker.setStartDate(a);this.datepicker.setEndDate(a);a=this.getStringDatesToRender();var b=Helper.dates.compare(b,this.current_plan),c=this.getDownloadBufferStartEnd();this.updateCollectionDateRange(c);this.collection.getDietsFromStartAndEndDate(c[0],c[1]);c=this.getPlaceholderBufferStartEnd();_.has(this.date_view_index,c[0])&&_.has(this.date_view_index,c[1])||this.updatePlaceholderViews(b);for(b=0;b<this.meal_plan_view_list.length;b++)_.contains(a,
this.meal_plan_view_list[b].date_string)?this.meal_plan_view_list[b].placeholder&&(this.meal_plan_view_list[b].placeholder=!1,this.meal_plan_view_list[b].render()):this.meal_plan_view_list[b].placeholder||(this.meal_plan_view_list[b].placeholder=!0,this.meal_plan_view_list[b].render())},updateCollectionDateRange:function(a){this.collection.start_date=a[0];this.collection.end_date=a[1]},updateCarouselItemsFromIndex:function(a){this.current_plan=a;a=this.getIndexBufferStartEnd();for(var b=0;b<this.meal_plan_view_list.length;b++)b>=
a[0]&&b<=a[1]?this.meal_plan_view_list[b].placeholder&&(this.meal_plan_view_list[b].placeholder=!1,this.meal_plan_view_list[b].render()):this.meal_plan_view_list[b].placeholder||(this.meal_plan_view_list[b].placeholder=!0,this.meal_plan_view_list[b].render())},initDietSetPlaceholders:function(){var a=new ETM.DietSetIntroView({model:this.model,user_is_owner:this.user_is_owner});this.meal_plan_view_list.push(a);this.plan_carousel_div.slick("slickAdd",a.render().el,!1,!1,!0);for(a=0;a<this.model.attributes.diets.length;a++){var b=
new ETM.SingleDayView({plan_index:a,placeholder:!0,user_is_owner:this.user_is_owner,carousel:this});this.meal_plan_view_list.push(b);this.plan_carousel_div.slick("slickAdd",b.render().el,!1,!1,!0)}this.carousel_obj.reinit(0)},updatePlaceholderViews:function(a){for(var b=this.getPlaceholderDatesList(),c=this.meal_plan_view_list.length-1;0<=c;c--)if(!_.contains(b,this.meal_plan_view_list[c].date_string)){var d=this.meal_plan_view_list[c].date_string;this.plan_carousel_div.slick("slickRemove",c,!1,!1,
!0);this.meal_plan_view_list.splice(c,1)[0].close();delete this.date_view_index[d]}if(-1===a||0===a)for(c=0;c<b.length;c++)a=b[c],_.has(this.date_view_index,a)||(d=new ETM.SingleDayView({plan_date:Helper.parseDateString(a),placeholder:!0,carousel:this}),this.meal_plan_view_list.push(d),this.date_view_index[a]=d,this.plan_carousel_div.slick("slickAdd",d.render().el,!1,!1,!0));else if(1===a)for(c=b.length;0<c--;)a=b[c],_.has(this.date_view_index,a)||(d=new ETM.SingleDayView({plan_date:Helper.parseDateString(a),
placeholder:!0}),this.meal_plan_view_list.unshift(d),this.date_view_index[a]=d,this.plan_carousel_div.slick("slickAdd",d.render().el,0,!0,!0));this.carousel_obj.reinit(this.getIndexOfDateString(Helper.convertDateToString(this.current_plan))-this.getCurrentBreakpoint().slide_offset)},getIndexOfDateString:function(a){return this.meal_plan_view_list.map(function(a){return a.date_string}).indexOf(a)},updateMonthLabel:function(){this.isCalendar()&&$(".current_month",this.el).html(moment(this.current_plan).format("MMMM YYYY"))},
removeCarouselListeners:function(){this.plan_carousel_div.off("afterChange");this.plan_carousel_div.off("breakpoint")},applyCarouselListeners:function(){var a=this;this.plan_carousel_div.on("afterChange",function(b,c,d){a.isCalendar()?(b=d+a.getCurrentBreakpoint().slide_offset,a.meal_plan_view_list[b]&&a.updateCarouselItemsFromDate(a.meal_plan_view_list[b].plan_date),a.updateMonthLabel()):a.meal_plan_view_list[d]&&a.updateCarouselItemsFromIndex(d)});this.plan_carousel_div.on("breakpoint",function(b,
c,d){a.isCalendar()?a.updateCarouselItemsFromDate(a.current_plan):a.updateCarouselItemsFromIndex(a.current_plan)})},render:function(){this.isCalendar()?(this.$el.html(this.template({is_calendar:!0,current_weekday:Helper.getWeekday(this.collection.selected_date.getDay()),email_weekday:Helper.getWeekday(ETM.current_user_profile.attributes.shopping_day-1),show_invite_notification:this.show_invite_notification,btn_size:ETM.is_mobile&&!ETM.is_tablet?"":"btn-lg",regen_week_text:this.getRegenerateWeekText(),
carousel_view:ETM.MealPlanViewState.getCarouselViewType()})),this.initCalendar()):this.$el.html(this.template({is_calendar:!1,user_is_owner:this.user_is_owner,show_back_to_meal_plans:this.show_back_to_meal_plans,show_invite_notification:this.show_invite_notification,btn_size:ETM.is_mobile&&!ETM.is_tablet?"":"btn-lg",regen_week_text:this.getRegenerateWeekText(),carousel_view:ETM.MealPlanViewState.getCarouselViewType()}));this.renderCarousel();return this},renderCarousel:function(){0<this.meal_plan_view_list.length&&
this.clearDietPlanItemList();this.plan_carousel_div&&(this.removeCarouselListeners(),this.plan_carousel_div.slick("unslick"),this.plan_carousel_div.html(""),this.carousel_obj=null);this.plan_carousel_div=$(".planner_day_views",this.el);this.plan_carousel_div.slick({accessibility:!1,draggable:!1,arrows:!1,showEdges:!0,dots:!1,modInfinite:this.isCalendar(),infinite:!1,speed:200,slidesToShow:7,slidesToScroll:1,selectedSlideIndex:1,adaptiveHeight:!1,centerPadding:"30px",responsive:this.getBreakpointSettings()});
this.carousel_obj=this.plan_carousel_div.slick("getSlick");if(this.isCalendar()){this.updateCarouselItemsFromDate(this.current_plan);this.updateMonthLabel();if(!1==ETM.current_user_profile.attributes.allow_week_regenerates||!1==ETM.current_user_profile.attributes.allow_meal_regenerates||!1==ETM.current_user_profile.attributes.allow_day_regenerates||!1==ETM.current_user_profile.attributes.allow_food_refresh||!1==ETM.current_user_profile.attributes.allow_add_delete||!1==ETM.current_user_profile.attributes.allow_save_load_plan||
!1==ETM.current_user_profile.attributes.allow_create_plan||!1==ETM.current_user_profile.attributes.allow_less_used_features||!1==ETM.current_user_profile.attributes.allow_settings_edit)ETM.current_user_profile.attributes.show_walkthrough_prompt=!1;ETM.current_user_profile.attributes.show_walkthrough_prompt&&this.showWalkthroughPopover()}else this.initDietSetPlaceholders(),this.updateCarouselItemsFromIndex(this.current_plan);this.applyCarouselListeners()}});
ETM.MealPlanViewState={_carousel_view_type:null,setState:function(a,b){ETM.local_variables.save({carousel_view:a});this._carousel_view_type=a},needsRerender:function(a){return this.isDifferentState()&&(a===ETM.WEEK_VIEW_LABEL||this.isWeekView())},isDifferentState:function(a){return this.getCarouselViewType()!==a},getCarouselViewType:function(){this._carousel_view_type||(Helper.localStorageExists()?this._carousel_view_type=ETM.local_variables.get("carousel_view"):0<$(".carousel_view_selector").length?
this._carousel_view_type=$(".carousel_view_selector").val():this._carousel_view_type=ETM.MULTI_DAY_VIEW_LABEL,this.getCarouselViewType()!==ETM.SINGLE_DAY_VIEW_LABEL&&this.getCarouselViewType()!==ETM.MULTI_DAY_VIEW_LABEL&&this.getCarouselViewType()!==ETM.WEEK_VIEW_LABEL&&this.setState(ETM.SINGLE_DAY_VIEW_LABEL));return this._carousel_view_type},isSingleDayCarousel:function(){return this.getCarouselViewType()===ETM.SINGLE_DAY_VIEW_LABEL&&ETM.is_logged_in},isMultiDayCarousel:function(){return this.getCarouselViewType()===
ETM.MULTI_DAY_VIEW_LABEL||!ETM.is_logged_in},isWeekView:function(){return this.getCarouselViewType()===ETM.WEEK_VIEW_LABEL}};ETM.SINGLE_DAY_VIEW_LABEL="singleday";ETM.MULTI_DAY_VIEW_LABEL="multiday";ETM.WEEK_VIEW_LABEL="week";
ETM.MealPlanWeekView=ETM.BaseMealPlanView.extend({events:function(){return _.extend({},ETM.BaseMealPlanView.prototype.events,{"click .regenerate_weeks_meals_btn":function(a){this.isCalendar()&&ETM.is_premium||this.openRegenerateModal(a)},"click .submit_regenerate_week":"submitRegenerateWeek","click .interactive_submit_regenerate_week":"submitInteractiveRegenerateWeek"})},hasDateViewWithPlan:function(a){return _.has(this.date_view_index,a)&&_.has(this.date_view_index[a],"model")&&0<this.date_view_index[a].model.stats.calories},
hasDateViewWithNoPlan:function(a){return _.has(this.date_view_index,a)&&(!_.has(this.date_view_index[a],"model")||0===this.date_view_index[a].model.stats.calories)},jumpToToday:function(){this.goToDate(moment())},initCalendar:function(){var a=this.getCurrentWeekStartEnd(),b=a[0],a=a[1],c="Last week, "+moment(b).subtract(7,"d").format("MMM D")+" - "+moment(a).subtract(7,"d").format("MMM D"),d="Current week, "+b.format("MMM D")+" - "+a.format("MMM D"),e="Next week, "+moment(b).add(7,"d").format("MMM D")+
" - "+moment(a).add(7,"d").format("MMM D");ranges_obj={};ranges_obj[c]=[moment(b).subtract(7,"d"),moment(a).subtract(7,"d")];ranges_obj[d]=[b,a];ranges_obj[e]=[moment(b).add(7,"d"),moment(a).add(7,"d")];c=moment(ETM.current_user_profile.attributes.date_joined).subtract(1,"months");c.isBefore(moment().subtract(2,"years"))&&(c=moment().subtract(2,"years"));$(".open_calendar_preview",this.el).daterangepicker({ranges:ranges_obj,startDate:b,endDate:a,maxDate:moment().add(3,"months").format("MM/DD/YYYY"),
minDate:c,autoApply:!0,isCustomDate:function(a){if(a.isSame(moment(),"day"))return"date_is_today"}},function(a,b,c){b.isAfter(moment(a).add(30,"days"))&&(b=moment(a).add(30,"days"));a=a.format("YYYY-MM-DD")+","+b.format("YYYY-MM-DD");ETM.router.navigateAndScroll("dates/"+a+"/",{trigger:!0})});this.datepicker=$(".open_calendar_preview",this.el).data("daterangepicker")},getCurrentWeekStartEnd:function(a){a=a?moment(a):moment();var b=ETM.current_user_profile.attributes.shopping_day+1;7===b&&(b=0);b+=
1;7===b&&(b=0);b=moment(a).day(b);b.isAfter(a,"day")&&b.subtract(7,"d");a=moment(b).add(6,"d");return[b,a]},setDefaultDateRange:function(a){a=this.getCurrentWeekStartEnd(a);this.start_date_obj=a[0];this.end_date_obj=a[1];this.start_date=this.start_date_obj.format("YYYY-MM-DD");this.end_date=this.end_date_obj.format("YYYY-MM-DD");this.updateCollectionDateRange()},goToDate:function(a){this.setDefaultDateRange(a);var b=moment(this.start_date_obj).format("YYYY-MM-DD")+","+moment(this.end_date_obj).format("YYYY-MM-DD");
a=moment(a).format("YYYY-MM-DD");ETM.router.navigateAndScrollTo("dates/"+b+"/","#"+a,{trigger:!0})},scrollToDate:function(a){$("html, body").animate({scrollTop:$("#"+a).offset().top-20},300)},loadDateRange:function(a){a=a.split(",");this.start_date=a[0];this.end_date=a[1];this.start_date_obj=moment(this.start_date);this.end_date_obj=moment(this.end_date);this.updateCollectionDateRange()},updateCollectionDateRange:function(){this.isCalendar()&&(this.collection.start_date=this.start_date_obj.toDate(),
this.collection.end_date=this.end_date_obj.toDate())},initialize:function(a){this.meal_plan_view_list=[];this.show_invite_notification=!0;this.meal_plan_source=a.meal_plan_source;this.read_only=a.read_only;a.daterange?this.loadDateRange(a.daterange):this.setDefaultDateRange(a.current_plan);a.current_plan?(this.todays_date=moment(),this.current_plan=a.current_plan,this.date_view_index={}):this.isCalendar()?(this.todays_date=moment(),this.current_plan=new Date,this.date_view_index={}):this.current_plan=
0;this.applyGeneratorListeners();this.isCalendar()?ETM.current_user_profile.attributes.currently_generating&&this.collection.listenToWeeklyPlannerComplete():(this.checkIfUserIsOwner(),ETM.is_premium&&(ETM.email_plan_set_modal?ETM.email_plan_set_modal.diet_set_id=this.model.attributes.id:ETM.email_plan_set_modal=new ETM.EmailPlanSetModalView({diet_set_id:this.model.attributes.id})))},onClose:function(){},updateDateHeader:function(){this.isCalendar()&&$(".current_date_range",this.el).html(this.start_date_obj.format("MMMM Do")+
" - "+this.end_date_obj.format("MMMM Do, YYYY"))},beforeClose:function(){$(".tutorial_popover").remove()},loadNextPlan:function(){var a=moment(this.end_date_obj).add(1,"days").format("YYYY-MM-DD")+","+moment(this.end_date_obj).add(7,"days").format("YYYY-MM-DD");ETM.router.navigateAndScroll("dates/"+a+"/",{trigger:!0})},loadPreviousPlan:function(){var a=moment(this.start_date_obj).subtract(7,"days").format("YYYY-MM-DD")+","+moment(this.start_date_obj).subtract(1,"days").format("YYYY-MM-DD");ETM.router.navigateAndScroll("dates/"+
a+"/",{trigger:!0})},updateTodayLabel:function(){if(this.isCalendar()){var a=moment();this.todays_date.isSame(a,"day")||(this.todays_date=a,this.trigger("currentDateChanged"))}},renderRegenerateWeekPopover:function(){var a=$(".regenerate_weeks_meals_btn",this.el);amplitude.logEvent("regenerate_week_planner_popover");var b;b=$(ETM.loadNestedTemplate("#RegenerateWeekModalTemplates","#regenerateWeekPopoverView")());if(moment().isBetween(this.start_date_obj,this.end_date_obj,"day","[]"))var c=moment().format("MMM Do")+
" - "+this.end_date_obj.format("MMM Do");else c=this.start_date_obj.format("MMM Do")+" - "+this.end_date_obj.format("MMM Do"),$(".current_week_note",b).hide();$(".date_range_string",b).html(c);a.popover({content:b,container:this.$el,trigger:"click",html:!0,placement:"bottom",offset:"45%p, 10px",template:'<div style="z-index:1039;" class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',flipEnabled:!0});a.on("shown.bs.popover",
function(){})},getRegenerateDateRange:function(){return moment().isBetween(this.start_date_obj,this.end_date_obj,"day","[]")?[moment().format("YYYY-MM-DD")+","+this.end_date_obj.format("YYYY-MM-DD")]:[this.start_date_obj.format("YYYY-MM-DD")+","+this.end_date_obj.format("YYYY-MM-DD")]},currentDayInRange:function(){return moment().isBetween(this.start_date_obj,this.end_date_obj,"day","[]")},render:function(){this.isCalendar()?(this.$el.html(this.template({is_calendar:!0,current_weekday:Helper.getWeekday(this.collection.selected_date.getDay()),
email_weekday:Helper.getWeekday(ETM.current_user_profile.attributes.shopping_day-1),show_invite_notification:this.show_invite_notification,btn_size:ETM.is_mobile&&!ETM.is_tablet?"":"btn-lg",regen_week_text:this.getRegenerateWeekText(),carousel_view:ETM.MealPlanViewState.getCarouselViewType()})),this.initCalendar()):this.$el.html(this.template({is_calendar:!1,user_is_owner:this.user_is_owner,show_back_to_meal_plans:this.show_back_to_meal_plans,show_invite_notification:this.show_invite_notification,
btn_size:ETM.is_mobile&&!ETM.is_tablet?"":"btn-lg",regen_week_text:this.getRegenerateWeekText(),carousel_view:ETM.MealPlanViewState.getCarouselViewType()}));this.renderPlans();ETM.is_premium&&this.isCalendar()&&this.renderRegenerateWeekPopover();if(!ETM.local_variables.attributes.seen_week_view_info&&!ETM.is_mobile){ETM.local_variables.save({seen_week_view_info:!0});var a=new ETM.WeekViewInfoModal;a.getModalElement().html(a.render().el);a.$el.modal({backdrop:"static",show:!0})}return this},renderPlans:function(){0<
this.meal_plan_view_list.length&&this.clearDietPlanItemList();this.plan_container&&this.plan_container.html("");this.plan_container=$(".plan_container",this.el);this.isCalendar()?this.renderDateRange():this.renderDietSet()},renderDietSet:function(){var a=this,b=new ETM.DietSetIntroView({model:this.model,user_is_owner:this.user_is_owner});this.meal_plan_view_list.push(b);for(b=0;b<this.model.attributes.diets.length;b++){var c=new ETM.SingleDayView({plan_index:b,user_is_owner:this.user_is_owner,parent_view:this});
this.meal_plan_view_list.push(c)}_.each(this.meal_plan_view_list,function(b){a.plan_container.append(b.render().el)})},renderDateRange:function(){var a=this.start_date_obj.toDate(),b=this.end_date_obj.toDate();this.datepicker.setStartDate(a);this.datepicker.setEndDate(b);for(this.collection.getDietsFromStartAndEndDate(a,b);a<=b;a.setDate(a.getDate()+1)){var c=Helper.convertDateToString(new Date(a)),d=new ETM.SingleDayView({plan_date:new Date(a),parent_view:this});this.meal_plan_view_list.push(d);
this.date_view_index[c]=d;this.plan_container.append(d.render().el)}this.updateDateHeader()},submitRegenerateWeek:function(){var a=this,b={reset_groceries:!0===$(".reset_groceries_check",this.el).is(":checked"),regenerate_weeks:this.getRegenerateDateRange(),send_email:!1},c=b.regenerate_weeks[0].split(",")[0],d=b.regenerate_weeks[b.regenerate_weeks.length-1].split(",")[1];ETM.calendar_list.regenerateWeeks(b);b.regenerate_weeks=JSON.stringify(b.regenerate_weeks);ETM.analytics.logRegenerate(b);ETM.generator_results_cache.clearCache();
ETM.current_user_profile.v2AlgorithmEnabled()?$.ajax({type:"POST",url:"/g/generate/week/",dataType:"json",data:{week_gen_start_date:c,week_gen_end_date:d,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds()),reset_groceries:!0===$(".reset_groceries_check",this.el).is(":checked"),send_email:!1},success:function(b){add_v2_food_info_objects(b.food_infos);ETM.calendar_list.finishedWeeklyPlannerV2(b.results);Helper.displayIssues(b.issues);a.currentDayInRange()&&a.scrollToDate(moment().format("YYYY-MM-DD"))},
error:function(a){ETM.generator_status.trigger("finishedWeeklyPlanner",a.responseJSON)}}):($.ajax({type:"POST",url:"/regenerate-weeks/",data:b,success:function(a){ETM.generator_status.trigger("finishedWeeklyPlanner",a)},error:function(){ETM.generator_status.trigger("finishedWeeklyPlanner","ERROR")}}),a.currentDayInRange()&&a.scrollToDate(moment().format("YYYY-MM-DD")));$(".regenerate_weeks_meals_btn",this.el).popover("hide")},submitInteractiveRegenerateWeek:function(){var a={reset_groceries:!0===
$(".reset_groceries_check",this.el).val(),regenerate_weeks:this.getRegenerateDateRange(),send_email:!1};$(".regenerate_weeks_meals_btn",this.el).popover("hide");a=new ETM.GuidedPlanningToolModalView({model:a});a.getModalElement().html(a.render().el);a.$el.modal({show:!0,backdrop:"static"})},getVisiblePlans:function(){var a=[],b;for(b in this.date_view_index)this.date_view_index.hasOwnProperty(b)&&a.push(this.date_view_index[b]);return a}});
ETM.WeekViewInfoModal=ModalView.extend({modal_id:"week_view_info",events:{},initialize:function(a){},render:function(){this.$el.html(this.template({dont_show_again:this.dont_show_again,is_diet:this.is_diet}));this.$el.modal({show:!1});return this}});ETM.ShareDietModalView=ModalView.extend({modal_id:"share_diet_modal",events:{"click .copy_permalink":function(){Helper.copyPermalink($(".share_diet_permalink",this.el))}},render:function(){this.$el.html(this.template({model:this.model}));return this}});
ETM.ImportDietSetModalView=ModalView.extend({modal_id:"import_diet_set_modal",events:{"click .import_diet_set":"importDietSet","click .view_saved_plans":"viewSavedPlans"},render:function(){this.$el.html(this.template({model:this.model}));return this},importDietSet:function(){var a=this,b=$("#diet_title",this.el).val().trim();if(!b||/^\s*$/.test(b))b=this.model.attributes.title;b={diet_set_id:this.model.attributes.id,title:b};$(".ajax_progress",this.el).show();$(".footer_buttons",this.el).hide();$(".ajax_failure",
this.el).hide();$.post("/weeklyplanner/import-diet-set/",b,function(b){var d=[ETM.nutrition_profile_list.fetch(),ETM.meal_type_list.fetch()];$.when.all(d).then(function(d){d=JSON.parse(b);ETM.diet_set_list.add(d);$(".ajax_progress",a.el).hide();$(".ajax_success",a.el).show()})})},viewSavedPlans:function(){this.$el.modal("hide");ETM.router.navigateAndScroll("preferences/saved/",{trigger:!0});$(".saved_plans_div").get(0).scrollIntoView()}});
ETM.ImportSingleDietModalView=ModalView.extend({modal_id:"import_single_diet_modal",events:{"click .import_diet_set":"importSingleDietFromSet","click .view_saved_plans":"viewSavedPlans"},render:function(){this.$el.html(this.template({model:this.model}));return this},selectDietAtIndex:function(a){$(".select_diet_from_set",this.el).val(ETM.diet_plan_set.attributes.diets.at(a).get("id"))},selectCurrentDiet:function(){$(".select_diet_from_set",this.el).val(ETM.diet_plan_set.selected_plan.toString())},
importSingleDietFromSet:function(){var a=this,b=parseInt($(".select_diet_from_set",this.el).val()),c=$("#diet_title",this.el).val().trim();if(!c||/^\s*$/.test(c))c=this.model.attributes.title;var d=ETM.diet_plan_set.getIndexFromID(b),b={selected_diet_id:b,title:c,description:"Day "+(d+1)+" plan from "+this.model.attributes.title};$(".ajax_progress",this.el).show();$(".footer_buttons",this.el).hide();$(".ajax_failure",this.el).hide();$.post("/weeklyplanner/import-diet-from-set/",b,function(b){var c=
[ETM.nutrition_profile_list.fetch(),ETM.meal_type_list.fetch()];$.when.all(c).then(function(c){c=JSON.parse(b);ETM.diet_set_list.add(c);$(".ajax_progress",a.el).hide();$(".ajax_success",a.el).show()})})},viewSavedPlans:function(){this.$el.modal("hide");ETM.router.navigateAndScroll("preferences/saved/",{trigger:!0});$(".saved_plans_div").get(0).scrollIntoView()}});
ETM.CopyDayModalView=ModalView.extend({modal_id:"copy_day_modal",id:"copy_day_modal",events:{"click #copy_btn":function(a){$(".copy_modal_error",this.el).empty();a.preventDefault();ETM.diet_plan_set?this.dietSetCopy(a):this.calendarCopy(a)}},initialize:function(a){ETM.diet_plan_set?this.selected_day=a.selected_day:this.selected_date=a.plan_date},render:function(){var a;a=ETM.diet_plan_set?"Day "+(this.selected_day+1):ETM.JS_DAY_LIST[this.selected_date.getDay()]+" "+Helper.convertDateToShortString(this.selected_date);
var b=0;this.model.attributes.meals.forEach(function(a){a.attributes.foods.forEach(function(a){b++})});this.$el.html(this.template({date_string:a,num_foods:b,num_meals:this.model.attributes.meals.length,calories:roundNumber(this.model.stats.calories,0)}));this.renderForm();return this},renderForm:function(){ETM.diet_plan_set?this.renderDietSetForm():this.renderCalendarForm()},renderDietSetForm:function(){this.day_options=[];for(var a=1;a<=ETM.diet_plan_set.attributes.diets.length;a++)this.day_options.push(a);
this.form=(new Backbone.Form({schema:{days:{type:"MultipleSelect",multipleSelectOptions:{placeholder:"Select at least one day",selectAll:!1,minimumCountSelected:10,allSelected:!1},options:this.day_options}},template:ETM.loadTemplate("#CopyDayDietSetForm")})).render();$(".copy_form",this.el).html(this.form.render().el)},renderCalendarForm:function(){this.date_options=[];var a=Helper.addDays(this.selected_date,-3),b=-3;a>new Date&&(a=Helper.addDays(this.selected_date,-7),b=-7);for(var c=Helper.addDays(this.selected_date,
ETM.is_premium?14:0),a=new Date(a.valueOf());a<=c;a=Helper.addDays(a,1)){var d=ETM.JS_DAY_LIST[a.getDay()];-1==b?d="Previous day":0==b?d="Same day":1==b&&(d="Next day");this.date_options.push({val:Helper.convertDateToString(a),label:d+" "+Helper.convertDateToShortString(a)});b+=1}this.form=new Backbone.Form({schema:{dates:{type:"MultipleSelect",multipleSelectOptions:{placeholder:"Select at least one date",selectAll:!1,minimumCountSelected:10,allSelected:!1},options:this.date_options}},data:{date:Helper.convertDateToString(this.selected_date)},
template:ETM.loadTemplate("#CopyDayCalendarForm")});$(".copy_form",this.el).html(this.form.render().el)},calendarCopy:function(a){var b=this,c=this.form.getValue().dates;if(null!=this.model&&null!=c&&0<c.length){var d=$(a.currentTarget).ladda();d.ladda("start");$.ajax({url:"/weeklyplanner/copy-day-calendar/",data:{source_diet_id:this.model.attributes.id,copy_dates:JSON.stringify(c)},type:"POST",success:function(a){c.forEach(function(a){a=ETM.calendar_list.date_index[a];null!=a&&"object"===typeof a&&
null!=a.attributes.diet&&(a=a.attributes.diet.attributes.meals,null!=a&&a.forEach(function(a){null!=a.attributes.foods&&a.attributes.foods.forEach(function(a){a.updateRelatedLeftovers("delete")})}))});ETM.calendar_list.reloadDietsInDateList(c,function(){d.ladda("stop");b.$el.modal("hide");0==a?Helper.warnToast("This day was not copied to any other days.",5E3):Helper.successToast("Successfully copied to "+a+" days",5E3)})},error:function(a,c,g){d.ladda("stop");$(".copy_modal_error",b.el).html('<div class="alert alert-danger">There was an error copying this day.</div>')}})}else $(".copy_modal_error",
this.el).html('<div class="alert alert-danger">Must select a valid date to copy to.</div>')},dietSetCopy:function(a){var b=this,c=this.form.getValue().days;if(null!=this.model&&null!=c){var d=$(a.currentTarget).ladda();d.ladda("start");$.ajax({url:"/weeklyplanner/copy-day-diet-set/",data:{diet_set_id:ETM.diet_plan_set.attributes.id,source_diet_id:this.model.attributes.id,copy_to_days:JSON.stringify(c)},type:"POST",success:function(a){var c=ETM.diet_plan_set.attributes.diet_key+ETM.diet_plan_set.attributes.id;
ETM.diet_plan_set=null;ETM.fetchAndRenderDietSet(c,function(){d.ladda("stop");b.$el.modal("hide");0==a?Helper.warnToast("This day was not copied to any other days.",5E3):Helper.successToast("Successfully copied to "+a+" days",5E3)})},error:function(a,c,g){d.ladda("stop");$(".copy_modal_error",b.el).html('<div class="alert alert-danger">There was an error copying this day.</div>')}})}else $(".copy_modal_error",this.el).html('<div class="alert alert-danger">Must select a valid day to copy to.</div>')}});
ETM.has_seen_walkthrough=!1;
ETM.LoggedOutDayView=Backbone.View.extend({events:{"click .gen_button, .day_refresh_button":"generateDiet","change .num_meals_selector":"numMealsChanged","click .preset_selector .nav-item":"presetDietChanged","keyup #cal_input":"processKey","change #cal_input":"changeCalories","click .open_calculator, #not_sure_button":"showNutritionCalculator","click .change_options":function(){this.toggleGeneratorHeader("show")},"click .collapse_header":function(){this.toggleGeneratorHeader("hide")},"click .free_overview":function(){ETM.start_free_walkthrough()},
"click .close-show-walkthrough":function(){$(".walkthrough-prompt").remove();ETM.current_user_profile.save({show_walkthrough_prompt:!1})},"click .update_macros":function(a){a.preventDefault();this.updateMacros()}},updateMacros:function(a){$("#update_macros_validation",this.el).hide();var b=this.model.attributes.nutrition_profile;b.changePresetDiet(ETM.current_user_profile.attributes.preset_diet)?(this.presetDietDidChange=!1,$(".preset_diet_update_macros",this.el).hide()):a?(this.presetDietDidChange=
!1,b.scaleMacrosForPresetDiet(ETM.current_user_profile.attributes.preset_diet)):($("#update_macros_validation",this.el).show(),$("#update_macros_validation",this.el).html('Please complete your <a href="javascript:void(0);" class="open_calculator"><i class="fa fa-calculator" aria-hidden="true"></i> User Profile</a> to allow us to suggest macros for your diet.'))},processKey:function(a){13===a.which&&this.generateDiet(a)},isCalendar:function(){return!1},initialize:function(a,b){var c=this;this.showing_loading_text=
this.has_clicked_generate=this.presetDietDidChange=!1;this.progressbar_timer=null;this.initProgressBar=ETM.SingleDayView.prototype.initProgressBar.bind(this);this.collapseProgressBar=ETM.SingleDayView.prototype.collapseProgressBar.bind(this);this.load_premade_diet=this.hide_prompts=!1;"undefined"!==typeof b&&(this.hide_prompts=null!=b.hide_prompts?b.hide_prompts:!1,this.load_premade_diet=null!=b.load_premade_diet?b.load_premade_diet:!1,this.premade_calories=b.calories,this.premade_diet_type=b.diet_type);
this.single_plan_view=new ETM.SinglePlanView({model:this.model});this.single_plan_view.parent_day_view=this;this.listenTo(this.single_plan_view,"hideMealsAndStats",function(){$(".walkthrough-prompt",this.el).hide();$(".day_refresh_button",this.el).popover("dispose");ETM.is_logged_in||($(".day_plan_container",this.el).hide(),$(".enter_some_calories",this.el).css("display","block"))},this);this.listenTo(this.model,"update-progress",function(a){100<a&&(a=100);$(".progress-bar",this.el).css({width:a+
"%"})});this.listenTo(this.model,"deleteDiet",function(){this.render()},this);this.listenTo(this.model.attributes.nutrition_profile,"change:calories",this.updateCalories,this);this.listenTo(this.model,"finishedGeneratingSaved",function(){0===c.model.stats.calories?(this.hideGeneratingText(),c.generate_button.data("ladda")&&c.generate_button.ladda("stop"),c.generate_refresh_button.find(".etm-icon").one("animationiteration webkitAnimationIteration",function(){$(this).removeClass("icon-rotating");c.generate_refresh_button.removeAttr("disabled")})):
this.showing_loading_text?this.listenToOnce(this,"finishedLoadingMessages",function(){this.showing_loading_text=!1;this.slideDownAndShowPlan();this.afterFinishingLoggedOutGenerate()},this):(this.showing_loading_text=!1,this.slideDownAndShowPlan(),this.afterFinishingLoggedOutGenerate())},this)},slideDownAndShowPlan:function(){$(".day_plan_container",this.el).slideDown(1E3);$(".walkthrough-prompt",this.el).show();$(".auto_generator_div",this.el).slideUp(500);ETM.has_seen_walkthrough||ETM.is_mobile||
(setTimeout(this.showWalkthroughPrompt,1E3),ETM.has_seen_walkthrough=!0);!this.has_toggled_header&&this.has_clicked_generate&&($(".expand_header_buttons",this.el).css("display","block"),this.toggleGeneratorHeader("hide"),ETM.is_mobile&&$("html, body").animate({scrollTop:$(".home_generator_box").offset().top-20},1E3));ETM.is_mobile&&setTimeout(function(){$(".signup_footer").show("slide",{direction:"down"},500)},7E3);ETM.is_logged_in||$(".enter_some_calories",this.el).is(":visible")&&$(".enter_some_calories",
this.el).fadeOut(600)},showGeneratingText:function(){function a(){$(".insert-loading-text",b.el).html(c[e]);e++;e<c.length?b.load_text_timer=setTimeout(a,d):(b.showing_loading_text=!1,b.trigger("finishedLoadingMessages"))}var b=this;b.showing_loading_text=!0;var c=["Combobulating calories...","Chopping onions...","Crying because of onions...","Almost there..."];$(".loading-text",this.el).show();$(".loading-text .insert-loading-text",this.el).html(c[0]);clearTimeout(b.load_text_timer);var d=1300,e=
1;b.load_text_timer=setTimeout(a,d)},hideGeneratingText:function(){$(".loading-text",this.el).hide()},afterFinishingLoggedOutGenerate:function(){var a=this;this.hideGeneratingText();a.single_plan_view.renderMeals();a.single_plan_view.model.trigger("updateStats");a.generate_button.data("ladda")&&a.generate_button.ladda("stop");a.generate_refresh_button.find(".etm-icon").one("animationiteration webkitAnimationIteration",function(){$(this).removeClass("icon-rotating");a.generate_refresh_button.removeAttr("disabled")});
setTimeout(function(){a.collapseProgressBar($(".day-generator-progress",a.el))},650)},showWalkthroughPrompt:function(){if(ETM.is_mobile)var a='Tap the <svg class="etm-icon etm-icon-xs"><use xlink:href="#icon-refresh3"></use></svg> Refresh buttons to get new suggestions, and tap foods to get more detail. Also, everything is customizable!',b="top",c=$(".day_refresh_button");else a='Click <svg class="etm-icon etm-icon-xs"><use xlink:href="#icon-refresh3"></use></svg> Regenerate to get a new meal plan.<br/>(There are also <svg class="etm-icon etm-icon-xs"><use xlink:href="#icon-refresh3"></use></svg> refresh buttons on the meals and foods). Also, everything is customizable!',
b="right",c=$(".day_refresh_button");Helper.confirmationPopover({element:c,message:a,footer_message:"Want more info? Take the tour!",position:b,custom_class:"wide-popover",hide_cancel:!1,cancel_text:"No thanks",confirm_text:"Start the tour",zindex:1038,confirmCallback:function(){ETM.start_free_walkthrough()},cancelCallback:function(){}})},toggleGeneratorHeader:function(a,b){this.has_toggled_header=!0;var c=$(".generator_header_div",this.el),d=$(".collapse_header",this.el),e=$(".change_options",this.el);
if("show"===a||"undefined"===typeof a&&!c.is(":visible"))b?c.show():c.slideDown(1E3),d.css("display","block"),e.css("display","none");else if("hide"===a||"undefined"===typeof a&&c.is(":visible"))b?c.hide():c.slideUp(1E3),d.css("display","none"),e.css("display","block")},changeCalories:function(a){a=parseInt($("#cal_input",this.el).val());var b=this.model.attributes.nutrition_profile.get("calories");a!==b&&(ETM.generator_results_cache.clearCache(),this.model.attributes.nutrition_profile.manually_edited?
(this.model.attributes.nutrition_profile.scaleMacrosFromCalories(a,b),this.model.attributes.nutrition_profile.save({calories:a})):(this.model.attributes.nutrition_profile.save({calories:a}),this.model.attributes.nutrition_profile.scaleMacrosForPresetDiet(ETM.current_user_profile.attributes.preset_diet)))},updateCalories:function(){$("#cal_input",this.el).is(":focus")||(this.model.attributes.nutrition_profile.attributes.calories?$("#cal_input",this.el).val(this.model.attributes.nutrition_profile.attributes.calories):
$("#cal_input",this.el).val(""))},showNutritionCalculator:function(){this.nutritionCalculator.$el.modal("show")},render:function(a){ETM.$fill_container.addClass("tomato_background");ETM.$fill_container.addClass("tomato_background_left");var b;b=this.load_premade_diet&&this.premade_calories?this.premade_calories:"undefined"!=typeof this.model.attributes.nutrition_profile?this.model.attributes.nutrition_profile.attributes.calories:null;var c=$("#premade_diet_plan"),d=$("#seo_content");this.$el.html(this.template({has_premade_diet_plan:0<
c.length,load_premade_diet:this.load_premade_diet,premade_diet_type:"atkins / ketogenic"===this.premade_diet_type?"keto":this.premade_diet_type,attributes:this.model.attributes,premade_calories:this.premade_calories,calories:b,show_walkthrough:ETM.current_user_profile.attributes.show_walkthrough_prompt,hide_prompts:this.hide_prompts}));Helper.lazyLoadYoutubeIframes();0<c.length&&$(".insert_diet_plan_html",this.el).html(c.html());0<d.length&&($(".diet_plan_seo_html_container",this.el).show(),$(".insert_diet_plan_seo_html",
this.el).html(d.html()));$(".single_day_view",this.el).html(this.single_plan_view.render(a).el);this.nutritionCalculator=new ETM.NutritionCalculatorView({model:ETM.current_user_profile},{nutrition_profile:this.model.attributes.nutrition_profile,go_back_enabled:!1,save_user_profile:!0,show_profile_alert:!1});this.listenTo(this.nutritionCalculator,"useCalculatedSettings",function(){$(".preset_diet_update_macros",this.el).hide();$("#update_macros_validation",this.el).hide();this.model.attributes.nutrition_profile.save()},
this);this.nutritionCalculator.getModalElement().html(this.nutritionCalculator.render().el);$(".preset_selector .nav-link",this.el).removeClass("active");this.load_premade_diet&&-1!=ETM.PRESET_DIET_TYPES.indexOf(this.premade_diet_type)?($(".preset_selector [data-value='"+this.premade_diet_type+"'] a.nav-link",this.el).addClass("active"),ETM.current_user_profile.set("preset_diet",this.premade_diet_type)):$(".preset_selector [data-value='"+ETM.current_user_profile.get("preset_diet")+"'] a.nav-link",
this.el).addClass("active");$(".faq_title",this.el).click(function(a){$(this).next(".faq_text").slideToggle("slow")});this.generate_button=$(".gen_button",this.el);this.generate_refresh_button=$(".day_refresh_button",this.el);a=$(".floating_signup_form");a.detach().appendTo($(".insert_signup_form_here",this.el));a.show();return this},planHasBeenGenerated:function(){return this.has_clicked_generate||!$(".enter_some_calories",this.el).is(":visible")||0!==this.single_plan_view.plan_stats_view.model.stats.calories},
autoStartGenerator:function(){this.toggleGeneratorHeader("hide",!0);this.has_toggled_header=!1;$(".enter_some_calories",this.el).is(":visible")&&$(".enter_some_calories",this.el).hide();$(".auto_generator_div",this.el).show();ETM.is_mobile&&$("html, body").animate({scrollTop:$(".auto_generator_div").offset().top+10},0);this.generateDiet()},generateDiet:function(a){!ETM.currently_generating&&this.initialCalorieValidation()&&(this.planHasBeenGenerated()||(this.logFirstGenerate(),this.showGeneratingText()),
this.has_clicked_generate=!0,ETM.startedGenerating(),this.changeCalories(),this.presetDietDidChange&&this.updateMacros(!0),this.generate_button.ladda(),this.generate_button.ladda("start"),this.initProgressBar(),this.generate_refresh_button.find(".etm-icon").addClass("icon-rotating"),this.generate_refresh_button.attr("disabled","true"),this.single_plan_view.generateDiet())},logFirstGenerate:function(){amplitude.getInstance().logEvent("first_generate_diet",{algorithm:ETM.current_user_profile.get("algorithm")});
bugsnagClient.leaveBreadcrumb("Initial generate")},initialCalorieValidation:function(){ETM.toast.clear();$("#cal_input",this.el).removeClass("is-invalid");var a=parseInt($("#cal_input",this.el).val()),b=parseInt($(".num_meals_selector",this.el).val());return 0<b&&4E3<a/b||100>a/b||isNaN(a)?(a=100*b,200>a&&(a=200),ETM.toast.showNotification({message:"For "+b+" meals, please enter between "+a+" and "+4E3*b+" calories.",type:"error"}),$("#cal_input",this.el).addClass("is-invalid"),!1):!0},numMealsChanged:function(){this.model.set({num_meals:parseInt($(".num_meals_selector",
this.el).val())})},presetDietChanged:function(a){var b=$(a.currentTarget).data("value");$(".preset_selector .nav-link",this.el).removeClass("active");$(".nav-link",a.currentTarget).addClass("active");a="atkins / ketogenic"===b;ETM.generator_results_cache.clearCache();ETM.current_user_profile.save({preset_diet:b,use_net_carbs:a});0!==this.single_plan_view.plan_stats_view.model.stats.calories&&this.model.attributes.nutrition_profile.manually_edited?$(".preset_diet_update_macros",this.el).show():this.presetDietDidChange=
!0}});
ETM.SingleDayView=Backbone.View.extend({events:{},initialize:function(a){this.progressbar_timer=null;this.status="init";this.placeholder=!1;a.placeholder&&(this.placeholder=a.placeholder);this.user_is_owner=!0;_.has(a,"user_is_owner")&&(this.user_is_owner=a.user_is_owner);if(a.plan_date){if(this.plan_date=a.plan_date,this.date_string=Helper.convertDateToString(a.plan_date),"object"===typeof this.model&&this.model.attributes.currently_generating||"generating"===this.model)this.currently_generating=!0}else this.plan_index=
a.plan_index;a.carousel&&(this.parent_carousel=a.carousel);this.day_header_view=new ETM.DayHeaderView({parent:this});this.initializeEvents()},initializeEvents:function(){this.listenForDietUpdates();this.listenToGenerator();this.listenForDateUpdates()},onClose:function(){delete this.parent_carousel},initStatus:function(){if(this.isCalendar()){var a=ETM.calendar_list.getCalendarDiet(this.plan_date);"generating"===a||"object"===typeof a&&a.attributes.currently_generating?this.status="generating":"blank"===
a||"object"===typeof a&&null==a.attributes.diet?this.status="blank":"downloading"===a?this.status="downloading":"object"===typeof a&&(this.status="okay",this.model=a.attributes.diet)}else 0<=this.plan_index&&ETM.diet_plan_set.attributes.diets.length>this.plan_index&&(this.model=a=ETM.diet_plan_set.attributes.diets.at(this.plan_index),this.status="okay")},runGenerator:function(){var a=$(".day_refresh_button",this.el);ETM.startedGenerating();this.initProgressBar();a.find(".etm-icon").off("animationiteration");
a.find(".etm-icon").addClass("icon-rotating");a.attr("disabled","true");try{_.each(this.day_plan_view.meal_list.meal_views,function(a){!0===a.model.attributes.eaten&&a.$el.find(".eaten_lock_icon").show()})}catch(b){}this.day_plan_view.model.generateOnServer()},generatePlan:function(a){ETM.currently_generating||"generating"===this.status||"downloading"===this.status||("blank"===this.status&&this.loadFromTemplate(),this.runGenerator())},listenForDateUpdates:function(){this.isCalendar()&&this.parent_carousel&&
this.listenTo(this.parent_carousel,"currentDateChanged",function(){moment().isSame(moment(this.plan_date),"day")?this.$el.addClass("current-day-slide"):this.$el.removeClass("current-day-slide")},this)},listenForDietUpdates:function(){var a=this.isCalendar()?ETM.calendar_list:ETM.diet_plan_set;this.listenTo(a,this.date_string,function(a){this.status=a.status;_.has(a,"diet_object")&&(this.model=a.diet_object);_.has(a,"skip_render")&&a.skip_render||this.render()},this)},listenToGenerator:function(){var a=
this;this.listenTo(ETM.generator_status,"weeklyProgressUpdated",function(b){"generating"===a.status&&("SUCCESS"===b?($(".loading_percent",a.el).html("Finishing..."),a.currently_generating=!1):"ERROR"===b?($(".loading_percent",a.el).html(""),$(".generating_diet_preview",a.el).html(""),$(".loading_status",a.el).html("Error :(")):$(".loading_percent",a.el).html(ETM.generator_status.getCurrentProgressShort()))})},isCalendar:function(){return"undefined"!==typeof this.plan_date},isBlocked:function(){return this.isCalendar()&&
!ETM.is_premium&&moment(this.plan_date).isAfter(moment(),"day")},shouldRenderDay:function(){return!this.placeholder&&"okay"===this.status&&this.model},loadAndRenderAppropriateView:function(){this.placeholder?this.renderPlaceholderView():this.isBlocked()?this.renderLockedPremiumView():("init"===this.status&&this.initStatus(),"generating"===this.status?this.renderGeneratingView():"blank"===this.status?this.renderNoDietView():"downloading"===this.status?this.renderLoadingDayView():"okay"===this.status?
(this.model.calculateStats(),this.renderDayView(),this.day_header_view.renderStats(),0===this.model.stats.calories&&this.day_plan_view.showMealsAndStats()):this.renderPlaceholderView())},render:function(){var a=this.isCalendar()&&moment().isSame(moment(this.plan_date),"day");this.$el.html(this.template({id_string:this.isCalendar()?this.date_string:"plan-"+this.plan_index,today:a}));$(".day_header",this.el).html(this.day_header_view.render().el);this.day_header_view.delegateEvents();this.loadAndRenderAppropriateView();
a&&this.$el.addClass("current-day-slide");return this},renderHeaderView:function(){this.day_header_view.render()},renderDayView:function(){Helper.lockPageHeight();this.removeOldViews();this.day_plan_view=this.user_is_owner?new ETM.SinglePlanView({model:this.model}):new ETM.ReadOnlySinglePlanView({model:this.model});this.day_plan_view.parent_day_view=this;$(".main_column",this.el).html(this.day_plan_view.render(!0).el);this.day_plan_view.printGraph();var a=parseInt(UrlFunctions.getUrlParameter("food_id")),
b=!1;UrlFunctions.getUrlParameter("date")&&-1!=Backbone.history.fragment.indexOf("date")&&(b=UrlFunctions.getUrlParameter("date"));a&&b===this.date_string&&this.day_plan_view.highlightFoods(a)&&ETM.MealPlanViewState.isWeekView()&&$("html, body").animate({scrollTop:$("#"+this.date_string).offset().top-20},300);this.applyDietListeners();Helper.unlockPageHeight()},loadPlan:function(a){var b=ETM.calendar_list.findWhere({date:this.date_string});null==b&&(b=new ETM.CalendarDiet);b.attributes.diet=a;b.attributes.date=
this.date_string;b.save(null,{async:!1});a=b.attributes.diet;ETM.calendar_list.date_index[this.date_string]=b;ETM.calendar_list.add(b);a.parent=b;this.model=a;this.status="okay";this.renderDayView(b);this.day_plan_view.showMealsAndStats()},loadFromTemplate:function(){var a=ETM.template_diet_list.getTemplateDietAtIndex(this.plan_date.getDay()).attributes.diet.clone();Helper.clearIDs(a);a.attributes.meals.each(function(a){Helper.clearIDs(a)});this.loadPlan(a)},loadPreviousDiet:function(a,b){var c=this;
"undefined"!=typeof this.date_string||Helper.convertDateToString(new Date);$.get("/cal/previous-diet/"+this.date_string+"/",function(d){"No calendar diet"==d?(d=new ETM.Diet,d.setupBlankDiet()):(d=new ETM.Diet(JSON.parse(d)),Helper.clearIDs(d),d.attributes.meals.each(function(b){Helper.clearIDs(b);a?(b.attributes.foods.reset([]),b.attributes.eaten=!1):(b.attributes.eaten=!1,b.attributes.foods.each(function(a){Helper.clearIDs(a);a.attributes.is_leftovers=!1;a.attributes.has_leftovers=!1;a.attributes.leftovers_from=
null;a.attributes.makes_leftovers_for.reset([])}))}));c.loadPlan(d);c.day_plan_view.showMealsAndStats();"undefined"!==typeof b&&b(d)})},applyDietListeners:function(a){var b=this,c=$(".day-generator-progress",this.el);this.isCalendar()?this.listenTo(b.model,"deleteCalendarDiet",function(){Helper.lockPageHeight();var a=b.model.parent;delete ETM.calendar_list.date_index[a.attributes.date];ETM.calendar_list.date_index[a.attributes.date]="blank";b.status="blank";b.model.destroy();a.destroy();b.renderNoDietView();
Helper.unlockPageHeight()},this):this.listenTo(b.model,"deleteDietFromSet",function(){Helper.lockPageHeight();var a=b.model.collection.indexOf(b.model);b.model.destroy();b.close();ETM.diet_plan_set_view.render();Helper.unlockPageHeight();setTimeout(function(){ETM.diet_plan_set_view.scrollToCarouselIndex(a)},500)},this);this.listenTo(b.model,"insertBlankDayAtThisDiet",function(){$.ajax({url:"/weeklyplanner/insert-blank-day/",data:{resource_uri:b.model.attributes.resource_uri},type:"POST",success:function(a){if(b.isCalendar())a=
JSON.parse(a),ETM.calendar_list.reloadDietsInDateList(a,function(){ETM.toast.showNotification({message:"Successfully inserted day.",type:"success"})});else{var c=b.model.collection.indexOf(b.model);ETM.diet_plan_set.fetch({success:function(){ETM.renderDietSet();ETM.toast.showNotification({message:"Successfully inserted day.",type:"success"});setTimeout(function(){ETM.diet_plan_set_view.scrollToCarouselIndex(c)},500)}})}},error:function(a,c,f){ETM.toast.showNotification({message:"An error happened while trying to insert a day. Please refresh the page to make sure your planner is up-to-date.",
type:"error"});bugsnagClient.notify(Error("Error while inserting blank day into diet plan"),{is_calendar:b.isCalendar(),msg:c})}})});this.listenTo(b.model,"update-progress",function(a,b){100<a&&(a=100);b&&c.find(".progress-bar").addClass(b+"-width-transition");c.find(".progress-bar").css({width:a+"%"});b&&c.find(".progress-bar").removeClass(b+"-width-transition")});this.listenTo(b.model,"finishedGeneratingSaved",function(){this.collapseProgressBar(c);var a=$(".day_refresh_button",this.el);a.find(".etm-icon").one("animationiteration",
function(){$(this).removeClass("icon-rotating");a.removeAttr("disabled")})},this)},initProgressBar:function(){clearTimeout(this.progressbar_timer);var a=$(".day-generator-progress",this.el);a.css({opacity:"1"});a.find(".progress-bar").addClass("notransition");a.find(".progress-bar").css({width:"0%"});a.find(".progress-bar").removeClass("notransition")},collapseProgressBar:function(a){var b=a.find(".progress-bar");a.css({opacity:"0"});clearTimeout(this.progressbar_timer);this.progressbar_timer=setTimeout(function(){b.addClass("notransition");
b.css({width:"0%"});b.removeClass("notransition")},300)},renderNoDietView:function(){this.removeOldViews();this.no_diet_view=new ETM.NoDietView({parent:this});$(".main_column",this.el).html(this.no_diet_view.render().el);this.no_diet_view.delegateEvents()},renderLoadingDayView:function(){this.loading_view&&this.loading_view.close();this.loading_view=new ETM.LoadingDayView({parent:this});$(".main_column",this.el).html(this.loading_view.render().el);this.loading_view.delegateEvents()},renderLockedPremiumView:function(){this.removeOldViews();
this.locked_date_view=new ETM.LockedPremiumDayView({parent:this});$(".main_column",this.el).html(this.locked_date_view.render().el);this.locked_date_view.delegateEvents()},renderPlaceholderView:function(){this.removeOldViews();this.placeholder_view=new ETM.PlaceholderDayView({parent:this});$(".main_column",this.el).html(this.placeholder_view.render().el);this.placeholder_view.delegateEvents()},renderGeneratingView:function(){this.removeOldViews();this.generating_view=new ETM.GeneratingDietView({parent:this});
$(".main_column",this.el).html(this.generating_view.render().el);this.generating_view.delegateEvents()},removeOldViews:function(){this.stopListening();this.initializeEvents();this.no_diet_view&&(this.no_diet_view.undelegateEvents(),this.no_diet_view.close(),this.no_diet_view=null);this.generating_view&&(this.generating_view.undelegateEvents(),this.generating_view.close(),this.generating_view=null);this.day_plan_view&&(this.day_plan_view.undelegateEvents(),this.day_plan_view.close(),this.day_plan_view=
null);this.loading_view&&(this.loading_view.close(),this.loading_view=null);this.placeholder_view&&(this.placeholder_view.close(),this.placeholder_view=null)},getDietObject:function(){if(this.isCalendar()){var a=ETM.calendar_list.getCalendarDiet(this.plan_date);return"object"===typeof a?a.get("diet"):!1}return ETM.diet_plan_set.attributes.diets.at(this.plan_index)}});
ETM.DietSetIntroView=Backbone.View.extend({events:{"click .recalculate_avg_macros":function(a){var b=this,c=$(a.currentTarget).ladda();c.ladda("start");setTimeout(function(){$.post("/weeklyplanner/recalculate-diet-set/",{id:b.model.attributes.id},function(a){c.ladda("stop");a=JSON.parse(a);b.model.set(a);ETM.diet_plan_set.set(a);b.render()})},300)},"click .edit_diet_set_description":function(a){var b=this;this.user_is_owner&&(ETM.edit_diet_set_title_modal=new ETM.DietPlanSetEditTitleModalView({model:this.model}),
ETM.edit_diet_set_title_modal.getModalElement().html(ETM.edit_diet_set_title_modal.render().el),ETM.edit_diet_set_title_modal.$el.modal("show"),ETM.edit_diet_set_title_modal.$el.one("hidden.bs.modal",function(){b.render()}))}},initialize:function(a){_.has(a,"user_is_owner")&&(this.user_is_owner=a.user_is_owner)},render:function(){this.$el.html(this.template({model:this.model,user_is_owner:this.user_is_owner}));return this}});
ETM.DayHeaderView=Backbone.View.extend({events:{"click .day_refresh_button":function(a){this.parent_day_view.generatePlan()},"click .save_diet_range_day":"showSaveDietRange","click .load_diet_range_day":"showLoadDietRange","click .email_date_range":"showEmailDietRange","click .delete_diet":"showDeleteDiet","click .insert_blank_day":"showInsertBlankDayModal","click .sync_diet_settings":"showSyncDiet","click .copy_day":function(){var a;null!=this.parent_day_view.model?(a=ETM.diet_plan_set?new ETM.CopyDayModalView({model:this.parent_day_view.model,
selected_day:this.parent_day_view.plan_index}):new ETM.CopyDayModalView({model:this.parent_day_view.model,plan_date:this.parent_day_view.plan_date}),a.getModalElement().html(a.render().el),a.$el.modal("show")):Helper.errorToast("There are no meals in this day to copy.",3E3)}},initialize:function(a){this.parent_day_view=a.parent},renderStats:function(a){if(this.plan_stats_view=this.parent_day_view.model?new ETM.PlanStatsView({model:this.parent_day_view.model}):null)$(".day_stats_container",this.el).html(this.plan_stats_view.render(a).el),
this.plan_stats_view.delegateEvents()},onClose:function(){delete this.parent_day_view},render:function(){var a;this.is_today=this.parent_day_view.isCalendar()?moment().isSame(moment(this.parent_day_view.plan_date),"day"):!1;a=this.template({weekday:this.parent_day_view.isCalendar()?moment(this.parent_day_view.plan_date).format("dddd"):"Day",day_number:this.parent_day_view.isCalendar()?moment(this.parent_day_view.plan_date).format("D"):this.parent_day_view.plan_index+1,day_title:this.parent_day_view.isCalendar()?
moment(this.parent_day_view.plan_date).format("dddd, MMMM Do"):"Day "+(this.parent_day_view.plan_index+1),today:this.is_today,is_diet_set:!this.parent_day_view.isCalendar(),is_blocked:this.parent_day_view.isBlocked(),diet_id:this.parent_day_view.model?this.parent_day_view.model.attributes.id:!1,show_insert_blank_day:this.parent_day_view.isCalendar()?moment(this.parent_day_view.plan_date).isAfter(moment().subtract(14,"days")):!0});this.$el.html(a);this.renderStats();return this},showSaveDietRange:function(){ETM.save_plans_modal&&
ETM.save_plans_modal.close();ETM.save_plans_modal=new ETM.SavePlansModalView;ETM.save_plans_modal.getModalElement().html(ETM.save_plans_modal.render().el);ETM.save_plans_modal.$el.modal("show");ETM.save_plans_modal.setSaveDate(this.parent_day_view.plan_date);ETM.save_plans_modal.queryPlanSummary();ETM.save_plans_modal.updateSaveTitle();googleanalytics("send","event","button","click","save_diet");amplitude.logEvent("save_diet")},showLoadDietRange:function(){ETM.load_plans_modal&&ETM.load_plans_modal.close();
ETM.load_plans_modal=new ETM.LoadPlansModalView;ETM.load_plans_modal.getModalElement().html(ETM.load_plans_modal.render().el);ETM.load_plans_modal.setLoadDate(this.parent_day_view.plan_date);ETM.load_plans_modal.showLoadDates();ETM.load_plans_modal.delegateEvents();ETM.load_plans_modal.$el.modal("show");googleanalytics("send","event","button","click","load_diet");amplitude.logEvent("load_diet")},showEmailDietRange:function(){this.parent_day_view.isCalendar()?(ETM.email_plans_modal||(ETM.email_plans_modal=
new ETM.EmailPlansModalView,ETM.email_plans_modal.getModalElement().html(ETM.email_plans_modal.render().el)),ETM.email_plans_modal.form.setCalendarDate(this.parent_day_view.plan_date),ETM.email_plans_modal.form.selectCalendarSource(),ETM.email_plans_modal.$el.modal("show")):ETM.email_plan_set_modal&&(ETM.email_plan_set_modal.getModalElement().html(ETM.email_plan_set_modal.render().el),ETM.email_plan_set_modal.delegateEvents(),ETM.email_plan_set_modal.$el.modal("show"))},showDeleteDiet:function(){if(!ETM.currently_generating){var a=
new ETM.DeleteDietModalView({model:this.parent_day_view.model});a.getModalElement().html(a.render().el);a.$el.modal("show");googleanalytics("send","event","button","click","delete_diet");amplitude.logEvent("delete_diet")}},showInsertBlankDayModal:function(){if(!ETM.currently_generating){var a=new ETM.InsertDayModalView({model:this.parent_day_view.model});a.getModalElement().html(a.render().el);a.$el.modal("show");googleanalytics("send","event","button","click","insert_blank_day");amplitude.logEvent("insert_blank_day")}},
showSyncDiet:function(){if(!ETM.currently_generating){var a=new ETM.SyncDietSettingsModalView({model:this.parent_day_view.model});a.getModalElement().html(a.render().el);a.$el.modal("show")}}});
ETM.SinglePlanView=Backbone.View.extend({events:{"change .num_meals_selector":"numMealsChanges"},initialize:function(a){this.plan_stats_view=new ETM.PlanStatsView({model:this.model});this.initializeEvents()},onClose:function(){delete this.parent_day_view},initializeEvents:function(){var a=this;this.listenTo(this.model,"showMealOverlays",function(){$(".meal_blocking_overlay",this.el).addClass("show_overlay")});this.listenTo(this.model,"hideMealOverlays",function(){$(".meal_blocking_overlay.show_overlay",
this.el).removeClass("show_overlay")});this.listenTo(this.model,"meal_eaten_update",function(){this.updateEatenProgress()});this.listenTo(this.model,"finishedGenerating",function(){a.model.save(null,{silent:!0,success:function(){a.model.trigger("finishedGeneratingSaved");a.renderMeals();a.model.attributes.meals.each(function(a){a.trigger("parent_diet_finished_generating");delete a.attributes.delete_other_foods;delete a.attributes.delete_other_foods_except_leftovers});ETM.stoppedGenerating()}})},this);
this.listenTo(this.model,"change:num_meals",function(){0==this.model.attributes.num_meals?$(".gen_button").prop("disabled",!0):$(".gen_button").prop("disabled",!1);this.renderMeals();this.showMeals();ETM.generator_results_cache.clearCache()},this);this.listenTo(this.model,"swap_complete",function(){this.renderMeals()},this)},render:function(a){this.$el.html(this.template({today:this.parent_day_view.isCalendar()&&moment().isSame(moment(this.parent_day_view.plan_date),"day")}));this.renderStats(a);
this.renderMeals(a);this.updateEatenProgress();ETM.dispatcher.trigger("finishedRenderingDayView");return this},highlightFoods:function(a){var b=!1;this.model.attributes.meals.each(function(c){c.attributes.foods.each(function(c){if(c.attributes.food.attributes.id===a)return c.trigger("highlightFood"),b=!0})});return b},showMeals:function(){for(var a=this.model.get("num_meals"),b=0;9>b;b++)b<a?$(".meal_box",this.el).eq(b).show():$(".meal_box",this.el).eq(b).hide()},hideMealsAndStats:function(){ETM.is_logged_in?
($(".meal_list",this.el).hide(),$(".workspace_stats",this.el).hide()):this.$el.hide()},showMealsAndStats:function(){ETM.is_logged_in?($(".meal_list",this.el).show(),$(".workspace_stats",this.el).show()):this.$el.is(":visible")||this.$el.show()},renderMeals:function(){0!=this.model.stats.calories||ETM.is_logged_in?(this.showMealsAndStats(),this.trigger("showMealsAndStats")):(this.hideMealsAndStats(),this.trigger("hideMealsAndStats"));0==this.model.attributes.meals.length||0==this.model.attributes.num_meals?
$(".meal_list",this.el).html('<div class="meal_title py-2"> This plan has no meals.</div>'):0<this.model.attributes.meals.length&&(Helper.lockPageHeight(),this.meal_list&&this.meal_list.close(),this.meal_list=new ETM.MealListView({model:this.model.attributes.meals}),$(".meal_list",this.el).html(this.meal_list.render().el),this.showMeals(),Helper.unlockPageHeight())},renderStats:function(a){$(".workspace_stats",this.el).html(this.plan_stats_view.render(a).el);this.plan_stats_view.delegateEvents()},
updateEatenProgress:function(){$tracking_percent=$(".day-tracking-percent",this.el);$tracking_progress=$(".day-tracking-progress",this.el);$tracking_percent.tooltip("dispose");var a=0,b=!0,c=this.model.attributes.num_meals,d=0;this.model.attributes.meals.each(function(e,f){f<c&&(e.attributes.eaten?(d++,a+=e.stats.calories):b=!1)});total_calories=this.model.stats.calories;var e=this.model.attributes.nutrition_profile.attributes.calories;if(0===a)$tracking_progress.css({opacity:"0"}),$tracking_percent.hide();
else if($tracking_progress.css({opacity:"1"}),$tracking_percent.show(),b){$tracking_progress.find(".progress-bar").css({width:"100%","background-color":"#28a745"});$tracking_percent.removeClass("badge-light badge-success").addClass("badge-success");$tracking_percent.html("100% <i class='fa fa-check'></i>");var f=ETM.MealPlanViewState.isWeekView()?"calc(100% - 150px)":"calc(100% - 60px)";$tracking_percent.css("left",f);$tracking_percent.tooltip({html:!0,title:"You tracked all of your meals for the day! Heck yeah!<br/>("+
roundNumber(100*(a/e),0)+"% of "+e+" Cal target)",position:"top"})}else f=roundNumber(100*(a/total_calories),0),$tracking_progress.find(".progress-bar").css({width:roundNumber(100*(a/total_calories),0)+"%","background-color":Helper.getColorForProgressPercentage(a/total_calories)}),$tracking_percent.html(f+"%"),$tracking_percent.removeClass("badge-light badge-success").addClass("badge-light"),$tracking_percent.css("right","auto"),$tracking_percent.css("left",f+"%"),$tracking_percent.tooltip({title:"<p>Tracked:<br/>"+
d+" of "+c+" meals<br/>"+roundNumber(a,0)+" of "+roundNumber(total_calories,0)+" Calories<br/>("+f+"% of "+e+" Cal target)</p><p class='text-left'>As you follow the plan,<br/>click 'I ate this' on your meals to get to 100%.</p>",position:"top",html:!0})},printGraph:function(){this.plan_stats_view.printSparkPie()},generateDiet:function(){this.model.generateOnServer()}});
ETM.DeleteDietModalView=ModalView.extend({modal_id:"delete_diet_modal",events:{"click .delete_diet_confirm":function(){ETM.is_logged_in?this.model.is_diet_set?this.model.trigger("deleteDietFromSet"):this.model.trigger("deleteCalendarDiet"):this.model.trigger("deleteDiet")}},initialize:function(){},render:function(){this.$el.html(this.template());return this}});
ETM.InsertDayModalView=ModalView.extend({modal_id:"insert_blank_day_modal",events:{"click .insert_day_confirm":function(){ETM.is_logged_in&&this.model.trigger("insertBlankDayAtThisDiet")}},initialize:function(){},render:function(){this.$el.html(this.template({is_diet_set:this.model.is_diet_set}));return this}});
ETM.SyncDietSettingsModalView=ModalView.extend({modal_id:"sync_diet_settings_modal",events:{"click .openWeeklyLayout":function(a){this.$el.one("hidden.bs.modal",function(){ETM.router.navigateAndScrollTo("preferences/meals/","#week_layout_settings",{trigger:!0})});this.$el.modal("hide")},"click .confirm_sync_diet":function(a){var b=this;a.preventDefault();var c=$(a.target).ladda();c.ladda("start");amplitude.logEvent("planner_match_weekly_layout_single");var d=this.model.parent;d.attributes.diet=d.attributes.diet.createMergedDietFromTemplate(Helper.parseDateString(this.model.parent.attributes.date).getDay());
ETM.calendar_list.trigger(d.attributes.date,{status:"downloading"});d.save(null,{success:function(){ETM.calendar_list.trigger(d.attributes.date,{status:"okay",diet_object:d.attributes.diet});c.ladda("stop");b.$el.modal("hide")}})}},initialize:function(){},detectWeeklyLayoutChanges:function(){var a=Helper.parseDateString(this.model.parent.attributes.date).getDay(),a=ETM.template_diet_list.getTemplateDietAtIndex(a).attributes.diet,b=[];if(null!=this.model&&null!=a){this.model.getNumberOfActiveMeals()!==
a.getNumberOfActiveMeals()&&b.push("\u2022 Your number of meals");this.model.attributes.nutrition_profile.id!==a.attributes.nutrition_profile.id&&b.push("\u2022 Your nutrition profile");for(var c=0;c<this.model.getNumberOfActiveMeals()&&c<a.getNumberOfActiveMeals();c++){var d=this.model.attributes.meals.at(c),e=a.attributes.meals.at(c);d.attributes.meal_type.id!==e.attributes.meal_type.id&&b.push("\u2022 Your meal type for meal "+(c+1))}}return b},getTemplateDict:function(){var a=this.detectWeeklyLayoutChanges(),
b="this change",c="does";1<a.length&&(b="these changes",c="do");var d;d=ETM.current_user_profile.usingSingleTemplateDiet()?"this day":moment(this.model.parent.attributes.date).format("dddd");return{change_text:a.join("<br/>"),num_changes_text:b,do_does_text:c,day_of_week:d,has_differences:0<a.length}},render:function(){this.$el.html(this.template(this.getTemplateDict()));this.$el.modal({show:!1});var a=this;this.$el.one("hidden.bs.modal",function(){a.close()});return this}});
var tooltip_timer,update_ingredients_timer,all_ingredients={},all_pantry_sidebar_ingredients={};function grabIngredients(a){return _.has(all_ingredients,a)?all_ingredients[a]:!1}function grabPantrySidebarIngredients(a){return _.has(all_pantry_sidebar_ingredients,a)?all_pantry_sidebar_ingredients[a]:!1}function mealStatsTooltipHTML(a,b){return'<div class="meal_tooltip"><div class="mealgraph"></div><div id="mealstats'+a+'" class="mealstats">'+b+"</div></div>"}
function getStatsHTML(a){roundNumber(a.carbs-a.fiber,1);var b='<div class="carbs-col">'+roundNumber(a.getPrimaryCarbs(),1)+"g "+ETM.current_user_profile.getPrimaryCarbsTitle()+"</div>",b=b+("<div class='net_carbs_div'>("+roundNumber(a.fiber,1)+"g fiber)</div>"),b=b+('<div class="fats-col">'+roundNumber(a.fats,1)+"g Fat</div>"),b=b+('<div class="proteins-col">'+roundNumber(a.proteins,1)+"g Protein</div>"),b=b+(roundNumber(a.calories,1)+" Calories<br/>");return b+="<div class='total_price_div'>Estimated $"+
roundNumber(a.price,2).toFixed(2)+"</div>"}function getMainStatsHTML(a){var b=roundNumber(a.carbs-a.fiber,1),c=roundNumber(a.carbs,1)+"g Carbs<br/>",c=c+("<div class='net_carbs_div'>("+b+"g <span class='net_carbs_tooltip'>net carbs</span>)</div>")+(roundNumber(a.fats,1)+"g Fat<br/>"),c=c+(roundNumber(a.proteins,1)+"g Protein<br/>"),c=c+(roundNumber(a.calories,1)+" Calories<br/>");return c+="<div class='total_price_div'>Estimated $"+roundNumber(a.price,2).toFixed(2)+"</div>"}
function miniGraph(a,b){var c=4*a.carbs+4*a.proteins+9*a.fats,c=[{label:"C",data:100*(4*a.carbs/c),color:"#FCB524"},{label:"P",data:100*(4*a.proteins/c),color:"#976fe8"},{label:"F",data:100*(9*a.fats/c),color:"#52C0BC"}];try{$.plot(b,c,{series:{pie:{startAngle:0,stroke:{color:"#000"},show:!0,radius:1,label:{show:!0,radius:0.5,formatter:function(a,b){return'<div style="font-size:7pt;text-align:center;padding:2px;color:white;">'+a+"</div>"},threshold:0.1}}},legend:{show:!1}})}catch(d){}}
function ingredientsHTML(a,b,c){b/=c;c="<div class='ttp_ingredients'>";for(var d=0;d<a.length;d++){var e=a[d];if("M"===ETM.current_user_profile.get("units")&&e.accurate_grams&&hasImperial(e.unit_description)){var f=e.gram_amount*e.amount*b,f=200<f?roundNumber(10*Math.round((f+4.9)/10),0):30<f?roundNumber(5*Math.round((f+2.4)/5),0):5<f?roundNumber(f,0):roundNumber(f,1);c=c+"<div class='ttp_ingredient_amount'>"+Helper.formatFoodAmount(f)+"g "+e.food_name+"</div>"}else c=c+"<div class='ttp_ingredient_amount'>"+
Helper.getRoundedFractionFromDecimal(roundNumber(e.unit_amount*e.amount*b,5))+" "+e.unit_description+" "+e.food_name+"</div>"}return c+"</div>"}
function pantrySidebarIngredientsHTML(a,b,c,d){c/=d;d=[];if(b&&0<b.length)for(d=b.split(","),b=0;b<d.length;b++)d[b]=parseInt(d[b]);var e="<div class='ttp_ingredients'>";for(b=0;b<a.length;b++){var f=a[b],g="";f.normalized_id&&-1<d.indexOf(f.normalized_id)&&(g=" ttp_ingredient_missing ");if("M"===ETM.current_user_profile.get("units")&&f.accurate_grams&&hasImperial(f.unit_description)||"grams"==f.unit_description)var h=f.gram_amount*f.amount*c,h=200<h?roundNumber(10*Math.round((h+4.9)/10),0):30<h?
roundNumber(5*Math.round((h+2.4)/5),0):5<h?roundNumber(h,0):roundNumber(h,1),e=e+"<div class='ttp_ingredient_amount"+g+"'>"+Helper.formatFoodAmount(h)+"g "+f.food_name+"</div>";else e=e+"<div class='ttp_ingredient_amount"+g+"'>"+Helper.getRoundedFractionFromDecimal(roundNumber(f.unit_amount*f.amount*c,5))+" "+f.unit_description+" "+f.food_name+"</div>"}return e+"</div>"}
function hasImperial(a){return-1!=a.indexOf("oz")||-1!=a.indexOf("ounce")||-1!=a.indexOf("cup")||-1!=a.indexOf("tsp")||-1!=a.indexOf("tbsp")||-1!=a.indexOf("tablespoon")||-1!=a.indexOf("teaspoon")||-1!=a.indexOf("lbs")||"lb"==a?!0:!1}
ETM.ReadOnlySinglePlanView=ETM.SinglePlanView.extend({events:{},initialize:function(){this.plan_stats_view=new ETM.PlanStatsView({model:this.model,read_only:!0});this.listenTo(this.model,"updateStats",function(){this.renderStats()})},renderMeals:function(a){0<this.model.attributes.meals.length&&(this.meal_list&&this.meal_list.close(),this.meal_list=new ETM.MealListView({model:this.model.attributes.meals}),$(".meal_list",this.el).html(this.meal_list.render().el),$(".meal_refresh_btn",this.el).hide(),
this.meal_list.meal_views.forEach(function(a){$(".meal_options_dropdown",a.el).removeClass("dropdown");$(".meal_options_dropdown",a.el).html('<span class="meal_title print_meal_title">'+a.model.get("meal_type").get("title")+"</span>")}),$(".meal_options_dropdown",this.el).unbind(),$(".meal_actions_dropdown",this.el).hide(),this.model.attributes.diet_owner_username!=ETM.current_user_profile.attributes.username&&(this.meal_list.meal_views.forEach(function(a){a.food_list.$el.sortable({disabled:!0})}),
$(".diet_draggable",this.el).css("cursor","auto"),$(".meal_icons",this.el).hide(),$(".food_delete_dd",this.el).hide(),$(".i_ate_this",this.el).remove(),$(".food_refresh",this.el).remove(),$(".food_delete",this.el).remove(),$(".block_item",this.el).switchClass("offset-0","offset-6"),$(".block_item",this.el).switchClass("offset-sm-2","offset-sm-7"),$(".block_item",this.el).switchClass("offset-md-4","offset-md-8"),$(".block_item",this.el).addClass("read_only_block_item"),$(".mod_units",this.el).remove(),
$(".static_div",this.el).addClass("remain_visible"),this.parent_day_view&&($(".delete_diet",this.parent_day_view.el).hide(),$(".day_refresh_button",this.parent_day_view.el).hide())),this.showMeals());0==this.model.stats.calories?(this.hideMealsAndStats(),this.trigger("hideMealsAndStats")):(this.showMealsAndStats(),this.trigger("showMealsAndStats"))}});
ETM.CustomFoodFormModalView=ModalView.extend({modal_id:"custom_food_form_modal",id:"custom_food_modal",events:{"click .show_optional_fields":"showCustomFields","click .show_optional_sugars":"showSugarFields","click .expand_gram_weights":"showGramWeightFields","click .show_optional_fats":"showFatFields","click #save_custom_food":"saveFood",'change input[name="carbs"]':"inputChanged",'change input[name="fats"]':"inputChanged",'change input[name="proteins"]':"inputChanged",'change input[name="price"]':"priceChanged",
'change input[name="default_package_amount"]':"priceChanged",'blur input[name="calories"]':"formCaloriesChanged","blur #custom_gram_weights input":"updateUnitsSelectorAfterEdit","blur .main_units_entry input":"updateUnitsSelectorAfterEdit","keyup .percent_rda_input input":"rdaValueChanged","keyup #optional_custom_fields .custom_value":"micronutrientChanged","click .resetMacros":function(a){a.preventDefault();this.carbs=this.fats=this.proteins=null;this.macro_calories=this.form_calories;a=this.form_calories/
3-4*this.proteins-9*this.fats;var b=this.form_calories/3-4*this.proteins-4*this.carbs;this.updateInputs(a,b);this.updateSlider(a,b);this.compareCaloriesAndMacros()},"click .resetCalories":function(a){a.preventDefault();this.form_calories=this.macro_calories;$("#calories",this.el).val(this.form_calories);this.compareCaloriesAndMacros()},"click .i_dont_care":function(a){a.preventDefault();this.ignore_macro_calorie_difference=!0;this.compareCaloriesAndMacros()},"change #restaurant_name":function(a){this.restaurant_enabled&&
0==$("#description",this.el).val().toLowerCase().indexOf("ate out")&&$("#description",this.el).val("Ate out at "+$(a.currentTarget).val())}},updateUnitsSelectorAfterEdit:function(){var a=$("#default_units",this.el).val();this.renderDefaultUnitsSelector();this.setDefaultUnits(a)},setDefaultUnits:function(a){$("#default_units",this.el).val(a.toString())},renderDefaultUnitsSelector:function(a){"undefined"!==typeof a?a=a.attributes.weights:(a=$(".custom_food_form",this.el).serializeObject(),a=this.parseGramWeightFields(a),
a=a.weights);for(var b='<select class="form-control" name="default_units" id="default_units">',c=1;c<a.length;c++)b=b+"<option value='"+c+"'>[Unit "+c+"] - "+a[c].amount+" "+a[c].description+"</option>";b+="</select>";$(".default_units_selector",this.el).html(b)},initialize:function(){this.ignore_macro_calorie_difference=this.restaurant_enabled=!1;this.copiedFoodImage=this.base_food_id=this.previous_food_id=this.food_id=null},render:function(){this.carbs=this.fats=this.proteins=this.form_calories=
this.macro_calories=null;this.$el.html(this.template());this.$el.modal({show:!1,backdrop:"static"});this.renderForm();this.renderSliders();this.toggleInputsAndSliders();this.toggleTooltips();$(".collapse",this.el).collapse();return this},toggleTooltips:function(){$(".grams_per_serving_tooltip",this.el).tooltip({title:"<div class='text-left'>Enter the gram weight of a serving of the actual food. This will let you convert between grams and servings.<br/><br/>Common units:<br/>1 oz = 28.35 g<br/>1 lb = 453.6 g<br/>1 tsp = 5 g (liquid)<br/>1 tbsp = 15 g (liquid)<br/>1 cup = 240 g (liquid)</div>",
html:!0,template:'<div class="tooltip" role="tooltip"><div class="arrow"></div><div style="margin-left:-20px;margin-right:-20px;" class="tooltip-inner"></div></div>',animation:!0,placement:"top",delay:{show:100,hide:0}})},showCustomFields:function(){$("#optional_custom_fields",this.el).slideToggle(200)},showSugarFields:function(){$("#optional_sugar_fields",this.el).slideToggle(200)},showFatFields:function(){$("#optional_fat_fields",this.el).slideToggle(200)},showGramWeightFields:function(){$("#custom_gram_weights",
this.el).slideToggle(200)},loadFood:function(a,b){var c="calcium choline copper fiber folate iron magnesium manganese niacin phosphorus potassium riboflavin selenium sodium thiamine vit_a vit_b6 vit_b12 vit_c vit_d vit_e vit_k zinc".split(" ");b?(this.previous_food_id=a.attributes.id,0<a.attributes.images.length&&(this.copiedFoodImage=new ETM.FoodImage(a.getDisplayImage().attributes),Helper.clearIDs(this.copiedFoodImage))):(this.food_id=a.attributes.id,this.previous_food_id=a.attributes.previous_food_id,
this.base_food_id=a.attributes.base_food_id);$("#gram_weight_1_amount",this.el).val(a.attributes.weights[1].amount);$("#gram_weight_1_description",this.el).val(a.attributes.weights[1].description);if(a.attributes.accurate_grams){$("#gram_weight_1",this.el).val(a.attributes.weights[1].grams);for(var d=2;d<a.attributes.weights.length;d++)$("#gram_weight_"+d+"_amount",this.el).val(a.attributes.weights[d].amount),$("#gram_weight_"+d+"_description",this.el).val(a.attributes.weights[d].description),$("#gram_weight_"+
d,this.el).val(a.attributes.weights[d].grams)}$("#food_name",this.el).val(a.attributes.food_name);$("#description",this.el).val(a.attributes.description);a.attributes.default_package_amount&&$("#default_package_amount",this.el).val(a.attributes.default_package_amount);d=a.attributes.weights[1].grams/100;for(key in a.attributes.nutrition)if(_.has(a.attributes.nutrition,key)&&null!=a.attributes.nutrition[key])if("price"===key){var e=roundNumber(a.attributes.nutrition.price*d*a.attributes.default_package_amount,
2);$("#price",this.el).val(e);this.priceChanged()}else e=roundNumber(a.attributes.nutrition[key]*d,2),$("#"+key,this.el).val(e),-1!==c.indexOf(key)&&(0<e?(e=roundNumber(100*(e/ETM.NUTRIENT_DICTIONARY[key].daily_value),1),$("#"+key+"-rda",this.el).val(e)):0===e?$("#"+key+"-rda",this.el).val(0):$("#"+key+"-rda",this.el).val(""));this.renderDefaultUnitsSelector(a);this.setDefaultUnits(a.attributes.default_units);100<=a.attributes.food_group&&$("#food_group",this.el).val(a.attributes.food_group.toString());
this.form_calories=roundNumber(a.attributes.nutrition.calories*d,2);this.inputChanged();this.toggleInputsAndSliders();is_staff&&!b&&(!0==a.attributes.curated&&$("#yes_curated",this.el).prop("checked",!0),$("#model",this.el).val(a.attributes.model))},renderForm:function(){this.form=(new Backbone.Form({schema:{restaurant_name:{type:"Text"},food_name:{type:"Text",editorAttrs:{maxlength:100},validators:["required"]},description:{type:"Text",editorAttrs:{maxlength:400}},calories:{type:"Text",validators:["required"]},
proteins:{type:"Text",validators:["required"]},fats:{type:"Text",validators:["required"]},carbs:{type:"Text",validators:["required"]},default_package_amount:{type:"PositiveNumber",validators:["required"]}},data:{description:this.restaurant_enabled?"Ate out":"",default_package_amount:1},templateData:{restaurant:this.restaurant_enabled,is_staff:is_staff},template:ETM.loadNestedTemplate("#CustomFoodFormTemplate",".custom_food_form_template")})).render();$(".ate_out_form",this.el).html(this.form.el)},
renderSliders:function(){var a=this;this.slider=$(".3_way_macro_slider",this.el);this.slider.slider({range:!0,min:0,max:this.macro_calories,step:0.01,values:[0,0],slide:function(b,c){a.updateInputs(c.values[0],c.values[1]-c.values[0])}});this.slider.css("background-color","#FCB524");$(".ui-widget-header",this.el).css("background","none");$(".ui-slider-range",this.el).css("background-color","#52C0BC");this.slider.append('<div class="right_slider_third"></div>')},formCaloriesChanged:function(a){if((this.form_calories=
parseInt($(a.currentTarget).val()))&&!this.macro_calories){this.macro_calories=this.form_calories;a=this.form_calories/3-4*this.proteins-9*this.fats;var b=this.form_calories/3-4*this.proteins-4*this.carbs;this.updateInputs(a,b);this.updateSlider(a,b)}this.toggleInputsAndSliders();this.compareCaloriesAndMacros()},toggleInputsAndSliders:function(){if(this.form_calories||this.macro_calories)return this.slider.slider("enable"),!0;this.slider.slider("disable");return!1},compareCaloriesAndMacros:function(){if(0<=
this.form_calories&&0<=this.macro_calories&&20<Math.abs(this.form_calories-this.macro_calories)&&!this.ignore_macro_calorie_difference){var a=ETM.loadTemplate("#AteOutAlertTemplate"),b=$(".cal_macros_warning",this.el);b.html(a({form_calories:this.form_calories,macro_calories:this.macro_calories}));$(".calorie_warning_tooltip",b).tooltip({title:"<div class='text-left'>Our algorithms depend on the Calorie and macronutrient numbers lining up, with 4 Calories per gram carbs and protein, and 9 per gram fat.<br/><br/>You can either massage the food's numbers until they line up (food labels are often allowed a 20% margin of error on their numbers), or ignore this warning and risk slightly worse generator results if you use this in recipes or as a recurring food.</div>",
template:'<div class="tooltip" role="tooltip"><div class="arrow"></div><div style="margin-left:-20px;margin-right:-20px;" class="tooltip-inner"></div></div>',animation:!0,html:!0,placement:"top",delay:{show:100,hide:0}});b.show();return!1}$(".cal_macros_warning",this.el).hide();return!0},priceChanged:function(){var a=$(".price_per_serving_text",this.el),b=$(".price_per_serving_info",this.el);a.removeClass("text-danger");a.html();var c=parseFloat($('input[name="price"]',this.el).val()),d=parseFloat($('input[name="default_package_amount"]',
this.el).val());if(c&&d){var e=(Math.round(100*(c/d))/100).toFixed(2);a.html($("<p>"+("$"+c.toString()+" / "+d.toString()+" servings per package = $"+e+" per serving.")+"</p>"));b.show()}else d?b.hide():(a=$(".price_per_serving_text",this.el),a.html($("<p>Please enter the number of servings per package above.</p>")),a.addClass("text-danger"),b.show())},inputChanged:function(){var a=4*parseInt($('input[name="carbs"]',this.el).val()),b=9*parseInt($('input[name="fats"]',this.el).val()),c=4*parseInt($('input[name="proteins"]',
this.el).val());this.macro_calories=a+b+c;0<=a&&0<=b&&0<=c&&!this.form_calories&&(this.form_calories=this.macro_calories,$("#calories",this.el).val(this.form_calories));this.updateSlider(a,b);this.compareCaloriesAndMacros()},updateInputs:function(a,b){this.carbs=Math.round(a/4);this.fats=Math.round(b/9);this.proteins=Math.round((this.macro_calories-a-b)/4);$('input[name="carbs"]',this.el).val(this.carbs);$('input[name="fats"]',this.el).val(this.fats);$('input[name="proteins"]',this.el).val(this.proteins);
$(".right_slider_third",this.el).css("width",(100*(this.macro_calories-a-b)/this.macro_calories).toFixed(2)+"%")},updateSlider:function(a,b){this.slider.slider("option","values",[a,a+b]);this.slider.slider("option","max",this.macro_calories);$(".right_slider_third",this.el).css("width",(100*(this.macro_calories-a-b)/this.macro_calories).toFixed(2)+"%")},rdaValueChanged:function(a){var b=$(a.currentTarget).attr("id").split("-")[0];a=parseFloat($(a.currentTarget).val());0<a?(a=roundNumber(a/100*ETM.NUTRIENT_DICTIONARY[b].daily_value,
2),$("#"+b,this.el).val(a)):0===a?$("#"+b).val(0):$("#"+b,this.el).val("")},micronutrientChanged:function(a){var b=$(a.currentTarget).attr("name");-1!=="calcium choline copper fiber folate iron magnesium manganese niacin phosphorus potassium riboflavin selenium sodium thiamine vit_a vit_b6 vit_b12 vit_c vit_d vit_e vit_k zinc".split(" ").indexOf(b)&&(a=parseFloat($(a.currentTarget).val()),0<a?(a=roundNumber(100*(a/ETM.NUTRIENT_DICTIONARY[b].daily_value),2),$("#"+b+"-rda",this.el).val(a)):0===a?$("#"+
b+"-rda").val(0):$("#"+b+"-rda",this.el).val(""))},parseGramWeightFields:function(a){var b=100,c=parseFloat(a.gram_weight_1);!isNaN(c)&&0<c?(b=c,a.accurate_grams=!0):a.accurate_grams=!1;a.weights=[{grams:100,amount:100,description:"grams"},{grams:b,amount:parseFloat(a.gram_weight_1_amount),description:a.gram_weight_1_description}];delete a.gram_weight_1;delete a.gram_weight_1_amount;delete a.gram_weight_1_description;for(b=2;9>b;b++)c=parseFloat(a["gram_weight_"+b]),gram_description=a["gram_weight_"+
b+"_description"],gram_amount=parseFloat(a["gram_weight_"+b+"_amount"]),!isNaN(c)&&0<c&&!isNaN(gram_amount)&&0<gram_amount&&0<gram_description.length&&a.weights.push({grams:c,amount:gram_amount,description:gram_description}),delete a["gram_weight_"+b],delete a["gram_weight_"+b+"_amount"],delete a["gram_weight_"+b+"_description"];return a},saveFood:function(){var a=this;$(".alert.alert-danger",this.el).remove();var b=this.form.validate();if(!this.compareCaloriesAndMacros()||"undefined"!==typeof b&&
b)for(var c in b)$('[data-editors="'+c+'"]').append('<div class="alert alert-danger" style="float:left">'+b[c].message+"</div>");else{b=$(".custom_food_form",a.el).serializeObject();delete b.restaurant_name;b.food_name=b.food_name.trim();b.description=b.description.trim();b.food_group="null"!=b.food_group?parseInt(b.food_group):null;b.default_units=parseInt(b.default_units);b=a.parseGramWeightFields(b);b.nutrition={};c=100/b.weights[1].grams;b.price&&(b.price/=b.default_package_amount);for(var d=
0;d<ETM.NUTRIENT_LIST.length;d++){var e=ETM.NUTRIENT_LIST[d];"undefined"!==typeof b[e]&&0!==b[e].length&&(b.nutrition[e]=roundNumber(parseFloat(b[e])*c,10));delete b[e]}b.id=this.food_id;b.previous_food_id=this.previous_food_id;b.base_food_id=this.base_food_id;var f,g=!0;if(null!=b.id){f=a.model.get(ROOT+"/food/"+b.id+"/");f||(g=!1,f=ETM.food_info_object_list.get(ROOT+"/food/"+b.id+"/"));f||(f=ETM.food_browser_model.result_model.custom_foods.all_foods.food_info_object_list.get(ROOT+"/food/"+b.id+
"/"));try{f.save(b,{success:function(a){var b=!0===a.attributes.force_reload;delete a.attributes.force_reload;delete a.attributes.old_food_servings;if(g){var c=ETM.food_info_object_list.get(a.id);c&&c.set(a.toJSON())}b&&(ETM.dispatcher.trigger("update_food_info_"+a.attributes.id),ETM.dispatcher.trigger("reload_custom_recipes",a.attributes.id));ETM.search_model.updateFoodInfo(a);ETM.ingredients_search_model.updateFoodInfo(a)}})}catch(h){bugsnagClient.notify(h,{metaData:{food_save_resource_uri:ROOT+
"/food/"+b.id+"/",collection_ids:a.model.modelIds().toString()}});$(".custom_form_validation",a.el).append('<div class="alert alert-danger" style="float:left">Error saving custom food</div>');return}}else f=a.model.create(b,{wait:!0,at:0,success:function(b){a.copiedFoodImage&&a.copiedFoodImage.save({food_id:b.attributes.id},{async:!1,success:function(a){b.attributes.images.add(a)}});ETM.search_model.updateFoodInfo(b);ETM.ingredients_search_model.updateFoodInfo(b)}});a.previous_food_id?a.$el.one("hidden.bs.modal",
function(){if(ETM.food_object_modal&&ETM.food_bank_sidebar){var a=new ETM.FoodObject({food:f,amount:1,units:f.attributes.default_units,is_custom:!0},{skip_global:!0});ETM.food_object_modal.loadFood(a)}}).modal("hide"):a.$el.modal("hide")}return!1}});ETM.AteOutFormView=ETM.CustomFoodFormModalView.extend({initialize:function(){this.restaurant_enabled=!0}});function getNodePosition(a){for(var b=left=0;a;)a.tagName?(b+=a.offsetTop,left+=a.offsetLeft,a=a.offsetParent):a=a.parentNode;return[b,left]}
var tooltip_show_delay=250;ETM.recently_blocked=[];ETM.reload_food_pool=!1;
ETM.FoodObjectView=ModalView.extend({tagName:"li",className:function(){return ETM.is_mobile&&!ETM.is_tablet?"mobile_diet_draggable diet_draggable":"diet_draggable"},events:{"click .food_refresh":"shuffleFood","click .food_repeat":"clickedRecurringIcon","click .food_delete, .food_delete_dd":"deleteFood","click .add_leftovers":"openAddLeftoversModal","click .amount_input, .food_units_selector":function(a){a.stopPropagation()},"keyup .amount_input":function(a){var b=this.model.attributes.amount;this.updateAmount();
this.resizeAmountInput($(a.currentTarget));b!==this.model.attributes.amount&&this.model.saveAfterAmountUpdate()},"blur .amount_input":function(a){var b=this.model.attributes.amount;this.updateAmount();this.resizeAmountInput($(a.currentTarget));b!==this.model.attributes.amount&&this.model.saveAfterAmountUpdate()},"change .food_units_selector":function(a){this.updateUnits();this.resizeAmountInput()},"click .block_food":function(a){$(a.currentTarget).prop("disabled")||this.model.toggleBlock($(a.currentTarget))},
"click .food_image":function(){this.openFoodModal()},"click .food_name .print_name, .mobile_food_units":function(){this.openFoodModal()},"click .food_thumbs .thumb_icon":function(a){a.preventDefault();a.stopPropagation();$(a.currentTarget).prop("disabled")||this.toggleThumb($(a.currentTarget))},"click .favorite_food":function(a){a.preventDefault();a.stopPropagation();$(a.currentTarget).prop("disabled")||this.model.toggleFavorite($(a.currentTarget))}},onClose:function(){this.$el.data&&this.$el.data("bs.tooltip")&&
this.$el.tooltip("dispose")},initialize:function(){this.applyFoodListeners();this.tooltip_handler=new ETM.FoodTooltipHandler(this.model);this.listenTo(this.model,"reRender",this.render,this);this.listenTo(this.model,"change:has_leftovers change:is_leftovers",this.render,this);this.listenTo(this.model,"modalUpdated",function(){this.render();this.updateTooltip();this.$el.tooltip("hide")},this);this.listenTo(this.model,"modelDeleted",function(){this.remove()},this);this.listenTo(this.model,"imageUpdated",
function(a){this.model.get("food").attributes.images.add(a);this.render()},this);this.listenTo(this.model,"foodChanged",function(){this.render();this.updateTooltip();this.model.get("food").get("is_recipe")&&this.applyIngredientsLookup();this.applyFoodListeners();this.$el.tooltip("hide");this.checkIfRecurring()},this);this.listenTo(this.model,"removeFoodObjectListeners",function(){this.stopListening(this.model.attributes.food)},this);this.listenTo(this.model,"disableHover",function(){this.$el.unbind("mouseenter mouseleave tooltip")},
this);this.listenTo(this.model,"disableEvents",function(){this.undelegateEvents()},this);this.listenTo(this.model,"enableHover",function(){this.render()},this);this.listenTo(this.model,"highlightFood",function(){this.flashFoodBackground()},this);this.listenTo(this.model,"enableTooltip",function(){this.applyTooltip()},this);this.listenTo(this.model,"enableStaticModal",function(){this.use_static_modal=!0},this);this.listenTo(this.model,"enableEvents",function(){this.delegateEvents()},this)},applyFoodListeners:function(){this.listenTo(this.model.attributes.food,
"updateRating",function(){this.renderFoodRating()},this);this.listenTo(this.model.attributes.food,"addFavorite",function(){this.model.is_favorite=!0;$(".favorite_icon",this.el).addClass("active");$(".favorite_food span",this.el).html("Remove favorite")},this);this.listenTo(this.model.attributes.food,"removeFavorite",function(){this.model.is_favorite=!1;$(".favorite_icon",this.el).removeClass("active");$(".favorite_food span",this.el).html("Add favorite")},this)},render:function(){this.updateStaticAmountAndUnits();
this.model.selector_html=this.selectorHTML();this.model.image=this.model.attributes.food.getDisplayImage();var a=this.template(this.model);this.$el.html(a);this.$el.unbind("mouseenter mouseleave");this.applyHoverEffects();this.applyTooltip();this.printGramReadout();this.resizeAmountInput();this.renderFoodRating();this.applyMobileEvents();return this},applyMobileEvents:function(){if(ETM.is_mobile){var a=this;$(".food_dropdown",this.el).on("show.bs.dropdown",function(){a.$el.tooltip("hide")})}},showRecurringIcon:function(){$(".food_name .food_repeat",
this.el).addClass("is_recurring")},hideRecurringIcon:function(){$(".food_name .food_repeat",this.el).removeClass("is_recurring")},checkIfRecurring:function(){if(this.model.hasParentMeal()){var a=this.model.getParentMeal().attributes.meal_type,b=a.getRecurringFood(this.model.attributes.food.id);b?(this.model.is_recurring=!0,this.model.is_recurring_always=1===b.attributes.frequency,this.showRecurringIcon()):(a=a.getRecurringCollectionsContainingFood(this.model.attributes.food.attributes.id),0<a.length?
(this.model.is_recurring=!1,this.model.is_recurring_always=!1,this.model.is_from_collections=!0,this.model.in_collections=a,this.showRecurringIcon()):(this.model.is_recurring=!1,this.model.is_recurring_always=!1,this.model.is_from_collections=!1,this.model.in_collections=null,this.hideRecurringIcon()))}},clickedRecurringIcon:function(a){this.model.is_from_collections?this.openFoodModal(a):this.openRecurringFoodModal(a)},openRecurringFoodModal:function(a){a.preventDefault();this.recurring_food_modal=
new ETM.RecurringFoodModalView({model:this.model});this.recurring_food_modal.getModalElement().html(this.recurring_food_modal.render().el);this.recurring_food_modal.$el.modal("show")},openFoodModal:function(a){var b=this;setTimeout(function(){b.$el.tooltip("hide")},0);ETM.food_object_modal.loadFood(this.model);this.use_static_modal&&$(".hide_when_static",ETM.food_object_modal.model_view.el).hide();null!=ETM.diet_plan_set&&ETM.diet_plan_set.managed_account&&$(".food_control_panel .recurring_icon_modal",
ETM.food_object_modal.model_view.el).hide()},openStaticFoodModal:function(){this.$el.tooltip("hide");ETM.food_object_modal.loadFood(this.model);$(".hide_when_static",ETM.food_object_modal.model_view.el).hide()},deleteFood:function(){this.$el.tooltip("dispose");this.model.destroy();this.remove()},openAddLeftoversModal:function(a){a.preventDefault();this.add_leftover_modal||(this.add_leftover_modal=new ETM.LeftoversAddModalView({model:this.model}));this.add_leftover_modal.parent_modal=this;this.add_leftover_modal.getModalElement().html(this.add_leftover_modal.render().el);
this.add_leftover_modal.$el.modal("show")},flashFoodBackground:function(){var a=this;setTimeout(function(){$(".food_box",a.el).animate({"background-color":"#F09E80"},400).animate({"background-color":"#ffffff"},400).animate({"background-color":"#F09E80"},400).animate({"background-color":"#ffffff"},400).animate({"background-color":"#F09E80"},400).delay(1E3).animate({"background-color":"#ffffff"},2E3)},1)},updateAmount:function(){var a=$(".amount_input",this.el).val(),a=-1!=a.indexOf("/")?Fraction.parseFractionToFloat(a):
roundNumber(parseFloat(a),2);isNaN(a)&&(a=0);this.model.updateFoodAmount(a);this.updateViewStaticAmounts();this.updateTooltip()},updateUnits:function(){var a=parseInt($(".food_units_selector",this.el).val());this.model.updateFoodUnits(a);this.updateViewStaticAmounts();this.updateAmountInput();this.updateTooltip()},updateAmountInput:function(){$(".amount_input",this.el).val(Helper.formatFoodAmount(this.model.static_amount))},resizeAmountInput:function(a){a=a||$("input.amount_input",this.el);if(0!==
a.length){Helper.resizeInputs(a);var b=this.$el.innerWidth();if(0<b){var c=a.next(".food_units_selector"),d=a.closest(".food_right_column"),e=d.prev(".food_image_column"),d=d.next(".food_buttons_col"),f=d.next(".food_buttons_col");a=b-(e.outerWidth(!0)+d.outerWidth(!0)+f.outerWidth(!0)+a.outerWidth(!0)+20);100<a&&c.css("max-width",a+"px")}}},updateViewStaticAmounts:function(){this.updateStaticAmountAndUnits();$(".static_amount",this.el).html(Helper.formatFoodAmount(this.model.static_amount));$(".static_units",
this.el).html(this.model.static_units);this.printGramReadout()},printCalorieReadout:function(){$(".food_calories",this.el).html(roundNumber(this.model.stats.calories,0)+" Calories")},printGramReadout:function(){$(".gram_printout",this.el).html(this.model.getGramReadout())},ignoreMobileTapOnTransparent:function(a,b){ETM.is_mobile||b(a)},shuffleFood:function(a){var b=this;!ETM.currently_generating&&_.has(b.model.attributes,"meal")&&(ETM.startedGenerating(),$(a.currentTarget).stop(),a.currentTarget.style.opacity=
0.5,$(a.currentTarget).find(".etm-icon").addClass("icon-rotating"),$(a.currentTarget).attr("disabled","true"),$(".food_refresh_btn",b.el).tooltip("dispose"),b.$el.tooltip("dispose"),clearTimeout(tooltip_timer),clearTimeout(update_ingredients_timer),this.stopListening(this.model.attributes.food),this.model.regenerateFoodServer(function(){$(a.currentTarget).removeAttr("disabled");$(a.currentTarget).removeAttr("style");$(a.currentTarget).find(".etm-icon").removeClass("icon-rotating");"function"==typeof b.runAfterShuffle&&
b.runAfterShuffle()}))},updateStaticAmountAndUnits:function(){this.model.updateStaticAmountAndUnits()},selectorHTML:function(){for(var a="<select class='food_units_selector'>",b=0;b<this.model.attributes.food.attributes.weights.length;b++)if(0!=b||!1!==this.model.attributes.food.attributes.accurate_grams&&null!=this.model.attributes.food.attributes.accurate_grams)a+="<option value="+b,b==this.model.attributes.units&&(a+=" selected"),a+=">"+this.model.attributes.food.attributes.weights[b].description+
"</option>";return a+"</select>"},applyTooltip:function(){this.tooltip_handler.applyTooltip(this.$el)},applyIngredientsLookup:function(){this.tooltip_handler.applyIngredientsLookup(this.$el)},updateTooltip:function(){this.tooltip_handler.updateTooltip(this.$el)},tooltipHTML:function(){return this.tooltip_handler.tooltipHTML()},applyHoverEffects:function(){var a=this;this.timer1=null;this.$el.hover(function(){clearTimeout(a.timer1)},function(){a.timer1=setTimeout(function(){$(".dropdown.show .dropdown-toggle",
a.el).dropdown("toggle")},900)})},renderFoodRating:function(){var a=this.model.attributes.food.attributes.food_rating;"undefined"!=typeof a&&null!=a&&(a.attributes.rating==THUMB_RATINGS.THUMBS_DOWN?($(".thumbs_down",this.el).addClass("active").removeClass("inactive"),$(".thumbs_up",this.el).removeClass("active").addClass("inactive")):a.attributes.rating==THUMB_RATINGS.THUMBS_UP?($(".thumbs_down",this.el).removeClass("active").addClass("inactive"),$(".thumbs_up",this.el).addClass("active").removeClass("inactive")):
a.attributes.rating===THUMB_RATINGS.NO_RATING&&($(".thumbs_down",this.el).removeClass("active").addClass("inactive"),$(".thumbs_up",this.el).removeClass("active").addClass("inactive")))},toggleThumb:function(a){if(!ETM.is_logged_in)return this.showLoggedOutThumbTooltip(a),!1;var b=a.hasClass("thumbs_up")?$(".food_thumbs .thumbs_down",this.el):$(".food_thumbs .thumbs_up",this.el);a.prop("disabled",!0);b.prop("disabled",!0);ETM.local_variables.attributes.seen_food_rating_info||(this.showThumbInfoPopup(a),
ETM.local_variables.save({seen_food_rating_info:!0}));a.toggleClass("active").toggleClass("inactive");if(a.hasClass("active")){b.hasClass("active")&&b.toggleClass("active").toggleClass("inactive");var c=a.hasClass("thumbs_up")?THUMB_RATINGS.THUMBS_UP:THUMB_RATINGS.THUMBS_DOWN}else c=THUMB_RATINGS.NO_RATING;this.model.attributes.food.saveThumbRating(c,function(){a.prop("disabled",!1);b.prop("disabled",!1)})},showThumbInfoPopup:function(a){Helper.oneTimePopover({element:a.parent().parent(),position:"top",
message:"Use the thumb ratings on foods to let us know which individual foods you like and don't like.  If you thumbs up a food it will appear more often in your plans.  If you thumbs down a food it will no longer appear in plans.",title:"Rating your foods",button_dismiss:!0,custom_class:"meal_rating_info_popup"})},showLoggedOutThumbTooltip:function(a){Helper.oneTimeTooltip(a.parent().parent(),"top","With a free account, these thumb buttons will teach our generator what foods you do and don't like.",
4E3)}});var recoupLeft,recoupTop;
ETM.FoodListView=Backbone.CollectionView.extend({tagName:"ul",sortable:!0,selectable:!1,sortableOptions:function(){return ETM.is_mobile?{connectWith:".meal_foods",handle:".draggable_handle",placeholder:"list_placeholder",axis:"y",tolerance:"pointer",scroll:!1}:{connectWith:".meal_foods",placeholder:"list_placeholder",tolerance:"pointer",scroll:!1}},initialize:function(a){var b=this;Backbone.CollectionView.prototype.initialize.apply(this,arguments);"undefined"!=typeof ETM.current_profile_completeness&&!1===
ETM.current_profile_completeness.attributes.drag_food&&this.listenToOnce(this,"sortStop",function(a,b){ETM.finish_profile_completeness_key("drag_food")});this.listenTo(ETM.recurring_foods_list,"add remove",function(){b.checkIfFoodsRecurring()})},checkIfFoodsRecurring:function(){ETM.is_logged_in&&this.viewManager.each(function(a){a.checkIfRecurring()})},render:function(){Backbone.CollectionView.prototype.render.call(this);this.checkIfFoodsRecurring()},emptyListCaption:"<div class='row'><div class='col-12 text-light-gray text-small empty_meal_box'><div class='text-label text-strong pb-2'>Empty Meal</div>Hit <i class=\"fa fa-refresh\"></i> to generate, or search for foods to add and drag them in. <a style='font-size: 12px;display: block;' target='_blank' href='https://eatthismuch.groovehq.com/knowledge_base/topics/why-is-the-generator-leaving-some-of-my-meals-empty'>Is the generator leaving this empty?</a></div></div>",
modelView:ETM.FoodObjectView});ETM.RestaurantFoodObjectView=ETM.FoodObjectView.extend({className:function(){return"row"},events:function(){this.use_static_modal=!0;return _.extend({},ETM.FoodObjectView.prototype.events,{"click .report_food_icon":"reportFoodModal"})},reportFoodModal:function(){var a=new ETM.RestaurantReportModalView({model:this.model.attributes.food});a.getModalElement().html(a.render().el);a.$el.modal("show")},applyHoverEffects:function(){}});
ETM.RestaurantFoodListView=Backbone.CollectionView.extend({tagName:"ul",sortable:!1,selectable:!1,emptyListCaption:"<div class='row'><div class='col-10 offset-1 empty_meal_box'>There are no foods for this restaurant.</div></div>",modelView:ETM.RestaurantFoodObjectView});
ETM.FoodObjectModalView=ModalView.extend({modal_id:"food_object_modal_div",id:"food_object_modal",tagName:"div",initialize:function(){this.ingredients_scale="to_cook";this.editing_old_recipe=this.has_different_scale_to_cook=!1},addTooltips:function(){$(".image_upload_tooltip",this.el).tooltip({placement:"right",title:'<p align="left">Images you upload will only be immediately viewable by you, however we reserve the right  to make images viewable by everyone.</p>',html:!0})},render:function(){this.$el.html(this.template());
this.$el.modal({show:!1});this.addTooltips();return this},loadFood:function(a,b){b||this.$el.modal("show");Helper.removeHiddenTooltips();this.ingredients_scale="to_cook";this.model=a;this.model.ingredients_scale=this.ingredients_scale;this.has_different_scale_to_cook=!1;this.model.get("food").get("is_recipe")?(this.model.getAmountToCook()!=this.model.getServingAmount()&&(this.has_different_scale_to_cook=!0),this.model.has_different_scale_to_cook=this.has_different_scale_to_cook,this.model_view=new ETM.FoodObjectModalRecipeView({model:this.model})):
(this.model.has_different_scale_to_cook=this.has_different_scale_to_cook,this.model_view=new ETM.FoodObjectModalBasicView({model:this.model}));this.model_view.parent=this;$(".modal-dialog",this.el).html(this.model_view.render().el);this.model_view.delayPrintGraph()}});
ETM.FoodObjectModalBasicView=ETM.FoodObjectView.extend({className:"modal-content",tagName:"div",events:{"click .food_refresh_btn":"shuffleFood","click .food_delete_icon":"deleteFood","click .delete_custom_food":"deleteCustomFood","click .edit_custom_food":"editCustomFood","click .copy_custom_food":"copyFood","click .recurring_icon_modal":"openRecurringFoodModal","keyup .modal_recipe_servings .amount_input":"updateAmount","blur .modal_recipe_servings .amount_input":function(a){this.resizeAmountInput($(a.currentTarget));
this.model.saveAfterAmountUpdate()},"click .add_leftovers":"openAddLeftoversModal","change .modal_recipe_servings .food_units_selector":"updateUnits","click .favorite_food":function(a){$(a.currentTarget).prop("disabled")||this.model.toggleFavorite($(a.currentTarget))},"click .block_icon_modal":function(a){$(a.currentTarget).prop("disabled")||this.model.toggleBlock($(a.currentTarget))},"click .add_to_plan_btn":"openAddToPlanModal","click .add_to_collection_btn":"openAddToCollectionModal","click .expand_modal_nutrition":"expandNutrition",
"change .recipe_scale_selector":"updateIngredientAmounts","click .admin_edit_basic_food":"adminEditBasicFood","click .save_basic_food_tags":"saveBasicFoodTags","click .copy_permalink":function(){Helper.copyPermalink($(".recipe_permalink",this.el),$(".copy_permalink",this.el))},"click .report_food_btn":"reportFoodModal","click .ingredient_origin_link":"navToIngredientOrigin","click .food_thumbs .thumb_icon":function(a){$(a.currentTarget).prop("disabled")||this.toggleThumb($(a.currentTarget))},"click .amazon_order_button a":function(){amplitude.logEvent("amazon_find_food",
{})}},initialize:function(){var a=this;this.tooltip_handler=new ETM.FoodTooltipHandler(this.model);this.listenTo(this.model.attributes.food,"addFavorite",function(){this.model.is_favorite=!0;$(".food_control_panel .favorite_food",this.el).addClass("active")},this);this.listenTo(this.model.attributes.food,"removeFavorite",function(){this.model.is_favorite=!1;$(".food_control_panel .favorite_food",this.el).removeClass("active")},this);this.listenTo(this.model,"imageUpdated",function(){this.parent.$el.parent().addClass("modal-open")},
this);this.listenTo(this.model,"foodChanged",function(){this.update_timer&&clearTimeout(this.update_timer);this.update_timer=setTimeout(function(){a.parent.loadFood(a.model,!0)},200)},this)},openAddToPlanModal:function(){if(ETM.is_logged_in){if(!ETM.calendar_list){var a=new Date;UrlFunctions.getUrlParameter("date")&&-1!=Backbone.history.fragment.indexOf("date")&&(a=Helper.parseDateString(UrlFunctions.getUrlParameter("date")));ETM.calendar_list=new ETM.CalendarDietList([],{selected_date:a})}if(ETM.add_food_modal){var a=
ETM.add_food_modal.selected_date,b=ETM.add_food_modal.selected_meal_num;ETM.add_food_modal.close();ETM.add_food_modal=null;ETM.add_food_modal=new ETM.AddFoodModal;ETM.add_food_modal.selected_date=a;ETM.add_food_modal.selected_meal_num=b}else ETM.add_food_modal=new ETM.AddFoodModal;a=this.model.clone();Helper.clearIDs(a);a.updateStaticAmountAndUnits();ETM.add_food_modal.loadFood(a);ETM.add_food_modal.getModalElement().html(ETM.add_food_modal.render().el);ETM.add_food_modal.initModal();ETM.add_food_modal.$el.modal("show")}},
openAddToCollectionModal:function(){if(ETM.add_to_collection_modal){var a=ETM.add_to_collection_modal.selected_collection;ETM.add_to_collection_modal.close();ETM.add_to_collection_modal=null;ETM.add_to_collection_modal=new ETM.FoodCollectionAddModalView;ETM.add_to_collection_modal.selected_collection=a}else ETM.add_to_collection_modal=new ETM.FoodCollectionAddModalView;ETM.add_to_collection_modal.foods=[this.model];ETM.add_to_collection_modal.getModalElement().html(ETM.add_to_collection_modal.render().el);
ETM.add_to_collection_modal.$el.modal("show")},addTooltips:function(){$(".personalize_tooltip",this.el).tooltip({placement:"bottom",title:"This lets you create a new version of the recipe that will automatically replace the original anytime you generate a meal plan.<br/><br/>This is useful if you want to substitute any ingredients, or add some more and see how the nutrition adds up.",html:!0});$(".image_upload_tooltip",this.el).tooltip({placement:"bottom",title:'<p align="left">Images you upload will only be immediately viewable by you, however we reserve the right to make your image the default (viewable by everyone).</p>',
html:!0});$(".thumbs_up",this.el).tooltip({trigger:"hover",placement:"top",title:"Like this"});$(".thumbs_down",this.el).tooltip({trigger:"hover",placement:"top",title:"Don't like this (block)"});$(".favorite_icon",this.el).tooltip({trigger:"hover",placement:"top",title:"Add to Favorites"});$(".recurring_icon_modal",this.el).tooltip({trigger:"hover",placement:"top",title:"Set as Recurring"});$(".food_refresh_btn",this.el).tooltip({trigger:"hover",placement:"top",title:"Refresh this food"});$(".food_delete_icon",
this.el).tooltip({trigger:"hover",placement:"top",title:"Remove from plan"});$(".add_to_plan_icon",this.el).tooltip({trigger:"hover",placement:"top",title:"Add to..."});$(".copy_permalink",this.el).tooltip({trigger:"hover",placement:"top",title:"Copy URL to clipboard"})},render:function(){this.updateStaticAmountAndUnits();this.$el.html(this.template({model:this.model,image:this.model.attributes.food.getDisplayImage(),amino_acids:ETM.amino_acids,fatty_acids:ETM.fatty_acids,vits_and_mins:ETM.vits_and_mins,
nutrient_names:ETM.nutrient_names,grocery_origin:this.groceryOriginLinks(),selector_html:this.selectorHTML(),user_id:ETM.current_user_profile.attributes.user_id?ETM.current_user_profile.attributes.user_id:!1,amazon_search_keyword:ETM.AmazonFreshHelper.getFoodName(this.model)}));this.renderFoodRating();this.printFoodStats();this.resizeAmountInput();this.create_uploader();this.addTooltips();this.renderAdminTags();this.renderCuratorSection();this.model.is_favorite&&$(".control_button.favorite_food",
this.el).addClass("active");$("img.lazyload",this.el).unveil();$("img.lazyload",this.el).trigger("unveil");return this},navToIngredientOrigin:function(a){a.preventDefault();var b=$(a.currentTarget).data("date");a=$(a.currentTarget).data("food_id");this.parent.$el.modal("hide");ETM.router.navigateAndScroll("?date="+b+"&food_id="+a,{trigger:!0})},groceryOriginLinks:function(){if(_.has(this.model.attributes,"origin_json")&&3<this.model.attributes.origin_json.length){var a=JSON.parse(this.model.attributes.origin_json);
grocery_origin="<ul>";string_list=this.model.attributes.origin_string.split("<hr>");origin_index=0;a.forEach(function(a){grocery_origin=grocery_origin+"<li>"+(a.amount+" "+a.units+" <strong>"+a.food_name+"</strong> ("+a.date+")")+" <a data-date='"+a.date+"' data-food_id='"+a.food_id+"' class='ingredient_origin_link' href='javascript:void(0)'>[View in plan]</a></li>";origin_index++});return grocery_origin+="</ul>"}return!1},renderCuratorSection:function(){if(this.isUsingCurator()){var a=new ETM.FoodChangesListView({model:this.model});
a.food_object_modal=this;$(".curator_div",this.el).html(a.render().el)}},isUsingCurator:function(){return!0==ETM.current_user_profile.get("is_staff")&&Backbone.history&&_.has(Backbone.history,"fragment")&&-1!==Backbone.history.fragment.indexOf("curator")?!0:!1},reportFoodModal:function(){var a=new ETM.FoodReportModalView({model:this.model.attributes.food});a.getModalElement().html(a.render().el);a.$el.modal("show")},create_uploader:function(){var a=this;ETM.is_logged_in&&ETM.displayImageSelectModal($(".food_upload_image",
this.el),function(b){a.modal&&a.modal.close();a.modal=new ETM.FoodImageCropModalView({model:a.model});a.modal.getModalElement().html(a.modal.render(b).el);a.modal.show()})},runAfterShuffle:function(){this.parent.loadFood(this.model,!0);this.updateIngredientAmounts();this.model.trigger("modalUpdated")},expandNutrition:function(){$(".nutrition_info",this.el).slideToggle(100)},updateAmount:function(a){this.resizeAmountInput($(a.currentTarget));a=$(".amount_input",this.el).val();a=-1!=a.indexOf("/")?
Fraction.parseFractionToFloat(a):roundNumber(parseFloat(a),2);isNaN(a)&&(a=0);this.model.updateFoodAmount(a);this.updateStaticAmountAndUnits();this.printFoodStats();this.updateIngredientAmounts();this.updateScaleSelector();this.model.trigger("modalUpdated")},updateIngredientAmounts:function(){if(this.model.get("food").get("is_recipe")&&null!=this.model.get("food").get("ingredients")){var a=$(".recipe_scale_selector",this.el).val();"scaled_servings"===a?this.scaledIngredientsToEat():"cook_scaled_servings"===
a?this.scaledIngredientsToCook():this.unscaledIngredients()}},updateAmountInput:function(){$(".modal_recipe_servings .amount_input",this.el).val(Helper.formatFoodAmount(this.model.static_amount))},updateUnits:function(a){var b=parseInt($(".food_units_selector",this.el).val());this.model.updateFoodUnits(b);this.updateStaticAmountAndUnits();this.updateAmountInput();this.updateScaleSelector();this.resizeAmountInput($(a.currentTarget).prev(".amount_input"));this.printFoodStats();this.model.trigger("modalUpdated")},
deleteFood:function(){this.parent.$el.modal("hide");this.model.destroy();this.model.trigger("modelDeleted")},deleteCustomFood:function(a){var b=this;Helper.confirmationPopover({element:$(a.target),title:"Are you sure?",message:"<p>It will be removed from your custom food/recipe list, but may still remain in your meal plans. You cannot undo this.</p>",position:"bottom",cancel_text:"Cancel",confirm_text:"Yes, delete",confirmCallback:function(){b.model.attributes.food.save({deleted:!0},{patch:!0});var a=
b.model.get("food").get("is_recipe")?"custom_recipes":"custom_foods";ETM.search_model.search_results_model_dict[a].all_foods.food_info_object_list.remove(b.model.attributes.food.id);b.model.destroy();b.model.trigger("modelDeleted");b.parent.$el.modal("hide")}})},editCustomFood:function(){if(this.model.get("food").get("is_recipe")){var a=this;this.model.get("food").downloadRecipeInfo(function(){ETM.recipe_editor=new ETM.RecipeEditorModalView;ETM.recipe_editor.copyThenLoad(a.model,!1);ETM.recipe_editor.getModalElement().html(ETM.recipe_editor.render().el);
ETM.recipe_editor.$el.modal("show");ETM.recipe_editor.printGraph();ETM.recipe_editor.applyEvents()})}else ETM.custom_food_form=new ETM.CustomFoodFormModalView({model:ETM.search_model.search_results_model_dict.custom_foods.all_foods.food_info_object_list}),ETM.custom_food_form.parent=this,ETM.custom_food_form.getModalElement().html(ETM.custom_food_form.render()),ETM.custom_food_form.food_id=this.model.attributes.food.attributes.id,ETM.custom_food_form.loadFood(this.model.attributes.food),ETM.custom_food_form.$el.modal("show")},
copyFood:function(){ETM.custom_food_form=new ETM.CustomFoodFormModalView({model:ETM.search_model.search_results_model_dict.custom_foods.all_foods.food_info_object_list});ETM.custom_food_form.parent=this;ETM.custom_food_form.getModalElement().html(ETM.custom_food_form.render());ETM.custom_food_form.loadFood(this.model.attributes.food,!0);ETM.custom_food_form.$el.modal("show");amplitude.logEvent("copy_basic_food");if("c"!==this.model.attributes.food.attributes.model&&1<this.model.attributes.food.attributes.default_units){var a=
this.model.attributes.food.attributes.weights,b=this.model.attributes.food.attributes.default_units;ETM.toast.showNotification({message:"Keep in mind, the nutrition for this food is entered per "+a[1].amount+" "+a[1].description+", but the default units are set as "+a[b].amount+" "+a[b].description+'.<br/><br/>You can modify the units under "Optional fields," but nutrition will always be based on the first units.',type:"info",timeout:12E3,extendedTimeout:6E3,position:"toast-bottom-wide-center"})}},
printFoodStats:function(){$("#serving_size",this.el).html(Helper.formatFoodAmount(this.model.static_amount)+" "+this.model.static_units);if(this.model.get("food").attributes.accurate_grams){var a=this.model.get("amount")*this.model.get("food").attributes.weights[this.model.get("units")].grams;$("#serving_grams",this.el).html(roundNumber(a,2))}for(var a=this.model.stats,b=new DailyRecommended,c=0;c<all_nutrients.length;c++){var d;d=0==b[all_nutrients[c]]?"-":Math.ceil(100*(a[all_nutrients[c]]/b[all_nutrients[c]]))+
"%";$("#"+all_nutrients[c],this.el).html(Math.round(a[all_nutrients[c]]*Math.pow(10,1))/Math.pow(10,1));$("#"+all_nutrients[c],this.el).next(".amount_units").html(micro_units[c]);$("#"+all_nutrients[c]+"_dv",this.el).html(d)}b=roundNumber(a.carbs-a.fiber,1);0>b&&(b=0);$("#net_carbs",this.el).html(b).next(".amount_units").html("g");$("#calories",this.el).html(roundNumber(a.calories,1));$("#fat_cals",this.el).html(roundNumber(9*a.fats,1));$("#fat_cal_percent",this.el).html(roundNumber(100*(9*a.fats/
a.calories),1));a=getStatsHTMLFromTemplate(a);$("#modal_day_stats .stats_output",this.el).html(a)},delayPrintGraph:function(){var a=this;setTimeout(function(){a.printGraph()},500)},printGraph:function(){var a=4*this.model.stats.getPrimaryCarbs()+4*this.model.stats.proteins+9*this.model.stats.fats,b=$("#modal_cumulative_graph",this.el);if(0>=a)b.html("");else{var c=roundNumber(100*(4*this.model.stats.getPrimaryCarbs()/a),2),d=roundNumber(100*(9*this.model.stats.fats/a),2),a=roundNumber(100*(4*this.model.stats.proteins/
a),2),c=[{label:"Carbs",data:c,color:"#FCB524"},{label:"Protein",data:a,color:"#976fe8"},{label:"Fat",data:d,color:"#52C0BC"}];try{$.plot(b,c,{series:{pie:{startAngle:0,show:!0,radius:1,label:{show:!0,radius:0.5,formatter:function(a,b){return'<div style="font-size:7pt;text-align:center;padding:2px;color:white;">'+a+"<br/>"+Math.round(b.percent)+"%</div>"},threshold:0.1}}},legend:{show:!1}})}catch(e){}}},updateScaleSelectorOLD:function(){var a=Helper.formatFoodAmount(this.model.static_amount)+" "+
this.model.static_units;25<a.length&&(a=a.slice(0,20)+"...");$(".current_serving_amount",this.el).html(a)},updateScaleSelector:function(){this.model.get("food").get("is_recipe")&&(this.scaleTemplate||(this.scaleTemplate=ETM.loadTemplate("#RecipeScaleSelector")),$(".recipe_scale_div",this.el).html(this.scaleTemplate({model:this.model})))},updateServingDescription:function(){$(".long_serving_description",this.el).html(this.getServingDescription())},getServingDescription:function(){if(_.has(this.model,
"amount_to_cook")&&this.model.amount_to_cook!=this.model.getServingAmount()&&0<this.model.amount_to_cook){$(".amount_to_prepare",this.el).html(this.model.amount_to_cook+" servings");var a="Prepare a total of "+this.model.amount_to_cook+" servings";_.has(this.model,"family_scale")&&1<this.model.family_scale&&(a+=", each of your "+this.model.family_scale+" family members eats "+this.model.getServingAmount(),a=1<this.model.attributes.amount?a+" servings":a+" serving");_.has(this.model,"leftovers_servings")&&
0<this.model.leftovers_servings&&(a+=", save "+this.model.leftovers_servings,a=1<this.model.attributes.amount?a+" servings for leftovers":a+" serving for leftovers")}else a="";return a},scaledIngredientsToEat:function(){this.parent.ingredients_scale="to_eat";this.model.ingredients_scale="to_eat";this.model.getAmountToCook();this.updateServingDescription();var a=0,a=1==this.model.get("units")?this.model.get("amount"):this.model.attributes.amount*this.model.attributes.food.attributes.weights[this.model.attributes.units].grams/
this.model.attributes.food.attributes.weights[1].grams;this.setIngredientScale(a);this.printFoodStats()},scaledIngredientsToCook:function(){this.model.getAmountToCook();this.updateServingDescription();this.parent.ingredients_scale="to_cook";this.model.ingredients_scale="to_cook";this.setIngredientScale(this.model.amount_to_cook);this.printFoodStats()},unscaledIngredients:function(){this.model.getAmountToCook();this.updateServingDescription();this.parent.ingredients_scale="original";this.model.ingredients_scale=
"original";this.setIngredientScale(this.model.get("food").get("number_servings"));this.printFoodStats()},setIngredientScale:function(a){this.model.scaleIngredients(a);_.has(this,"ingredients_list_view")?this.ingredients_list_view.render():console.log("DOESN'T HAVE INGREDIENTS LIST VIEW")},adminEditBasicFood:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;ETM.food_info_object_list.add(this.model.attributes.food);ETM.custom_food_form=new ETM.CustomFoodFormModalView({model:ETM.food_info_object_list});
ETM.custom_food_form.parent=this;ETM.custom_food_form.getModalElement().html(ETM.custom_food_form.render());ETM.custom_food_form.food_id=this.model.attributes.food.attributes.id;ETM.custom_food_form.loadFood(this.model.attributes.food);ETM.custom_food_form.$el.modal("show")},renderAdminTags:function(){$("#food_tags",this.el).val(this.model.get("food").get("extra_tags"))},saveBasicFoodTags:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;$(".save_basic_food_tags",a.el).attr("disabled",
!0);var b=$("#food_tags",this.el).val();$.ajax({url:"/admin/food/save_tags/"+this.model.get("food").get("id"),data:{extra_tags:b},type:"POST",success:function(c){$(".save_tags_errors",a.el).html("<span class='text-success'>Success!</span>");a.model.attributes.food.attributes.extra_tags=b;$(".save_basic_food_tags",a.el).attr("disabled",!1)},error:function(b,d,e){$(".save_tags_errors",a.el).html("<span class='text-danger'>Shit, an error!</span>");$(".save_basic_food_tags",a.el).attr("disabled",!1);
console.log(d);console.log(e)}})}});
ETM.IngredientObjectView=ETM.FoodObjectView.extend({events:function(){var a=_.extend({},ETM.FoodObjectView.prototype.events,{"change .preparation_text":"changePreparationText"});delete a.click;return a},initialize:function(){this.tooltip_handler=new ETM.FoodTooltipHandler(this.model)},changePreparationText:function(){this.model.attributes.preparation=$(".preparation_text",this.el).val();$(".static_preparation_text",this.el).text(this.model.attributes.preparation)},render:function(){this.updateStaticAmountAndUnits();
this.model.selector_html=this.selectorHTML();var a=this.template(_.extend({},this.model,{read_only:!1,image:this.model.attributes.food.getDisplayImage()}));this.$el.html(a);this.applyTooltip();this.printGramReadout();this.resizeAmountInput();return this}});ETM.vits_and_mins="vit_a vit_b6 vit_b12 vit_c vit_d vit_d2 vit_d3 vit_e vit_k caffeine calcium iron magnesium phosphorus zinc copper fluoride manganese selenium retinol lycopene thiamine riboflavin niacin folate choline betaine water".split(" ");
ETM.amino_acids="tryptophan threonine isoleucine leucine lysine methionine cystine phenylalanine tyrosine valine arginine histidine alanine aspartic_acid glutamic_acid glycine proline serine hydroxyproline".split(" ");ETM.fatty_acids="ala_fatty_acid dha_fatty_acid epa_fatty_acid dpa_fatty_acid total_omega_3 total_omega_6".split(" ");
ETM.nutrient_names={vit_e:"Vitamin E",copper:"Copper",saturated_fats:"Saturated fats",alanine:"Alanine",vit_a:"Vitamin A",glycine:"Glycine",vit_d:"Vitamin D",proteins:"Proteins",valine:"Valine",vit_k:"Vitamin K",phenylalanine:"Phenylalanine",polyunsaturated_fats:"Polyunsaturated fats",zinc:"Zinc",galactose:"Galactose",isoleucine:"Isoleucine",lysine:"Lysine",alcohol:"Alcohol",serine:"Serine",vit_c:"Vitamin C",selenium:"Selenium",caffeine:"Caffeine",folate:"Folate (B9)",leucine:"Leucine",methionine:"Methionine",
choline:"Choline",vit_b6:"Vitamin B6",trans_fats:"Trans fats",vit_d2:"Vitamin D2",vit_d3:"Vitamin D3",proline:"Proline",price:"Price",cystine:"Cystine",glucose:"Glucose",aspartic_acid:"Aspartic acid",niacin:"Niacin",fiber:"Fiber",monounsaturated_fats:"Monounsaturated fats",maltose:"Maltose",potassium:"Potassium",hydroxyproline:"Hydroxyproline",arginine:"Arginine",fats:"Fats",glutamic_acid:"Glutamic acid",fructose:"Fructose",tryptophan:"Tryptophan",threonine:"Threonine",histidine:"Histidine",phosphorus:"Phosphorus",
vit_b12:"Vitamin B12",carbs:"Carbs",lycopene:"Lycopene",lactose:"Lactose",retinol:"Retinol",sodium:"Sodium",calories:"Calories",manganese:"Manganese",betaine:"Betaine",calcium:"Calcium",riboflavin:"Riboflavin (B2)",thiamine:"Thiamine",magnesium:"Magnesium",iron:"Iron",cholesterol:"Cholesterol",tyrosine:"Tyrosine",fluoride:"Fluoride",water:"Water",alpha_carotene:"Alpha Carotene",beta_carotene:"Beta Carotene",pantothenic_acid:"Pantothenic acid",vit_a_iu:"Vitamin A IU",vit_d_iu:"Vitamin D IU",starch:"Starch",
sucrose:"Sucrose",sugar:"Sugar",theobromine:"Theobromine",ala_fatty_acid:"Alpha Lipoic Acid (ALA)",dha_fatty_acid:"Docosahexaenoic acid (DHA)",epa_fatty_acid:"Eicosapentaenoic acid (EPA)",dpa_fatty_acid:"Docosapentaenoic acid (DPA)",total_omega_3:"Total Omega 3",total_omega_6:"Total Omega 6"};
var all_nutrients="alanine alcohol arginine aspartic_acid betaine caffeine calcium calories carbs cholesterol choline copper cystine fats fiber fluoride folate fructose galactose glucose glutamic_acid glycine histidine hydroxyproline iron isoleucine lactose leucine lycopene lysine magnesium maltose manganese methionine monounsaturated_fats niacin phenylalanine phosphorus polyunsaturated_fats potassium proline proteins retinol riboflavin saturated_fats selenium serine sodium thiamine threonine trans_fats tryptophan tyrosine valine vit_a vit_b6 vit_b12 vit_c vit_d vit_d2 vit_d3 vit_e vit_k water zinc price alpha_carotene beta_carotene pantothenic_acid vit_a_iu vit_d_iu starch sucrose sugar theobromine ala_fatty_acid dha_fatty_acid epa_fatty_acid dpa_fatty_acid total_omega_3 total_omega_6".split(" "),daily_rec=
[0,0,0,0,0,0,1E3,0,0,0,550,2,0,0,25,0,400,0,0,0,0,0,0,0,8,0,0,0,0,0,350,0,2,0,0,20,0,1E3,0,4700,0,0,0,1.7,0,70,0,2400,1.5,0,0,0,0,0,900,1.3,2.4,60,15,0,0,20,120,0,15,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0],micro_units="g;g;g;g;mg;mg;mg;kcal;g;mg;mg;mg;g;g;g;\u03bcg;\u03bcg;g;g;g;g;g;g;g;mg;g;g;g;\u03bcg;g;mg;g;mg;g;g;mg;g;mg;g;mg;g;g;\u03bcg;mg;g;\u03bcg;g;mg;mg;g;g;g;g;g;\u03bcg RAE;mg;\u03bcg;mg;\u03bcg;\u03bcg;\u03bcg;mg;\u03bcg;g;mg;USD;\u03bcg;\u03bcg;mg;IU;IU;g;g;g;mg;g;g;g;g;g;g".split(";");
function DailyRecommended(){for(var a=0;a<all_nutrients.length;a++)this[all_nutrients[a]]=daily_rec[a]}
ETM.FoodReportModalView=ModalView.extend({modal_id:"food_report_modal",events:{"click .send_report":"sendReport"},render:function(){this.$el.html(this.template({food_name:this.model.attributes.food_name,slug:this.model.attributes.slug}));this.renderForm();return this},renderForm:function(){this.form=(new Backbone.Form({schema:{preset_reasons:{type:"Select",validators:["required"],value_type:"Number",options:[{val:3,label:"Incorrect nutrition information"},{val:10,label:"Bad picture"},{val:11,label:"Tasted bad :("},
{val:0,label:"Other reason"}]},custom_reason:{type:"Text",editorAttrs:{maxlength:100}}},template:Helper.createTemplateFunction($("#report_food_form",this.el).html())})).render();$("#report_food_form_container",this.el).html(this.form.el)},sendReport:function(){$(".report_error",this.el).remove();var a=this.form.validate();if("0"===this.form.getValue("preset_reasons")){var b=this.form.getValue("custom_reason");b&&""!==b||(a||(a={}),a.custom_reason={message:"This field is required.",type:"required"})}if(a)for(var c in a)$('[data-editors="'+
c+'"]').append('<div class="report_error alert alert-danger">'+a[c].message+"</div>");else $(".report_error",this.el).empty(),(new ETM.ReportFood(this.form.getValue())).save({food:this.model.attributes.resource_uri}),this.$el.modal("hide")}});
ETM.RestaurantReportModalView=ETM.FoodReportModalView.extend({modal_id:"restaurant_report_modal",renderForm:function(){this.form=(new Backbone.Form({schema:{preset_reasons:{type:"Select",validators:["required"],options:[{val:12,label:"Food shouldn't be recommended in meals"},{val:15,label:"Food shown for wrong restaurant"},{val:13,label:"Food discontinued by restaurant"},{val:14,label:"Bad meal pairing"},{val:3,label:"Incorrect nutrition information"},{val:10,label:"Bad picture"},{val:11,label:"Tasted bad :("},
{val:0,label:"Other reason"}]},custom_reason:{type:"TextArea",editorAttrs:{maxlength:2048}}},template:Helper.createTemplateFunction($("#report_food_form",this.el).html())})).render();$("#report_food_form_container",this.el).html(this.form.el)}});ETM.FoodTooltipClass=function(a){this.model=a};ETM.FoodTooltipClass.extend=Backbone.Model.extend;
ETM.FoodTooltipHandler=ETM.FoodTooltipClass.extend({getTooltipPlacement:function(){return ETM.is_mobile?"top":"right"},applyTooltip:function(a){a.tooltip("dispose");var b=ETM.is_mobile?"click":"hover";a.tooltip({title:this.tooltipHTML(),html:!0,animation:!1,placement:this.getTooltipPlacement(),boundary:"viewport",trigger:b,template:'<div class="tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner food_obj_tooltip"></div></div>',delay:{show:tooltip_show_delay,hide:0}});this.model.attributes.food.attributes.is_recipe&&
this.applyIngredientsLookup(a)},applyIngredientsLookup:function(a){var b=this,c=this.model.attributes.food,d=_.has(this.model.attributes.food.attributes,"missing_ids")&&_.has(this.model.attributes.food.attributes,"missing_ingredients")||_.has(this.model.attributes,"missing_ids")&&_.has(this.model.attributes,"missing_ingredients");a.hover(function(){if(c.hasOwnProperty("tooltip_ingredients"))update_ingredients_timer=setTimeout(function(){b.updateTooltip(a)},tooltip_show_delay+1);else{var e=c.attributes.id,
f=d?grabPantrySidebarIngredients(e):grabIngredients(e);!1==f?tooltip_timer=setTimeout(function(){d?$.post("/food/fetch_sidebar_pantry_ingredients/",{recipe_ids:JSON.stringify([e])},function(d){all_pantry_sidebar_ingredients[e]=JSON.parse(d);c.tooltip_ingredients=all_pantry_sidebar_ingredients[e];b.updateTooltip(a)}):c.attributes.user_id===ETM.current_user_profile.attributes.user_id?$.post("/food/fetch_ingredients/",{recipe_ids:JSON.stringify([e])},function(d){all_ingredients[e]=JSON.parse(d);c.tooltip_ingredients=
all_ingredients[e];b.updateTooltip(a)}):$.get("/food/ingredients/"+e+"/",function(d){all_ingredients[e]=JSON.parse(d);c.tooltip_ingredients=all_ingredients[e];b.updateTooltip(a)})},tooltip_show_delay+150):(c.tooltip_ingredients=f,setTimeout(function(){b.updateTooltip(a)},tooltip_show_delay+1))}},function(){clearTimeout(tooltip_timer);clearTimeout(update_ingredients_timer)})},updateTooltip:function(a){try{var b=a.data("bs.tooltip"),c=$(a.data("bs.tooltip").tip),d=c.find("> .arrow"),e=d.offset().top-
d.parent().offset().top,f=parseFloat(c.css("top").replace(/(^\d+)(.+$)/i,"$1")),g=c.innerHeight();a.attr("title",this.tooltipHTML()).tooltip("_fixTitle");c.find("> .tooltip-inner").html(this.tooltipHTML());if(ETM.is_mobile)b._popper.update();else{var h=$(window).scrollTop(),m=c.offset().top-h,k=c.innerHeight();m+k>window.innerHeight||ETM.is_mobile?(a=k-g,c.css("top",f-a+"px"),ETM.is_mobile||d.css("top",e+a+"px")):d.css("top",e+"px")}}catch(n){}},tooltipHTML:function(){var a=this.model.attributes.food,
b=this.model.attributes.food.attributes,c=b.food_name,d=b.description,e=this.model.stats,f="";if(b.is_recipe){var d=_.has(this.model.attributes.food.attributes,"missing_ids")&&_.has(this.model.attributes.food.attributes,"missing_ingredients")||_.has(this.model.attributes,"missing_ids")&&_.has(this.model.attributes,"missing_ingredients"),g="<div class='tooltip_time text-small'>"+b.prep_time+" mins prep, "+b.cook_time+" mins cook</div>",c='<div class="sb_tooltip_title">'+c+"</div>";if(a.hasOwnProperty("tooltip_ingredients")){var h=
this.model.getServingAmount();d?(d=_.has(b,"missing_ids")?b.missing_ids:this.model.attributes.missing_ids,a="<hr class='ingredients_bar'/><div class='recipe_ingredients'>"+pantrySidebarIngredientsHTML(a.tooltip_ingredients,d,h,b.number_servings)+"</div>"):a="<hr class='ingredients_bar'/><div class='recipe_ingredients'>"+ingredientsHTML(a.tooltip_ingredients,h,b.number_servings)+"</div>"}else a="<hr class='ingredients_bar'/><div class='recipe_ingredients'><img src='/static_files/ttp_spinner.gif'/></div>"}else g=
"",c='<div class="sb_tooltip_title">'+c+'</div><div class="sb_tooltip_desc">'+d+"</div>",a="",_.has(this.model.attributes,"origin_string")&&null!==this.model.attributes.origin_string&&0<this.model.attributes.origin_string.length&&(f="<hr class='ingredients_bar'/><div class='grocery_origin'>"+this.model.attributes.origin_string+"</div>");d="";0<e.price?(d='<div class="tt_macro tooltip_price"><div class="tt_macro_name">Est. Price</div><div class="tt_macro_amt">$'+roundNumber(e.price,2).toFixed(2)+"</div></div>",
b.is_recipe&&b.missing_prices&&(d+="<div>*Some missing price info</div>")):d="No price info";b="<div class='tooltip_units text-label'>Per "+Helper.formatFoodAmount(this.model.attributes.amount*b.weights[this.model.attributes.units].amount)+" "+b.weights[this.model.attributes.units].description+"</div>";e='<div class="tt_macro_div"><div class="tt_macro tooltip_calories"><div class="tt_macro_name">Calories</div><div class="tt_macro_amt">'+roundNumber(e.calories,1)+'</div></div><div class="tt_macro tooltip_carbs"><div class="tt_macro_name">'+
ETM.current_user_profile.getPrimaryCarbsTitle()+'</div><div class="tt_macro_amt">'+roundNumber(e.getPrimaryCarbs(),1)+'g</div></div><div class="tt_macro tooltip_fats"><div class="tt_macro_name">Fat</div><div class="tt_macro_amt">'+roundNumber(e.fats,1)+'g</div></div><div class="tt_macro tooltip_proteins"><div class="tt_macro_name">Protein</div><div class="tt_macro_amt">'+roundNumber(e.proteins,1)+"g</div></div>"+d+"</div>";return'<div class="tooltip_box">'+c+g+"<hr class='ingredients_bar'/>"+b+e+
a+f+"</div>"}});
ETM.CuratorView=Backbone.View.extend({initialize:function(){this.food_list=new ETM.FoodList},render:function(){var a=this;this.$el.html(this.template({is_staff:ETM.is_staff,is_logged_in:ETM.is_logged_in,user:ETM.current_user_profile.attributes}));this.loadCuratorProfile(function(){a.loadListToCurate(function(){a.renderListToCurate();a.updateFilters()})});return this},renderForm:function(){this.form=(new Backbone.Form({model:this.model.get("curator"),template:Helper.createTemplateFunction($("#curatorForm",this.el).html())})).render()},
loadCuratorProfile:function(a){var b=this;this.curator_profile?a():(curator_profile_list=new ETM.CuratorProfileList,curator_profile_list.fetch({success:function(){b.curator_profile=curator_profile_list.at(0);1<b.curator_profile.attributes.current_search_query.length&&$("#query_input",this.el).val(b.curator_profile.attributes.current_search_query);a()}}))},reloadCurator:function(a){a.preventDefault();var b=this;a=$("#query_input").val();a!==this.curator_profile.get("current_search_query")?this.curator_profile.save({current_search_query:a},
{success:function(){b.loadListToCurate(function(){b.renderListToCurate();b.updateFilters()})}}):b.loadListToCurate(function(){b.renderListToCurate();b.updateFilters()})},loadListToCurate:function(a){var b=this;$(".loading_gif",this.el).show();$.get("/curator/get-list/",function(c){$(".loading_gif",b.el).hide();var d=[];JSON.parse(c).forEach(function(a){var b=new ETM.FoodObjectWithChanges({food:a,amount:1,units:a.default_units});d.push(b);ETM.food_info_object_list.findWhere({id:a.id})||(a.resource_uri=
a.resource_uri.replace("foodwithchanges","food"),ETM.food_info_object_list.add(a))});b.food_list.reset(d);a()})},renderListToCurate:function(){this.curate_list_view=new ETM.CuratorFoodListView({collection:this.food_list,el:$(".curate_list",this.el)});this.curate_list_view.render()},updateFilters:function(){var a=this.curator_profile;a||(a=this.loadCuratorProfile());(a=a.get("current_search_query"))||(a='{"model__in":"u"}');var b=JSON.parse(a);Object.keys(b).forEach(function(a){var d=$("#"+a);d&&("model__in"==
a?b[a].split(",").forEach(function(a){"ub"!=a&&$("#"+a+"_model").prop("checked",!0)}):d.val(b[a]))})}});
ETM.CuratorFoodObjectView=ETM.FoodObjectView.extend({render:function(){this.updateStaticAmountAndUnits();this.model.selector_html=this.selectorHTML();this.model.image=this.model.attributes.food.getDisplayImage();for(var a="Needs review",b=0;b<this.model.attributes.food.attributes.changes.models.length;b++){var c=this.model.attributes.food.attributes.changes.models[b];if(c.attributes.review_approved){a="Review complete";break}else c.attributes.reviewer===ETM.curator_view.curator_profile.id&&(!c.attributes.review_complete||
c.attributes.review_approved||c.attributes.review_rejected?c.attributes.review_rejected&&c.attributes.review_complete&&(a="Needs re-review"):a="Waiting for approval")}this.model.review_status=a;a=this.template(this.model);this.$el.html(a);this.$el.unbind("mouseenter mouseleave");this.applyHoverEffects();this.applyTooltip();this.printGramReadout();this.resizeAmountInput();return this}});ETM.CuratorFoodListView=ETM.FoodListView.extend({modelView:ETM.CuratorFoodObjectView});
ETM.FoodChangesListView=Backbone.View.extend({events:{"click .create_new_changes":"startNewFoodChanges"},startNewFoodChanges:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;a.food_object_modal.undelegateEvents();this.food_object_modal.parent.$el.one("hidden.bs.modal",function(){a.model.get("food").get("is_recipe")?(ETM.recipe_editor=new ETM.RecipeCuratorModalView,ETM.recipe_editor.loadFoodChanges(a.model,!1),ETM.recipe_editor.getModalElement().html(ETM.recipe_editor.render().el),
ETM.recipe_editor.$el.modal("show"),ETM.recipe_editor.applyEvents(),ETM.recipe_editor.delayPrintGraph()):(ETM.basic_food_curator=new ETM.BasicFoodCuratorModalView,ETM.basic_food_curator.parent=this,ETM.basic_food_curator.loadFoodChanges(a.model),ETM.basic_food_curator.getModalElement().html(ETM.basic_food_curator.render()))}).modal("hide")},render:function(){var a=this;this.$el.html(this.template(this.model));list_div=$(".existing_changes_list",this.el);list_div.html("");_.each(this.model.attributes.food.attributes.changes.models,
function(b){object_view=new ETM.FoodChangesObjectView({model:b});object_view.food_object_modal=a.food_object_modal;list_div.append(object_view.render().el)});return this}});
ETM.FoodChangesObjectView=Backbone.View.extend({events:{"click .edit_changes":"loadExistingChanges","click .duplicate_changes":"copyChanges","click .delete_changes":"deleteChanges","click .merge_changes":"applyChangesToRecipe","change .approval_radio":"setChangesApproval"},initialize:function(){},loadExistingChanges:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;a.food_object_modal.undelegateEvents();this.food_object_modal.parent.$el.one("hidden.bs.modal",function(){a.food_object_modal.model.get("food").get("is_recipe")?
(ETM.recipe_editor=new ETM.RecipeCuratorModalView,ETM.recipe_editor.loadFoodChanges(a.food_object_modal.model,!0,a.model),ETM.recipe_editor.getModalElement().html(ETM.recipe_editor.render().el),ETM.recipe_editor.$el.modal("show"),ETM.recipe_editor.applyEvents(),ETM.recipe_editor.delayPrintGraph()):(ETM.basic_food_curator=new ETM.BasicFoodCuratorModalView,ETM.basic_food_curator.parent=this,ETM.basic_food_curator.loadFoodChanges(a.food_object_modal.model,!0,a.model),ETM.basic_food_curator.getModalElement().html(ETM.basic_food_curator.render()))}).modal("hide")},
copyChanges:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;a.food_object_modal.undelegateEvents();this.food_object_modal.parent.$el.one("hidden.bs.modal",function(){a.food_object_modal.model.get("food").get("is_recipe")?(ETM.recipe_editor=new ETM.RecipeCuratorModalView,ETM.recipe_editor.loadFoodChanges(a.food_object_modal.model,!1,a.model),ETM.recipe_editor.getModalElement().html(ETM.recipe_editor.render().el),ETM.recipe_editor.$el.modal("show"),ETM.recipe_editor.applyEvents(),
ETM.recipe_editor.delayPrintGraph()):(ETM.basic_food_curator=new ETM.BasicFoodCuratorModalView,ETM.basic_food_curator.parent=this,ETM.basic_food_curator.loadFoodChanges(a.food_object_modal.model,!1,a.model),ETM.basic_food_curator.getModalElement().html(ETM.basic_food_curator.render()))}).modal("hide")},deleteChanges:function(){this.remove();this.model.destroy()},setChangesApproval:function(){if(!0!=is_superuser)return!1;var a=$(".approval_radio input:checked",this.el).val();"null"==a?this.model.set({review_approved:!1,
review_rejected:!1}):0==a?this.model.set({review_approved:!1,review_rejected:!0}):1==a&&this.model.set({review_approved:!0,review_rejected:!1});this.model.save()},render:function(){this.$el.html(this.template({curator_profile:ETM.curator_view.curator_profile,model:this.model}));return this}});
ETM.BasicFoodCuratorModalView=ModalView.extend({modal_id:"curator_modal_div",id:"basic_food_curator_modal",tagName:"div",parent:"#curator_modal_div",events:{"click #save_custom_food":"saveChanges","change #default_units select":"updateDefaultServingDescription","click #refresh_serving_size_selector":"updateListOfServingSizes",'click div[name="is_discrete"] .btn':"toggleDiscreteInput"},updateDefaultServingDescription:function(){this.form.commit({validate:!1});var a=this.food_changes_obj.attributes["gram_weight_"+
this.food_changes_obj.attributes.default_units+"_description"];$(".default_unit_text",this.el).html(a)},updateListOfServingSizes:function(){save_errors=this.form.commit({validate:!0});this.renderForm()},initialize:function(){this.ignore_macro_calorie_difference=this.restaurant_enabled=!1;this.food_id=null;this.$el.one("hidden.bs.modal",function(){ETM.basic_food_curator.undelegateEvents();ETM.basic_food_curator.close()})},render:function(){this.carbs=this.fats=this.proteins=this.form_calories=this.macro_calories=
null;this.$el.html(this.template());this.$el.modal({backdrop:"static",keyboard:!1,show:!0});this.renderForm();return this},toggleDiscreteInput:function(a){$(a.currentTarget).hasClass("active")||("true"==$("input",a.currentTarget).val()?$('input[name="minimum_discrete_amount"]',this.el).attr("disabled",!1):"false"==$("input",a.currentTarget).val()&&$('input[name="minimum_discrete_amount"]',this.el).attr("disabled",!0))},toggleTooltips:function(){$(".grams_per_serving_tooltip",this.el).tooltip({title:"<div class='text-left'>Enter the gram weight of a serving of the actual food. This will let you convert between grams and servings.<br/><br/>Conversions:<br/>1 oz = 28.35 g<br/>1 lb = 453.6 g<br/>1 tbsp = 15 g (liquid)<br/>1 tsp = 5 g (liquid)</div>",
html:!0,template:'<div class="tooltip" role="tooltip"><div class="arrow"></div><div style="margin-left:-20px;margin-right:-20px;" class="tooltip-inner"></div></div>',animation:!0,placement:"top",delay:{show:100,hide:0}})},renderForm:function(){this.food_changes_obj.schema.default_units={type:"Select",value_type:"Number",options:[]};for(var a=0;9>a;a++)if(0<this.food_changes_obj.attributes["gram_weight_"+a+"_amount"]&&0<this.food_changes_obj.attributes["gram_weight_"+a+"_description"].length)this.food_changes_obj.schema.default_units.options.push({val:a,
label:this.food_changes_obj.attributes["gram_weight_"+a+"_amount"]+" "+this.food_changes_obj.attributes["gram_weight_"+a+"_description"]});else break;this.form=(new Backbone.Form({model:this.food_changes_obj,template:Helper.createTemplateFunction($("#basicFoodForm",this.el).html())})).render();$(".basic_food_changes_form",this.el).html(this.form.el);a=this.food_changes_obj.attributes["gram_weight_"+this.food_changes_obj.attributes.default_units+"_description"];$(".default_unit_text",this.el).html(a);
!0===this.food_changes_obj.attributes.is_discrete?$('input[name="minimum_discrete_amount"]',this.el).attr("disabled",!1):$('input[name="minimum_discrete_amount"]',this.el).attr("disabled",!0);$(".review_complete",this.el).prop("checked",this.food_changes_obj.attributes.review_complete)},loadFoodChanges:function(a,b,c){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;this.original_food_object=a;var d=a.clone();if(b||c)e=new ETM.FoodChanges(c.toJSON()),e.attributes.gram_weight_0=100,e.attributes.gram_weight_0_amount=
100,e.attributes.gram_weight_0_description="grams";else for(var e=new ETM.FoodChanges(a.attributes.food.toJSON()),f=0;f<e.attributes.weights.length;f++){var g=e.attributes.weights[f];e.attributes["gram_weight_"+f]=g.grams;e.attributes["gram_weight_"+f+"_amount"]=g.amount;e.attributes["gram_weight_"+f+"_description"]=g.description}e.attributes.food_id=a.attributes.food.attributes.id;b&&(ETM.current_user_profile.get("user_id")===e.attributes.user_id||is_superuser)?e.url=ROOT+"/foodchanges/"+c.get("id")+
"/":(Helper.clearIDs(e),e.url=function(){return ROOT+"/foodchanges/"});this.model=d;this.food_changes_obj=e},scrapeFields:function(){this.food_changes_obj.attributes.review_complete=$(".review_complete",this.el).is(":checked");return this.food_changes_obj},saveChanges:function(){var a=this,b=this.form.commit({validate:!0}),c=this.scrapeFields();if("undefined"===typeof b)$(".recipe_save_spinner",this.el).show(),$("#save_custom_food",this.el).prop("disabled",!0),_.has(c.attributes,"reviewer")&&null!=
c.attributes.reviewer||(c.attributes.reviewer=ETM.curator_view.curator_profile.id),delete c.attributes.changes,delete c.attributes.images,delete c.attributes.date_created,delete c.attributes.date_last_updated,c.save({},{success:function(b,c,d){a.original_food_object.attributes.food.fetch({success:function(){a.original_food_object.trigger("modalUpdated")}});a.$el.modal("hide")},error:function(b,c,d){$(".recipe_save_spinner",a.el).hide();$("#save_custom_food",a.el).prop("disabled",!1);console.log("failed to save food changes :(");
$(".modal-footer").append('<div class="alert alert-danger recipe_validation_error" style="float:left">Failed to save food.</div>')}});else for(var d in b)b.hasOwnProperty(d)&&$('[data-editors="'+d+'"]').append('<div class="alert alert-danger recipe_validation_error" style="float:left">'+b[d].message+"</div>")}});
ETM.AmazonFreshRecipeModal=ModalView.extend({modal_id:"amazon_fresh_recipe_modal",events:{"click .amazonfresh_submit":function(a){a.preventDefault();amplitude.logEvent("amazonfresh_started",{lang:"en_us",recipe:!0});$('[name="afx-ingredients-verifier-form"]').submit()},"click .amazonfresh_uk":function(){amplitude.logEvent("amazonfresh_started",{lang:"en_uk",recipe:!0});$('[name="afx-ingredients-verifier-form-uk"]').submit()},"click .amazonfresh_de":function(){amplitude.logEvent("amazonfresh_started",
{lang:"de_de",recipe:!0});$('[name="afx-ingredients-verifier-form-de"]').submit()},"change .prefer_organic":function(){ETM.local_variables.save("prefer_organic_groceries",$(".prefer_organic",this.el).is(":checked"));this.undelegateEvents();this.render();this.delegateEvents()}},initialize:function(){},render:function(a){this.$el.html(this.template({amazon_fresh_url:ETM.AmazonFreshHelper.amazon_fresh_url,amazon_fresh_uk_url:ETM.AmazonFreshHelper.amazon_fresh_uk_url,amazon_fresh_de_url:ETM.AmazonFreshHelper.amazon_fresh_de_url,
grocery_json:JSON.stringify(ETM.AmazonFreshHelper.generateRecipeJson(a)),prefer_organic:ETM.local_variables.get("prefer_organic_groceries")}));this.$el.modal({show:!1});return this}});
ETM.AmazonFreshModal=ModalView.extend({modal_id:"amazon_fresh_modal",events:{"click .amazonfresh_submit":function(a){a.preventDefault();amplitude.logEvent("amazonfresh_started",{lang:"en_us",grocery:!0});$('[name="afx-ingredients-verifier-form"]').submit()},"click .amazonfresh_uk":function(){amplitude.logEvent("amazonfresh_started",{lang:"en_uk",grocery:!0});$('[name="afx-ingredients-verifier-form-uk"]').submit()},"click .amazonfresh_de":function(){amplitude.logEvent("amazonfresh_started",{lang:"de_de",
grocery:!0});$('[name="afx-ingredients-verifier-form-de"]').submit()},"change .prefer_organic":function(){ETM.local_variables.save("prefer_organic_groceries",$(".prefer_organic",this.el).is(":checked"));this.undelegateEvents();this.render();this.delegateEvents()}},initialize:function(){},render:function(){this.$el.html(this.template({amazon_fresh_url:ETM.AmazonFreshHelper.amazon_fresh_url,amazon_fresh_uk_url:ETM.AmazonFreshHelper.amazon_fresh_uk_url,amazon_fresh_de_url:ETM.AmazonFreshHelper.amazon_fresh_de_url,
grocery_json:JSON.stringify(ETM.AmazonFreshHelper.generateGroceryJson()),prefer_organic:ETM.local_variables.get("prefer_organic_groceries")}));this.$el.modal({show:!1});return this}});
ETM.AmazonFreshHelper={units_map:{count:"unit fruit piece large medium small tortilla".split(" "),cloves:[],bunches:[],stalks:["stalk"],slices:["slice"],leaves:["leaf"],pinches:["pinch"],cups:["cup"],fl_oz:["fl oz","fluid ounce"],gallons:["gallon"],grams:["gram"],kilograms:["kg","kilogram"],liters:["liter"],milliliters:["ml","milliliters"],ounces:["oz","ounce","ozs"],pints:["pint"],pounds:["lb","lbs","pound"],quarts:["quart"],tbsp:["tablespoon","tbsps"],tsp:["teaspoon","tsps"]},findUnits:function(a){if(_.has(this.units_map,
a))return a;for(var b in this.units_map)if(this.units_map.hasOwnProperty(b)){if(-1<this.units_map[b].indexOf(a)||-1!==a.indexOf(b))return b;for(var c=0;c<this.units_map[b].length;c++)if(-1!==a.indexOf(this.units_map[b][c]))return b}return!1},getQuantityList:function(a){var b=[],c=this.findUnits(a.getStaticUnits().toLowerCase());c&&b.push({unit:c,amount:a.getStaticAmountFloat()});a.attributes.food.attributes.accurate_grams&&b.push({unit:"grams",amount:a.gram_amount});return b},foodDescriptionKeywords:"canned in water;canned in oil;canned;freeze dried;dried;lowfat;nonfat;frozen".split(";"),
getFoodName:function(a){for(var b=(ETM.local_variables.get("prefer_organic_groceries")?"Organic ":"")+a.attributes.food.attributes.food_name,c=0;c<this.foodDescriptionKeywords.length;c++)if(-1!==a.attributes.food.attributes.description.toLowerCase().indexOf(this.foodDescriptionKeywords[c])){b+=" "+this.foodDescriptionKeywords[c];break}return b.replace(/[\[\]&,]+/g,"")},units_priority:["ounces","gallons","cups"],amazon_fresh_url:"https://www.amazon.com/afx/ingredients/landing?tag=swoleme-20",amazon_fresh_uk_url:"https://www.amazon.co.uk/afx/ingredients/landing?tag=etmuk-21",
amazon_fresh_de_url:"https://www.amazon.de/afx/ingredients/landing?tag=etmuk-21",generateGroceryJson:function(){var a=this,b={ingredients:[]};ETM.groceries_and_pantry.grocery_list.each(function(c){0<c.attributes.amount&&(c={name:a.getFoodName(c),quantityList:a.getQuantityList(c)},b.ingredients.push(c))});return b},generateGroceryJsonWithDescriptions:function(){var a=this,b={ingredients:[]};ETM.groceries_and_pantry.grocery_list.each(function(c){c={name:a.getFoodName(c),description:c.attributes.food.attributes.description?
c.attributes.food.attributes.food_name+", "+c.attributes.food.attributes.description:c.attributes.food.attributes.food_name,quantityList:a.getQuantityList(c)};b.ingredients.push(c)});return b},generateRecipeJson:function(a){var b=this,c={ingredients:[]};a.attributes.food.attributes.ingredients.each(function(a){a={name:b.getFoodName(a),quantityList:b.getQuantityList(a)};c.ingredients.push(a)});return c}};
ETM.InstacartModal=ModalView.extend({modal_id:"instacart_modal",events:{"change .prefer_organic":function(){ETM.local_variables.save("prefer_organic_groceries",$(".prefer_organic",this.el).is(":checked"));$("a.instacart_url",this.el).attr("href",this.generateInstacartUrl())},"click .instacart_post_btn":function(a){var b=$(a.target).ladda();b.ladda("start");this.generateInstacartPOST(function(a){b.ladda("stop");window.open(a)})}},initialize:function(){},render:function(){this.$el.html(this.template({instacart_url:this.generateInstacartUrl(),
show_refresh_warning:85<ETM.groceries_and_pantry.grocery_list.models.length,prefer_organic:ETM.local_variables.get("prefer_organic_groceries")}));this.$el.modal({show:!1});return this},generateFullInstacartUrl:function(){var a="https://www.instacart.com/store/partner_recipe?",a=a+"description="+encodeURIComponent("For your meal plans from "+moment(ETM.grocery_pantry_view.model.attributes.current_start_date).format("MMM Do")+" to "+moment(ETM.grocery_pantry_view.model.attributes.current_end_date).format("MMM Do")),
a=a+"&image_url="+encodeURIComponent("https://www.eatthismuch.com/static_files/images/orange_etm_logo.png"),a=a+"&partner_name=eatthismuch",a=a+"&utm_campaign=eatthismuch_grocerylist&utm_source=partner_eatthismuch&utm_medium=recipe_api";ETM.groceries_and_pantry.grocery_list.each(function(b){a=a+"&ingredients%5B%5D="+encodeURIComponent(b.attributes.food.attributes.food_name)});ETM.groceries_and_pantry.grocery_list.each(function(b){var c=String(b.static_amount)+" "+b.static_units+" "+b.attributes.food.attributes.food_name;
0<b.attributes.food.attributes.description.length&&(c=c+" ("+b.attributes.food.attributes.description+")");a=a+"&quantity%5B%5D="+encodeURIComponent(c)});return a+="&title=Your+Eat+This+Much+Grocery+List"},generateInstacartUrl:function(){var a=!1===ETM.grocery_pantry_view.usePantryAmounts,b=(document.location.origin?document.location.origin:"https://www.eatthismuch.com")+"/pantry/formatted-groceries/"+ETM.current_user_profile.attributes.unsubscribe_string.slice(0,8)+ETM.current_user_profile.attributes.user_id+
"/?t="+Math.round((new Date).getTime()/1E3),b=b+"&prefer_organic="+ETM.local_variables.get("prefer_organic_groceries"),a="https://www.instacart.com/store/partner_recipe?url="+encodeURIComponent(b+"&ignore_pantry="+a);return a+="&utm_campaign=eatthismuch_grocerylist&utm_source=partner_eatthismuch&utm_medium=recipe_api&partner_name=eatthismuch"},generateInstacartPOST:function(a){var b={ingredients:[],quantities:[],image_url:"https://www.eatthismuch.com/static_files/images/peach_etm_logo.png",recipe_url:"https://www.eatthismuch.com/",
partner_name:"Eat This Much"};ETM.groceries_and_pantry.grocery_list.each(function(a){0<a.attributes.amount&&(b.ingredients.push(ETM.AmazonFreshHelper.getFoodName(a)),b.quantities.push(String(a.static_amount)+" "+a.static_units))});$.post("https://www.instacart.com/v3/partner_recipe",b,function(b){a(b.url)})}});
ETM.MealListView=Backbone.View.extend({className:function(){return ETM.MealPlanViewState.isWeekView()?"row":""},initialize:function(){this.is_diet_set=_.has(this.model,"diet")&&_.has(this.model.diet,"is_diet_set")&&this.model.diet.is_diet_set;this.meal_views=[];this.applyEvents()},applyEvents:function(){var a=this;this.listenTo(this.model,"reset",function(){this.render()},this);this.listenTo(this.model,"add",function(b){b=(new ETM.MealObjectView({model:b,is_diet_set:a.is_diet_set,num_meals:a.model.models.length})).render();
a.meal_views.push(b);a.$el.append(b.el)})},render:function(){var a=this;this.$el.empty();_.each(this.model.models,function(b){b=(new ETM.MealObjectView({model:b,is_diet_set:a.is_diet_set,num_meals:a.model.models.length})).render();a.meal_views.push(b);a.$el.append(b.el)},this);return this},onClose:function(){_.each(this.meal_views,function(a){a.close()},this);this.meal_views=null}});
ETM.MealObjectView=Backbone.View.extend({tagName:"div",className:function(){if(ETM.MealPlanViewState.isWeekView())if(this.num_meals){if(1===this.num_meals)return ETM.is_mobile?"meal_box mobile_meal_box meal_container col":"meal_box meal_container col";if(4>=this.num_meals)return ETM.is_mobile?"meal_box mobile_meal_box meal_container col-12 col-md-6 col-lg":"meal_box meal_container col-12 col-md-6 col-lg";if(4<this.num_meals)return ETM.is_mobile?"meal_box mobile_meal_box meal_container col-12 col-md-6 col-lg-3 col-xl":
"meal_box meal_container col-12 col-md-6 col-lg-3 col-xl"}else return ETM.is_mobile?"meal_box mobile_meal_box meal_container col-12 col-md-6 col-lg-3 col-xl":"meal_box meal_container col-12 col-md-6 col-lg-3 col-xl";else return ETM.is_mobile?"meal_box mobile_meal_box meal_container row":"meal_box meal_container row"},events:{"click .meal_refresh_btn":"shuffleMeal","click .edit_meal_type":"editMealType","click .meal_options_dropdown_button":"showMealTypeDropdown","click .create_meal_type":"createMealType",
"click .i_ate_this":function(a){if(!ETM.local_variables.attributes.seen_i_ate_this_pantry_info_tooltip&&(!1===ETM.current_profile_completeness.get("mark_meal_as_eaten")||!1===ETM.current_profile_completeness.get("remove_eaten_foods"))){var b;b=ETM.is_premium?"<p>After your mark 'I ate this' for meals as you eat them, you can subtract those foods from your pantry by heading to the groceries page, clicking the <svg class='etm-icon etm-icon-sm'><use xlink:href=''#icon-view-more'></use></svg> Actions button in your pantry list, and selecting <i class=\"fa fa-cutlery\" aria-hidden=\"true\"></i> Remove eaten foods.</p><p>All eaten foods will also get removed automatically from your pantry whenever a new week is generated.</p>":
"<p>Subscribe to premium to track your pantry foods automatically by marking 'I ate this'!</p><p>After your mark 'I ate this' for meals as you eat them, you can subtract those foods from your pantry by heading to the groceries page, clicking the 'Actions' button on your pantry list, and selecting <i class=\"fa fa-cutlery\" aria-hidden=\"true\"></i> Remove eaten foods.</p><p>All eaten foods will also get removed automatically from your pantry whenever a new week is generated.</p>";setTimeout(Helper.oneTimePopover({element:$(".i_ate_this",
this.el),position:"top",message:b,title:"Pantry foods and 'I ate this'",button_dismiss:!0,custom_class:"meal_rating_info_popup",dismiss_callback:function(){ETM.local_variables.save({seen_i_ate_this_pantry_info_tooltip:!0});!1===ETM.current_profile_completeness.get("remove_eaten_foods")}}),1E3)}$(a.currentTarget).hasClass("disabled")||($(a.currentTarget).addClass("disabled"),$(a.currentTarget).toggleClass("i_ate_this_on").toggleClass("i_ate_this_off"),this.model.save({eaten:!this.model.attributes.eaten},
{patch:!0,dataType:"text",success:function(){$(a.currentTarget).removeClass("disabled")},error:function(){$(a.currentTarget).removeClass("disabled")}}),this.model.hasParentDiet()&&this.model.parent.trigger("meal_eaten_update"))},"click .meal_thumbs .thumb_icon":function(a){a.preventDefault();a.stopPropagation();$(a.currentTarget).prop("disabled")||this.toggleThumb($(a.currentTarget))},"click .swap_meal":function(){var a=new ETM.SwapMealModalView({model:this.model});a.getModalElement().html(a.render().el);
a.$el.modal("show")},"click .copy_meal":function(){var a=new ETM.CopyMealModalView({model:this.model});a.getModalElement().html(a.render().el);a.$el.modal("show")},"click .clear_meal":function(){var a=this;this.model.attributes.foods.forEach(function(a){(a.attributes.is_leftovers||a.attributes.has_leftovers)&&a.updateRelatedLeftovers("delete")});this.model.attributes.foods.reset([]);this.model.set("delete_other_foods",!0);this.model.save(null,{success:function(b,c){delete a.model.attributes.delete_other_foods;
amplitude.logEvent("cleared_meal")}})},"click .search_map":function(){var a=new ETM.MapSearchModalView({model:this.model});ETM.map_search=a;a.getModalElement().html(a.render().el);a.$el.modal({show:!0,backdrop:"static"});a.$el.one("shown.bs.modal",function(){a.displayMap()});a.$el.one("hidden.bs.modal",function(){a.close();a.$el.empty()})},"click .list_meal_combos":function(){var a=new ETM.AlternateMealsModalView({model:this.model});a.getModalElement().html(a.render().el);a.$el.modal("show")},"click .add_restaurant_food":function(){var a=
this,b=new ETM.CustomFoodList([],{url:ROOT+"/customfood/"});this.listenTo(b,"add",function(b){ETM.food_info_object_list.add(b.attributes.food);a.food_list.collection.add(new ETM.FoodObject({amount:b.attributes.amount,units:b.attributes.units,food:b.attributes.food}))});amplitude.logEvent("add_restaurant_food_shortcut");b=new ETM.AteOutFormView({model:b.food_info_object_list});b.getModalElement().html(b.render().el);b.$el.modal("show")},"click .add_food":function(){var a=this,b=new ETM.CustomFoodList([],
{url:ROOT+"/customfood/"});this.listenTo(b,"add",function(b){ETM.food_info_object_list.add(b.attributes.food);a.food_list.collection.add(new ETM.FoodObject({amount:b.attributes.amount,units:b.attributes.units,food:b.attributes.food}))});amplitude.logEvent("add_custom_food_shortcut");b=new ETM.CustomFoodFormModalView({model:b.food_info_object_list});b.getModalElement().html(b.render().el);b.$el.modal("show")},"click .manager_meal_note .meal_note_btn, .add_edit_note":function(){var a=this,b=new ETM.MealNoteModalView({model:this.model});
b.getModalElement().html(b.render().el);b.$el.modal("show");b.$el.one("hidden.bs.modal",function(){a.renderMealNote()})}},initialize:function(a){this.num_meals=this.is_diet_set=!1;"undefined"!==typeof a&&(_.has(a,"is_diet_set")&&a.is_diet_set&&(this.is_diet_set=!0),_.has(a,"num_meals")&&a.num_meals&&(this.num_meals=a.num_meals));this.listenTo(this.model,"switchedMealTypes",this.updateMealTypeTitle,this);this.listenTo(this.model,"change:meal_type.title",this.updateMealTypeTitle,this);this.listenTo(this.model,
"nested-change",this.updateDietAndRender,this);this.listenTo(this.model,"rerender",this.reRender,this);this.listenTo(this.model,"checkRecurring",function(){null!=this.food_list&&this.food_list.checkIfFoodsRecurring()},this);this.listenTo(this.model,"switchedMealTypes",function(){ETM.use_local_storage?(this.model.set({meal_type:this.model.attributes.meal_type.attributes.resource_uri}),this.model.getParentDiet().save()):(this.model.save({meal_type:this.model.attributes.meal_type.attributes.resource_uri},
{patch:!0}),this.updateThumbRatingView())},this);var b=this;this.listenTo(this.model,"updateStats",function(a,d){b.updateThumbRatingView();b.renderStats()});this.listenTo(this.model,"parent_diet_finished_generating",function(a,d){b.showThumbsDownCaveatTooltip()})},render:function(){var a=this.model.getThumbRating();this.$el.html(this.template({attributes:this.model.attributes,is_premium:ETM.is_premium,cid:this.model.cid,is_diet_set:this.is_diet_set,thumb_rating:a,is_manager:ETM.current_user_profile.hasManagerSubscription()||
!0==ETM.current_user_profile.attributes.impersonating}));ETM.MealPlanViewState.isWeekView()&&(this.$el.removeClass(),this.$el.addClass(this.className()));this.food_list?this.food_list.checkIfFoodsRecurring():(this.food_list=new ETM.FoodListView({collection:this.model.attributes.foods,el:$(".meal_foods",this.el)}),this.food_list.render());this.meal_options=new ETM.MealOptionsDropdownView({model:this.model});this.renderStats();this.model.attributes.meal_note?this.renderMealNote():$(".meal_note",this.el).empty();
this.meal_options.$el=$(".meal-options-dropdown-menu",this.el);this.meal_options.delegateEvents({"click .other_meal_type":"switchMealTypes","click .delete_meal_type a":"deleteMealType"});return this},renderMealNote:function(){$(".meal_note",this.el).html((new ETM.MealNoteView({model:this.model.attributes.meal_note})).render().el)},toggleThumb:function(a){if(!ETM.is_logged_in)return!1;var b=a.siblings(".thumb_icon");a.prop("disabled",!0);b.prop("disabled",!0);ETM.local_variables.attributes.seen_meal_rating_info||
(this.showThumbInfoPopup(a),ETM.local_variables.save({seen_meal_rating_info:!0}));a.toggleClass("active").toggleClass("inactive");if(a.hasClass("active")){b.hasClass("active")&&b.toggleClass("active").toggleClass("inactive");var c=a.hasClass("thumbs_up")?THUMB_RATINGS.THUMBS_UP:THUMB_RATINGS.THUMBS_DOWN}else c=THUMB_RATINGS.NO_RATING;var d=function(){a.prop("disabled",!1);b.prop("disabled",!1)};this.is_swap_meal?this.model.saveThumbRating(c,this.meal_type_id,this.meal_number,this.num_meals,d):this.model.saveThumbRating(c,
null,null,null,d)},reAddThumbButtonEvent:function(){events=_.result(this,"events");var a=this.events["click .meal_thumbs .thumb_icon"],b="click",a=_.bind(a,this),b=b+(".delegateEvents"+this.cid);this.$el.on(b,".meal_thumbs .thumb_icon",a);return this},showThumbInfoPopup:function(a){Helper.oneTimePopover({element:a,position:"top",message:"Use the thumb ratings to help our algorithms learn which foods go well together in a meal.<div class='small_top_spacer row'><div class='col-1' style='padding-right: 0px;'><img width='16' src='/static_files/images/thumb_up_green.png'></div><div class='col-11'>I <strong>like</strong> the combination of foods in this meal.</div></div><div class='row'><div class='col-1' style='padding-right: 0px;'><img width='16' src='/static_files/images/thumb_down_red.png'></div><div class='col-11'>I <strong>dislike</strong> the combination of foods in this meal.</div></div><p class='small_top_spacer'>The more you rate, the better it gets!</p><p>Also, thumbs up/down specific recipes to send an even stronger signal about what you do/don't like.</p>",
title:"Rating your meals",button_dismiss:!0,custom_class:"meal_rating_info_popup"})},showThumbsDownCaveatTooltip:function(){if(!ETM.local_variables.attributes.seen_thumbs_down_temp_tooltip&&!is_mobile&&ETM.is_logged_in&&1===this.model.getThumbRating())Helper.oneTimePopover({element:$(".meal_thumbs .thumbs_down",this.el),position:"top",message:"<p>Sorry for showing you this meal again! You gave it a thumbs-down, but our algorithms struggled to find a better meal for your preferences. If this meal keeps appearing, try blocking specific foods.</p>",
title:"Refresh me!",button_dismiss:!0,custom_class:"meal_rating_info_popup",dismiss_callback:function(){ETM.local_variables.save({seen_thumbs_down_temp_tooltip:!0})}})},updateThumbRatingView:function(){var a=this.model.getThumbRating(),b=$(".meal_thumbs .thumbs_up",this.el),c=$(".meal_thumbs .thumbs_down",this.el);a==THUMB_RATINGS.THUMBS_UP?(b.addClass("active").removeClass("inactive"),c.addClass("inactive").removeClass("active")):a==THUMB_RATINGS.THUMBS_DOWN?(c.addClass("active").removeClass("inactive"),
b.addClass("inactive").removeClass("active")):(b.removeClass("active").addClass("inactive"),c.removeClass("active").addClass("inactive"))},removeMealControls:function(){this.undelegateEvents();$(".meal_options_dropdown",this.el).removeClass("dropdown");$(".meal_options_dropdown",this.el).html('<span class="meal_title print_meal_title wrap_or_truncate">'+this.model.get("meal_type").get("title")+"</span>");this.food_list.collection.models.forEach(function(a){a.trigger("disableHover");a.trigger("disableEvents");
a.trigger("enableTooltip")});this.food_list.$el.sortable({disabled:!0});$(".diet_draggable",this.el).css("cursor","auto");$(".favorite_food",this.el).css("cursor","auto");$(".food_link",this.el).css("cursor","auto");$(".meal_options_dropdown",this.el).unbind();$(".meal_icons",this.el).hide();$(".food_link_text",this.el).hide();$(".favorite_food",this.el).hide();$(".meal_refresh_btn",this.el).hide();$(".i_ate_this_text",this.el).hide();$(".i_ate_this",this.el).css("cursor","auto")},softRender:function(){this.food_list||
($(".meal_foods_row",this.el).html('<ul class="meal_foods col-12"></ul>'),this.food_list=new ETM.FoodListView({collection:this.model.attributes.foods,el:$(".meal_foods",this.el)}),this.food_list.render());this.renderStats();this.updateThumbRatingView()},onClose:function(){this.stopListening();this.food_list.close();this.meal_options.close();this.meal_stats_view.close();null!=this.create_meal_type&&(this.create_meal_type.close(),this.create_meal_type=null);this.meal_stats_view=this.meal_options=this.food_list=
null},renderEditMealType:function(){this.edit_meal_type=new ETM.EditMealTypeModalView({model:this.model.get("meal_type")},{meal:this.model});this.edit_meal_type.getModalElement().html(this.edit_meal_type.render().el)},renderCreateMealType:function(){this.create_meal_type=new ETM.EditMealTypeModalView({model:new ETM.MealType},{meal:this.model});this.create_meal_type.getModalElement().html(this.create_meal_type.render().el)},renderStats:function(){this.meal_stats_view&&this.meal_stats_view.close();
this.meal_stats_view=new ETM.MealStatsView({model:this.model});$(".meal_stats",this.el).html(this.meal_stats_view.render().el)},showMealTypeDropdown:function(){this.meal_options.render()},editMealType:function(){this.renderEditMealType();this.edit_meal_type.renderForm();this.edit_meal_type.$el.modal("show")},createMealType:function(){this.renderCreateMealType();this.create_meal_type.model=new ETM.MealType;this.create_meal_type.renderForm();this.create_meal_type.$el.modal("show")},updateMealTypeTitle:function(){$(".print_meal_title",
this.el).html(this.model.get("meal_type").get("title"))},reRender:function(){var a=this;a.model.trigger("updateStats");Helper.retainPageHeight(function(){null!=a.food_list&&(a.food_list.close(),a.food_list=null);a.softRender()})},updateDietAndRender:function(a){var b=this;b.model.trigger("updateStats");Helper.retainPageHeight(function(){null!=b.food_list&&(b.food_list.close(),b.food_list=null);b.softRender();$(a.currentTarget).removeAttr("disabled");$(a.currentTarget).find(".etm-icon").one("animationiteration webkitAnimationIteration",
function(){$(this).removeClass("icon-rotating")});ETM.stoppedGenerating()})},shuffleMeal:function(a){if(!ETM.currently_generating)if(this.model.attributes.eaten){var b=$(a.currentTarget).parent().find(".i_ate_this_text");b.effect("shake");Helper.oneTimeTooltip(b,"top","This meal is locked since it's marked as eaten. Uncheck 'I ate this' to regenerate it.",3E3)}else $(a.currentTarget).stop(),$(a.currentTarget).find(".etm-icon").addClass("icon-rotating"),$(a.currentTarget).attr("disabled","true"),this.model.regenerateMealServer(function(){$(a.currentTarget).removeAttr("disabled");
$(a.currentTarget).find(".etm-icon").one("animationiteration webkitAnimationIteration",function(){$(this).removeClass("icon-rotating")})})}});
ETM.MealOptionsDropdownView=Backbone.View.extend({render:function(){var a=this;this.current_meal_type=this.model.get("meal_type");this.other_meal_types=[];ETM.meal_type_list.forEach(function(b){b.id==a.current_meal_type.id||b.attributes.deleted||a.other_meal_types.push(b)});this.$el.html(this.template({current_meal_type:this.current_meal_type,other_meal_types:this.other_meal_types,is_logged_in:ETM.is_logged_in}));return this},deleteMealType:function(a){a.stopPropagation();a=parseInt(a.currentTarget.id);
this.other_meal_types[a].attributes.deleted=1;this.other_meal_types[a].save(null,{validate:!1});this.render()},switchMealTypes:function(a){a.stopPropagation();a=parseInt(a.currentTarget.id);a=this.other_meal_types[a];this.model.set("meal_type",a);this.current_meal_type=a;this.render();this.model.trigger("switchedMealTypes")}});
ETM.MealStatsView=Backbone.View.extend({onClose:function(){$(".cal_amount",this.el).tooltip("dispose")},render:function(){this.model.calorie_printout=roundNumber(this.model.stats.calories,0);this.$el.html(this.template(this.model));this.applyTooltip();this.applyGraphRender();return this},updateStatsTooltip:function(){this.model.calorie_printout=roundNumber(this.model.stats.calories,0);this.$el.html(this.template(this.model));var a=getStatsHTML(this.model.stats);$(".cal_amount",this.el).attr("title",
mealStatsTooltipHTML(this.model.attributes.meal_number,a)).tooltip("fixTitle");return this},applyTooltip:function(){var a=getStatsHTML(this.model.stats);placement=ETM.is_mobile?"left":"right";$(".cal_amount",this.el).tooltip({title:mealStatsTooltipHTML(this.model.attributes.meal_number,a),html:!0,delay:250,animation:!0,placement:placement,container:this.$el})},applyGraphRender:function(){var a=this;this.$el.mouseover(function(){setTimeout(function(){a.renderTooltipGraph(a)},251)})},renderTooltipGraph:function(a){var b=
$(".mealgraph",a.el);0!=a.model.stats.calories&&miniGraph(a.model.stats,b)}});
ETM.SwapMealObjectView=ETM.MealObjectView.extend({className:"meal_box meal_container row",initialize:function(a){var b=this;this.show_missing_ingredients=!1;this.listenTo(this.model,"updateStats",function(a,d){b.renderStats()});this.is_swap_meal=!0;a.meal_type_id&&(b.meal_type_id=a.meal_type_id,b.meal_number=a.meal_number,b.num_meals=a.num_meals)},render:function(){var a=this;ETM.is_logged_in&&this.model.attributes.foods.each(function(b){b.parent=a.model});var b=0,c=0;this.show_missing_ingredients&&
this.model.attributes.foods.each(function(a){_.has(a.attributes,"missing_ingredients")&&(b+=parseInt(a.attributes.missing_ingredients));c=_.has(a.attributes.food.attributes,"number_of_ingredients")&&0<a.attributes.food.attributes.number_of_ingredients?c+a.attributes.food.attributes.number_of_ingredients:c+1});var d=this.model.getThumbRating(a.meal_type_id);this.$el.html(this.template({show_missing_ingredients:this.show_missing_ingredients,total_ingredients:c,total_owned_ingredients:c-b,attributes:this.model.attributes,
is_premium:ETM.is_premium,cid:this.model.cid,thumb_rating:d}));this.food_list||this.renderFoodList();this.renderStats();return this},renderFoodList:function(){this.food_list=new ETM.FoodListView({collection:this.model.attributes.foods,el:$(".meal_foods",this.el)});this.food_list.render()}});
ETM.SwapRestaurantMealObjectView=ETM.SwapMealObjectView.extend({className:"meal_box",renderFoodList:function(){var a=this;this.food_list=new ETM.RestaurantFoodListView({collection:this.model.attributes.foods,el:$(".meal_foods",this.el)});this.food_list.render();$(".replace_meal_button",this.el).on("click",function(){a.model.parent_view.trigger("replace_with_meal",a.model)})}});
ETM.GuidedPlanningMealChoiceView=ETM.MealObjectView.extend({className:function(){return"guided_planning_meal h-100 d-flex"},events:function(){var a=this;return _.extend({},ETM.FoodObjectView.prototype.events,{"click .select_meal":function(b){b=$(b.currentTarget).parents(".guided_planning_meal");b.hasClass("guided_planning_selected_meal")?(a.trigger("mealUnselected",a.column),b.removeClass("guided_planning_selected_meal")):(a.trigger("mealSelected",a.column),$(".guided_planning_selected_meal").removeClass("guided_planning_selected_meal"),
b.addClass("guided_planning_selected_meal"))}})},initialize:function(a){var b=this;this.listenTo(this.model,"updateStats",function(a,d){b.renderStats()});b.choice_description="";a.choice_description&&(b.choice_description=a.choice_description);b.column=a.column},render:function(){this.$el.html(this.template({attributes:this.model.attributes,is_premium:ETM.is_premium,cid:this.model.cid,choice_description:this.choice_description,meal_selected:!1,total_time:this.model.calculateTotalTime(),total_ingredients:this.model.calculateTotalIngredients()}));
this.food_list||this.renderFoodList();this.renderStats();return this},renderFoodList:function(){this.food_list=new ETM.GuidedPlanningFoodListView({collection:this.model.attributes.foods,el:$(".meal_foods",this.el)});this.food_list.render()}});
ETM.EditMealTypeModalView=ModalView.extend({modal_id:"edit_meal_type_modal",id:"edit_meal_type_modal",initialize:function(a,b){null!=b&&null!=b.meal&&(this.meal=b.meal)},events:{"click #meal_type_save_changes":"saveMealType","click #remove_delete":"removeDelete","click .close_modal":"closeModal","click .replace-button":function(a){var b=this;a.preventDefault();ETM.meal_type_list.filter(function(a){return a.attributes.title===b.form.getValue().title&&!a.deleted&&(null==b.model.attributes.user_id||
a.attributes.user_id==b.model.attributes.user_id)&&a.id!==b.model.id}).forEach(function(a){a.save({title:Helper.findNextAvailableTitle(ETM.meal_type_list,a.attributes.title)},{validate:!1})});$(".meal_type_error",this.el).remove()},"change [name='only_use_recurring'] input":"checkRecurringFoodsState"},render:function(){this.$el.html(this.template(this.model));this.$el.modal({show:!1});this.renderForm();return this},closeModal:function(){this.trigger("closedModal");this.$el.modal("hide")},renderForm:function(){this.form=
(new Backbone.Form({model:this.model,template:Helper.createTemplateFunction($("#editMealTypeFormTemplate",this.el).html())})).render();$("#edit_meal_type_body",this.el).html(this.form.el);0===this.model.get("max_cooktime")?($("#cant_cook",this.el).addClass("active"),$("#cant_cook .btn",this.el).checked=!0):1===this.model.get("min_cooktime")?($("#must_cook",this.el).addClass("active"),$("#must_cook .btn",this.el).checked=!0):($("#can_cook",this.el).addClass("active"),$("#can_cook .btn",this.el).checked=
!0);$(".meal_size_tooltip",this.el).tooltip({placement:"right",html:!0,title:'<p align="left">This will determine what fraction of your day\'s nutrition targets this meal contains. The number of calories in a meal is flexible, but this gives a guideline for how big a meal is relative to other meals.</p><p align="left">When you use the "meal refresh", it will try to fill up whatever calories are available in the day. If you want to reset a meal to the selected size, use the day refresh or week refresh.</p>'});
$(".family_scale_tooltip",this.el).tooltip({placement:"right",html:!0,title:'<p align="left">If you have more than one person, you can scale the recipes in this meal by "Amount to cook" instead of just "Amount to eat". Your grocery list will also multiply the ingredients by the number of people you select.</p><p align="left">Check out the Knowledge Base in the Help menu for tips on making this work for people with different nutrition targets (search "family meal").</p>'});$(".only_use_recurring_tooltip",
this.el).tooltip({placement:"right",html:!0,title:'<p align="left">When the generator creates this meal, it will only use the "Recurring foods" that you\'ve selected. This lets you completely customize the generator\'s output.</p><p align="left">If you haven\'t selected any recurring foods and you check this box, the generator will leave this meal empty.</p>'});$(".meal_complexity_tooltip",this.el).popover({placement:"top",html:!0,trigger:"hover",content:'<p align="left">Low complexity recipes have fewer ingredients and less preparation. Higher complexity tends to give more interesting recipes and has better variety, but the grocery list also gets longer.</p><p align="left"><span class="badge badge-info">Tip</span> Try changing these settings around and regenerating the meals to see how they affect your results.</p>'});
this.renderSliders();this.checkRecurringFoodsState();this.toggleSaveButton()},renderSliders:function(){var a=this;$("#meal-type-size",this.el).hide();var b=$(".size_slider",this.el),c=this.model.schema.size_slider.options;$(".size_slider_label",a.el).html(c[(parseInt(this.model.attributes.size_slider)-50)/25].label);b.slider({range:"min",min:c[0].val,max:c[c.length-1].val,step:25,value:this.model.attributes.size_slider,slide:function(b,e){$(".size_slider_label",a.el).html(c[(parseInt(e.value)-50)/
25].label);$("#meal-type-size select",a.el).val(e.value)}})},checkRecurringFoodsState:function(){$("[name='only_use_recurring'] input",this.el).is(":checked")?$(".recurring_foods_info",this.el).show():$(".recurring_foods_info",this.el).hide()},toggleSaveButton:function(){this.model.attributes.deleted?($("#meal_type_save_changes",this.el).hide(),$("#deleted_meal_type_warning",this.el).html("<div class='alert alert-danger'>This meal type was previously deleted. <button class='btn btn-secondary' id='remove_delete'>Undo the delete</button></div>")):
($("#deleted_meal_type_warning",this.el).html(""),$("#meal_type_save_changes",this.el).show())},removeDelete:function(a){a.preventDefault();this.model.attributes.deleted=!1;ETM.meal_type_list.findWhere({id:this.model.attributes.id}).attributes.deleted=!1;this.model.save();this.toggleSaveButton()},saveMealType:function(a){a.preventDefault();a=this.form.commit({validate:!0});if("undefined"===typeof a){var b=this,c="undefined"===typeof this.model.attributes.id;$("#cant_cook",this.el).hasClass("active")?
(this.model.set("min_cooktime",0),this.model.set("max_cooktime",0)):$("#must_cook",this.el).hasClass("active")?(this.model.set("min_cooktime",1),this.model.set("max_cooktime",this.model.get("max_totaltime"))):(this.model.set("min_cooktime",0),this.model.set("min_preptime",0),this.model.set("max_cooktime",this.model.get("max_totaltime")),this.model.set("max_preptime",this.model.get("max_totaltime")));this.model.save(null,{success:function(a,d){c&&ETM.meal_type_list.add(a);null!=b.meal&&(b.meal.attributes.meal_type=
a,c?b.meal.trigger("switchedMealTypes"):b.meal.trigger("changedMealType"));b.trigger("closedModal");b.$el.modal("hide")}})}else for(var d in a)$('[data-editors="'+d+'"]').append('<div class="alert alert-danger meal_type_error" style="float:left">'+a[d].message+"</div>")}});var previous_calories=0;
ETM.EditNutritionTargetsModalView=ModalView.extend({modal_id:"edit_nutrition_targets_modal",id:"edit_nutrition_modal",events:{"click #nutrition_profile_save_changes":"saveChanges"},initialize:function(a,b){"undefined"!==typeof b&&(this.diet=b.diet)},render:function(){this.$el.html(this.template(this.model));this.$el.modal({show:!1});this.targets_view=new ETM.EditNutritionTargetsView({model:this.model},{diet:this.diet});$(".modal-body",this.el).html(this.targets_view.render().el);this.listenTo(this.targets_view,
"openNutritionCalculator",this.openNutritionCalculator,this);this.listenTo(this.targets_view,"switchedNutritionProfiles nutritionProfileUpdated",this.saveChangesComplete,this);return this},saveChanges:function(a){a&&a.preventDefault();this.targets_view.saveChanges()},saveChangesComplete:function(){this.$el.modal("hide");this.diet&&this.diet.trigger("nutritionProfileUpdated")},openNutritionCalculator:function(){var a=this;this.$el.modal("hide");this.$el.one("hidden.bs.modal",function(){a.trigger("openNutritionCalculator")})},
updateNutritionTargets:function(){this.targets_view.form.setValue(this.targets_view.model.attributes);this.targets_view.renderForm();this.targets_view.renderSliders();this.targets_view.toggleInputsAndSliders()}});
ETM.EditNutritionTargetsView=Backbone.View.extend({events:{"change .macro_scheme_radio":"changeMacroScheme","click #remove_nutrition_profile_delete":"removeDelete","click .cholesterol_check":"triggerCholesterolInput","click .sodium_check":"triggerSodiumInput","click #increase_macro_maximums":"increaseMacroMaximums","click #decrease_macro_minimums":"decreaseMacroMinimums","click #open_nutrition_calculator":"openNutritionCalculator","change #nutrition_profile_title input":"updateTitle","change #nutrition_profile_description input":"updateDescription",
"change #2nd_cal_input input":"caloriesChangedCheck","change #fats div input":"updateFats","change #carbs div input":"updateCarbs","change #proteins div input":"updateProteins","click .replace-button":function(a){var b=this;a.preventDefault();ETM.nutrition_profile_list.filter(function(a){return a.attributes.title===b.form.getValue().title&&!a.deleted&&(null==b.model.attributes.user_id||a.attributes.user_id==b.model.attributes.user_id)&&a.id!==b.model.id}).forEach(function(a){a.save({title:Helper.findNextAvailableTitle(ETM.nutrition_profile_list,
a.attributes.title)},{validate:!1})});$(".nutrition_profile_error",this.el).remove()}},initialize:function(a,b){"undefined"!==typeof b&&(this.diet=b.diet)},openNutritionCalculator:function(a){a.preventDefault();this.trigger("openNutritionCalculator")},caloriesChangedCheck:function(){var a=roundNumber(parseInt($("#2nd_cal_input input",this.el).val()),0),b=this.model.attributes.calories;a!=b&&(this.model.set("calories",a),this.changeCalories(a,b))},updateTitle:function(){var a=$("#nutrition_profile_title input",
this.el).val();a!=this.model.attributes.title&&this.model.set("title",a)},updateDescription:function(){var a=$("#nutrition_profile_description input",this.el).val();a!=this.model.attributes.description&&this.model.set("description",a)},removeDelete:function(a){a.preventDefault();this.model.attributes.deleted=!1;ETM.nutrition_profile_list.findWhere({id:this.model.attributes.id}).attributes.deleted=!1;this.model.save();this.toggleSaveButton()},toggleSaveButton:function(){this.model.attributes.deleted?
($("#nutrition_profile_save_changes",this.el).hide(),$("#deleted_nutrition_profile_warning",this.el).html("<div class='alert alert-danger'>This nutrition profile was previously deleted. <button class='btn btn-secondary' id='remove_nutrition_profile_delete'>Undo the delete</button></div>")):($("#deleted_nutrition_profile_warning",this.el).html(""),$("#nutrition_profile_save_changes",this.el).show())},increaseMacroMaximums:function(a){a.preventDefault();a=roundNumber(this.model.attributes.max_carbs,
0);for(var b=roundNumber(this.model.attributes.max_proteins,0),c=roundNumber(this.model.attributes.max_fats,0),d=4*a+9*c+4*b,e=roundNumber(this.model.attributes.calories,0),d=e-d;0<d;)a+1<=e/4&&(a+=1,d-=4),b+1<=e/4&&(b+=1,d-=4),c+1<=e/9&&(c+=1,d-=9);this.model.set({max_carbs:a,max_fats:c,max_proteins:b});this.renderMacroInputs();this.renderSliders()},decreaseMacroMinimums:function(a){a.preventDefault();a=roundNumber(this.model.attributes.min_carbs,0);for(var b=roundNumber(this.model.attributes.min_proteins,
0),c=roundNumber(this.model.attributes.min_fats,0),d=4*a+9*c+4*b,e=roundNumber(this.model.attributes.calories,0),d=d-e;0<d;)0<=a-1&&(a-=1,d-=4),0<=b-1&&(b-=1,d-=4),0<=c-1&&(c-=1,d-=9);this.model.set({min_carbs:a,min_proteins:b,min_fats:c});this.renderMacroInputs();this.renderSliders()},updateCarbs:function(){this.updateSliders(this.carbs_slider,this.min_carbs_input,this.max_carbs_input,"carbs")},updateFats:function(){this.updateSliders(this.fats_slider,this.min_fats_input,this.max_fats_input,"fats")},
updateProteins:function(){this.updateSliders(this.proteins_slider,this.min_proteins_input,this.max_proteins_input,"proteins")},render:function(){this.$el.html(this.template(this.model));this.renderForm();this.renderSliders();return this},renderForm:function(){this.form=new Backbone.Form({model:this.model,template:ETM.loadTemplate("#EditNutritionTargetsForm")});$("#editForm",this.el).html(this.form.render().el);this.min_carbs_input=$("#carbs .min_input input",this.el);this.min_fats_input=$("#fats .min_input input",
this.el);this.min_proteins_input=$("#proteins .min_input input",this.el);this.max_carbs_input=$("#carbs .max_input input",this.el);this.max_fats_input=$("#fats .max_input input",this.el);this.max_proteins_input=$("#proteins .max_input input",this.el);this.changeMacroScheme();this.triggerCholesterolInput();this.triggerSodiumInput();this.toggleSaveButton()},renderMacroInputs:function(){this.min_carbs_input.val(roundNumber(this.model.attributes.min_carbs,0));this.min_fats_input.val(roundNumber(this.model.attributes.min_fats,
0));this.min_proteins_input.val(roundNumber(this.model.attributes.min_proteins,0));this.max_carbs_input.val(roundNumber(this.model.attributes.max_carbs,0));this.max_fats_input.val(roundNumber(this.model.attributes.max_fats,0));this.max_proteins_input.val(roundNumber(this.model.attributes.max_proteins,0))},renderSliders:function(){var a=this;this.carbs_slider=$("#carbs_range .macro_slider",this.el);this.fats_slider=$("#fats_range .macro_slider",this.el);this.proteins_slider=$("#proteins_range .macro_slider",
this.el);this.max_carbs_bound=$(".max_carbs_bound",this.el);this.max_fats_bound=$(".max_fats_bound",this.el);this.max_proteins_bound=$(".max_proteins_bound",this.el);this.max_carbs_bound.text(roundNumber(this.model.attributes.calories/4,0));this.carbs_slider.slider({range:!0,min:0,max:roundNumber(this.model.attributes.calories/4,0),step:0.01,values:[this.model.attributes.min_carbs,this.model.attributes.max_carbs],slide:function(b,c){a.updateInputs(c.values,a.min_carbs_input,a.max_carbs_input,"carbs")}});
this.max_fats_bound.text(roundNumber(this.model.attributes.calories/9,0));this.fats_slider.slider({range:!0,min:0,max:roundNumber(this.model.attributes.calories/9,0),step:1,values:[this.model.attributes.min_fats,this.model.attributes.max_fats],slide:function(b,c){a.updateInputs(c.values,a.min_fats_input,a.max_fats_input,"fats")}});this.max_proteins_bound.text(roundNumber(this.model.attributes.calories/4,0));this.proteins_slider.slider({range:!0,min:0,max:roundNumber(this.model.attributes.calories/
4,0),step:1,values:[this.model.attributes.min_proteins,this.model.attributes.max_proteins],slide:function(b,c){a.updateInputs(c.values,a.min_proteins_input,a.max_proteins_input,"proteins")}});this.checkIfValidCalories()},toggleInputsAndSliders:function(){if(!this.model.attributes.calories||10>this.model.attributes.calories)return $(".macro_slider",this.el).slider("disable"),$(".min_input input",this.el).prop("disabled",!0),$(".max_input input",this.el).prop("disabled",!0),!1;$(".macro_slider",this.el).slider("enable");
$(".min_input input",this.el).prop("disabled",!1);$(".max_input input",this.el).prop("disabled",!1);return!0},checkIfValidCalories:function(){var a=4*roundNumber(this.model.attributes.min_carbs,0)+9*roundNumber(this.model.attributes.min_fats,0)+4*roundNumber(this.model.attributes.min_proteins,0),b=4*roundNumber(this.model.attributes.max_carbs,0)+9*roundNumber(this.model.attributes.max_fats,0)+4*roundNumber(this.model.attributes.max_proteins,0),c=roundNumber(this.model.attributes.calories,0);if(a>
c)return $(".min_macro_validation").show(),$(".min_macro_validation").html('<div class="alert alert-danger">The minimum possible calories from your macros <strong>('+a+")</strong> is greater than your desired calories <strong>("+c+')</strong>.<br/><strong>  Decrease some of your macro minimums or click the button.</strong>  <button class="btn btn-secondary" id="decrease_macro_minimums">Decrease macro minimums</button></div>'),!1;$(".min_macro_validation").hide();if(b<c)return $(".max_macro_validation").show(),
$(".max_macro_validation").html('<div class="alert alert-danger">The maximum possible calories from your macros <strong>('+b+")</strong> is smaller than your desired calories <strong>("+c+')</strong>.<strong>  Increase some of your macro maximums.</strong>  <button class="btn btn-secondary" id="increase_macro_maximums">Increase macro maximums</button></div>'),!1;$(".max_macro_validation").hide();return!0},updateInputs:function(a,b,c,d){var e=a[0];a=a[1];e!=this.model.get("min_"+d)&&(b.val(roundNumber(e,
0)),this.model.set("min_"+d,e),this.checkIfValidCalories());a!=this.model.get("max_"+d)&&(c.val(roundNumber(a,0)),this.model.set("max_"+d,a),this.checkIfValidCalories())},updateSliders:function(a,b,c,d){b=b.val();c=c.val();if(b!=this.model.get("min_"+d)||c!=this.model.get("max_"+d))a.slider("option","values",[b,c]),this.model.set("min_"+d,b),this.model.set("max_"+d,c),this.checkIfValidCalories()},changeCalories:function(a,b){this.toggleInputsAndSliders()&&(this.model.scaleMacrosFromCalories(a,b),
this.renderMacroInputs(),this.renderSliders())},changeMacroScheme:function(){"grams"==this.form.getValue().macro_scheme?($(".macro_ranges",this.el).show(),$(".macro_percents",this.el).hide()):($(".macro_ranges",this.el).hide(),$(".macro_percents",this.el).show())},triggerCholesterolInput:function(){$('[data-editors="watch_cholesterol"] input',this.el).is(":checked")?$('[data-editors="cholesterol"] input',this.el).removeAttr("disabled"):$('[data-editors="cholesterol"] input',this.el).attr("disabled",
!0)},triggerSodiumInput:function(){$('[data-editors="watch_sodium"] input',this.el).is(":checked")?$('[data-editors="sodium"] input',this.el).removeAttr("disabled"):$('[data-editors="sodium"] input',this.el).attr("disabled",!0)},saveChanges:function(){var a=this;$(".nutrition_profile_error",this.el).remove();var b=this.form.commit({validate:!0});"undefined"===typeof b&&this.checkIfValidCalories()?ETM.use_local_storage||"undefined"!==typeof this.model.attributes.id?a.diet?a.diet.attributes.nutrition_profile.save(a.model.attributes,
{success:function(b,d){ETM.is_logged_in||(a.diet.attributes.nutrition_profile.manually_edited=!0);a.trigger("nutritionProfileUpdated");a.diet.attributes.nutrition_profile.id!=a.model.id&&(a.diet.attributes.nutrition_profile=a.model,a.diet.update_nutrition_profile=!0,a.diet.save(null,{patch:!0}),delete a.diet.update_nutrition_profile,a.trigger("switchedNutritionProfiles"))}}):ETM.nutrition_profile_list.findWhere({id:a.model.attributes.id}).save(a.model.attributes,{success:function(b,d){a.trigger("nutritionProfileUpdated")}}):
this.model.save(null,{success:function(b,d){ETM.nutrition_profile_list.add(a.model);a.diet&&(a.diet.attributes.nutrition_profile=a.model,a.diet.update_nutrition_profile=!0,a.diet.save(null,{patch:!0}),delete a.diet.update_nutrition_profile);a.trigger("switchedNutritionProfiles")}}):a.renderErrors(b);return!1},renderErrors:function(a){for(var b in a)("macro_scheme"===b?$("#macro_scheme_errors"):$('[data-editors="'+b+'"]')).append('<div class="alert alert-danger nutrition_profile_error" style="float:left">'+
a[b].message+"</div>"),$("fieldset",this.form.el).append('<div class="alert alert-danger nutrition_profile_error">'+a[b].message+"</div>")}});
ETM.ManagerSignupEditNutritionTargetsView=ETM.EditNutritionTargetsView.extend({saveChanges:function(){var a=this;$(".nutrition_profile_error",this.el).remove();var b=this.form.commit({validate:!0});if("undefined"===typeof b&&this.checkIfValidCalories()){var c=!ETM.use_local_storage&&"undefined"===typeof this.model.attributes.id;this.model.save(null,{success:function(b,e){c&&ETM.nutrition_profile_list.add(a.model);a.trigger("nutritionProfileUpdated")},error:function(){}})}else a.renderErrors(b);return!1}});
ETM.ManagerUserSettingsNutritionTargetsView=ETM.ManagerSignupEditNutritionTargetsView.extend({events:function(){return _.extend({},ETM.ManagerSignupEditNutritionTargetsView.prototype.events,{"click .calculate_targets":function(a){a.preventDefault();a.stopPropagation();var b=this;Helper.calculateMacrosFromProfile(this.user_profile,function(c){!1==c.valid?Backbone.trigger("flash",{message:"There was an issue with this user's profile: "+c.errors,type:"danger"}):Helper.confirmationPopover({element:$(a.currentTarget),
title:"Are you sure?",message:ETM.loadTemplate("#ManagerConfirmCalculatorTargets")(c),position:"bottom",cancel_text:"Cancel",confirm_text:"Yes",confirmCallback:function(){b.model.save(c,{silent:!0});b.form.setValue(c);b.renderSliders()}})})},"click .delete_nutrition_profile":function(a){a.preventDefault();a.stopPropagation();var b=this;1<b.nutrition_profiles.where({deleted:!1}).length?Helper.confirmationPopover({element:$(a.currentTarget),title:"Are you sure you want to delete this profile?",position:"bottom",
cancel_text:"Cancel",confirm_text:"Yes",confirmCallback:function(){var a=!1;b.client_templates.forEach(function(d){d.attributes.diet.attributes.nutrition_profile.attributes.resource_uri===b.model.attributes.resource_uri&&(a=!0)});b.model.save({deleted:!0},{silent:!0});var d=b.nutrition_profiles.findWhere({deleted:!1});b.updateModel(d);a&&Backbone.trigger("flash",{message:"This nutrition profile is in use in one or more days in your layout.  You may want to head to the 'Meal Plan Layout' and switch those days to no longer use this profile.",
type:"warning"})}}):Backbone.trigger("flash",{message:"Unable to delete nutrition profile - must have at least 1 non deleted profile.",type:"danger"})},"click .undelete_nutrition_profile":function(a){a.preventDefault();a.stopPropagation();var b=this;Helper.confirmationPopover({element:$(a.currentTarget),title:"Are you sure you want to undelete this profile?",position:"bottom",cancel_text:"Cancel",confirm_text:"Yes",confirmCallback:function(){b.model.save({deleted:!1},{silent:!0});b.renderNutritionProfileSelector();
b.renderDeleteButton()}})},"click .create_nutrition_profile":function(a){a.preventDefault();a.stopPropagation();var b=this;for(a=this.nutrition_profiles.length;this.nutrition_profiles.findWhere({title:"My Nutrition Targets "+a});)a+=1;var c=new ETM.NutritionProfile({calories:2E3,title:"My Nutrition Targets "+a});c.save(null,{validate:!1,success:function(){b.nutrition_profiles.add(c);b.updateModel(c)}})}})},initialize:function(a){var b=this;this.name=a.name;this.user_profile=a.user_profile;this.nutrition_profiles=
a.nutrition_profiles;this.client_templates=a.client_templates;this.save_delay=2E3;this.form=new Backbone.Form({model:this.model,template:ETM.loadTemplate("#ManagerEditNutritionTargetsForm"),templateData:{name:this.name}});this.listenTo(this.model,"change",function(){b.autoSave()});this.listenTo(this.form,"change",function(){b.autoSave()})},initializeNpForm:function(){var a=[];this.nutrition_profiles.forEach(function(b){b.attributes.deleted||a.push({val:b.attributes.resource_uri,label:b.attributes.title})});
this.nutrition_profiles.forEach(function(b){b.attributes.deleted&&a.push({val:b.attributes.resource_uri,label:b.attributes.title+" (Deleted)"})});this.np_selector_form=new Backbone.Form({schema:{nutrition_profiles:{type:"Select",options:a}},template:_.template('<div class="col-12 col-sm-8 col-lg-4 mt-1 mb-1" data-editors="nutrition_profiles" id="nutrition_profile_selector"></div>')})},createNpSelectorForm:function(){var a=this;this.initializeNpForm();this.listenTo(this.np_selector_form,"nutrition_profiles:change",
function(b,c){var d=c.getValue();a.updateModel(a.nutrition_profiles.get(d))},this)},beforeClose:function(){this.waiting_to_save&&this.saveChanges()},autoSave:function(){var a=this;if(null==this.waiting_to_save)this.waiting_to_save=!0,this.saveChanges(),a.waiting_to_save=!1;else if(this.waiting_to_save){$(".nutrition_profile_error",this.el).remove();var b=this.form.commit({validate:!0});this.renderErrors(b)}else this.waiting_to_save=!0,setTimeout(function(){a.saveChanges();a.waiting_to_save=!1},a.save_delay)},
updateModel:function(a){var b=this;this.stopListening(this.model);this.model=a;b.form.model=a;b.form.setValue(b.model.attributes);b.renderNutritionProfileSelector();b.renderSliders();b.renderDeleteButton();this.listenTo(this.model,"change",function(){b.autoSave()})},renderDeleteButton:function(){this.model.attributes.deleted?($(".undelete_nutrition_profile",this.el).parent().show(),$(".delete_nutrition_profile",this.el).parent().hide()):($(".delete_nutrition_profile",this.el).parent().show(),$(".undelete_nutrition_profile",
this.el).parent().hide())},render:function(){this.$el.html(this.template({name:this.name}));this.renderForm();return this},renderNutritionProfileSelector:function(){this.createNpSelectorForm();$("#nutrition_profile_selector",this.el).remove();$(".selected_nutrition_profile",this.el).after(this.np_selector_form.render().el);this.np_selector_form.setValue("nutrition_profiles",this.model.attributes.resource_uri)},renderForm:function(){this.form.render();$("#editForm",this.el).html(this.form.el);this.min_carbs_input=
$("#carbs .min_input input",this.el);this.min_fats_input=$("#fats .min_input input",this.el);this.min_proteins_input=$("#proteins .min_input input",this.el);this.max_carbs_input=$("#carbs .max_input input",this.el);this.max_fats_input=$("#fats .max_input input",this.el);this.max_proteins_input=$("#proteins .max_input input",this.el);this.changeMacroScheme();this.triggerCholesterolInput();this.triggerSodiumInput();this.toggleSaveButton();this.renderNutritionProfileSelector();if(null==this.model.attributes.title||
""===this.model.attributes.title)this.model.attributes.title="My Nutrition Targets";this.form.setValue({title:this.model.attributes.title});this.renderSliders()}});
ETM.SuggestedTargetsModal=ModalView.extend({modal_id:"suggested_targets_modal",events:{"click .apply-macro-changes":"applyMacroChanges","change .macro_changes_form select":function(){this.renderMacroChanges()}},initialize:function(){},updateNutritionProfilesList:function(){var a=this;this.nutrition_profiles=[];ETM.nutrition_profile_list.forEach(function(b){b.attributes.deleted||a.nutrition_profiles.push({label:b.attributes.title,val:b.id})});0<this.nutrition_profiles.length?this.nutrition_profile=
ETM.nutrition_profile_list.get(this.nutrition_profiles[0].val):(this.nutrition_profile=new ETM.NutritionProfile,this.nutrition_profile.save(null,{async:!1}),ETM.nutrition_profile_list.add(this.nutrition_profile))},render:function(){this.$el.html(this.template());this.$el.modal({show:!1});this.renderForm();return this},renderForm:function(){this.updateNutritionProfilesList();this.form=(new Backbone.Form({data:{nutrition_profile:this.nutrition_profile.id},schema:{nutrition_profile:{type:"Select",options:this.nutrition_profiles}},
template:Helper.createTemplateFunction($("#macro_changes_template",this.el).html())})).render();$(".macro_changes_form",this.el).html(this.form.el);this.renderMacroChanges()},renderMacroChanges:function(){var a=ETM.current_user_profile,b=Helper.calculateMacrosFromProfile(a);if(b){a=ETM.nutrition_profile_list.get(this.form.getValue().nutrition_profile);null===a&&(a=this.nutrition_profile,this.form.setValue({nutrition_profile:this.nutrition_profile.id}));var c=ETM.loadTemplate("#MacroChangesTemplate"),
d="";b.capped_min_calories&&(d+='<br/><div class="alert alert-warning">Your weight goal would require eating too few calories, so the calculator used half the calories required to maintain your current weight instead.</div>');a.attributes.calories!=b.calories&&(d+=c({what_changed:"Calories",old_value:a.attributes.calories,new_value:b.calories}));a.attributes.min_carbs!=b.min_carbs&&(d+=c({what_changed:"Min Carbs",old_value:a.attributes.min_carbs+"g",new_value:b.min_carbs+"g"}));a.attributes.max_carbs!=
b.max_carbs&&(d+=c({what_changed:"Max Carbs",old_value:a.attributes.max_carbs+"g",new_value:b.max_carbs+"g"}));a.attributes.min_fats!=b.min_fats&&(d+=c({what_changed:"Min Fats",old_value:a.attributes.min_fats+"g",new_value:b.min_fats+"g"}));a.attributes.max_fats!=b.max_fats&&(d+=c({what_changed:"Max Fats",old_value:a.attributes.max_fats+"g",new_value:b.max_fats+"g"}));a.attributes.min_proteins!=b.min_proteins&&(d+=c({what_changed:"Min Proteins",old_value:a.attributes.min_proteins+"g",new_value:b.min_proteins+
"g"}));a.attributes.max_proteins!=b.max_proteins&&(d+=c({what_changed:"Max Proteins",old_value:a.attributes.max_proteins+"g",new_value:b.max_proteins+"g"}));d?($(".macro_changes",this.el).html("<br/>Based on your user profile, goal, and preset diet type, we estimate the following nutrition targets:<br/><br/> "+d),$(".macro_changes",this.el).append('<br/><button class="btn btn-orange apply-macro-changes"><i class="fa fa-check-circle-o" aria-hidden="true"></i> Apply nutrition targets</button>')):$(".macro_changes",
this.el).html("<br/>This nutrition profile matches the recommended nutrition targets.")}else b=a.validationErrorsForCalculator(),a="",0<b.length&&(a="Error(s) trying to calculate recommended changes:<br/>"+b.join("<br/>"),a+="<br/><br/>"),$(".macro_changes",this.el).html(a+'Please fill out your <a href="#" onclick="ETM.router.navigateAndScroll(&quot;/account/&quot;, {trigger: true})">user profile</a>  or update your weight goal settings to enable macro recommendations.')},applyMacroChanges:function(a){null!=
a&&a.preventDefault();a=ETM.nutrition_profile_list.get(this.form.getValue().nutrition_profile);var b=Helper.calculateMacrosFromProfile(ETM.current_user_profile);b&&(delete b.capped_min_calories,a.save(b));this.renderMacroChanges()}});
ETM.MacroChangesView=Backbone.View.extend({events:{"click .show_macro_changes":"toggleMacroChanges","click .apply-macro-changes":"applyMacroChanges"},initialize:function(){var a=this;this.nutrition_profiles=[];ETM.nutrition_profile_list.forEach(function(b){a.nutrition_profiles.push({label:b.attributes.title,val:b.id})});null!=ETM.current_diet&&null!=ETM.current_diet.attributes.nutrition_profile?this.nutrition_profile=ETM.current_diet.attributes.nutrition_profile:0<this.nutrition_profiles.length?this.nutrition_profile=
ETM.nutrition_profile_list.get(this.nutrition_profiles[0].val):(this.nutrition_profile=new ETM.NutritionProfile,this.nutrition_profile.save(null,{async:!1}),ETM.nutrition_profile_list.add(this.nutrition_profile));this.current_preset_diet=ETM.current_user_profile.attributes.preset_diet},render:function(){this.$el.html(this.template());this.renderForm();return this},renderForm:function(){this.form=(new Backbone.Form({data:{nutrition_profile:this.nutrition_profile.id},schema:{nutrition_profile:{type:"Select",
options:this.nutrition_profiles}},template:Helper.createTemplateFunction($("#macro_changes_template",this.el).html())})).render();$(".macro_changes_form",this.el).html(this.form.el)},renderMacroChanges:function(a,b){null!=a&&(this.current_preset_diet=a);null==b&&(b=ETM.current_user_profile.clone().set("preset_diet",this.current_preset_diet));var c=Helper.calculateMacrosFromProfile(b);if(c){var d=ETM.nutrition_profile_list.get(this.form.getValue().nutrition_profile);null==d&&(d=this.nutrition_profile,
this.form.setValue({nutrition_profile:this.nutrition_profile.id}));var e=ETM.loadTemplate("#MacroChangesTemplate"),f="";c.capped_min_calories&&(f+='<br/><div class="alert alert-warning">Your weight goal would require eating too few calories, so the calculator used half the calories required to maintain your current weight instead.</div>');d.attributes.calories!=c.calories&&(f+=e({what_changed:"Calories",old_value:d.attributes.calories,new_value:c.calories}));d.attributes.min_carbs!=c.min_carbs&&(f+=
e({what_changed:"Min Carbs",old_value:d.attributes.min_carbs+"g",new_value:c.min_carbs+"g"}));d.attributes.max_carbs!=c.max_carbs&&(f+=e({what_changed:"Max Carbs",old_value:d.attributes.max_carbs+"g",new_value:c.max_carbs+"g"}));d.attributes.min_fats!=c.min_fats&&(f+=e({what_changed:"Min Fats",old_value:d.attributes.min_fats+"g",new_value:c.min_fats+"g"}));d.attributes.max_fats!=c.max_fats&&(f+=e({what_changed:"Max Fats",old_value:d.attributes.max_fats+"g",new_value:c.max_fats+"g"}));d.attributes.min_proteins!=
c.min_proteins&&(f+=e({what_changed:"Min Proteins",old_value:d.attributes.min_proteins+"g",new_value:c.min_proteins+"g"}));d.attributes.max_proteins!=c.max_proteins&&(f+=e({what_changed:"Max Proteins",old_value:d.attributes.max_proteins+"g",new_value:c.max_proteins+"g"}));f?($(".macro_changes",this.el).html("<br/>In switching to this diet we recommend the following changes to your macros (based on your profile):<br/> "+f),$(".macro_changes",this.el).append('<br/><button class="btn btn-secondary apply-macro-changes">Apply macro changes</button>')):
$(".macro_changes",this.el).html("This nutrition profile already matches the recommend macro changes.")}else c=b.validationErrorsForCalculator(),d="",0<c.length&&(d="Error(s) trying to calculate recommended changes:<br/>"+c.join("<br/>"),d+="<br/><br/>"),$(".macro_changes",this.el).html(d+'Please fill out your <a href="#" onclick="ETM.router.navigateAndScroll(&quot;/account/&quot;, {trigger: true})">user profile</a>  or update your weight goal settings to enable macro recommendations.')},toggleMacroChanges:function(){$(".macro_changes",
this.el).slideToggle(300)},applyMacroChanges:function(a){null!=a&&a.preventDefault();a=ETM.nutrition_profile_list.get(this.form.getValue().nutrition_profile);null==a&&(a=ETM.current_diet.attributes.nutrition_profile,this.form.setValue({nutrition_profile:a.id}));var b=Helper.calculateMacrosFromProfile(ETM.current_user_profile.clone().set("preset_diet",this.current_preset_diet));b&&(delete b.capped_min_calories,a.save(b));this.renderMacroChanges()}});
ETM.NutritionSummaryView=Backbone.View.extend({render:function(){this.$el.html(this.template({current_profile:this.model,preset_diet:ETM.current_user_profile.attributes.preset_diet}));return this}});
ETM.NutritionTargetsView=Backbone.View.extend({events:{"click .edit_meal_options":"editNutritionProfile","click .create_profile_btn":"createNutritionProfile","click .nutrition_targets_dropdown_button":"renderDropdown"},initialize:function(){this.initializeEvents()},initializeEvents:function(){null!=this.model?this.listenTo(this.model,"nutritionProfileUpdated switchedNutritionProfiles change:nutrition_profile",this.updateCurrentNutritionProfile,this):bugsnagClient.notify(Error("Null nutrition profile"))},
updateCurrentNutritionProfile:function(){null==this.nutritionTargetsDetails&&this.render();$(".nutrition_targets_title",this.el).text(this.model.attributes.nutrition_profile.attributes.title);this.nutritionTargetsDetails.render();this.renderDropdown()},render:function(){this.current_nutrition_profile=this.model.attributes.nutrition_profile;this.nutritionTargetsDetails=new ETM.NutritionTargetsDetailsView({model:this.model});this.dropdown=new ETM.NutritionTargetsDropdownView({model:this.model});this.$el.html(this.template({current_profile:this.current_nutrition_profile}));
$(".nutrition_targets_details",this.el).html(this.nutritionTargetsDetails.render().el);this.dropdown.$el=$("#nutrition_targets_dropdown",this.el);return this},renderDropdown:function(){this.dropdown.render();this.dropdown.delegateEvents({"click .other_profile":"switchNutritionProfiles","click .delete_profile":"deleteNutritionProfile"});$('[data-toggle="tooltip"]',this.el).tooltip()},editNutritionProfile:function(){this.initializeEditNutritionModal(this.model.attributes.nutrition_profile.clone())},
createNutritionProfile:function(){this.initializeEditNutritionModal(new ETM.NutritionProfile)},createEditNutritionModal:function(a){return new ETM.EditNutritionTargetsModalView({model:a},{diet:this.model})},initializeEditNutritionModal:function(a){this.editNutritionModalView=this.createEditNutritionModal(a);this.listenTo(this.editNutritionModalView,"openNutritionCalculator",this.showNutritionCalculator,this);this.nutritionCalculator=new ETM.NutritionCalculatorView({model:ETM.current_user_profile},
{nutrition_profile:a,go_back_enabled:!0,show_profile_alert:!0});this.listenTo(this.nutritionCalculator,"useCalculatedSettings",this.updateAndShowEditNutritionModal,this);this.listenTo(this.nutritionCalculator,"openEditNutritionTargets",this.updateAndShowEditNutritionModal,this);this.editNutritionModalView.getModalElement().html(this.editNutritionModalView.render().el);this.nutritionCalculator.getModalElement().html(this.nutritionCalculator.render().el);this.editNutritionModalView.$el.modal("show")},
updateAndShowEditNutritionModal:function(){this.editNutritionModalView.updateNutritionTargets();this.editNutritionModalView.$el.modal("show")},showNutritionCalculator:function(){this.nutritionCalculator.renderForm();this.nutritionCalculator.renderHeightWeightAge();this.nutritionCalculator.$el.modal("show")}});
ETM.NutritionTargetsDetailsView=Backbone.View.extend({render:function(){this.current_nutrition_profile=this.model.attributes.nutrition_profile;this.$el.html(this.template({current_profile:this.current_nutrition_profile}));return this}});
ETM.NutritionTargetsDropdownView=Backbone.View.extend({render:function(){var a=this;this.current_nutrition_profile=this.model.attributes.nutrition_profile;this.other_profiles=[];ETM.nutrition_profile_list.each(function(b){b.id==a.current_nutrition_profile.id||b.attributes.deleted||a.other_profiles.push(b)});this.$el.html(this.template({current_profile:this.current_nutrition_profile,other_profiles:this.other_profiles,is_logged_in:ETM.is_logged_in}));return this},deleteNutritionProfile:function(a){a.stopPropagation();
a=parseInt(a.currentTarget.id);this.other_profiles[a].attributes.deleted=1;this.other_profiles[a].save(null,{validate:!1});ETM.nutrition_profile_list.remove(this.other_profiles[a]);this.render()},switchNutritionProfiles:function(a){a.stopPropagation();a=parseInt(a.currentTarget.id);a=this.other_profiles[a];this.model.save({nutrition_profile:a},{patch:!0});this.model.trigger("switchedNutritionProfiles");this.current_nutrition_profile=a;this.render()}});
ETM.NutritionProfileListView=ETM.NutritionTargetsView.extend({events:{"click .create_new_profile":"createNutritionProfile"},initialize:function(){this.collection_views=[];this.listenTo(ETM.nutrition_profile_list,"add remove",function(){this.renderNutritionProfiles()},this)},render:function(){this.$el.html(this.template());this.renderNutritionProfiles();return this},renderNutritionProfiles:function(){var a=this;$(".meal_type_list",this.el).html("");a.collection_views.forEach(function(a){a.close()});
a.collection_views=[];ETM.nutrition_profile_list.where({deleted:!1}).forEach(function(b){b=new ETM.NutritionProfileListItem({model:b});a.collection_views.push(b);$(".nutrition_profile_list",a.el).append(b.render().el)})}});
ETM.NutritionProfileListItem=ETM.NutritionTargetsView.extend({events:{"click .nutrition_profile_row":"editNutritionProfile","click .delete_nutrition_profile a":"deleteNutritionProfile"},initialize:function(a){this.listenTo(this.model,"change",function(){this.render()},this)},deleteNutritionProfile:function(a){a.preventDefault();a.stopPropagation();if(1<ETM.nutrition_profile_list.where({deleted:!1}).length){var b=this;Helper.confirmationPopover({element:$(a.target),title:"Are you sure?",message:"<p>It will be removed from your nutrition profile list, but may still remain in your meal plans.</p>",
position:"bottom",cancel_text:"Cancel",confirm_text:"Yes, delete",confirmCallback:function(){b.model.save({deleted:!0},{patch:!0});b.close()}})}else Backbone.trigger("flash",{message:"You must have at least 1 nutrition profile.",type:"danger"})},editNutritionProfile:function(){this.initializeEditNutritionModal(this.model.clone())},createEditNutritionModal:function(a){return new ETM.EditNutritionTargetsModalView({model:a})},render:function(){this.$el.html(this.template({model:this.model}));return this}});
function dietDiff(a,b,c){var d={};d.min_carbs=b.min_carbs-a.getPrimaryCarbs();d.max_carbs=b.max_carbs-a.getPrimaryCarbs();d.min_fats=b.min_fats-a.fats;d.max_fats=b.max_fats-a.fats;d.min_proteins=b.min_proteins-a.proteins;d.max_proteins=b.max_proteins-a.proteins;d.max_cholesterol=b.max_cholesterol-a.cholesterol;d.max_sodium=b.max_sodium-a.sodium;d.min_fiber=b.min_fiber-a.fiber;d.max_fiber=b.max_fiber-a.fiber;d.max_price=b.max_price-a.price;d.calories=1==lap_num?b["meal"+c].calories:b.calories-a.calories;
return d}
function getMealConstraints(a,b){var c=a.returnDietStatsWithoutMeal(b),d=getMacroConstraints(a),e=a.attributes.nutrition_profile.attributes.fiber;e>d.max_carbs&&(e=d.max_carbs);var f=1.5*e;37.5>f&&(f=37.5);c.fiber>f&&(f=c.fiber);d=$.extend({},d,{calories:a.attributes.nutrition_profile.attributes.calories,max_sodium:a.attributes.nutrition_profile.attributes.sodium,max_cholesterol:a.attributes.nutrition_profile.attributes.cholesterol,max_price:ETM.current_user_profile.attributes.daily_price_limit,min_fiber:e,
max_fiber:f});lap_num=2;c=dietDiff(c,d,0);lap_num=1;return c}function cleanConstraints(a){for(var b in a)a.hasOwnProperty(b)&&(a[b]=0>a[b]?0:roundNumber(a[b],0))}
function getMacroConstraints(a){var b=a.attributes.nutrition_profile;if("grams"==b.attributes.macro_scheme)a={min_carbs:b.attributes.min_carbs,max_carbs:b.attributes.max_carbs,min_fats:b.attributes.min_fats,max_fats:b.attributes.max_fats,min_proteins:b.attributes.min_proteins,max_proteins:b.attributes.max_proteins};else{a=Math.ceil(b.attributes.calories*(b.attributes.percent_carbs/100))/4;var c=Math.ceil(b.attributes.calories*(b.attributes.percent_fats/100))/9,b=Math.ceil(b.attributes.calories*(b.attributes.percent_proteins/
100))/4;a={min_carbs:a-4,max_carbs:a+4,min_fats:c-2,max_fats:c+2,min_proteins:b-4,max_proteins:b+4}}return a}
ETM.MealNutritionTargetsView=Backbone.View.extend({events:{"click .reset_nutrition_button":"resetNutritionTargets","click .edit_meal_nutrition_targets":"toggleNutritionTargetsPopover"},initialize:function(a,b){this.nutrition_target_storage=new ETM.SimpleNutritionProfile;this.nutrition_target_storage.fetch();this.default_targets=this.getDefaultTargets();this.targets_dict=_.clone(this.default_targets)},render:function(){this.$el.html(this.template({targets:this.targets_dict,nutrition_profile:this.nutrition_target_storage}));
this.popover_button=$(".edit_meal_nutrition_targets",this.el);this.renderTargetsString();this.renderNutritionTargetsPopover();return this},renderTargetsString:function(){var a=this.targets_dict.calories+" Calories, "+this.targets_dict.min_carbs+"-"+this.targets_dict.max_carbs+"g carbs, "+this.targets_dict.min_fats+"-"+this.targets_dict.max_fats+"g fat, "+this.targets_dict.min_proteins+"-"+this.targets_dict.max_proteins+"g protein";$(".restaurant_nutrition_targets",this.el).html(a);this.showResetButton()},
showResetButton:function(){var a=!1,b;for(b in this.targets_dict)if(this.targets_dict.hasOwnProperty(b)&&this.targets_dict[b]!==this.default_targets[b]){a=!0;break}a?$(".reset_nutrition_div",this.el).show():$(".reset_nutrition_div",this.el).hide()},onClose:function(){this.closeNutritionTargetsPopover();Helper.hideAllTooltips()},resetNutritionTargets:function(){this.targets_dict=_.clone(this.default_targets);this.renderTargetsString();this.parent.search()},getDefaultTargets:function(){var a={calories:500,
max_carbs:100,max_cholesterol:5E3,max_fats:100,max_fiber:100,max_price:100,max_proteins:100,max_sodium:5E3,min_carbs:0,min_fats:0,min_fiber:0,min_proteins:0};this.model.hasParentDiet()&&(a=getMealConstraints(this.model.getParentDiet(),this.model.attributes.meal_number));cleanConstraints(a);return a},getSerializedTargets:function(){return JSON.stringify(this.targets_dict)},renderNutritionTargetsPopover:function(){var a=this.nutrition_target_storage.attributes.customized_targets?new ETM.SimpleNutritionProfile(this.nutrition_target_storage.attributes):
new ETM.SimpleNutritionProfile(this.targets_dict);this.nutrition_form_view||(this.nutrition_form_view=new ETM.MiniNutritionTargetsView({model:a}),this.nutrition_form_view.parent=this);this.popover_button.popover({placement:"bottom",html:!0,title:"Customize nutrition filters",template:'<div class="targets_popover popover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',content:this.nutrition_form_view.render().el,trigger:"manual"})},toggleNutritionTargetsPopover:function(){this.popover_button.popover("toggle")},
closeNutritionTargetsPopover:function(){this.popover_button.popover("hide")},loadTargetsAndRender:function(){this.targets_dict.calories=this.nutrition_form_view.model.attributes.calories;this.targets_dict.min_carbs=this.nutrition_form_view.model.attributes.min_carbs;this.targets_dict.max_carbs=this.nutrition_form_view.model.attributes.max_carbs;this.targets_dict.min_fats=this.nutrition_form_view.model.attributes.min_fats;this.targets_dict.max_fats=this.nutrition_form_view.model.attributes.max_fats;
this.targets_dict.min_proteins=this.nutrition_form_view.model.attributes.min_proteins;this.targets_dict.max_proteins=this.nutrition_form_view.model.attributes.max_proteins;this.closeNutritionTargetsPopover();this.renderTargetsString();this.parent.search()}});
ETM.MiniNutritionTargetsView=ETM.EditNutritionTargetsView.extend({events:{"click #increase_macro_maximums":"increaseMacroMaximums","click #decrease_macro_minimums":"decreaseMacroMinimums","change #2nd_cal_input input":"caloriesChangedCheck","change #fats div input":"updateFats","change #carbs div input":"updateCarbs","change #proteins div input":"updateProteins","click .cancel_meal_targets":"closeForm","click .close_popover":"closeForm","click .save_meal_targets":"saveChanges"},initialize:function(a,
b){},changeMacroScheme:function(){$(".macro_ranges",this.el).show()},schema:{calories:{type:"PositiveNumber"},max_carbs:"PositiveNumber",max_fats:"PositiveNumber",max_proteins:"PositiveNumber",min_carbs:"PositiveNumber",min_fats:"PositiveNumber",min_proteins:"PositiveNumber"},renderForm:function(){this.form=(new Backbone.Form({model:this.model,template:Helper.createTemplateFunction($("#smallEditNutritionFormTemplate",this.el).html()),schema:this.schema})).render();$(".editTargetsForm",this.el).html(this.form.el);
this.min_carbs_input=$("#carbs .min_input input",this.el);this.min_fats_input=$("#fats .min_input input",this.el);this.min_proteins_input=$("#proteins .min_input input",this.el);this.max_carbs_input=$("#carbs .max_input input",this.el);this.max_fats_input=$("#fats .max_input input",this.el);this.max_proteins_input=$("#proteins .max_input input",this.el)},closeForm:function(a){a=this.form.commit({validate:!0});"undefined"===typeof a&&this.checkIfValidCalories()?this.saveTargetsToLocalStorage():this.renderErrors(a);
this.parent.closeNutritionTargetsPopover();return!1},saveChanges:function(){$(".nutrition_profile_error",this.el).remove();var a=this.form.commit({validate:!0});"undefined"===typeof a&&this.checkIfValidCalories()?(this.saveTargetsToLocalStorage(),this.parent.loadTargetsAndRender()):this.renderErrors(a);return!1},saveTargetsToLocalStorage:function(){this.parent.nutrition_target_storage.save({customized_targets:!0,calories:this.model.attributes.calories,min_carbs:this.model.attributes.min_carbs,max_carbs:this.model.attributes.max_carbs,
min_fats:this.model.attributes.min_fats,max_fats:this.model.attributes.max_fats,min_proteins:this.model.attributes.min_proteins,max_proteins:this.model.attributes.max_proteins})}});
ETM.PlanStatsView=ETM.NutritionTargetsView.extend({events:{"click .micro_expandable":"toggleMicroStats","click .edit_current_targets":"editNutritionProfile"},initialize:function(a){this.read_only="undefined"!==typeof a&&a.read_only;this.listenTo(this.model.attributes.nutrition_profile,"change",function(){this.renderUpdates()},this);this.listenTo(this.model,"updateStats finishedGeneratingSaved change:num_meals swap_complete",function(){this.renderUpdates()})},render:function(a){$(".plan_stats_popover",
this.el).popover("dispose");this.$el.html(this.template({model:this.model}));this.renderStatsPopover();this.toggleStatsAlert();$(".micro_day_stats",this.el).html(getMicroHTML(this.model.stats));"undefined"===typeof a&&this.printSparkPie();return this},onClose:function(){},renderUpdates:function(){this.printStatsPreview();this.updatePopoverContent();this.toggleStatsAlert();$(".edit_current_targets",self.el).tooltip("dispose");$(".edit_current_targets",self.el).tooltip({placement:"top",html:!0,trigger:"hover",
title:'Edit "'+this.model.attributes.nutrition_profile.attributes.title+'" profile'})},printStatsPreview:function(){$(".plan_calories",this.el).html(roundNumber(this.model.stats.calories,0)+" Calories");this.printSparkPie()},updatePopoverContent:function(){if($(".plan_stats_popover",this.el).data("bs.popover")){var a=this.template({model:this.model});entire_popover_content=$("<div/>").html(Helper.createTemplateFunction($("<div/>").html(a).find("#planStatsPopover").html())());a=$(".nutrition-row",
entire_popover_content);$(".plan_stats_popover",this.el).data("bs.popover").config.content=entire_popover_content.html();$(".popover-body .nutrition-row",this.el).replaceWith(a);$(".popover-body .micro_day_stats",this.el).html(getMicroHTML(this.model.stats));this.printGraph($(".popover-body .cumulative_graph",this.el));ETM.MealPlanViewState.isSingleDayCarousel()&&($(".plan_stats_expanded .nutrition-row",this.el).replaceWith(a),$(".plan_stats_expanded .micro_day_stats",this.el).html(getMicroHTML(this.model.stats)),
this.printGraph($(".plan_stats_expanded .cumulative_graph",this.el)))}},renderStatsPopover:function(){var a=this,b=$(".plan_stats_popover",this.el);b.off();var c=Helper.createTemplateFunction($("#planStatsPopover",this.el).html())();$(".net_carbs_tooltip",c).tooltip({placement:"right",html:!1,title:"Net carbs are the grams of carbohydrates minus the grams of fiber. If you're following a low-carb diet, this is the number you should pay attention to."});b.popover({content:c,container:a.$el,trigger:"click",
html:!0,placement:"right",offset:"45%p, 10px",template:'<div style="z-index:1039;" class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',flipEnabled:ETM.is_logged_in});b.on("shown.bs.popover",function(){a.printGraph($(".popover-body .cumulative_graph",a.el));a.toggleStatsAlert();$(".micro_day_stats",a.el).html(getMicroHTML(a.model.stats));$(".edit_current_targets",a.el).tooltip("dispose");$(".edit_current_targets",a.el).tooltip({placement:"top",
html:!0,trigger:"hover",title:'Edit "'+a.model.attributes.nutrition_profile.attributes.title+'" profile'})});if(ETM.is_mobile)b.on("hide.bs.popover",function(){$(document).off("click",a.checkPopoverDismiss)});ETM.MealPlanViewState.isSingleDayCarousel()&&($(".plan_stats_expanded",this.el).html(c),a.printGraph($(".plan_stats_expanded .cumulative_graph",a.el)),$(".plan_stats_expanded .close-stats-popover",this.el).hide(),$(".plan_stats_expanded .edit_current_targets",a.el).tooltip("dispose"),$(".plan_stats_expanded .edit_current_targets",
a.el).tooltip({placement:"top",html:!0,trigger:"hover",title:'Edit "'+a.model.attributes.nutrition_profile.attributes.title+'" profile'}))},checkPopoverDismiss:function(a){var b=this;$(".plan_stats_popover",this.el).each(function(){$(this).is(a.target)||0!==$(this).has(a.target).length||0!==$(".popover",b.el).has(a.target).length||((($(this).popover("hide").data("bs.popover")||{}).inState||{}).click=!1)})},editNutritionProfile:function(){$(".edit_current_targets",this.el).tooltip("hide");this.initializeEditNutritionModal(this.model.attributes.nutrition_profile.clone());
!ETM.local_variables.attributes.seen_edit_nutrition_from_layout_tip&&ETM.is_logged_in&&setTimeout(this.showWeeklyLayoutPopover,500)},showWeeklyLayoutPopover:function(){Helper.oneTimePopover({element:$("#edit_nutrition_modal .modal-header"),position:"bottom",message:'<p>If you want to create new Nutrition Profiles or switch them around, you can do so in the <strong>Meal Layout</strong> editor.</p><p>You can find the Meal Layout editor by clicking <strong>"<i class="fa fa-pencil"></i> Meal Layout"</strong> in the top right of the planner page.</p>',
button_dismiss:!0,dismiss_callback:function(){ETM.local_variables.save({seen_edit_nutrition_from_layout_tip:!0})}})},toggleStatsAlert:function(){this.model.dietStatsMatchTargets()||this.read_only?($(".stats_alert",this.el).css("display","none"),$(".stats_warning",this.el).hide()):($(".stats_alert",this.el).css("display","block"),$(".stats_warning",this.el).show())},toggleMicroStats:function(){$(".micro_day_stats",this.el).toggle();this.toggleStatsAlert()},printSparkPie:function(){var a=4*this.model.stats.getPrimaryCarbs()+
4*this.model.stats.proteins+9*this.model.stats.fats,b=$(".plan_spark_chart",this.el);if(0>=a)b.html("");else{var c=roundNumber(100*(4*this.model.stats.getPrimaryCarbs()/a),2),d=roundNumber(100*(9*this.model.stats.fats/a),2),a=roundNumber(100*(4*this.model.stats.proteins/a),2),e=[{label:"Carbs",data:c,color:"#FCB524"},{label:"Protein",data:a,color:"#976fe8"},{label:"Fat",data:d,color:"#52C0BC"}];setTimeout(function(){try{0<b.width()&&0<b.height()&&$.plot(b,e,{series:{pie:{startAngle:0,show:!0,radius:1,
label:{show:!1}}},legend:{show:!1}})}catch(a){console.log(a),console.log("--- failed to print graph ---")}},0)}},printGraph:function(a){var b=4*this.model.stats.getPrimaryCarbs()+4*this.model.stats.proteins+9*this.model.stats.fats;if(0>=b)a.html("");else{var c=roundNumber(100*(4*this.model.stats.getPrimaryCarbs()/b),2),d=roundNumber(100*(9*this.model.stats.fats/b),2),b=roundNumber(100*(4*this.model.stats.proteins/b),2),e=[{label:"Carbs",data:c,color:"#FCB524"},{label:"Protein",data:b,color:"#976fe8"},
{label:"Fat",data:d,color:"#52C0BC"}];setTimeout(function(){try{$.plot(a,e,{series:{pie:{startAngle:0,show:!0,radius:1,label:{show:!0,radius:0.5,formatter:function(a,b){return'<div style="font-size:10pt;text-align:center;padding:0px;color:white;">'+a+"<br/>"+Math.round(b.percent)+"%</div>"},threshold:0.1}}},legend:{show:!1}})}catch(b){console.log(b)}},0)}}});
ETM.FoodObjectModalRecipeView=ETM.FoodObjectModalBasicView.extend({className:"modal-content",events:function(){return _.extend({},ETM.FoodObjectModalBasicView.prototype.events,{"click .personalize_recipe":"convertViewToEdit","click .add_direction":"addDirection","click .cancel_edits":"closeEditor","click .save_recipe":"saveRecipe","click .enter_ingredients_text":function(a){this.enterTextIngredients(!1)},"click .confirm_ingredients_text":"confirmTextIngredients","click .parse_ingredients_text":function(a){this.parseTextIngredients($(".enter_ingredients_textbox",
self.el).val())},"click .cancel_ingredients_text":"cancelTextIngredients","click .admin_edit":function(){this.adminEditRecipe("copy_for_edits")},"click .admin_edit_in_place":function(){this.adminEditRecipe("edit_in_place")},"click .admin_curate_and_edit":function(){this.adminEditRecipe("copy_and_curate")},"change .modal_curate_recipe_radio":"changeRecipeCuration","click .enable_curation_radio":"enableCurationRadioButtons","change .admin_extra_tags_checkboxes input":"enableTagSaveButton","click .admin_save_recipe_tags":"saveRecipeTags",
"click .report_recipe_btn":"reportRecipeModal","submit .import_recipe_form":"importRecipeFromUrl","click .see_import_errors":"scrollToError","click .print_recipe":"printRecipe","blur .form-group.import_group":"validateInputUI","click .ingredient_thumbs .thumb_icon":function(a){$(a.currentTarget).prop("disabled")||this.toggleIngredientThumb($(a.currentTarget))},"click .amazon_fresh_ingredients .a-button":"openAmazonRecipeModal"})},render:function(){this.updateStaticAmountAndUnits();var a=this;this.$el.html(this.template({model:this.model,
amino_acids:ETM.amino_acids,fatty_acids:ETM.fatty_acids,vits_and_mins:ETM.vits_and_mins,nutrient_names:ETM.nutrient_names,selector_html:a.selectorHTML(),user_id:ETM.current_user_profile.attributes.user_id?ETM.current_user_profile.attributes.user_id:!1,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff,image:this.model.attributes.food.getDisplayImage(),thumb_rating:0}));this.renderFoodRating();this.renderAdminSection();this.printFoodStats();this.addTooltips();this.resizeAmountInput();
this.updateScaleSelector();this.model.attributes.food.downloadRecipeInfo(function(){$(".downloading_ingredients_spinner",a.el).hide();_.has(a,"ingredients_list_view")||(a.ingredients_list_view=new ETM.ReadOnlyIngredientListView({collection:a.model.get("food").get("ingredients"),el:$(".ingredients_list",a.el)}),a.ingredients_list_view.render());_.has(a,"directions_list_view")||(a.directions_list_view=new ETM.ReadOnlyDirectionsListView({collection:a.model.get("food").get("directions"),el:$(".directions_list",
a.el)}),a.directions_list_view.render());a.updateIngredientAmounts()});this.model.is_favorite&&$(".control_button.favorite_food",this.el).addClass("active");$("img.lazyload",this.el).unveil();$("img.lazyload",this.el).trigger("unveil");this.printTags();this.renderCuratorSection();this.create_uploader();return this},openAmazonRecipeModal:function(){this.amazon_fresh_recipe_modal||(this.amazon_fresh_recipe_modal=new ETM.AmazonFreshRecipeModal);this.amazon_fresh_recipe_modal.getModalElement().html(this.amazon_fresh_recipe_modal.render(this.model).el);
this.amazon_fresh_recipe_modal.delegateEvents();this.amazon_fresh_recipe_modal.$el.modal("show");ETM.analytics.logAmazonRecipeOpenModal()},renderAdminSection:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;this.admin_section_template||(this.admin_section_template=ETM.loadTemplate("#RecipeAdminTemplate"));$("#admin_food_options",this.el).html(this.admin_section_template({model:this.model}))},renderCuratorSection:function(){if(this.isUsingCurator()){var a=new ETM.FoodChangesListView({model:this.model});
a.food_object_modal=this;$(".curator_div",this.el).html(a.render().el)}},initialize:function(){this.listenTo(this.model.attributes.food,"addFavorite",function(){this.model.is_favorite=!0;$(".control_button.favorite_food",this.el).addClass("active")},this);this.listenTo(this.model.attributes.food,"removeFavorite",function(){this.model.is_favorite=!1;$(".control_button.favorite_food",this.el).removeClass("active")},this)},printFoodStats:function(){if(!this.model.get("food").get("is_recipe")||this.parent&&
"original"!==this.parent.ingredients_scale)this.model.get("food").get("is_recipe")&&"to_cook"===this.parent.ingredients_scale?(a=this.model.amount_to_cook,b=this.model.customStats(a,1),c=roundNumber(a*this.model.attributes.food.attributes.weights[1].amount,5),d=this.model.attributes.food.attributes.weights[1].description,a*=this.model.get("food").attributes.weights[1].grams):(a=this.model.get("amount"),b=this.model.stats,c=this.model.static_amount,d=this.model.static_units,a*=this.model.get("food").attributes.weights[this.model.get("units")].grams);
else var a=this.model.get("food").get("number_servings"),b=this.model.customStats(a,1),c=roundNumber(a*this.model.attributes.food.attributes.weights[1].amount,5),d=this.model.attributes.food.attributes.weights[1].description,a=a*this.model.get("food").attributes.weights[1].grams;$(".stats_serving_info",this.el).html("Based on "+Helper.formatFoodAmount(c)+" "+d);this.model.attributes.food.attributes.accurate_grams&&$(".stats_serving_info",this.el).append(" ("+roundNumber(a,2)+" grams)");$(".add_micronutrients_here",
this.el).html(getMicroHTML(b));b=getStatsHTMLFromTemplate(b);$("#modal_day_stats .stats_output",this.el).html(b)},convertViewToEdit:function(){var a=this;a.undelegateEvents();this.parent.$el.one("hidden.bs.modal",function(){ETM.recipe_editor=new ETM.RecipeEditorModalView;ETM.recipe_editor.copyThenLoad(a.model,!1);ETM.recipe_editor.getModalElement().html(ETM.recipe_editor.render().el);ETM.recipe_editor.$el.modal("show");ETM.recipe_editor.applyEvents();ETM.recipe_editor.delayPrintGraph()}).modal("hide")},
adminEditRecipe:function(a){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var b=this;b.undelegateEvents();this.parent.$el.one("hidden.bs.modal",function(){ETM.recipe_editor=new ETM.RecipeEditorModalView;ETM.recipe_editor.admin_edit=!0;ETM.recipe_editor.admin_edit_method=a;ETM.recipe_editor.copyThenLoad(b.model,!1);ETM.recipe_editor.getModalElement().html(ETM.recipe_editor.render().el);ETM.recipe_editor.$el.modal("show");ETM.recipe_editor.applyEvents();ETM.recipe_editor.delayPrintGraph();
b.hideImageEditorForAdmins()}).modal("hide")},hideImageEditorForAdmins:function(){$(".recipe_upload_image",ETM.recipe_editor.el).html('<span class="font-italic text-muted">Image editor hidden for admin edits</span>')},changeRecipeCuration:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=$(".modal_curate_recipe_radio input:checked").val();$.ajax({url:"/admin/recipe/switch_curated/"+this.model.get("food").get("id"),data:{curated:a},type:"POST",success:function(a){console.log("successfully changed")}})},
enableTagSaveButton:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;$(".admin_save_recipe_tags",this.el).attr("disabled",!1)},reportRecipeModal:function(){var a=new ETM.RecipeReportModalView({model:this.model.attributes.food});a.getModalElement().html(a.render().el);a.$el.modal("show")},saveRecipeTags:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;$(".admin_save_recipe_tags",a.el).attr("disabled",!0);var b=[];$(".admin_extra_tags_checkboxes :checkbox:checked",
this.el).each(function(){b.push($(this).attr("name"))});save_tags=b.join(" ");$.ajax({url:"/admin/recipe/save_tags/"+this.model.get("food").get("id"),data:{substitution_tags:save_tags},type:"POST",success:function(b){console.log("successfully changed");$(".save_tags_errors",a.el).html("<span class='text-success'>Success!</span>");a.model.attributes.food.attributes.substitution_tags=save_tags},error:function(b,d,e){$(".save_tags_errors",a.el).html("<span class='text-danger'>Shoot, an error!</span>");
$(".admin_save_recipe_tags",a.el).attr("disabled",!1);console.log(d);console.log(e)}})},printTags:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this,b=null!=a.model.attributes.food.attributes.substitution_tags?a.model.attributes.food.attributes.substitution_tags.split(" "):[];$(".admin_extra_tags_checkboxes input",this.el).each(function(){$(this).attr("checked",!1)});b&&_.each(b,function(b){$(".admin_extra_tags_checkboxes [name='"+b+"']",a.el).attr("checked",!0)})},toggleIngredientThumb:function(a){if(!ETM.is_logged_in)return!1;
a.prop("disabled",!0);ETM.local_variables.attributes.seen_food_rating_info||(this.showThumbInfoPopup(a),ETM.local_variables.save({seen_food_rating_info:!0}));a.toggleClass("active").toggleClass("inactive");var b=a.hasClass("active")?a.hasClass("thumbs_up")?THUMB_RATINGS.THUMBS_UP:THUMB_RATINGS.THUMBS_DOWN:THUMB_RATINGS.NO_RATING;this.model.get("food").get("ingredients").get(a.data("id")).attributes.food.saveThumbRating(b,function(){a.prop("disabled",!1)})},enableCurationRadioButtons:function(){$(".modal_curate_recipe_radio input",
this.el).prop("disabled",!1)},printRecipe:function(){var a=ETM.loadTemplate("#PrintableRecipeTemplate")({model:this.model,user_id:ETM.current_user_profile.attributes.user_id?ETM.current_user_profile.attributes.user_id:!1,image:this.model.attributes.food.getDisplayImage(),serving_description:this.getServingDescription()});ETM.writeContentToDocument(a,this.model.attributes.food.attributes.food_name+" - Eat This Much",!0)}});
ETM.RecipeEditorModalView=ETM.FoodObjectModalRecipeView.extend({modal_id:"recipe_editor_modal_div",id:"recipe_editor_modal",className:"modal fade",initialize:function(){this.admin_edit_method=this.admin_edit=this.imported_recipe_url=this.currently_parsing=this.editing_user_recipe=this.editing_from_sidebar=this.original_food_object=this.editing_old_recipe=!1;this.$el.one("hidden.bs.modal",function(){ETM.recipe_editor.undelegateEvents();ETM.recipe_editor.search_view.close();ETM.recipe_editor.close();
self.editing_old_recipe&&!self.editing_from_sidebar?(self.editing_old_recipe=!1,self.original_food_object=!1,self.editing_from_sidebar=!1,self.editing_user_recipe=!1,ETM.food_object_modal.loadFood(ETM.food_object_modal.model)):(self.editing_old_recipe=!1,self.original_food_object=!1,self.editing_from_sidebar=!1,self.editing_user_recipe=!1)})},applyEvents:function(){var a=this;this.listenTo(this.model.get("food").get("ingredients"),"add",function(){a.calculateStats();a.printRecipeStats();a.printGraph()});
this.listenTo(this.model.get("food").get("ingredients"),"remove",function(){a.calculateStats();a.printRecipeStats();a.printGraph()});this.listenTo(this.model.get("food").get("ingredients"),"updateStats",function(){a.calculateStats();a.printRecipeStats();a.printGraph()});this.listenTo(this.model.get("food").get("ingredients"),"addedRecipe",function(){$(".ingredients_error",a.el).css("display","inline-block")});this.listenTo(this.model.get("food").get("ingredients"),"addedIngredient",function(){$(".ingredients_error",
a.el).hide()})},render:function(){this.$el.html(this.template({model:this.model,image:this.model.attributes.food.getDisplayImage(),user_id:null,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff}));this.$el.modal({backdrop:"static",keyboard:!1,show:!1});this.ingredients_list_view=new ETM.IngredientListView({collection:this.model.get("food").get("ingredients"),el:$(".ingredients_list",this.el)});this.ingredients_list_view.render();this.setIngredientScale(this.model.get("food").get("number_servings"));
this.directions_list_view=new ETM.DirectionsListView({collection:this.model.get("food").get("directions"),el:$(".directions_list",this.el)});this.directions_list_view.render();this.renderForm();this.resizeDirectionsFields();this.model.get("food").get("ingredients").each(function(a){a.calculateStats()});this.renderIngredientsSearch();this.calculateStats();this.printRecipeStats();this.create_uploader_recipe_editor();this.addTooltips();return this},renderIngredientsSearch:function(){this.search_view||
(this.search_view=new ETM.SearchBarView({model:ETM.ingredients_search_model,in_modal:!0,ingredients_only:!0,container:this.$el,placement:"right"}));$(".ingredients_search",this.el).html(this.search_view.render().el)},resizeDirectionsFields:function(){setTimeout("resizeAllDirections()",500)},create_uploader_recipe_editor:function(){var a=this;this.listenTo(this.model,"imageUpdated",function(b){a.imageObject=b});ETM.displayImageSelectModal($(".recipe_upload_image",a.el),function(b){a.modal&&a.modal.close();
a.modal=new ETM.RecipeEditorCropModalView({model:a.model});a.modal.getModalElement().html(a.modal.render(b).el);a.modal.show()})},copyThenLoad:function(a,b){var c=a.clone(),d=a.attributes.food.clone();this.editing_old_recipe=!0;this.editing_user_recipe=ETM.current_user_profile.get("user_id")===d.attributes.user_id&&!1===d.attributes.curated;this.original_food_object=a;this.editing_from_sidebar=b;if(!this.admin_edit&&0<d.attributes.images.length){var e=a.attributes.food.getDisplayImage();this.imageObject=
new ETM.FoodImage(e.attributes);this.editing_user_recipe||Helper.clearIDs(this.imageObject);d.attributes.images.add(this.imageObject)}var f=[];a.attributes.food.attributes.ingredients.each(function(a){f.push(a.toJSON())});var e=new ETM.IngredientsList(f),g=new ETM.DirectionsList(a.attributes.food.attributes.directions.toJSON());d.attributes.ingredients=e;d.attributes.directions=g;this.editing_user_recipe?(d.attributes.deleted=!1,d.url=function(){return ROOT+"/recipe/"+a.attributes.food.get("id")+
"/"}):this.admin_edit&&("edit_in_place"===this.admin_edit_method?(d.url=function(){return ROOT+"/adminrecipe/"+a.attributes.food.get("id")+"/"},this.editing_user_recipe=!0):d.url=function(){return ROOT+"/adminrecipe/"},d.attributes.previous_user=d.attributes.user_id,d.attributes.admin_edit_method=this.admin_edit_method);this.editing_user_recipe||(this.admin_edit||(d.attributes.deleted=!1),Helper.clearIDs(d),delete d.attributes.food_id,d.attributes.ingredients.each(function(a){Helper.clearIDs(a)}),
d.attributes.directions.each(function(a){Helper.clearIDs(a)}),!0!==d.attributes.curated||this.admin_edit||(d.attributes.curated=!1),d.attributes.previous_food_id=a.attributes.food.attributes.id,d.attributes.base_food_id=null!=a.attributes.food.attributes.base_food_id?a.attributes.food.attributes.base_food_id:a.attributes.food.attributes.id,this.admin_edit||(d.url=function(){return ROOT+"/recipe/"}));c.attributes.food=d;this.model=c},closeEditor:function(){Helper.hideAllTooltips();this.$el.modal("hide")},
renderForm:function(){this.form=(new Backbone.Form({model:this.model.get("food"),template:Helper.createTemplateFunction($("#recipeForm",this.el).html())})).render();$(".recipe_info_container",this.el).html(this.form.el);$("#recipe-title",this.el).val(this.model.get("food").attributes.food_name);$("#recipe-description",this.el).val(this.model.get("food").attributes.description);$("#serving-size-input",this.el).val(this.model.get("food").attributes.weights[1].amount);$("#serving-description",this.el).val(this.model.get("food").attributes.weights[1].description)},
parseServingSize:function(a){return roundNumber(parseFloat(a),2)},validate:function(a){$(".recipe_validation_error",this.el).remove();var b=!0,c=$("#recipe-title",this.el),d=$("#serving-size-input",this.el),e=$("#serving-description",this.el);0<!c.val().length&&(c.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a title.</div>"),b=!1);0<!d.val().length?(d.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a serving size.</div>"),
b=!1):0>=this.parseServingSize(d.val())&&(d.after("<div class='alert alert-danger recipe_validation_error'>The recipe serving size must be greater than zero.</div>"),b=!1);0<!e.val().length&&(e.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a serving size description.</div>"),b=!1);a||0!=this.model.get("food").attributes.ingredients.length||($(".ingredients_header").after("<div class='alert alert-danger recipe_validation_error'>The recipe needs at least one ingredient.</div>"),
b=!1);return b},scrapeFields:function(){var a=$("#recipe-title",this.el).val().trim(),b=$("#recipe-description",this.el).val().trim(),c=$("#serving-size-input",this.el).val().trim(),d=$("#serving-description",this.el).val().trim(),e=this.model.get("food");e.attributes.food_name=a;e.attributes.description=b;e.attributes.weights[1].amount=this.parseServingSize(c);e.attributes.weights[1].description=d;return e},saveRecipe:function(){var a=this;if($(".enter_ingredients_text",this.el).hasClass("as_drag"))return $(".ingredients_container",
this.el).after('<div class="alert alert-danger recipe_finishing_entering_ingredients_error recipe_validation_error">Please finish verifying the matched ingredients or hit cancel.'),!1;if(!this.validate())return!1;var b=this.form.commit({validate:!0}),c=this.scrapeFields();if("undefined"===typeof b){a.imported_recipe_url&&ETM.analytics.logImportedRecipeSave(a.imported_recipe_url);var d=0;c.get("ingredients").each(function(a){a.attributes.order=d;d++});d=0;c.get("directions").each(function(b){b.attributes.order=
d;b.attributes.text=$(".directions_text textarea",a.el).eq(d).val().replace(/</g,"").replace(/>/g,"");0===b.attributes.text.length&&(b.attributes.text="");d++});$(".recipe_save_spinner",this.el).show();$(".save_recipe",this.el).prop("disabled",!0);c.save({},{success:function(b,c,d){a.imagesToSave&&0<a.imagesToSave.length?_.each(a.imagesToSave,function(c){c.save({food_id:b.attributes.id},{async:!1,success:function(){b.attributes.images.add(a.imageObject)}})}):a.imageObject&&a.imageObject.save({food_id:b.attributes.id},
{async:!1,success:function(){b.attributes.images.add(a.imageObject)}});b.attributes.ingredients.models.forEach(function(a){a.attributes.original_recipe_amount=a.attributes.amount});c=ROOT+"/food/"+b.get("id")+"/";b.id=c;b.set("resource_uri",c);b.url=function(){return ROOT+"/food/"+b.get("id")+"/"};a.editing_old_recipe=!1;a.editing_from_sidebar=!1;a.original_food_object&&(_.has(a.original_food_object.attributes.food,"tooltip_ingredients")&&(delete a.original_food_object.attributes.food.tooltip_ingredients,
delete all_ingredients[b.get("id")]),a.original_food_object.trigger("removeFoodObjectListeners"),a.original_food_object.stopListening(a.original_food_object.get("food")),_.has(a.original_food_object.attributes,"meal")?a.original_food_object.save({food:b}):a.original_food_object.set({food:b}),a.original_food_object.calculateStats(),a.original_food_object.initializeEvents(),a.original_food_object.get("food").trigger("change"));ETM.search_model.updateFoodInfo(b);ETM.reload_food_pool=!0;var e=null;a.original_food_object&&
(e=a.original_food_object.clone());Helper.hideAllTooltips();a.$el.one("hidden.bs.modal",function(){e&&_.has(e.attributes,"meal")&&ETM.food_object_modal.loadFood(e)}).modal("hide")},error:function(b,c,d){$(".recipe_save_spinner",a.el).hide();$(".save_recipe",a.el).prop("disabled",!1);$(".modal-footer").append('<div class="alert alert-danger recipe_validation_error" style="float:left">Failed to save recipe.</div>')}})}else for(var e in b)b.hasOwnProperty(e)&&$('[data-editors="'+e+'"]').append('<div class="alert alert-danger recipe_validation_error" style="float:left">'+
b[e].message+"</div>")},enterTextIngredients:function(a){a=a||!1;this.search_view.hideAllResults();if($(".enter_ingredients_text",this.el).hasClass("as_text"))if($(".enter_ingredients_text",this.el).switchClass("as_text","as_drag"),$(".enter_ingredients_text",this.el).html('<i class="fa fa-arrow-left" aria-hidden="true"></i> Cancel ingredient matching'),$(".ingredients_list",this.el).hide(),$(".ingredients_box",this.el).hide(),$(".recipe_stats_div",this.el).hide(),$(".enter_ingredients_text_div",
this.el).show(),a)$(".ingredients_text_input_row",this.el).hide();else{$(".ingredients_text_input_row",this.el).show();$(".enter_ingredients_textbox",this.el).val("");var b="";this.model.get("food").get("ingredients").each(function(a){b+=a.getStaticAmount()+" "+a.getStaticUnits()+" "+a.attributes.food.attributes.description+" "+a.attributes.food.attributes.food_name+"\n"});$(".enter_ingredients_textbox",this.el).val(b)}else $(".enter_ingredients_text",this.el).switchClass("as_drag","as_text"),$(".enter_ingredients_text",
this.el).html('<i class="fa fa-pencil-square-o" aria-hidden="true"></i> Enter ingredients as text'),$(".enter_ingredients_text_div",this.el).hide(),$(".ingredients_list",this.el).show(),$(".ingredients_box",this.el).show(),$(".recipe_stats_div",this.el).show()},showNormalIngredients:function(){$(".enter_ingredients_text",this.el).switchClass("as_drag","as_text");$(".enter_ingredients_text",this.el).html('<i class="fa fa-pencil-square-o" aria-hidden="true"></i> Enter ingredients as text');$(".enter_ingredients_text_div",
this.el).hide();$(".ingredients_list",this.el).show();$(".ingredients_box",this.el).show();$(".recipe_stats_div",this.el).show()},toggleTextInput:function(a){"show"===a||$(".ingredients_text_input_row",this).is(":visible")},parseTextIngredients:function(a,b){var c=this;this.currently_parsing||(this.currently_parsing=!0,$(".parse_spinner",this.el).show(),$(".enter_ingredients_textbox",this.el).prop("disabled",!0),$(".parse_ingredients_text",this.el).prop("disabled",!0),$.ajax({url:"/recipe/parse-ingredients/",
data:{ingredients:a},type:"POST",success:function(a){c.currently_parsing=!1;$(".enter_ingredients_textbox",c.el).prop("disabled",!1);$(".parse_ingredients_text",c.el).prop("disabled",!1);$(".parse_spinner",c.el).hide();$(".accept_parse_buttons",c.el).show();c.parseResults=JSON.parse(a);add_food_info_objects(c.parseResults.info_objs);c.renderParseResults(c.parseResults);"undefined"!==typeof b&&b()},error:function(a,e,f){console.log(e);$(".enter_ingredients_textbox",c.el).prop("disabled",!1);$(".parse_ingredients_text",
c.el).prop("disabled",!1);$(".parse_spinner",c.el).hide();c.currently_parsing=!1;c.showNormalIngredients();"undefined"!==typeof b&&b()}}))},renderParseResults:function(a){this.parsed_results=new ETM.ParseIngredientsListView({results:a});$(".parse_results_div",this.el).html(this.parsed_results.render().el)},confirmTextIngredients:function(){var a=[],b=[];this.parsed_results.ingredients_views.forEach(function(c){c=c.ingredients_list_view;if(0<$(".diet_draggable",c.$el).filter(":visible").length){var d=
c.getSelectedModel();d&&(a.push(d),b.push({original_string:c.original_unit_string,unit_database_column:d.attributes.units,unit_amount:d.attributes.amount,food_id:d.attributes.food.attributes.id,notes:d.attributes.preparation}))}});$.ajax({url:"/save_user_fixed_matches/",data:JSON.stringify(b),contentType:ETM.CONTENT_TYPES.JSON,type:"POST"});this.parseListViews=[];$(".parse_results",this.el).html("");$(".accept_parse_buttons",this.el).hide();this.showNormalIngredients();this.model.get("food").get("ingredients").reset(a);
this.model.get("food").get("ingredients").each(function(a){a.calculateStats()});this.calculateStats();this.printRecipeStats();this.printGraph()},cancelTextIngredients:function(){$(".recipe_finishing_entering_ingredients_error").remove();self.showNormalIngredients()},addDirection:function(){this.directions_list_view.collection.add(new ETM.Direction)},calculateStats:function(){self=this;self.stats=new ETM.NutritionStatsObject;ETM.NUTRIENT_LIST.forEach(function(a){self.stats[a]=0});this.model.get("food").get("ingredients").each(function(a){ETM.NUTRIENT_LIST.forEach(function(b){self.stats[b]+=
a.stats[b]})})},printRecipeStats:function(){var a=getStatsHTMLFromTemplate(this.stats);$("#modal_day_stats .stats_output",this.el).html(a)},printGraph:function(){var a=4*this.stats.getPrimaryCarbs()+4*this.stats.proteins+9*this.stats.fats,b=$("#modal_cumulative_graph",this.el);if(0>=a)b.html("");else{var c=roundNumber(100*(4*this.stats.getPrimaryCarbs()/a),2),d=roundNumber(100*(9*this.stats.fats/a),2),a=roundNumber(100*(4*this.stats.proteins/a),2),c=[{label:"Carbs",data:c,color:"#FCB524"},{label:"Protein",
data:a,color:"#976fe8"},{label:"Fat",data:d,color:"#52C0BC"}];try{$.plot(b,c,{series:{pie:{startAngle:0,show:!0,radius:1,label:{show:!0,radius:0.5,formatter:function(a,b){return'<div style="font-size:7pt;text-align:center;padding:2px;color:white;">'+a+"<br/>"+Math.round(b.percent)+"%</div>"},threshold:0.1}}},legend:{show:!1}})}catch(e){}}},importRecipeFromUrl:function(a){var b=this;a.preventDefault();var c=$("#recipe_url",this.el).val(),d=$(".import_recipe_btn",this.el).ladda();d.ladda("start");$.ajax({url:"/recipe/import_recipe_url/",
data:{recipe_url:c},method:"POST",success:function(a){d.ladda("stop");ETM.analytics.logRecipeImport(c);b.imported_recipe_url=c;b.updateRecipeStatsFromUrl(JSON.parse(a))},error:function(){d.ladda("stop");console.log("error importing recipe from url: "+c);b.updateRecipeStatsFromUrl()}})},extensionUrlImport:function(a){var b=this;a.from&&"ETM_CHROME_EXT"===a.from&&"recipeData"===a.action&&(null==a.url||null==a.html?a.retry?(document.dispatchEvent(new CustomEvent("etmExtFailed")),document.dispatchEvent(new CustomEvent("ETM_ext_disconnect"))):
document.dispatchEvent(new CustomEvent("etmExtResendRecipeData")):$.ajax({url:"/recipe/import_recipe_url/",data:{recipe_url:a.url,recipe_html:a.html},method:"POST",success:function(c){document.dispatchEvent(new CustomEvent("etmExtRecipeClipped"));ETM.analytics.logRecipeImport(a.url);b.imported_recipe_url=a.url;b.updateRecipeStatsFromUrl(JSON.parse(c))},error:function(){document.dispatchEvent(new CustomEvent("etmExtFailed"));document.dispatchEvent(new CustomEvent("ETM_ext_disconnect"))}}))},updateRecipeStatsFromUrl:function(a){var b=
!1;this.model.attributes.food.attributes.imported?this.clearImportedData():this.model.attributes.food.attributes.imported=!0;if((this.prev_import_data=a)&&a.url_valid){this.model.attributes.food.attributes.source_url=a.source_url;b=this.fillRecipeSettings(a.settings)||b;b=this.fillServings(a.servings)||b;this.addMetaTags(a.other);this.renderForm();var c=this.addDirections(a.directions,a.author),b=c||b,d=this.addIngredients(a.ingredients),b=d||b,b=!this.validate(!0)||b;this.printImportStatus(b);this.showFormErrors(a,
c,d)}else this.renderForm(),$(".image_upload_group",this.el).before("<div class='col-sm-8 offset-sm-2 alert alert-danger import_status'>Uh oh. It looks like we weren't able to import information for that url. We're not able to import every recipe unfortunately. Please check the url and try again. We're sorry!</div>")},fillServings:function(a){var b=!1;null!=a.amount?this.model.attributes.food.attributes.number_servings=a.amount:(this.model.attributes.food.attributes.number_servings="",this.model.attributes.food.attributes.weights[1].amount=
"",b=!0);null!=a.units?this.model.attributes.food.attributes.weights[1].description=a.units:(this.model.attributes.food.attributes.weights[1].description="",b=!0);return b},fillRecipeSettings:function(a){var b=!1,c;for(c in a){var d=a[c];if(""==d||null==d)b=!0;this.model.attributes.food.attributes[c]=d}return b},addMetaTags:function(a){var b="",c;for(c in a){var d=a[c];""!=d&&null!=d&&(b+=d+", ")}this.model.attributes.food.attributes.meta_tags=b},addDirections:function(a,b){for(var c=!1,d=0;d<a.length;d++)new_direction=
new ETM.Direction,new_direction.attributes.text=a[d],this.directions_list_view.collection.add(new_direction);0<a.length?this.directions_list_view.render():c=!0;d="";b&&(d+="Recipe by: "+b);d+=" (source: "+this.model.attributes.food.attributes.source_url+")";source_direction=new ETM.Direction;source_direction.attributes.text=d;this.directions_list_view.collection.add(source_direction);return c},addIngredients:function(a){for(var b="",c=!1,d=this,e=0;e<a.length;e++)b+=a[e]+"\n";""!=b?(d.enterTextIngredients(!0),
$(".enter_ingredients_textbox",this.el).val(b),$(".results_spinner_div",this.el).show(),d.parseTextIngredients(b,function(){$(".results_spinner_div",d.el).hide()})):c=!0;return c},printImportStatus:function(a){var b=$(".image_upload_group",this.el);a?b.before("<div class='col-sm-8 offset-sm-2 alert alert-warning import_status'>It looks like one or more of the fields weren't able to be imported. Please scroll through, fill in any incorrect blanks, and make sure the chosen ingredients are correct.</div>"):
b.before("<div class='col-sm-8 offset-sm-2 alert alert-info import_status'>Import complete. Please scroll down, fill in any incorrect blanks, and choose the correct parsed ingredient(s) below :)</div>")},printImportWarning:function(a,b,c){a=$(a);"after"==b?a.after(c):"before"==b&&a.before(c)},clearImportedData:function(){this.enterTextIngredients();this.cancelTextIngredients();this.ingredients_list_view.collection.reset();this.directions_list_view.collection.reset();if(this.prev_import_data)for(var a in this.prev_import_data.settings)delete this.model.attributes.food.attributes[a];
delete this.model.attributes.food.attributes.meta_tags;this.model.attributes.food.attributes.number_servings=1;this.model.attributes.food.attributes.weights[1].description="servings";this.model.attributes.food.attributes.weights[1].amount=1;$(".recipe_validation_error").detach();$(".import_status").detach();this.removeFormUiValidation()},showFormErrors:function(a,b,c){for(var d in a.settings){var e=a.settings[d],f=$(".form-group."+d);""!=e&&null!=e?f.addClass("has-success"):f.addClass("has-error")}$(".form-group.non-import").addClass("has-warning");
d=$(".form-group.number_servings");null!=a.servings.amount?d.addClass("has-success"):d.addClass("has-error");d=$(".form-group.serving_size");null!=a.servings.units?d.addClass("has-success"):d.addClass("has-error");b&&self.printImportWarning(".recipe_directions_list","before","<div style='padding-top: 20px;' class='row'><div class='col-sm-6 offset-sm-3 alert alert-warning recipe_validation_error'>Something went wrong importing directions. Please re-enter any missing directions.</div></div>");c&&self.printImportWarning(".ingredients_header",
"before","<div style='padding-top: 20px;' class='row'><div class='col-sm-6 offset-sm-3 alert alert-warning recipe_validation_error'>Something went wrong importing ingredients. Please re-enter ingredients.</div></div>")},removeFormUiValidation:function(){$(".form-group.import_group").removeClass("has-error has-warning has-success")},validateInputUI:function(a){var b=$(a.target);a=b.val();b=b.closest(".form-group");if(b.hasClass("has-warning")||b.hasClass("has-error")){if(b.hasClass("serving_size")){var c=
!0;$("input",b).each(function(){""==this.value&&(c=!1)});c&&(b.removeClass("has-warning has-error"),b.addClass("has-success"))}else""!=a&&(b.removeClass("has-warning has-error"),b.addClass("has-success"));""!=$("#num-servings-input input").val()&&""!=$("#serving-size-input").val()&&""!=$("#serving-description").val()&&$(".recipe_validation_error",".form-group.serving_size").detach()}}});
ETM.RecipeEditorView=ETM.RecipeEditorModalView.extend({modal_id:"recipe_editor_modal",id:"recipe_editor",className:"div",render:function(){this.template=ETM.loadTemplate("#RecipeEditorModalView");this.$el.html(this.template({model:this.model,image:this.model.attributes.food.getDisplayImage(),user_id:null,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff}));$(".modal-content",this.el).unwrap(".modal-dialog");$(".modal-header",this.el).unwrap(".modal-content");this.ingredients_list_view=
new ETM.IngredientListView({collection:this.model.get("food").get("ingredients"),el:$(".ingredients_list",this.el)});this.ingredients_list_view.render();this.setIngredientScale(this.model.get("food").get("number_servings"));this.directions_list_view=new ETM.DirectionsListView({collection:this.model.get("food").get("directions"),el:$(".directions_list",this.el)});this.directions_list_view.render();this.renderForm();this.resizeDirectionsFields();this.model.get("food").get("ingredients").each(function(a){a.calculateStats()});
this.calculateStats();this.printRecipeStats();this.renderIngredientsSearch();this.create_uploader_recipe_editor();this.addTooltips();return this},saveRecipe:function(){var a=this;if($(".enter_ingredients_text",this.el).hasClass("as_drag"))return $(".ingredients_container",this.el).after('<div style="margin-bottom:20px;" class="alert alert-danger recipe_finishing_entering_ingredients_error recipe_validation_error">Please finish entering your text ingredients or hit cancel.'),$(".recipe_directions_list",
this.el).after('<div style="margin-bottom:20px;" class="alert alert-danger recipe_finishing_entering_ingredients_error recipe_validation_error">Please scroll up and finish entering your text ingredients, or hit cancel.'),!1;if(!this.validate())return!1;var b=this.form.commit({validate:!0}),c=this.scrapeFields();if("undefined"===typeof b){a.imported_recipe_url&&ETM.analytics.logImportedRecipeSave(a.imported_recipe_url);var d=0;c.get("ingredients").each(function(a){a.attributes.order=d;d++});d=0;c.get("directions").each(function(b){b.attributes.order=
d;b.attributes.text=$(".directions_text textarea",a.el).eq(d).val().replace(/</g,"").replace(/>/g,"");0===b.attributes.text.length&&(b.attributes.text="");d++});$(".recipe_save_spinner",this.el).show();$(".save_recipe",this.el).prop("disabled",!0);c.save({},{success:function(b,c,d){a.imageObject?a.imageObject.save({food_id:b.attributes.id},{success:function(){a.model.attributes.food.attributes.images.add(a.imageObject);window.location.replace("/recipe/nutrition/"+b.attributes.slug)}}):window.location.replace("/recipe/nutrition/"+
b.attributes.slug)},error:function(b,d,e){Helper.clearIDs(c);$(".recipe_save_spinner",a.el).hide();$(".save_recipe",a.el).prop("disabled",!1);$(".modal-footer").append('<div class="alert alert-danger recipe_validation_error" style="float:left">Failed to save recipe.</div>');console.log("failed to save recipe :(")}})}else for(var e in b)b.hasOwnProperty(e)&&$('[data-editors="'+e+'"]').append('<div class="alert alert-danger recipe_validation_error" style="float:left">'+b[e].message+"</div>")}});
ETM.RecipeView=ETM.FoodObjectModalRecipeView.extend({id:"recipe_viewer",className:"div"});ETM.DirectionView=Backbone.View.extend({tagName:"tr",className:"table",events:{"click .delete_direction":"deleteDirection"},deleteDirection:function(){this.undelegateEvents();this.model.destroy();this.remove()},render:function(){this.$el.html(this.template(this.model));return this}});
ETM.DirectionsListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,sortable:!0,sortableOptions:{placeholder:"list_placeholder",axis:"y",tolerance:"pointer",handle:".drag_handle"},emptyListCaption:"<div class='empty_meal_box'>There are no directions in this recipe</div>",modelView:ETM.DirectionView});ETM.ReadOnlyDirectionView=Backbone.View.extend({tagName:"li",className:"row",render:function(){this.$el.html(this.template(this.model));return this}});
ETM.ReadOnlyDirectionsListView=Backbone.CollectionView.extend({selectable:!1,tagName:"ul",emptyListCaption:"<div class='empty_meal_box'>There are no directions in this recipe</div>",modelView:ETM.ReadOnlyDirectionView});
ETM.ReadOnlyIngredientObjectView=ETM.FoodObjectView.extend({events:function(){var a=_.extend({},ETM.FoodObjectView.prototype.events,{});delete a["click .food_image"];delete a["click .food_name .print_name"];delete a["click .food_name .print_name, .mobile_food_units"];return a},initialize:function(){this.tooltip_handler=new ETM.FoodTooltipHandler(this.model)},render:function(a){this.updateStaticAmountAndUnits();this.model.selector_html=this.selectorHTML();this.template=ETM.loadTemplate("#IngredientObjectView");
a=this.template(_.extend({},this.model,{read_only:!0,image:this.model.attributes.food.getDisplayImage()}));this.$el.html(a);this.applyTooltip();this.printGramReadout();return this},updateStaticAmountAndUnits:function(){this.model.updateStaticAmountAndUnitsWithConversion()},applyReadOnlyHoverEffects:function(){}});
ETM.IngredientListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,sortable:!0,sortableOptions:function(){return ETM.is_mobile?{handle:".draggable_handle",placeholder:"list_placeholder",axis:"y",tolerance:"pointer"}:{placeholder:"list_placeholder",axis:"y",tolerance:"pointer"}},emptyListCaption:"<div class='empty_meal_box'>Search for ingredients to add from above.</div>",modelView:ETM.IngredientObjectView});
ETM.ParsedIngredientCollectionView=Backbone.CollectionView.extend({tagName:"ul",selectable:!0,sortable:!0,sortableOptions:{placeholder:"list_placeholder",axis:"y",tolerance:"pointer"},emptyListCaption:"<div class='empty_meal_box' style='margin-left:35px;'>No ingredients found for this text. You can drag one in from the sidebar to use it</div>",modelView:ETM.IngredientObjectView});
ETM.ReadOnlyIngredientListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,emptyListCaption:"<div class='row'><div class='col-10 offset-2 empty_meal_box'>This recipe has no ingredients</div></div>",modelView:ETM.ReadOnlyIngredientObjectView});function auto_grow(a){a.style.height="5px";a.style.height=a.scrollHeight+"px"}function resizeAllDirections(){_.each($(".directions_text textarea").get(),function(a){auto_grow(a)})}
function getStatsHTMLFromTemplate(a){return ETM.loadTemplate("#FoodStatsTemplate")({stats:a})}
ETM.RecipeCuratorModalView=ETM.RecipeEditorModalView.extend({modal_id:"recipe_curator_modal",id:"recipe_curator_editor_modal",events:function(){return _.extend({},ETM.FoodObjectModalBasicView.prototype.events,{"click .personalize_recipe":"convertViewToEdit","click .add_direction":"addDirection","click .cancel_edits":"closeEditor","click .save_recipe_changes":"saveChanges","click .enter_ingredients_text":"enterTextIngredients","click .confirm_ingredients_text":"confirmTextIngredients","click .parse_ingredients_text":"parseTextIngredients",
"click .cancel_ingredients_text":"cancelTextIngredients","click .admin_edit":function(){this.adminEditRecipe("copy_for_edits")},"click .admin_curate_and_edit":function(){this.adminEditRecipe("copy_and_curate")},"change .modal_curate_recipe_radio":"changeRecipeCuration","click .enable_curation_radio":"enableCurationRadioButtons","change .admin_extra_tags_checkboxes input":"enableTagSaveButton","click .admin_save_recipe_tags":"saveRecipeTags"})},loadFoodChanges:function(a,b,c){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;
this.original_food_object=a;var d=a.clone();if(b||c)e=new ETM.FoodChanges(c.toJSON()),e.attributes.ingredients=new ETM.IngredientsList(JSON.parse(e.attributes.ingredients_changes)),e.attributes.directions=new ETM.DirectionsList(JSON.parse(e.attributes.directions_changes));else{var e=new ETM.FoodChanges(a.attributes.food.toJSON());e.addExtraFoodAttributesToChanges(a);var f=a.attributes.food.attributes.directions,g=[];a.attributes.food.attributes.ingredients.each(function(a){g.push(a.toJSON())});var h=
new ETM.IngredientsList(g),f=new ETM.DirectionsList(f.toJSON());e.attributes.ingredients=h;e.attributes.directions=f}e.attributes.ingredients.each(function(a){Helper.clearIDs(a)});e.attributes.directions.each(function(a){Helper.clearIDs(a)});e.attributes.food_id=a.attributes.food.attributes.id;b&&(ETM.current_user_profile.get("user_id")===e.attributes.user_id||is_superuser)?e.url=function(){return ROOT+"/foodchanges/"+c.get("id")+"/"}:(Helper.clearIDs(e),e.url=function(){return ROOT+"/foodchanges/"});
this.model=d;this.food_changes_obj=e},saveChanges:function(){var a=this;if(!this.validate())return console.log("failed to validate!"),!1;if($(".enter_ingredients_text",this.el).hasClass("as_drag"))return $(".ingredients_container",this.el).after('<div class="alert alert-danger recipe_finishing_entering_ingredients_error recipe_validation_error">Please finish entering your text ingredients or hit cancel.'),!1;var b=this.form.commit({validate:!0}),c=this.scrapeFields();if("undefined"===typeof b){var d=
0;c.get("ingredients").each(function(a){a.attributes.order=d;d++});d=0;c.get("directions").each(function(b){b.attributes.order=d;b.attributes.text=$(".directions_text textarea",a.el).eq(d).val().replace(/</g,"").replace(/>/g,"");0===b.attributes.text.length&&(b.attributes.text="");d++});c.attributes.ingredients_changes=JSON.stringify(c.attributes.ingredients.toJSON());c.attributes.directions_changes=JSON.stringify(c.attributes.directions.toJSON());this.checkIfIngredientsDirectionsChanged(c);$(".recipe_save_spinner",
this.el).show();$(".save_recipe",this.el).prop("disabled",!0);_.has(c.attributes,"reviewer")&&null!=c.attributes.reviewer||(c.attributes.reviewer=ETM.curator_view.curator_profile.id);c.save({},{success:function(b,c,d){a.original_food_object.attributes.food.fetch({success:function(){a.original_food_object.trigger("modalUpdated")}});a.$el.modal("hide")},error:function(b,c,d){$(".recipe_save_spinner",a.el).hide();$(".save_recipe",a.el).prop("disabled",!1);$(".modal-footer").append('<div class="alert alert-danger recipe_validation_error" style="float:left">Failed to save recipe.</div>')}})}else for(var e in b)b.hasOwnProperty(e)&&
$('[data-editors="'+e+'"]').append('<div class="alert alert-danger recipe_validation_error" style="float:left">'+b[e].message+"</div>")},checkIfIngredientsDirectionsChanged:function(a){var b=this.original_food_object.attributes.food.attributes.ingredients.clone(),c=this.original_food_object.attributes.food.attributes.directions.clone();b.each(function(a){Helper.clearIDs(a)});c.each(function(a){Helper.clearIDs(a)});b=JSON.stringify(b.toJSON());c=JSON.stringify(c.toJSON());a.attributes.has_ingredients_changes=
a.attributes.ingredients_changes!=b;a.attributes.has_directions_changes=a.attributes.directions_changes!=c},render:function(){this.$el.html(this.template({model:this.model,image:this.model.attributes.food.getDisplayImage(),user_id:null,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff}));this.$el.modal({backdrop:"static",keyboard:!1,show:!0});this.ingredients_list_view=new ETM.IngredientListView({collection:this.food_changes_obj.get("ingredients"),el:$(".ingredients_list",
this.el)});this.ingredients_list_view.render();this.setIngredientScale(this.model.get("food").get("number_servings"));this.directions_list_view=new ETM.DirectionsListView({collection:this.food_changes_obj.get("directions"),el:$(".directions_list",this.el)});this.directions_list_view.render();this.renderForm();this.resizeDirectionsFields();this.model.get("food").get("ingredients").each(function(a){a.calculateStats()});this.renderIngredientsSearch();this.calculateStats();this.printRecipeStats();this.create_uploader();
this.addTooltips();return this},renderForm:function(){this.form=(new Backbone.Form({model:this.food_changes_obj,template:Helper.createTemplateFunction($("#recipeChangesForm",this.el).html())})).render();$(".recipe_info_container",this.el).html(this.form.el);$("#recipe-title",this.el).val(this.food_changes_obj.attributes.food_name);$("#recipe-description",this.el).val(this.food_changes_obj.attributes.description);$("#serving-size-input",this.el).val(this.food_changes_obj.attributes.serving_size_amount);
$("#serving-description",this.el).val(this.food_changes_obj.attributes.serving_size_description);$(".review_complete",this.el).prop("checked",this.food_changes_obj.attributes.review_complete);this.setupMealTagTokenField()},validate:function(){$(".recipe_validation_error",this.el).remove();var a=!0,b=$("#recipe-title",this.el),c=$("#serving-size-input",this.el),d=$("#serving-description",this.el),e=$(".tokenfield",this.el);0<!b.val().length&&(b.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a title.</div>"),
a=!1);0<!c.val().length?(c.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a serving size.</div>"),a=!1):0>=parseInt(c.val())&&(c.after("<div class='alert alert-danger recipe_validation_error'>The recipe serving size must be greater than zero.</div>"),a=!1);0<$(".token.invalid").length&&(e.after("<div class='alert alert-danger recipe_validation_error'>Invalid meal tag entered.</div>"),a=!1);0<!d.val().length&&(d.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a serving size description.</div>"),
a=!1);0==this.model.get("food").attributes.ingredients.length&&($(".ingredients_header").after("<div class='alert alert-danger recipe_validation_error'>The recipe needs at least one ingredient.</div>"),a=!1);return a},scrapeFields:function(){var a=$("#recipe-title",this.el).val().trim(),b=$("#recipe-description",this.el).val().trim(),c=$("#serving-size-input",this.el).val().trim(),d=$("#serving-description",this.el).val().trim(),e=this.food_changes_obj;e.attributes.food_name=a;e.attributes.description=
b;e.attributes.serving_size_amount=parseInt(c);e.attributes.serving_size_description=d;e.attributes.review_complete=$(".review_complete",this.el).is(":checked");return e},setupMealTagTokenField:function(){var a=this;this.tokenfield_selector=$("#meal-tags",this.el);this.tokenfield_selector.tokenfield({autocomplete:{source:function(a,c){var d=$.ui.autocomplete.filter(ETM.meal_tag_list.pluck("tag_name"),a.term);c(d)},delay:100},showAutocompleteOnFocus:!0});a.loadMealTagTokens();this.tokenfield_selector.on("tokenfield:createtoken",
function(b){b.attrs.value=b.attrs.value.toLowerCase();b.attrs.label=b.attrs.value;$.each($(this).tokenfield("getTokens"),function(c,d){d.value===b.attrs.value&&($(".token-input",a.el).val(""),b.preventDefault())})});this.tokenfield_selector.on("tokenfield:createdtoken",function(b){var c=ETM.meal_tag_list.findWhere({tag_name:b.attrs.value});c?a.food_changes_obj.attributes.mapped_meal_tags.add(c):$(b.relatedTarget).addClass("invalid")});this.tokenfield_selector.on("tokenfield:removedtoken",function(b){(b=
a.food_changes_obj.attributes.mapped_meal_tags.findWhere({tag_name:b.attrs.value}))&&a.food_changes_obj.attributes.mapped_meal_tags.remove(b)})},loadMealTagTokens:function(){var a=this.food_changes_obj.attributes.mapped_meal_tags.pluck("tag_name");0<a.length&&this.tokenfield_selector.tokenfield("setTokens",a)}});
ETM.RecipeReportModalView=ETM.FoodReportModalView.extend({modal_id:"recipe_report_modal",renderForm:function(){this.form=(new Backbone.Form({schema:{preset_reasons:{type:"Select",validators:["required"],options:[{val:1,label:"Incorrect prep or cook time"},{val:2,label:"Incorrect serving size or number of servings"},{val:3,label:"Incorrect nutrition information"},{val:4,label:"Missing ingredients"},{val:5,label:"Incorrect ingredients or ingredient amounts"},{val:6,label:"Confusing ingredients or ingredient amounts"},
{val:7,label:"Missing directions"},{val:8,label:"Incorrect directions"},{val:9,label:"Confusing directions"},{val:10,label:"Bad picture"},{val:11,label:"Tasted bad :("},{val:0,label:"Other reason"}]},custom_reason:{type:"TextArea",editorAttrs:{maxlength:2048}}},template:Helper.createTemplateFunction($("#report_recipe_form",this.el).html())})).render();$("#report_recipe_form_container",this.el).html(this.form.el)}});
ETM.SavedRecipesView=Backbone.View.extend({initialize:function(){this.custom_foods=new ETM.CustomFoodList([],{url:ROOT+"/customfood/"});this.custom_recipes=new ETM.CustomFoodList([],{url:ROOT+"/customrecipe/"})},render:function(){this.$el.html(this.template({is_premium:ETM.is_premium,user:ETM.current_user_profile.attributes}));return this}});
ETM.SimilarRecipeObjectView=ETM.FoodObjectView.extend({className:"similar_recipe_object_view",render:function(a){a=this.template({model:this.model,image:this.model.attributes.food.getDisplayImage()});this.$el.html(a);this.applyTooltip();return this},initialize:function(){this.tooltip_handler=new ETM.FoodTooltipHandler(this.model)}});
ETM.SimilarRecipeListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,emptyListCaption:"<div class='col-6 offset-1'>This recipe has no similar recipes</div>",modelView:ETM.SimilarRecipeObjectView});
ETM.SimilarRecipesView=Backbone.View.extend({className:"similar_recipe_view",events:{"click .view_similar_recipe":"viewSimilarRecipe"},renderSimilarRecipes:function(a){var b=this;b.similarRecipeViews=[];var c=$('<ul class="similar_recipes_list col-8 offset-1"/>');b.recipe_list=new ETM.SimilarRecipeList;a.forEach(function(a){a=new ETM.FoodInfoObject(a);b.recipe_list.food_info_object_list.add(a);a=new ETM.FoodObject({food:a,amount:1,units:a.attributes.default_units});b.recipe_list.add(a,{silent:!0});
new ETM.SimilarRecipeObjectView({model:a})});a=new ETM.SimilarRecipeListView({collection:b.recipe_list,el:c});a.render();b.similarRecipeViews.push(a);b.similar_recipes_element.append($('<div class="similar_recipes row"></hr></div>').append(c))},searchRecipes:function(a){var b=this;this.currently_searching||(this.currently_searching=!0,$.ajax({url:"/food/get_similar_recipes/",data:{ingredients:JSON.stringify(this.ingredients),name_string:this.name_string,original_recipe_id:this.original_recipe_id},
type:"POST",success:function(c){b.currently_searching=!1;b.renderSimilarRecipes(JSON.parse(c));a(b.original_recipe_id)},error:function(c,d,e){console.log(d);b.currently_searching=!1;a()}}))},initialize:function(a,b){"undefined"!==typeof b&&(this.list_type="undefined"!=typeof b.list_type?b.list_type:"generic",this.ingredients=b.ingredients,this.name_string=b.name,this.original_recipe_id=b.recipe_id,this.similar_recipes_element=b.element)}});
ETM.RecurringFoodModalView=ModalView.extend({modal_id:"recurring_food_modal",events:{"click #add_recurring_food_button":"addRecurringFood","change #recurring_food_meal_type select":"renderMealRecurringFoods","click .recurring_list_item_delete":"deleteRecurringFood","change .recurring_select":"changeFrequency","change .modal_recurring_select":"changeFrequency"},initialize:function(a){this.current_meal_type=null;a.meal_type_id?this.current_meal_type=ETM.meal_type_list.get(a.meal_type_id):null!=this.model&&
null!=this.model.parent&&(this.current_meal_type=ETM.meal_type_list.get(this.model.parent.attributes.meal_type.attributes.resource_uri));this.current_meal_type||(this.current_meal_type=ETM.meal_type_list.at(0));this.listenTo(this.model,"modalUpdated",function(){this.render();this.updateTooltip();this.$el.tooltip("hide")},this);this.listenTo(this.model,"modelDeleted",function(){this.remove()},this);this.listenTo(this.model,"imageUpdated",function(a){this.model.get("food").attributes.images.add(a);
this.render()},this)},render:function(){this.$el.html(this.template({attributes:this.model.attributes,logged_in:ETM.is_logged_in}));ETM.is_logged_in&&(this.renderForm(),this.renderRecurringIn(),this.renderMealRecurringFoods());return this},renderForm:function(){this.recurring_food=new ETM.RecurringFood({food:this.model.attributes.food,meal_type:this.current_meal_type.id,units:this.model.attributes.units,amount:this.model.attributes.amount});var a=[];this.recurring_food.attributes.food.attributes.weights.forEach(function(b,
c){a.push({val:c,label:b.description})});this.form=(new Backbone.Form({schema:{meal_type:{type:"Select",validators:["required"],options:ETM.meal_type_list.getMealTypeNameAndIds()},frequency:{type:"SegmentedRadio",validators:["required"],options:[{val:0,label:"Often"},{val:1,label:"Always"}]},amount:{type:"PositiveNumber"},units:{type:"Select",value_type:"Number",validators:["required"],options:a}},model:this.recurring_food,template:Helper.createTemplateFunction($("#addRecurringFormTemplate",this.el).html())})).render();
this.form.setValue({amount:roundNumber(this.recurring_food.attributes.amount*this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].amount,2)});this.listenTo(this.form,"amount:change",function(a,c){var d=c.getValue()/this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].amount;this.recurring_food.set({amount:d})},this);this.listenTo(this.form,"units:change",function(a,c){var d=c.getValue();this.recurring_food.set({amount:this.recurring_food.attributes.amount*
this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].grams/this.recurring_food.attributes.food.attributes.weights[d].grams,units:d});this.form.setValue({units:this.recurring_food.attributes.units,amount:roundNumber(this.recurring_food.attributes.amount*this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].amount,2)})},this);this.list_item_template=ETM.loadNestedTemplate("#RecurringFoodTemplates","#recurringFoodListModalItemTemplate");
this.empty_food_template=ETM.loadNestedTemplate("#RecurringFoodTemplates","#recurringFoodEmptyTemplate");$("#add_recurring_form",this.el).html(this.form.el)},renderRecurringIn:function(){var a=this,b="";ETM.recurring_foods_list.where({food:this.model.attributes.food}).forEach(function(c){var d=ETM.meal_type_list.get(c.attributes.meal_type);b+=a.list_item_template({title:d.attributes.title,frequency:ETM.RecurringFood.frequency_types[c.attributes.frequency],id:c.id})});b||(b=this.empty_food_template());
$("#recurring_in",this.el).html(b);this.showDeleteOnHover($(".recurring_list_item",this.el),".recurring_list_item_delete")},renderMealRecurringFoods:function(){var a=this,b=this.form.getValue().meal_type,c=ETM.meal_type_list.get(b);"undefined"==typeof c?bugsnagClient.notify(Error("No meal type id render meal recurring foods."),{metaData:{meal_type_id:b}}):($("#meal_recurring_foods_header",this.el).text("Recurring foods for "+c.attributes.title+":"),$("#meal_recurring_foods",this.el).html(""),b=ETM.recurring_foods_list.where({meal_type:b}),
b.forEach(function(b){b=new ETM.RecurringFoodObjectView({model:b});a.listenTo(b.model,"destroy",function(b){ETM.recurring_foods_list.remove(b);a.renderRecurringIn();a.renderMealRecurringFoods()});$("#meal_recurring_foods",a.el).append(b.render().el)}),0==b.length&&$("#meal_recurring_foods",this.el).html(this.empty_food_template()),this.showDeleteOnHover($(".recurring_list_item",this.el),".recurring_list_item_delete"))},showDeleteOnHover:function(a,b){a.hover(function(){$(this).find(b).show()},function(){$(this).find(b).hide()})},
changeFrequency:function(a){var b=$(a.currentTarget);a=b.val();var b=b.data("id"),c=$('select[data-id="'+b+'"]',this.el);c.val(a);"always"===a?(c.removeClass("badge-info"),c.addClass("badge-primary")):(c.removeClass("badge-primary"),c.addClass("badge-info"));ETM.recurring_foods_list.get(b).save({frequency:ETM.RecurringFood.frequency_types.indexOf(a)},{patch:!0})},deleteRecurringFood:function(a){a.preventDefault();ETM.recurring_foods_list.get($(a.currentTarget).data("id")).destroy();this.renderRecurringIn();
this.renderMealRecurringFoods()},addRecurringFood:function(a){a.preventDefault();a=this.form.commit({validate:!0});if("undefined"===typeof a)this.recurring_food.set({amount:this.recurring_food.attributes.amount/this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].amount}),this.recurring_food.save(null,{async:!1}),ETM.recurring_foods_list.add(this.recurring_food),this.current_meal_type=ETM.meal_type_list.get(this.recurring_food.attributes.meal_type),ETM.recurring_foods_list.trigger("rerender",
this.recurring_food.attributes.meal_type),this.renderForm(),this.renderRecurringIn(),this.renderMealRecurringFoods();else for(var b in a)$('[data-editors="'+b+'"]').append('<div class="alert alert-danger" style="float:left">'+a[b].message+"</div>")}});
ETM.RecurringFoodObjectView=ETM.FoodObjectView.extend({tagName:"li",className:"align-items-center static_recurring_food",events:function(){return _.extend({},ETM.FoodObjectView.prototype.events,{"click .food_image":function(){},"click .food_name .print_name, .mobile_food_units":function(){},"change .recurring_select":"changeFrequency"})},initialize:function(){this.tooltip_handler=new ETM.FoodTooltipHandler(this.model);this.listenTo(this.model,"change:frequency",this.toggleUnitsText,this);this.listenTo(this.model,
"recurring_food_saved",this.render,this);this.listenTo(this.model.attributes.food,"imageUpdated",this.render,this)},render:function(){this.updateStaticAmountAndUnits();this.model.selector_html=this.selectorHTML();this.model.combineFoodInfoPointers();var a=ETM.food_info_object_list.get(this.model.attributes.food),a=this.template({food_name:a.attributes.food_name,frequency:ETM.RecurringFood.frequency_types[this.model.attributes.frequency],food:a,image:a.getDisplayImage(),model:this.model});this.$el.html(a);
this.toggleUnitsText();this.applyTooltip();this.printGramReadout();this.resizeAmountInput();return this},changeFrequency:function(a){a=$(a.currentTarget);var b=a.val();"always"===b?(a.removeClass("badge-info"),a.addClass("badge-primary")):(a.removeClass("badge-primary"),a.addClass("badge-info"));this.model.save({frequency:ETM.RecurringFood.frequency_types.indexOf(b)},{patch:!0})},toggleUnitsText:function(){0==this.model.attributes.frequency?($(".often_frequency_units",this.el).show(),$(".always_frequency_units",
this.el).hide()):($(".often_frequency_units",this.el).hide(),$(".always_frequency_units",this.el).show())}});ETM.DraggableRecurringFoodObjectView=ETM.RecurringFoodObjectView.extend({tagName:"li",className:"diet_draggable align-items-center row",events:function(){this.use_static_modal=!0;return _.extend({},ETM.FoodObjectView.prototype.events,{"click .add-food-list-item":"addFoodToList","click .add-food-meal-item":"addFoodToMeal","click .add-food-collection-item":"addFoodToCollection","change .recurring_select":"changeFrequency"})}});
ETM.RecurringFoodListView=Backbone.CollectionView.extend({sortable:!0,selectable:!1,sortableOptions:function(){return ETM.is_mobile?{handle:".recurring_draggable_handle",connectWith:".meal_type_recurring_foods",placeholder:"recurring_list_placeholder",axis:"y",tolerance:"pointer"}:{connectWith:".meal_type_recurring_foods",placeholder:"recurring_list_placeholder",axis:"y",tolerance:"pointer"}},emptyListCaption:"<div class='small_top_spacer small_bottom_spacer text-small'>There are no recurring foods in this meal.<br/>Use the <strong>Search Foods</strong> button in the main menu and drag in your favorites.</div>",
modelView:ETM.DraggableRecurringFoodObjectView});
ETM.RecurringFoodsMealTypeView=Backbone.View.extend({events:{"click .add_collection_to_recur":"openAddRecurringCollectionModal"},initialize:function(a){this.inline_search=a&&a.inline_search?a.inline_search:!1;this.listenTo(ETM.recurring_collections_list,"rerender",function(a){a===this.model.attributes.resource_uri&&this.render()})},openAddRecurringCollectionModal:function(){ETM.add_recurring_collection_modal&&ETM.add_recurring_collection_modal.close();ETM.add_recurring_collection_modal=new ETM.AddRecurringCollectionModalView({meal_type:this.model});
ETM.add_recurring_collection_modal.getModalElement().html(ETM.add_recurring_collection_modal.render().el);ETM.add_recurring_collection_modal.delegateEvents();ETM.add_recurring_collection_modal.$el.modal("show");googleanalytics("send","event","button","click","add_collection_modal");amplitude.logEvent("add_collection_modal")},render:function(){var a=this,b=ETM.recurring_foods_list.where({meal_type:this.model.id});this.$el.html(this.template({meal_type:this.model.attributes.title}));var c=ETM.recurring_collections_list.where({meal_type:this.model.id}),
d=(new Backbone.Form({model:this.model,schema:{only_use_recurring:{type:"AnimatedCheckbox",value_type:"boolean",validators:[],options:[{val:!0,label:"Only use recurring foods for this meal"}]}},template:ETM.loadNestedTemplate("#RecurringFoodTemplates","#onlyUseRecurringFormTemplate"),templateData:{model:this.model}})).render();a.listenTo(d,"only_use_recurring:change",function(a,b,c){a.model.save({only_use_recurring:a.getValue().only_use_recurring},{patch:!0})});$(".onlyUseRecurringForm",this.el).html(d.el);
ETM.search_model||(ETM.search_model=new ETM.SearchBar);var e=new ETM.RecurringFoodList(b);e.meal_type=this.model.id;b=new ETM.RecurringFoodCollectionList(c);b.meal_type=this.model.id;this.food_list;this.inline_search?(this.search_view=new ETM.SearchBarView({model:new ETM.SearchBar,in_modal:!0,ingredients_only:!1,container:this.$el,meal_type_id:this.model.id,placement:"right"}),$(".recurring_foods_search",this.el).html(this.search_view.render().el),this.food_list=new ETM.RecurringFoodListView({collection:e,
el:$(".meal_type_recurring_foods",this.el),emptyListCaption:"<div class='small_top_spacer small_bottom_spacer text-small'>There are no recurring foods in this meal.</div>"})):this.food_list=new ETM.RecurringFoodListView({collection:e,el:$(".meal_type_recurring_foods",this.el)});this.food_list.render();0<b.length?(new ETM.RecurringCollectionListView({collection:b,el:$(".meal_type_recurring_collections",this.el)})).render():($(".recurring_collection_header",this.el).hide(),$(".recurring_collections_container",
this.el).hide());a.listenTo(ETM.recurring_foods_list,"add",function(b){b.attributes.meal_type===a.model.id&&e.add(b)});a.listenTo(this.food_list.collection,"dragError",function(b){var c="Error(s) adding recurring food: ",d;for(d in b)b.hasOwnProperty(d)&&(c+=b[d].message+".  ");a.$el.append('<div class="alert alert-danger recurring_drag_error col-11 offset-1">'+c+"<div/>");setTimeout(function(){$(".recurring_drag_error",a.el).fadeOut("normal",function(){$(a).remove()})},5E3)},this.food_list);return this}});
ETM.RecurringFoodSettingsView=Backbone.View.extend({events:{},initialize:function(a){this.inline_search=a&&a.inline_search?a.inline_search:!1;this.recurring_foods_meal_views=[]},render:function(){Helper.lockPageHeight();this.$el.html(this.template({inline_search:this.inline_search,using_v2_alg:ETM.current_user_profile.v2AlgorithmEnabled()}));this.renderRecurringFoods();this.applyTipsTooltip();Helper.unlockPageHeight();return this},onClose:function(){},applyTipsTooltip:function(){$(".recurring_foods_tips",
this.el).popover({title:"<strong>Using Recurring Foods</strong>",content:'<ul class="grocery_tips"><li><strong>Want total control over the foods that the planner uses?</strong> Drag 15-20 foods that you like into a meal (all set to "often"), and check "Only use recurring foods for this meal". The more foods you add, the better the variety will be. </li><li>If you want different foods to recur on different days of the week, create a new meal type for that day in the "Weekly planner layout" page of your settings, or directly in the planner by clicking the meal\'s name. </li><li><strong>Add foods that you already typically eat to make a plan much easier to start following.</strong> Make breakfast and lunch match your typical day, and then leave dinner a surprise. The added redundancy will dramatically shorten your grocery list. </li></ul>',
trigger:"hover",placement:"left",html:!0})},renderRecurringFoods:function(){var a=this;$(".recurring_foods",this.el).html("");ETM.meal_type_list.where({deleted:!1}).forEach(function(b){b=new ETM.RecurringFoodsMealTypeView({model:b,inline_search:a.inline_search});$(".recurring_foods",a.el).append(b.render().el);a.recurring_foods_meal_views.push(b)})}});ETM.plan_to_walkthrough=null;ETM.free_walkthrough=null;ETM.premium_walkthrough=null;
ETM.start_free_walkthrough=function(){ETM.start_walkthrough_on_homepage(function(){null!==ETM.free_walkthrough&&(ETM.free_walkthrough=null);ETM.free_walkthrough=new Shepherd.Tour({defaults:{classes:"shepherd-theme-arrows step_md",scrollTo:!1,showCancelLink:!0,when:{show:function(){var a=this.getAttachTo().element;a&&$("html,body").animate({scrollTop:$(a).offset().top-($(window).height()-$(a).outerHeight(!0))/2},200)}}}});ETM.free_walkthrough.addStep("1",{text:"This is a quick overview of the generator's main functions.",
attachTo:{element:$(".day_header",ETM.plan_to_walkthrough.el)[0],on:"top"}});var a=".day_refresh_button right";ETM.is_logged_in&&(a={element:$(".day_refresh_button",ETM.plan_to_walkthrough.el)[0],on:"right"},ETM.free_walkthrough.addStep("2-loggedin",{title:"Editing your meal layout",text:'<p>If you want to change your meal layout, or edit your Nutrition Profile, you can do so by clicking this <strong><i class="fa fa-pencil"></i>Layout</strong> button, or going to the Preferences section.</p>',attachTo:".open_weekly_layout left"}).addStep("3-loggedin",
{title:"Navigating your plans",text:"Use these arrows, <strong>or your keyboard's arrow keys</strong>, to navigate between the meal plans in your calendar.",attachTo:".next_plan_button bottom"}));ETM.free_walkthrough.addStep("2",{text:'<p>Click the refresh button <svg class="etm-icon etm-icon-xs"><use xlink:href="#icon-refresh3"></use></svg> to generate a new plan.</p><p>There are also refresh buttons on each meal and food to regenerate specific parts of your plan.</p>',attachTo:a}).addStep("3",{title:"This is a Meal in your plan",
text:'<p>Meals have their own options that you can customize by clicking this 3-dot menu, and then <i class="fa fa-gear" aria-hidden="true"></i> Edit Meal Settings</p><p>Meals can have custom cook times, sizes, family members, and more.</p>',attachTo:{element:$(".meal_title",ETM.plan_to_walkthrough.el)[0],on:"bottom"}}).addStep("4",{title:"This is a food in your plan",text:"<p>Hover your mouse over it (or tap once on a touchscreen) to see more details, and change the serving amount or units.</p><p>Click the food's picture or name to open a popup with even more info, like recipe directions.</p>",
attachTo:{element:$(".diet_draggable",ETM.plan_to_walkthrough.el)[0],on:"bottom"}});ETM.MealPlanViewState.isMultiDayCarousel()||!ETM.is_logged_in?ETM.free_walkthrough.addStep("5",{title:"Nutrition details",text:"<p>These are the nutrition totals for your plan.</p><p><strong>Click it for more details</strong>. You can also change your Nutrition Targets in here.</p><p>The generator will try to meet all of your goals, but sometimes it may violate one limit (like budget) in favor of meeting another (like minimum protein). Double check the results before following any diet.</p>",
attachTo:{element:$(".plan_stats_popover",ETM.plan_to_walkthrough.el)[0],on:"bottom"}}):ETM.free_walkthrough.addStep("5",{title:"Nutrition details",text:"<p>These are the nutrition totals for your plan.</p><p>They will update as you make changes to your plan. You can also change your Nutrition Targets here.</p><p>The generator will try to meet all of your goals, but sometimes it may violate one limit (like budget) in favor of meeting another (like minimum protein). Double check the results before following any diet.</p>",
attachTo:{element:$(".current-stats-col",ETM.plan_to_walkthrough.el)[0],on:"left"}});ETM.is_logged_in?ETM.free_walkthrough.addStep("6",{title:"Using the Food Bank",text:"<p>Click the Search box to open the Food Bank.</p><p>Here you can search our database for foods to add to your plans, or <strong>create your own foods and recipes.</strong></p>",attachTo:{element:$(".toggle_food_search")[0],on:"right"},when:{hide:function(){ETM.food_bank_sidebar.toggleFoodBank("close")}}}).addStep("7",{text:"<p>You can update or customize the rest of your settings with the options in the sidebar.</p><p><strong>Click your username</strong> to edit your profile or Account Info.</p><p><strong>Click Recurring Foods</strong> to customize foods that show up more often, or ones that are 'locked' into your plan (like your favorite breakfast).</p><p><strong>Click Preferences</strong> to customize everything else.</p>",
attachTo:{element:$(".user-profile")[0],on:"right"},classes:"shepherd-theme-arrows step_md tour_left_inset"}).addStep("8",{text:"You can come back to this walkthrough, and find more resources in our Help Page!",classes:"shepherd-theme-arrows step_md tour_left_inset",attachTo:{element:$(".help_page")[0],on:"right"},buttons:[{text:"Finish",action:function(){ETM.current_user_profile.save({show_walkthrough_prompt:!1},{patch:!0});ETM.free_walkthrough.next()}}]}):ETM.free_walkthrough.addStep("6",{text:"By creating a Free Account, you can track your intake, create custom foods/recipes, fine tune your taste profile, completely customize your nutrition targets. Check it out!",
attachTo:".logged_out_create_account left",buttons:[{text:"Finish",action:ETM.free_walkthrough.next}]});ETM.free_walkthrough.start()})};
ETM.start_premium_walkthrough=function(){(function(){null!==ETM.premium_walkthrough&&(ETM.premium_walkthrough=null);ETM.premium_walkthrough=new Shepherd.Tour({defaults:{classes:"shepherd-theme-arrows step_md",scrollTo:!1,showCancelLink:!0,when:{show:function(){var a=this.getAttachTo().element;a&&$("html,body").animate({scrollTop:$(a).offset().top-($(window).height()-$(a).outerHeight(!0))/2},200)}}}});var a="<p>This is an overview of the premium features will help you get the most out of using Eat This Much.</p><p><strong>We'll go over:</strong></p><ol class='ordered-list'><li>Your grocery list</li><li>The pantry system</li><li>The leftovers system</li><li>Saving/loading plans</li></ol>";
ETM.is_premium||(a+="<hr/><p><span class='badge badge-primary'>Note</span> It looks like you're not currently a subscriber, so many of this walkthrough's pointers might not make sense, and might not point to the right items on the grocery and leftovers pages. You're still welcome to follow along and read this stuff :)</p>");ETM.premium_walkthrough.addStep("1",{title:"Premium features walkthrough",text:a}).addStep("2",{attachTo:".pantry_grocery_nav right",text:"This will take you to the grocery list and pantry page. Click <strong>Next</strong> to head there now.",
classes:"shepherd-theme-arrows step_md tour_left_inset",when:{hide:function(){ETM.router.navigateAndScroll("groceries/",{trigger:!0})}}}).addStep("3",{attachTo:ETM.is_premium?".grocery_title_col top":"viewport",text:'<p>As soon as the grocery page opens, it automatically syncs with your meal plans.</p><p>You can change the dates that the grocery list syncs to by clicking the <i class="fa fa-pencil" aria-hidden="true"></i> next to the date range.</p>'}).addStep("4",{title:"Other functionality",attachTo:ETM.is_premium?
".grocery_title_col top":"viewport",text:"<p>You can also:</p><ol class='ordered-list'><li>Search and add from the Food Bank</li><li>Print or email the list from the \"Actions\" menu</li><li>Remove foods you don't want to buy</li></ol><p><span class='badge badge-primary'>Note</span> If you add or remove specific foods, those foods will stick around until you either reset the list by changing the date range, or until the next week is generated.</p>"}).addStep("5",{title:"The Pantry",attachTo:ETM.is_premium?
".pantry_title_col top":"viewport",text:"<p>Use the pantry to keep track of what you already own.</p><p>The generator's algorithms will try to use up your pantry items as much as possible to reduce waste, but if you're generating a week from scratch, it's likely that you'll have to go shopping.</p><p><strong>However... </strong> (click Next)</p>"}).addStep("6",{title:"Generating using Pantry foods",attachTo:ETM.is_premium?".pantry_title_col top":"viewport",text:"<p>You can have the planner find specific meals or recipes using one of two methods:</p><p><strong>1.</strong> Click the name of a meal in your planner, and then 'List alternative meals'. Then check the box at the top that says 'Sort by Pantry ingredients'. This will show you meals made from your pantry foods that hit your targets.</p><p><strong>2.</strong> Open the Food Bank, then click the 3-dot menu, then 'Find recipes using my Pantry'. This will give you individual recipes you can add to your plans.</p>"}).addStep("7",
{text:"<p>Next up is the leftovers system, which you can find in the Settings menu.</p><p>Click 'Next' to go there now.</p>",attachTo:".settings_nav right",classes:"shepherd-theme-arrows step_md tour_left_inset",when:{hide:function(){ETM.router.navigateAndScroll("preferences/meals/",{trigger:!0})}}}).addStep("8",{text:"<p>Leftovers are defined by <strong>patterns</strong>.</p><p>You pick which meal in the week creates extra food for leftovers, and then you pick which meals eat those leftovers up.</p>",
attachTo:".leftovers_div top"}).addStep("9",{text:"<p>As you update your patterns, this preview will update to show you how leftovers are passed throughout the week.</p><p>A leftovers pattern will not extend beyond the week, and the start of a week is defined by your selected grocery shopping day.</p>",attachTo:ETM.is_premium?".start_of_the_week top":"viewport"}).addStep("10",{text:"<p>If the leftovers options don't give you enough customizability, try creating new meal types and putting them on specific days of the week (like make a 'Leftovers Lunch' and 'Meal Prep Dinner').</p>",
attachTo:ETM.is_premium?".start_of_the_week top":"viewport"}).addStep("11",{title:"Saving and loading meal plans",text:"<p>Finally we're going to look at saving and loading meal plans.</p><p>Click <strong>Next</strong> and we'll head to the meal planner.</p>",classes:"shepherd-theme-arrows step_md tour_left_inset",attachTo:".diet_planner_nav right",when:{hide:function(){ETM.router.navigateAndScroll("",{trigger:!0})}}}).addStep("12",{text:"<p>In the Diet Actions menu, you can save, load, or print/email meal plans.</p><p>You can save up to two weeks of meal plans at a time when you save, or just one day if you want.</p><p>You can then load it into other days to use it like a copy & paste, or share the link to view it with your friends and family.</p>",
attachTo:".diet_actions_btn bottom"}).addStep("13",{text:'<p>That wraps up our brief overview.</p><p>If you have any unanswered questions, please check out our other resources on the Help Page, or feel free to email us at <a href="mailto:support@eatthismuch.com?subject=I%20have%20a%20question%20after%20viewing%20the%20walkthrough">support@eatthismuch.com</a></p>'});ETM.premium_walkthrough.start()})()};ETM.no_meal_plan_walkthrough=null;
ETM.start_no_plan_walkthrough=function(){ETM.no_meal_plan_walkthrough||(ETM.no_meal_plan_walkthrough=new Shepherd.Tour({defaults:{classes:"shepherd-theme-arrows step_md",scrollTo:!0,showCancelLink:!0}}),initial_message=ETM.is_logged_in?"<p><span class='badge badge-primary'>Note</span> To enable the full walkthrough, please create/load a diet plan for the current day.</p>":"<p><span class='badge badge-primary'>Note</span> To enable the full walkthrough, please enter a number of calories and hit the Generate button.</p>",
ETM.no_meal_plan_walkthrough.addStep("1",{title:"Hold up a second",text:initial_message}));ETM.no_meal_plan_walkthrough.start()};
ETM.start_walkthrough_on_homepage=function(a){function b(){if(ETM.is_logged_in){var b=ETM.calendar_view.getFirstVisiblePlan();if(b)ETM.plan_to_walkthrough=b;else return ETM.start_no_plan_walkthrough()}else{b=ETM.logged_out_day_view.single_plan_view;if(0===b.model.stats.calories)return ETM.start_no_plan_walkthrough();ETM.plan_to_walkthrough=b}a()}var c=["","v2/","v3/"];""!==Backbone.history.fragment&&-1===c.indexOf(Backbone.history.fragment)&&-1===Backbone.history.fragment.indexOf("diet-plan/")?(ETM.router.navigateAndScroll("",
{trigger:!0}),setTimeout(function(){b()},500)):b()};
ETM.SearchResultObjectView=ETM.FoodObjectView.extend({className:"foodbank_food diet_draggable row",initialize:function(){this.use_static_modal=!0;this.tooltip_handler=new ETM.FoodTooltipHandler(this.model);this.listenTo(this.model,"highlightFood",function(){this.flashFoodBackground()},this);this.listenTo(this.model,"imageUpdated",function(a){this.model.get("food").attributes.images.add(a);this.render()},this)},events:function(){return _.extend({},ETM.FoodObjectView.prototype.events,{"click .add_food":"addFood"})},
addFood:function(a){a.stopPropagation();var b=this;this.$el.tooltip("hide");if(this.collectionListView.ingredients_only){var c=this.model.attributes.food;ETM.food_info_object_list.add(c);var d=this.model.toJSON();d.food=c;c=new ETM.IngredientObject(d);ETM.recipe_editor.ingredients_list_view.collection.add(c);Helper.oneTimeTooltip($(a.target),"left","Added to recipe!",1E3)}else if(-1!==Backbone.history.fragment.indexOf("recurring-foods"))this.openRecurringFoodModal(a);else if(ETM.editing_user_settings)a.preventDefault(),
a=new ETM.RecurringFood({food:this.model.attributes.food,meal_type:this.collectionListView.search_bar.meal_type_id,units:this.model.attributes.units,amount:this.model.attributes.amount}),(c=a.validate(a.attributes))?_.each(c,function(a){Backbone.trigger("flash",{message:a.message,type:"danger"})}):(a.save(null,{async:!1}),ETM.recurring_foods_list.add(a),ETM.recurring_foods_list.trigger("rerender",a.attributes.meal_type));else if(-1!==Backbone.history.fragment.indexOf("groceries"))ETM.add_to_groceries_modal&&
(ETM.add_to_groceries_modal.close(),ETM.add_to_groceries_modal=null),ETM.add_to_groceries_modal=new ETM.AddToGroceriesModal,ETM.add_to_groceries_modal.loadFood(this.model),this.collectionListView.search_bar.listenTo(ETM.add_to_groceries_modal,"added_food",function(a){b.collectionListView.search_bar.model.addToRecentList(a)}),ETM.add_to_groceries_modal.getModalElement().html(ETM.add_to_groceries_modal.render().el),ETM.add_to_groceries_modal.initModal(),ETM.add_to_groceries_modal.$el.modal("show");
else if(-1!==Backbone.history.fragment.indexOf("collections")){if(ETM.router_functions.currentView===ETM.browse_collections_view||ETM.router_functions.currentView===ETM.single_collection_view&&ETM.single_collection_model.userIsOwner())ETM.add_to_collection_modal&&(ETM.add_to_collection_modal.close(),ETM.add_to_collection_modal=null),ETM.add_to_collection_modal=new ETM.FoodCollectionAddModalView,ETM.add_to_collection_modal.foods=[this.model],ETM.router_functions.currentView===ETM.single_collection_view&&
(ETM.add_to_collection_modal.selected_collection_id=ETM.single_collection_view.model.get("id")),ETM.add_to_collection_modal.getModalElement().html(ETM.add_to_collection_modal.render().el),ETM.add_to_collection_modal.$el.modal("show")}else ETM.add_food_modal?(a=ETM.add_food_modal.selected_date,c=ETM.add_food_modal.selected_meal_num,ETM.add_food_modal.close(),ETM.add_food_modal=null,ETM.add_food_modal=new ETM.AddFoodModal,ETM.add_food_modal.selected_date=a,ETM.add_food_modal.selected_meal_num=c):ETM.add_food_modal=
new ETM.AddFoodModal,ETM.add_food_modal.loadFood(this.model),this.collectionListView.search_bar.listenTo(ETM.add_food_modal,"added_food",function(a){b.collectionListView.search_bar.model.addToRecentList(a)}),ETM.add_food_modal.getModalElement().html(ETM.add_food_modal.render().el),ETM.add_food_modal.initModal(),ETM.add_food_modal.$el.modal("show")},render:function(a){this.updateStaticAmountAndUnits();this.model.selector_html=this.selectorHTML();void 0===typeof a&&(a=!0);a=this.template(_.extend({},
this.model,{read_only:a,image:this.model.attributes.food.getDisplayImage(),result_type:this.collectionListView.result_type,ingredients_only:this.collectionListView.ingredients_only}));this.$el.html(a);this.addDataAttributes();this.applyTooltip();this.resizeAmountInput();this.applyDraggable();return this},addDataAttributes:function(){this.$el.attr("data-result_type",this.collectionListView.result_type);this.$el.attr("data-food_id",this.model.get("food").get("id"))},applyTooltip:function(){this.$el.tooltip("dispose");
this.$el.tooltip({title:this.tooltipHTML(),html:!0,animation:!1,placement:this.tooltip_handler.getTooltipPlacement(),container:"body",trigger:"hover focus",template:'<div class="tooltip food_search_tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner food_obj_tooltip"></div></div>',delay:{show:tooltip_show_delay,hide:0}});this.model.attributes.food.attributes.is_recipe&&this.applyIngredientsLookup()},applyDraggable:function(){handle=ETM.is_mobile?".sidebar_draggable_handle":
null;var a=this;this.$el.draggable({handle:handle,connectToSortable:this.collectionListView.ingredients_only?".ingredients_list, .parse_result_list":".meal_foods, .meal_type_recurring_foods, .grocery_foods_list, .parse_result_list, .collection_food_list",distance:10,appendTo:"body",helper:"clone",tolerance:"pointer",placeholder:"list_placeholder",start:function(b,c){$(c.helper).tooltip("hide");$(c.helper).tooltip("dispose");a.$el.tooltip("hide");$(c.helper).attr("data-model_json",JSON.stringify(a.model.toJSONFull()));
a.collectionListView.search_bar.fadeResults()},stop:function(b,c){a.collectionListView.search_bar.stopFadeResults()}})}});
ETM.SearchResultsListView=Backbone.CollectionView.extend({tagName:"ul",emptyListCaption:function(){return!0===this.search_bar.search_results[this.result_type].model.error_loading?"<div class='row small_top_spacer'><div class='col-12 font-italic'>Uh oh. :( Something went wrong here.</div></div>":"pantry_recipes"===this.result_type?ETM.is_premium?"<div class='row small_top_spacer'><div class='col-12 font-italic'>No pantry results. For the best overlap with our recipe database, stick to using 'Basic Foods' when filling up your Pantry.</div></div>":"<div class='row small_top_spacer'><div class='col-12'>As a <a href='/choose-plan/' target='_blank'>Premium user</a>, we'll show you recipes you can prepare <strong>using the ingredients in your Pantry</strong>.</div></div>":
"collection_foods"===this.result_type&&0===Object.keys(this.search_bar.collection_foods_search_view.search_results).length?"<div class='row small_top_spacer'><div class='col-12'><a href='/collections/' target=='_blank'>Create a collection</a> to see results!</div></div>":"<div class='row small_top_spacer'><div class='col-12 font-italic'>No matching results.</div></div>"},modelView:ETM.SearchResultObjectView,initialize:function(a){Backbone.CollectionView.prototype.initialize.apply(this,arguments);
_.has(a,"ingredients_only")&&(this.ingredients_only=a.ingredients_only);_.has(a,"result_type")&&(this.result_type=a.result_type);_.has(a,"search_bar")&&(this.search_bar=a.search_bar)}});
ETM.SearchResultsView=Backbone.View.extend({events:{"click .add_custom_button":function(a){a.preventDefault();this.addCustom(a)},"click .back_prev_results":function(a){a.preventDefault();this.backToPrevResults()},"click .view_more_button":function(a){a.preventDefault();this.showMoreResults()}},initialize:function(a){for(var b in a)this[b]=a[b];this.pages_shown=0;this.rendered=!1;this.shuffled_results=null},showButtons:function(){$(".header_btn, .search_results_top_btn, .search_results_footer_1, .search_results_footer_2 a",
this.el).hide();1>this.pages_shown?$(".search_results_footer_1",this.el).show():$(".search_results_top_btn",this.el).show();0<this.model.total_results-3||"collection_foods"===this.result_type&&0!==Object.keys(this.search_bar.collection_foods_search_view.search_results).length?0===this.pages_shown?($(".search_results_footer_2 .header_btn a",this.el).show(),$(".search_results_footer_2 .header_btn",this.el).show()):50*this.pages_shown<this.model.results.size()?$(".search_results_footer_2 .view_more_button",
this.el).show():$(".search_results_footer_2 .back_prev_results",this.el).show():0<this.pages_shown&&$(".search_results_footer_2 .back_prev_results",this.el).show();if("pantry_recipes"===this.result_type&&!this.search_bar.pantry_loading){var a=$(".pantry_recipes_search_spinner",this.el),b=$(".pantry_recipes_results_list",this.el);a&&a.hide();b&&b.show()}},render:function(){this.undelegateEvents();this.rendered||(this.$el.empty(),this.$el.html($(ETM.loadTemplate("#SearchResultsContainer")({result_type:this.result_type,
collection_title:this.collection_title}))),this.results_container=this.$("."+this.result_type+"_results_container"));var a=this.renderCategoryResults();this.$("."+this.result_type+"_results_list").html(a.el);this.showButtons();this.rendered=!0;this.delegateEvents();return this},showMoreResults:function(a){0===this.pages_shown?(this.search_bar.setSelectedTab(this.result_type),this.search_bar.runSearch({result_type:this.result_type})):this.search_bar.renderMoreResults(this.result_type,!0)},addCustom:function(){this.search_bar.addCustom(this.result_type)},
backToPrevResults:function(){this.search_bar.backToPrevFilters()},renderCategoryResults:function(){var a=$('<ul class="search_results '+this.result_type+'_results col-12 mb-0"><div class="col-12"/></ul>'),b=0===this.pages_shown?3:50*this.pages_shown,c=this.model.results.clone();c.models=c.slice(0,b);a=new ETM.SearchResultsListView({collection:c,el:a,ingredients_only:this.search_bar.ingredients_only,result_type:this.result_type,search_bar:this.search_bar});a.render();return a},showResults:function(){this.results_container.show()},
hideResults:function(){this.results_container.hide()}});
ETM.CollectionFoodsSearchView=Backbone.View.extend({initialize:function(a){for(var b in a)this[b]=a[b];this.ingredients_only=a.ingredients_only||!1;this.search_results={};this.prev_query=this.current_collection_view=null;this.initEvents()},initSearchResultsViews:function(){var a=this;this.model.initCollectionResultsModels(function(){a.search_results={};_.each(a.model.all_model_keys,function(b){a.search_results[b]=new ETM.SearchResultsView({model:a.model.collection_results_models[b],result_type:b,
collection_title:a.model.collection_results_models[b].collection_title,search_bar:a})})})},initEvents:function(){var a=this;this.listenTo(this.model,"addToRecentList",function(b){a.addToRecentList(b)})},getPagesShown:function(){return this.current_collection_view?this.current_collection_view.pages_shown:0},setCurrentCollectionView:function(a){this.current_collection_view=this.search_results[a];this.model.current_collection_key=a},resetCurrentCollectionView:function(){this.current_collection_view=
null;this.model.current_collection_key=null},renderMoreResults:function(a,b){this.current_collection_view||this.setCurrentCollectionView(a);this.current_collection_view.pages_shown+=1;1===this.current_collection_view.pages_shown?this.search_bar.runSearch():this.search_bar.renderMoreResults("collection_foods",b)},updateCollectionViews:function(){var a=this;_.each(a.model.all_model_keys,function(b){a.search_results[b]||(a.search_results[b]=new ETM.SearchResultsView({model:a.model.collection_results_models[b],
result_type:b,collection_title:a.model.collection_results_models[b].collection_title,search_bar:a}))});var b=Object.keys(a.search_results);_.each(_.difference(b,a.model.all_model_keys),function(b){a.search_results[b].remove();delete a.search_results[b]});a.model.models_updated=!1},render:function(){var a=this;if(this.current_collection_view)return this.current_collection_view.render();this.model.models_updated&&a.updateCollectionViews();var b=$("<div></div>");if(0===this.model.all_model_keys.length)return b.append("<div class='row small_top_spacer'><div class='col-12'><a href='/collections/' target=='_blank'>Create a collection</a> to see results!</div></div>"),
this.el=b,this;var c=[],d=[],e=Object.keys(a.search_results).slice();_.each(e,function(b){a.search_results[b].pages_shown=0;a.search_results[b].prev_query=a.query;0<a.search_results[b].model.total_results?c.push(b):d.push(b)});e=c.concat(d);_.each(e,function(c){b.append(a.search_results[c].render().el)});$(".search_results_footer_2 .back_prev_results",b).slice(-1).text("Search all categories");$(".search_results_footer_2 .back_prev_results",b).slice(-1).show();this.el=b;return this},hideResults:function(){var a=
this,b=Object.keys(a.search_results);_.each(b,function(b){a.search_results[b].hideResults()})},setSelectedTab:function(a){"collection_foods"===a&&this.backToPrevFilters()},runSearch:function(a){this.renderMoreResults(a.result_type)},showResults:function(){var a=this;if(this.current_collection_view)this.current_collection_view.showResults();else{var b=Object.keys(a.search_results);_.each(b,function(b){a.search_results[b].showResults()})}},getPrevQuery:function(){return this.current_collection_view?
this.current_collection_view.prev_query:this.prev_query},setPrevQuery:function(a){this.current_collection_view?this.current_collection_view.prev_query=a:this.prev_query=a},backToPrevFilters:function(){this.current_collection_view?(this.resetCurrentCollectionView(),this.search_bar.runSearch()):this.search_bar.backToPrevFilters()},fadeResults:function(){this.search_bar.fadeResults()},stopFadeResults:function(){this.search_bar.stopFadeResults()},addToRecentList:function(a){this.search_bar.model.addToRecentList(a)}});
ETM.SearchBarView=Backbone.View.extend({className:"etm_search_bar",events:{"keyup .etm_search_input":"runSearch","focus .etm_search_input":"showAllResults","click .clear_search":function(a){$(".etm_search_input",this.el).val("");this.runSearch()}},initialize:function(a){this.ingredients_only=a.ingredients_only||!1;this.in_modal=a.in_modal||!1;this.$container=a.container||$("body");this.query="";this.back_button_query=null;this.meal_type_id=a.meal_type_id;this.search_delay=500;this.top_filter_override=
null;this.hidden=!0;this.placement=a.placement?a.placement:ETM.is_mobile?"bottom":"bottom-start";this.ingredients_only&&(this.model.result_types=["basic_foods","favorites","custom_foods","branded_foods"],this.top_filter_override="basic_foods")},onClose:function(){},initFilters:function(){var a=this;$(".search_bar_filters",this.search_results_el).multipleSelect({filterIcon:!0,placeholder:'<i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Select food types to search',minimumCountSelected:10,
allSelected:"Searching all food categories",width:100,styler:function(){return"font-size:small;"},onClose:function(){var b=$(".search_bar_filters",a.search_results_el).multipleSelect("getSelects");a.result_type_strings!==b&&a.runSearch({run_search:!0})}});$(".search_bar_filters",this.search_results_el).multipleSelect("checkAll");this.all_filters=$(".search_bar_filters",this.search_results_el).multipleSelect("getSelects");this.model.fetchFilters();$(".search_bar_filters",this.search_results_el).multipleSelect("setSelects",
this.model.result_types);this.result_type_strings=this.model.result_types},triggerViewCustomFoodsOnProfile:function(){ETM.finish_profile_completeness_key("view_custom_food_screen")},initResults:function(){this.search_results={recent_foods:new ETM.SearchResultsView({model:this.model.search_results_model_dict.recent_foods,result_type:"recent_foods",search_bar:this}),basic_foods:new ETM.SearchResultsView({model:this.model.search_results_model_dict.basic_foods,result_type:"basic_foods",search_bar:this}),
restaurant_foods:new ETM.SearchResultsView({model:this.model.search_results_model_dict.restaurant_foods,result_type:"restaurant_foods",search_bar:this}),branded_foods:new ETM.SearchResultsView({model:this.model.search_results_model_dict.branded_foods,result_type:"branded_foods",search_bar:this}),custom_foods:new ETM.SearchResultsView({model:this.model.search_results_model_dict.custom_foods,result_type:"custom_foods",search_bar:this,url:ROOT+"/customfood/"}),favorites:new ETM.SearchResultsView({model:this.model.search_results_model_dict.favorites,
result_type:"favorites",search_bar:this})};this.ingredients_only||(this.search_results.pantry_recipes=new ETM.SearchResultsView({model:this.model.search_results_model_dict.pantry_recipes,result_type:"pantry_recipes",search_bar:this}),this.search_results.custom_recipes=new ETM.SearchResultsView({model:this.model.search_results_model_dict.custom_recipes,result_type:"custom_recipes",search_bar:this,url:ROOT+"/customrecipe/"}),this.search_results.recipes=new ETM.SearchResultsView({model:this.model.search_results_model_dict.recipes,
result_type:"recipes",search_bar:this}),this.collection_foods_search_view=new ETM.CollectionFoodsSearchView({model:this.model.collection_foods_search_model,search_bar:this}),this.collection_foods_search_view.initSearchResultsViews(),this.search_results.collection_foods=new ETM.SearchResultsView({model:this.model.search_results_model_dict.collection_foods,result_type:"collection_foods",search_bar:this}))},fadeResults:function(){this.search_results_el.css("opacity",0.15);$(".drag_food_overlay",this.search_results_el).css("display",
"block")},stopFadeResults:function(){this.search_results_el.css("opacity",1);$(".drag_food_overlay",this.search_results_el).css("display","none")},initEvents:function(){var a=this;$(".search_close_btn",this.search_results_el).click(function(b){a.hideAllResults()});$(".search_bar_back_btn",this.search_results_el).click(function(b){a.backToPrevFilters()});$(".view-custom-foods-item",this.search_results_el).click(function(b){a.triggerViewCustomFoodsOnProfile();$(".search_bar_filters",a.search_results_el).multipleSelect("setSelects",
["custom_foods"]);a.runSearch()});$(".view-favorite-foods-item",this.search_results_el).click(function(b){$(".search_bar_filters",a.search_results_el).multipleSelect("setSelects",["favorites"]);a.runSearch()});$(".add-custom-food-item",this.search_results_el).click(function(b){a.newCustomFood()});this.ingredients_only||($(".view-custom-recipes-item",a.search_results_el).click(function(b){a.triggerViewCustomFoodsOnProfile();$(".search_bar_filters",a.search_results_el).multipleSelect("setSelects",["custom_recipes"]);
a.runSearch()}),$(".view-pantry-recipes-item",a.search_results_el).click(function(b){$(".search_bar_filters",a.search_results_el).multipleSelect("setSelects",["pantry_recipes"]);a.runSearch()}),$(".add-custom-recipe-item",a.search_results_el).click(function(b){a.newRecipe()}));this.search_results.favorites.model.initializeEvents();this.listenTo(this.search_results.favorites.model,"addFavorite removeFavorite",function(b,c){-1!=a.result_type_strings.indexOf("favorites")&&(a.search_results.favorites.model.search(a.query),
a.search_results.favorites.render(),a.search_results.favorites.showResults())},this);a.listenTo(a.search_results.custom_foods.model,"updatedCustom",function(b,c){!0===b&&(-1===a.result_type_strings.indexOf("custom_foods")&&a.result_type_strings.unshift("custom_foods"),$(".search_bar_filters",a.search_results_el).multipleSelect("setSelects",a.result_type_strings),a.top_filter_override="custom_foods");a.search_results.custom_foods.model.search(a.query);a.runSearch()},this);a.ingredients_only||a.listenTo(a.search_results.custom_recipes.model,
"updatedCustom",function(b,c){if(!0===b){-1===a.result_type_strings.indexOf("custom_recipes")&&a.result_type_strings.unshift("custom_recipes");try{$(".search_bar_filters",a.search_results_el).multipleSelect("setSelects",a.result_type_strings)}catch(d){}a.top_filter_override="custom_recipes"}a.search_results.custom_recipes.model.search(a.query);a.runSearch()},this);a.listenTo(a.search_results.recent_foods.model,"render_recent_foods",function(){-1!=a.result_type_strings.indexOf("recent_foods")&&(a.search_results.recent_foods.model.search(a.query),
a.search_results.recent_foods.render(),a.search_results.recent_foods.showResults())});a.ingredients_only||a.listenTo(a.search_results.pantry_recipes.model,"updated_pantry_foods",function(){a.updatePantryRecipes()})},backToPrevFilters:function(){$(".search_bar_filters",this.search_results_el).multipleSelect("checkAll");$(".search_bar_back_btn",this.search_results_el).hide();this.runSearch({force_search:!0});this.back_button_query=this.prev_result_type_strings=null},showSpinner:function(){this.spinner_el&&
this.spinner_el.show()},markPantryLoading:function(){var a=this,b=$(".pantry_recipes_search_spinner",this.results_container),c=$(".pantry_recipes_results_list",this.results_container);$(".search_results_footer_2 .header_btn a",this.search_results.pantry_recipes.el).hide();$(".search_results_footer_2 .header_btn",this.search_results.pantry_recipes.el).hide();b&&b.show();c&&c.hide();a.pantry_loading=!0;this.listenTo(a.model,"done_loading",function(b){"pantry_recipes"===b&&(a.stopListening(a.model,"done_loading"),
a.markPantryLoaded(),a.renderResults())})},hideSpinner:function(){this.spinner_el&&this.spinner_el.hide()},markPantryLoaded:function(){this.pantry_loading=!1},render:function(){this.$el.html(this.template({ingredients_only:this.ingredients_only}));this.search_results_el=$(ETM.loadTemplate("#SearchResultsView")({ingredients_only:this.ingredients_only}));this.results_container=$(".etm_results_container",this.search_results_el);this.spinner_el=$(".search_spinner",this.search_results_el);this.$container.append(this.search_results_el);
this.in_modal&&this.search_results_el.css("z-index","1100");this.results_rendered=!1;this.initPopper();this.initFilters();this.initResults();this.initEvents();this.renderResults();return this},runSearch:function(a){var b=this;a="undefined"!=typeof a?"Enter"===a.key||a.force_search:!1;var c=!1;clearTimeout(this.search_timer);var d=$(".etm_search_input",this.el).val().trim();0<d.length?$(".clear_search",this.el).show():$(".clear_search",this.el).hide();var e=$(".search_bar_filters",this.search_results_el).multipleSelect("getSelects");
null==b.prev_result_type_strings&&null==b.back_button_query&&$(".search_bar_back_btn",this.search_results_el).hide();0==e.length&&(e=["recipes","recent_foods"]);_.intersection(e,b.result_type_strings).length!==b.result_type_strings.length&&(this.top_filter_override=null);var f=[];if(1===e.length){var g=e[0],h="collection_foods"===g?b.collection_foods_search_view.getPrevQuery():b.search_results[g].prev_query;(b.search_results[g].model.results.size()===b.search_results[g].model.total_results||3<b.search_results[g].model.results.size())&&
d===h||f.push(g)}else c=!0,_.each(e,function(a){d!==b.search_results[a].prev_query&&f.push(a)});b.result_type_strings=e;b.model.saveFilters(b.result_type_strings);(2<d.length||0===d.length||!0===a)&&0<f.length?this.search_timer=setTimeout(function(){b.showSpinner();-1!==f.indexOf("pantry_recipes")&&b.markPantryLoading();b.query=d;b.model.searchAllModels(b.query,f,c,function(){b.hideSpinner();b.renderResults()})},this.search_delay):b.renderResults()},renderMoreResults:function(a,b){var c=this;1>this.search_results[a].pages_shown&&
(this.results_container.empty(),this.results_container.scrollTop());this.result_type_strings=[a];_.each(_.difference(this.ALL_FILTERS,this.result_type_strings),function(a){c.search_results[a].hideResults()});"collection_foods"===a?(this.search_results[a].hideResults(),this.search_results[a].pages_shown=this.collection_foods_search_view.getPagesShown(),this.collection_foods_search_view.setPrevQuery(c.query),this.results_container.append(this.collection_foods_search_view.render().el),this.collection_foods_search_view.showResults()):
(this.search_results[a].prev_query=c.query,this.search_results[a].pages_shown+=1,this.results_container.append(this.search_results[a].render().el),this.search_results[a].showResults())},updatePantryRecipes:function(){var a=this,b=a.query?a.query:$(".etm_search_input",this.el).val();this.search_results.pantry_recipes.model.updateRecipes(b,function(){a.search_results.pantry_recipes.render();a.hidden||-1===a.result_type_strings.indexOf("pantry_recipes")||(a.search_results.pantry_recipes.showResults(),
a.search_results.pantry_recipes.showButtons())})},runDefaultFetch:function(){var a=this;this.model.default_fetched?a.renderResults():(this.model.default_fetched=!0,this.showSpinner(),this.ingredients_only||a.markPantryLoading(),this.model.searchAllModels(this.query,this.result_type_strings,1<this.result_type_strings.length,function(){a.hideSpinner();a.renderResults()}))},showAllResults:function(){var a=this;this.hideOtherSearchBars();this.hidden=!1;this.search_results_el.show();this.popper_object.update();
this.runDefaultFetch();$(document).on("click",function c(d){if("main_container"===d.target.id||$(d.target).parents("#main_container").length||"recipe_editor_modal"===d.target.id)a.hideAllResults(),$(document).off("click",c)})},hideOtherSearchBars:function(){var a=this;$(".etm_search_results:visible").each(function(){$(this).is(a.search_results_el)||$(this).hide()})},hideAllResults:function(){this.search_results_el.hide();this.hidden=!0;$(".food_search_tooltip").remove()},initPopper:function(){var a=
this,b=$(".etm_search_input",this.el)[0],c={};this.ingredients_only&&!ETM.is_mobile&&(c={offset:"70px"});setTimeout(function(){a.popper_object=new Popper(b,a.search_results_el[0],{modifiers:{preventOverflow:{boundariesElement:"scrollParent"},flip:{enabled:!1},offset:c},removeOnDestroy:!0,placement:a.placement})},0)},renderResults:function(){var a=this;$(".food_search_tooltip").remove();if(this.results_rendered){var b=$(".etm_search_input",this.el).val().trim();if(1===this.result_type_strings.length&&
(b===a.query||3>b.length))_.each(a.result_type_strings,function(b){a.renderMoreResults(b)});else{a.results_container.empty();var c=[],d=[],b=this.all_filters.slice();if(null!==this.top_filter_override){var e=b.indexOf(this.top_filter_override);-1!==e&&b.splice(e,1);b.unshift(this.top_filter_override)}_.each(b,function(b){-1!==a.result_type_strings.indexOf(b)?(a.search_results[b].pages_shown=0,a.search_results[b].prev_query=a.query,"pantry_recipes"===b&&a.pantry_loading?c.push(b):0<a.search_results[b].model.total_results?
c.push(b):d.push(b)):(a.search_results[b].pages_shown=0,a.search_results[b].hideResults())});b=c.concat(d);_.each(b,function(b){a.results_container.append(a.search_results[b].render().el);"pantry_recipes"===b&&a.pantry_loading||a.search_results[b].showResults()})}}else _.each(this.all_filters,function(b){a.results_container.append(a.search_results[b].render().el)}),this.results_rendered=!0;return this},newCustomFood:function(){this.custom_food_form=new ETM.CustomFoodFormModalView({model:this.search_results.custom_foods.model.results.food_info_object_list});
this.custom_food_form.parent=this;this.custom_food_form.getModalElement().html(this.custom_food_form.render());$("#gram_weight_1_amount",this.custom_food_form.el).val(1);$("#gram_weight_1_description",this.custom_food_form.el).val("serving");($("#recipe_editor_modal").data("bs.modal")||{}).isShown?Helper.showNestedModal(this.custom_food_form):this.custom_food_form.$el.modal("show");var a=this;setTimeout(function(){a.custom_food_form.renderDefaultUnitsSelector();a.custom_food_form.setDefaultUnits(1)},
200)},newRecipe:function(){var a=new ETM.FoodInfoObject({ingredients:new ETM.IngredientsList,directions:new ETM.DirectionsList,nutrition:{},category_id:11,number_servings:1});a.url=function(){return ROOT+"/recipe/"};a=new ETM.FoodObject({food:a,amount:1,units:1});ETM.recipe_editor=new ETM.RecipeEditorModalView;ETM.recipe_editor.model=a;ETM.recipe_editor.getModalElement().html(ETM.recipe_editor.render().el);ETM.recipe_editor.$el.modal("show");ETM.recipe_editor.printGraph();ETM.recipe_editor.applyEvents()},
addCustom:function(a){"custom_foods"==a?this.newCustomFood():"custom_recipes"==a&&this.newRecipe()},setSelectedTab:function(a){this.prev_result_type_strings=this.result_type_strings;this.back_button_query=this.query;$(".search_bar_filters",this.search_results_el).multipleSelect("setSelects",[a])}});ETM.NavigationSearchBarView=ETM.SearchBarView.extend({});
ETM.FoodCollectionLoggedOutHeader=Backbone.View.extend({initialize:function(a){for(var b in a)this[b]=a[b]},render:function(){this.$el.html(this.template({secret_url:this.secret_url}));return this}});
ETM.FoodCollectionAddModalView=ModalView.extend({modal_id:"collection_add_modal_div",id:"collection_add_modal",events:{"click .confirm_add_btn":"addToCollection"},initialize:function(){ETM.browse_collections_model||(ETM.browse_collections_model=new ETM.BrowseCollectionsModel,ETM.browse_collections_model.collection_models.my_collections.fetch({async:!1}));this.collections=ETM.browse_collections_model.collection_models.my_collections;this.foods=[]},addToCollection:function(){var a=this;try{this.$(".confirm_add_btn").prop("disabled",
!0);var b=this.$("#add_to_collection_dropdown").val();Array.isArray(b)||(b=[b]);_.each(this.foods,function(c){_.each(b,function(b){var f=a.collections.get(b),g=c.attributes.food.clone(),h=new ETM.FoodCollectionItem({food:g,amount:c.get("amount"),units:c.get("units"),food_collection_id:f.get("id")});h.save(null,{success:function(){a.$(".add_to_collection_modal.modal-body").html("<h4>Added successfully!</h4>");ETM.router_functions.currentView===ETM.single_collection_view&&ETM.single_collection_view.model.fetch().done(function(){ETM.single_collection_view.render()});
ETM.browse_collections_view&&ETM.browse_collections_view.updateSingleCollectionCard(b);setTimeout(function(){a.closeModal()},800)},error:function(b,c){bugsnagClient.notify(Error(c),{metaData:{etm_msg:"Error adding food(s) to a collection.",collection:JSON.stringify(f),modelToAdd:h}});a.$(".add_to_collection_modal.modal-body").html("<h4>Uh oh. Something went wrong :(</h4>");setTimeout(function(){a.closeModal()},800)}})})})}catch(c){bugsnagClient.notify(c,{metaData:{etm_msg:"Error adding food(s) to a collection.",
collection:JSON.stringify(b)}}),a.$(".add_to_collection_modal.modal-body").html("<h4>Uh oh. Something went wrong :(</h4>"),setTimeout(function(){a.closeModal()},800)}},loadFoodsFromElements:function(a){var b=this;_.each(a,function(a){a=$(a).data("modelCid");a=ETM.single_collection_model.attributes.foods.get(a);b.foods.push(a)})},initializeDropdown:function(){if(ETM.is_logged_in){var a=1<this.foods.length?"Select a Collection":"Select one or more Collections";this.$("#add_to_collection_dropdown").multiselect({nonSelectedText:a,
buttonWidth:"100%",maxHeight:400,inheritClass:!0,enableCaseInsensitiveFiltering:!0,enableFullValueFiltering:!0})}},render:function(){this.$el.html(this.template({current_collection_id:this.model?this.model.get("id"):null,selected_collection_id:this.selected_collection_id?this.selected_collection_id:null,num_foods:this.foods.length,collections:this.collections,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff}));this.$el.modal({backdrop:"static",keyboard:!1,show:!1});this.initializeDropdown();
return this},closeModal:function(){this.$el.modal("hide")}});
ETM.FoodCollectionDeleteModalView=ModalView.extend({modal_id:"collection_create_modal_div",id:"collection_create_modal",events:{"click .delete_collection_btn":"deleteCollection"},deleteCollection:function(){var a=this.model.attributes.secret_url;this.model.save({deleted:!0},{patch:!0});ETM.single_collection_model=null;if(ETM.browse_collections_model){var b=ETM.browse_collections_model.collection_models.my_collections.findWhere({secret_url:a});ETM.browse_collections_model.collection_models.my_collections.remove(b)}ETM.recurring_collections_list.deleteRecurringCollections(a);
ETM.router.navigateAndScroll("collections/",{trigger:!0});this.closeModal()},render:function(){this.$el.html(this.template({model:this.model,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff}));this.$el.modal({backdrop:"static",keyboard:!1,show:!1});return this},closeModal:function(){this.$el.modal("hide")}});
ETM.FoodCollectionCreateEditModalView=ModalView.extend({modal_id:"collection_create_modal_div",id:"collection_create_modal",events:{"click .create_collection_btn":"createCollection","click .confirm_collection_edit_btn":"editCollection"},initialize:function(a){for(var b in a)this[b]=a[b]},editCollection:function(){var a=this;if(this.collection_view.model.attributes.title!==$("#collection-title",this.el).val()||this.collection_view.model.attributes.description!==$("#collection-description",this.el).val()){var b=
$("#collection-title",this.el).val(),c=$("#collection-description",this.el).val();this.collection_view.model.attributes.title=b;this.collection_view.model.attributes.description=c;var d=this.collection_view.model.get("secret_url");this.collection_view.model.save({title:b,description:c},{success:function(b,c,g){ETM.browse_collections_model&&(ETM.browse_collections_model.collection_models.my_collections.findWhere({secret_url:d}).fetch(),(c=ETM.browse_collections_model.collection_models.featured_collections.findWhere({secret_url:d}))&&
c.fetch());ETM.recurring_collections_list.updateRecurringCollections(b);a.collection_view.renderInfoHeader();a.$el.modal("hide")}})}else a.collection_view.renderInfoHeader(),a.$el.modal("hide")},createCollection:function(){var a=this;if(!this.validate())return!1;var b=this.model;this.model||(b=new ETM.FoodCollection,b.urlRoot=function(){return ROOT+"/fullfoodcollection/"});b.attributes.title=$("#collection-title",this.el).val();b.attributes.description=$("#collection-description",this.el).val();b.save(null,
{url:ROOT+"/fullfoodcollection/",success:function(b,d,e){ETM.browse_collections_model.collection_models.my_collections.add(b,{at:0});a.$el.modal("hide");ETM.router.navigateAndScroll("collections/"+b.attributes.secret_url+"/",{trigger:!0})}})},render:function(){this.$el.html(this.template({model:this.model,edit_collection:!!this.collection_view,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff}));this.$el.modal({backdrop:"static",keyboard:!1,show:!1});this.renderForm();
this.model&&this.populateForm();return this},renderForm:function(){this.form=(new Backbone.Form({template:Helper.createTemplateFunction($("#createCollectionForm",this.el).html())})).render();this.$(".create_collection_form").html(this.form.el)},populateForm:function(){$("#collection-title",this.el).val(this.model.attributes.title);$("#collection-description",this.el).val(this.model.attributes.description)},validate:function(){$(".collection_validation_error",this.el).remove();var a=!0,b=$("#collection-title",
this.el);0<!b.val().length&&(b.after("<div class='alert alert-danger collection_validation_error'>The collection must have a title.</div>"),a=!1);return a},closeModal:function(){this.$el.modal("hide")}});
ETM.FoodCollectionFoodObjectView=ETM.FoodObjectView.extend({className:"collection_foodlist_food diet_draggable row bottom_border_col",events:function(){this.use_static_modal=!0;return _.extend({},ETM.FoodObjectView.prototype.events,{"click .remove_collection_item":function(){this.model.userIsOwner()&&this.deleteFood()},"click .add-food-list-item":"addFoodToList","click .add-food-meal-item":"addFoodToMeal","change .food_checkbox input":function(a){this.toggleSelected(a);$(a.target).blur()},"click .add-food-collection-item":"addFoodToCollection"})},
addFoodToList:function(a){this.openRecurringFoodModal(a)},deleteFood:function(){var a=this;this.$el.tooltip("dispose");this.model.destroy({success:function(b,c){a.collectionListView.food_collection.model.trigger("destroyFinished")}});this.remove()},addFoodToCollection:function(){if(ETM.add_to_collection_modal){var a=ETM.add_to_collection_modal.selected_collection;ETM.add_to_collection_modal.close();ETM.add_to_collection_modal=null;ETM.add_to_collection_modal=new ETM.FoodCollectionAddModalView({model:ETM.single_collection_model});
ETM.add_to_collection_modal.selected_collection=a}else ETM.add_to_collection_modal=new ETM.FoodCollectionAddModalView({model:ETM.single_collection_model});ETM.add_to_collection_modal.foods=[this.model];ETM.add_to_collection_modal.getModalElement().html(ETM.add_to_collection_modal.render().el);ETM.add_to_collection_modal.$el.modal("show")},addFoodToMeal:function(a){a.stopPropagation();ETM.calendar_list||(a=new Date,UrlFunctions.getUrlParameter("date")&&-1!=Backbone.history.fragment.indexOf("date")&&
(a=Helper.parseDateString(UrlFunctions.getUrlParameter("date"))),ETM.calendar_list=new ETM.CalendarDietList([],{selected_date:a}));if(ETM.add_food_modal){a=ETM.add_food_modal.selected_date;var b=ETM.add_food_modal.selected_meal_num;ETM.add_food_modal.close();ETM.add_food_modal=null;ETM.add_food_modal=new ETM.AddFoodModal;ETM.add_food_modal.selected_date=a;ETM.add_food_modal.selected_meal_num=b}else ETM.add_food_modal=new ETM.AddFoodModal;ETM.add_food_modal.loadFood(this.model);ETM.add_food_modal.getModalElement().html(ETM.add_food_modal.render().el);
ETM.add_food_modal.initModal();ETM.add_food_modal.$el.modal("show")},render:function(a){var b=this;this.updateStaticAmountAndUnits();this.model.selector_html=this.selectorHTML();void 0===typeof a&&(a=!0);a=this.template(_.extend({},this.model,{read_only:a,image:this.model.attributes.food.getDisplayImage(),result_type:""}));this.$el.html(a);$(".food_checkbox input",this.el).is(":checked")&&$(".food_box",this.el).addClass("blueHighlight");$(".add_food",this.el).on("hidden.bs.dropdown",function(){$(".add_btn_dropdown",
b.$el).blur()});this.applyTooltip();this.resizeAmountInput();return this},toggleSelected:function(a){this.model.is_selected=$(a.target).is(":checked");this.model.is_selected?$(a.currentTarget).closest(".collection_foodlist_food").addClass("blueHighlight"):$(a.currentTarget).closest(".collection_foodlist_food").removeClass("blueHighlight")},applyTooltip:function(){this.$el.tooltip("dispose");this.$el.tooltip({title:this.tooltipHTML(),html:!0,animation:!1,placement:this.tooltip_handler.getTooltipPlacement(),
container:"body",trigger:"hover focus",template:'<div class="tooltip food_search_tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner food_obj_tooltip"></div></div>',delay:{show:tooltip_show_delay,hide:0}});this.model.attributes.food.attributes.is_recipe&&this.applyIngredientsLookup()}});
ETM.FoodCollectionFoodListView=Backbone.CollectionView.extend({tagName:"ul",modelView:ETM.FoodCollectionFoodObjectView,sortable:!0,selectable:!0,sortableOptions:function(){return ETM.is_mobile?{connectWith:".collection_food_list",handle:".draggable_handle",placeholder:"list_placeholder",axis:null,tolerance:"pointer"}:{connectWith:".collection_food_list",placeholder:"list_placeholder",axis:null,tolerance:"pointer"}},emptyListCaption:function(){return"<div class='row small_top_spacer'><div class='col-12 font-italic'>No foods. Add some from the search bar on the left or in the food browser.</div></div>"},
initialize:function(a){Backbone.CollectionView.prototype.initialize.apply(this,arguments);_.has(a,"food_collection")&&(this.food_collection=a.food_collection)},render:function(){Backbone.CollectionView.prototype.render.apply(this,arguments);this.$el.sortable({items:"li"});this.food_collection.model.userIsOwner()||(this.$el.sortable({disabled:!0}),$(".diet_draggable",this.el).addClass("static_draggable"));return this}});
ETM.FoodCollectionView=Backbone.View.extend({events:{"click .single_collection_back_btn":"backToBrowseCollections","click .edit-collection-dropdown":"editCollectionModal","click .delete-collection-dropdown":"deleteCollectionModal","click .follow-collection-dropdown":"toggleFollowing","click .follow_button":"toggleFollowing","change .collection_sort":"reSortFoods","click .make-public-dropdown":"togglePublicPrivate","click .copy_permalink":function(){Helper.copyPermalink($(".collection_permalink",this.el),
$(".link_button",this.el))},"click .add-multiple-foods-dropdown":"toggleMultiAdd","click .select_all":"selectAll","click .multi-cancel-btn":"toggleMultiAdd","click .multi-add-btn":"openAddToCollectionModal","click .add_collection_to_meal":"openAddRecurringCollectionModal","click .curate_all_images":"adminCurateAllCollectionImages"},toggleFollowing:function(){ETM.is_logged_in?(this.updateFollowingModel(),this.renderInfoHeader()):window.location.href="/user/register-free-account/?next=/collections/"+
this.model.attributes.secret_url+"/"},togglePublicPrivate:function(){this.model.userIsOwner()&&(this.model.save({is_public:!this.model.get("is_public")}),this.renderInfoHeader())},adminCurateAllCollectionImages:function(a){if(!ETM.is_staff)return!1;var b=this;Helper.confirmationPopover({element:$(a.target),title:"Are you sure?",message:"<p>This will curate all the images in the collection.</p>",position:"bottom",cancel_text:"Cancel",confirm_text:"Yes, curate",confirmCallback:function(){ETM.toast.showNotification({type:"info",
message:"Started curating..."});$.post("/admin/collection_images/curate_all/",{collection_id:b.model.attributes.id},function(a){a?ETM.toast.showNotification({type:"info",message:"Successfully curated "+a}):ETM.toast.showNotification({type:"error",message:"Error! "+a})})}})},openAddRecurringCollectionModal:function(){ETM.is_logged_in?(ETM.add_recurring_collection_modal&&ETM.add_recurring_collection_modal.close(),ETM.add_recurring_collection_modal=new ETM.AddRecurringCollectionModalView({collection:this.model}),
ETM.add_recurring_collection_modal.getModalElement().html(ETM.add_recurring_collection_modal.render().el),ETM.add_recurring_collection_modal.delegateEvents(),ETM.add_recurring_collection_modal.$el.modal("show"),googleanalytics("send","event","button","click","add_collection_modal"),amplitude.logEvent("add_collection_modal")):window.location.href="/user/register-free-account/?next=/collections/"+this.model.attributes.secret_url+"/"},openAddToCollectionModal:function(){var a=this.$(".collection_foodlist_food.blueHighlight");
if(ETM.add_to_collection_modal){var b=ETM.add_to_collection_modal.selected_collection;ETM.add_to_collection_modal.close();ETM.add_to_collection_modal=null;ETM.add_to_collection_modal=new ETM.FoodCollectionAddModalView({model:this.model});ETM.add_to_collection_modal.selected_collection=b}else ETM.add_to_collection_modal=new ETM.FoodCollectionAddModalView({model:this.model});ETM.add_to_collection_modal.loadFoodsFromElements(a);ETM.add_to_collection_modal.getModalElement().html(ETM.add_to_collection_modal.render().el);
ETM.add_to_collection_modal.$el.modal("show")},toggleMultiAdd:function(){ETM.is_logged_in?this.multi_add_active?(this.multi_add_active=!1,this.$(".food_box .food_checkbox_col").hide(),this.$(".multi-add-controls").hide(),this.$(".food_box .food_buttons_col").show(),this.$(".remove_item_icon").show(),this.$(".collection_foodlist_food").removeClass("blueHighlight"),this.deselectAll()):(this.multi_add_active=!0,this.$(".food_box .food_checkbox_col").show(),this.$(".multi-add-controls").show(),this.$(".food_box .food_buttons_col").hide(),
this.$(".remove_item_icon").hide()):window.location.href="/user/register-free-account/?next=/collections/"+this.model.attributes.secret_url+"/"},selectAll:function(a){if(this.multi_add_active){var b=$(".collection_foodlist_food .food_checkbox input");$(a.target).is(":checked")?b.prop("checked",!0):b.prop("checked",!1);b.trigger("change")}},deselectAll:function(){var a=$(".collection_foodlist_food .food_checkbox input"),b=this.$(".select_all");a.prop("checked",!1);a.trigger("change");b.prop("checked",
!1);b.trigger("change")},reSortFoods:function(){var a=this.$(".collection_sort").val();a||(a="-date_added");var b=a[0];"-"===b&&(a=a.slice(1));this.model.attributes.foods.comparator=function(c,d){"food_name"===a?(valA=c.get("food").get(a).toLowerCase(),valB=d.get("food").get(a).toLowerCase()):(valA=c.get(a).toLowerCase(),valB=d.get(a).toLowerCase());ret=valA<valB?-1:valA>valB?1:0;"-"===b&&(ret=-ret);return ret};this.model.attributes.foods.sort();this.model.attributes.foods.comparator=null;this.renderCollectionFoods()},
initialize:function(a){this.model=a.model},initializeSort:function(){if(ETM.is_logged_in){var a=this;this.$("#collection_foods_sort").multiselect({onChange:function(b,c,d){a.reSortFoods()},buttonWidth:"100%",maxHeight:400,inheritClass:!0})}},initializeFollowing:function(){var a=this;ETM.is_logged_in?this.model.fetchFollowing(function(){a.renderInfoHeader()}):a.renderInfoHeader()},updateFollowingModel:function(){this.model.is_followed&&this.model.following_model?(this.model.following_model.destroy(),
this.model.following_model=null,this.model.is_followed=!1,ETM.browse_collections_model.collection_models.followed_collections.remove(this.model)):(this.model.following_model=new ETM.FoodCollectionFollowerModel({food_collection_id:this.model.attributes.id}),this.model.following_model.save(),this.model.is_followed=!0,ETM.browse_collections_model.collection_models.followed_collections.add(this.model))},initializeEvents:function(){var a=this;this.listenTo(this.model,"updateNumFoods",function(){6>=a.model.attributes.num_foods&&
null==a.model.attributes.image_url&&$(".collection_image img",a.el).attr("src",a.model.getCollectionImageUrl());if(ETM.browse_collections_model){var b=ETM.browse_collections_model.collection_models.my_collections.findWhere({secret_url:this.model.get("secret_url")});b&&b.set("num_foods",this.model.attributes.num_foods);(b=ETM.browse_collections_model.collection_models.featured_collections.findWhere({secret_url:this.model.get("secret_url")}))&&b.set("num_foods",this.model.attributes.num_foods)}ETM.recurring_collections_list.updateRecurringCollections(a.model);
a.renderInfoHeader()});this.listenTo(this.model,"change:image_url",function(b,c,d){$(".collection_image img",a.el).attr("src",a.model.getCollectionImageUrl())})},renderInfoHeader:function(){this.collection_info_header.replaceWith($(ETM.loadTemplate("#FoodCollectionInfoHeader")({model:this.model})));this.collection_info_header=this.$(".collection_info_header");if(this.model.is_followed){var a=this.$(".follow_button");a.text("Following");a.addClass("active")}this.delegateEvents()},render:function(){this.initializeEvents();
this.$el.html(this.template({model:this.model}));this.collection_info_header=this.$(".collection_info_header");this.create_uploader();this.initializeFollowing();this.initializeSort();this.renderCollectionFoods();this.delegateEvents();return this},create_uploader:function(){if(ETM.is_logged_in){var a=this;ETM.displayImageSelectModal($(".collection_image",this.el),function(b){a.modal&&a.modal.close();a.modal=new ETM.CollectionImageCropModalView({model:a.model});a.modal.getModalElement().html(a.modal.render(b).el);
a.modal.show()})}},editCollectionModal:function(){this.model.userIsOwner()&&(ETM.collection_editor=new ETM.FoodCollectionCreateEditModalView({model:this.model,collection_view:this}),ETM.collection_editor.getModalElement().html(ETM.collection_editor.render().el),ETM.collection_editor.$el.modal("show"))},deleteCollectionModal:function(){this.model.userIsOwner()&&(ETM.collection_delete_modal=new ETM.FoodCollectionDeleteModalView({model:this.model}),ETM.collection_delete_modal.getModalElement().html(ETM.collection_delete_modal.render().el),
ETM.collection_delete_modal.$el.modal("show"))},deleteCollectionItem:function(a){this.model.userIsOwner()&&(a=this.model.attributes.foods.findWhere({food:a.attributes.food}),this.model.attributes.foods.remove(a),a.destroy())},renderCollectionFoods:function(){var a=$('<ul class="collection_food_list col-12"><div class="col-12"/></ul>');this.food_list_view=new ETM.FoodCollectionFoodListView({collection:this.model.attributes.foods,el:a,food_collection:this});this.food_list_view.render();this.$(".collection_foods").html(this.food_list_view.el);
return this.food_list_view},backToBrowseCollections:function(){ETM.router.navigateAndScroll("collections/",{trigger:!0})}});
ETM.analytics={logRegenerate:function(a){dates=JSON.parse(a.regenerate_weeks);a={next_week:!0,this_week:!0};if(2!=dates.length){var b=(new Date).toJSON().split("T")[0],c=dates[0].split(",");Date.parse(b)<Date.parse(c[0])?a.this_week=!1:a.next_week=!1}amplitude.logEvent("regenerate_week",a);"/"===window.location.pathname||-1!==window.location.pathname.indexOf("/dates/")?amplitude.logEvent("regenerate_week_planner",a):amplitude.logEvent("app_regenerate_week",a)},logRecipeImport:function(a){a={full_url:a,
domain:extractRootDomain(a)};amplitude.logEvent("recipe_import_started",a)},logImportedRecipeSave:function(a){a={full_url:a,domain:extractRootDomain(a)};amplitude.logEvent("recipe_import_saved",a)},logGenerate:function(a,b){amplitude.logEvent("generate_diet",{starting_calories:a.calories,starting_carbs:a.carbs,starting_fats:a.fats,starting_proteins:a.proteins,ending_calories:b.stats.calories,ending_carbs:b.stats.carbs,ending_fats:b.stats.fats,ending_proteins:b.stats.proteins,number_meals:b.attributes.num_meals})},
logInstacartOpenModal:function(){amplitude.logEvent("instacart_modal");googleanalytics("send","event","instacart","click","open_modal")},logAmazonOpenModal:function(){amplitude.logEvent("amazonfresh_modal");googleanalytics("send","event","amazonfresh","click","open_modal")},logAmazonRecipeOpenModal:function(){amplitude.logEvent("amazonfresh_modal");googleanalytics("send","event","amazonfresh","click","open_recipe_modal")},logInstacartClick:function(){var a=0,b=0;ETM.groceries_and_pantry.grocery_list.each(function(c){b++;
a+=c.stats.price});amplitude.logEvent("instacart_start_order",{num_items:b,est_cost:a});googleanalytics("send","event","instacart","click","num_items",b);googleanalytics("send","event","instacart","click","est_cost",a)},logMealRefresh:function(a,b,c){c===ETM.ALTERNATE_MEAL_CHOSEN?amplitude.logEvent("alternate_meal_chosen"):0.1>Math.random()&&amplitude.logEvent("meal_refresh");if(ETM.is_logged_in&&ETM.ANALYTICS_ENABLED){var d={};d.previous_foods=a;d.new_foods={};b.attributes.foods.each(function(a){d.new_foods[a.attributes.food.attributes.id]=
a.attributes.amount});d.meal=parseIdFromResourceURI(b.id);d.previous_foods=JSON.stringify(d.previous_foods);d.new_foods=JSON.stringify(d.new_foods);switch(c){case ETM.MAP_SEARCH_MEAL_CHOSEN:case ETM.ALTERNATE_MEAL_CHOSEN:d.user_chosen_meal_type=c}$.ajax({url:"/analytics/meal_refresh/",data:d,type:"POST",error:function(a,b,c){console.log("Ajax error logging meal refresh "+b)}})}},changeNumMeals:function(){},logEatenMeal:function(a,b){a.attributes.eaten?amplitude.logEvent("log_meal_eaten"):amplitude.logEvent("unlog_meal_eaten");
if(ETM.ANALYTICS_ENABLED){var c={};c.eaten=a.attributes.eaten;c.meal_id=a.attributes.id;c.food_ids=[];a.attributes.foods.each(function(a){c.food_ids.push(a.attributes.food.attributes.id)});c.food_ids=JSON.stringify(c.food_ids);$.ajax({url:"/analytics/eaten_meal/",data:c,type:"POST",error:function(a,b,c){console.log("Ajax error logging eaten meal "+b)}})}},logSwapMeal:function(a,b){ETM.ANALYTICS_ENABLED&&$.ajax({url:"/analytics/swap_meal/",data:{orig_meal_id:a,swap_meal_id:b},type:"POST",error:function(a,
b,e){console.log("Ajax error logging swapped meal "+b)}})}};function extractRootDomain(a){a=extractHostname(a);var b=a.split("."),c=b.length;2<c&&(a=b[c-2]+"."+b[c-1]);return a}function extractHostname(a){a=-1<a.indexOf("://")?a.split("/")[2]:a.split("/")[0];a=a.split(":")[0];return a=a.split("?")[0]}ETM.AssignedDietSet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/assigneddietset/"});ETM.AssignedDietSetList=Backbone.Collection.extend({model:ETM.AssignedDietSet,url:ROOT+"/assigneddietset/"});
ETM.BlockedFood=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/blockedfood/",initialize:function(){Backbone.AssociatedModel.prototype.initialize.call(this);this.attributes.food_resource_uri="string"==typeof this.attributes.food?this.attributes.food:this.attributes.food.attributes.resource_uri},toJSONFull:function(){var a=Backbone.AssociatedModel.prototype.toJSONFull.apply(this,arguments);if("string"===typeof a.food||a.food instanceof String){var b=ETM.food_info_object_list.get(a.food);null!=b&&(a.food=
b.toJSONFull())}return a}});
ETM.BlockedFoodList=Backbone.Collection.extend({model:ETM.BlockedFood,url:ROOT+"/blockedfood/",loadFoodInfoObjects:function(){var a=$.Deferred(),b=this,c=[];this.forEach(function(a){c.push(a.attributes.food)});ETM.food_info_object_list.addAndFetchMissing(c,function(){b.listenTo(b,"add",function(a){ETM.food_info_object_list.get(a.attributes.food).trigger("addBlock")},this);b.listenTo(b,"remove",function(a){ETM.food_info_object_list.get(a.attributes.food).trigger("removeBlock")},this);a.resolve()});
return a.promise()}});
ETM.BrowseCollectionsModel=Backbone.Model.extend({initialize:function(){this.collection_models={my_collections:new ETM.FoodCollectionList,followed_collections:new ETM.FollowedFoodCollectionList,featured_collections:new ETM.FeaturedFoodCollectionList};ETM.current_user_profile.isManaged()&&(this.collection_models.trainer_collections=new ETM.TrainerFoodCollectionList);this.fetched_default_collections=!1},setFetchListener:function(a){var b=this;this.listenTo(this,"fetch_complete",function(){var c=!0;
_.each(Object.keys(this.collection_models),function(a){b.collection_models[a].fetch_complete||(c=!1)});c&&(b.stopListening(b,"fetch_complete"),a())})},reloadCollections:function(a){var b=this;this.setFetchListener(a);_.each(Object.keys(this.collection_models),function(a){var d=b.collection_models[a];d.fetch_complete=!1;d.fetch().done(function(){ETM.is_mobile&&_.each(d.models,function(a){a.setCollectionImageUrlForMobile()});d.fetch_complete=!0;b.trigger("fetch_complete")})})},fetchDefaultCollections:function(a){var b=
this;this.fetched_default_collections?a():this.reloadCollections(function(){b.fetched_default_collections=!0;a()})},getUserCollectionsList:function(){var a=[];this.collection_models.my_collections.each(function(b){b.attributes.deleted||a.push(b)});this.collection_models.followed_collections.each(function(b){a.push(b)});return a},getUserCollectionsFormList:function(){var a=[];this.collection_models.my_collections.each(function(b){b.attributes.deleted||a.push({val:b.getShortURI(),label:b.attributes.title})});
this.collection_models.followed_collections.each(function(b){a.push({val:b.getShortURI(),label:b.attributes.title})});ETM.current_user_profile.isManaged()&&this.collection_models.trainer_collections&&this.collection_models.trainer_collections.each(function(b){var c={val:b.getShortURI(),label:b.attributes.title};0===a.filter(function(a){return a.val===c.val}).length&&a.push(c)});return a},collectionIsOwnedOrFollowed:function(a){return this.collection_models.my_collections.findWhere({id:a.attributes.id})||
this.collection_models.followed_collections.findWhere({id:a.attributes.id})},findCollection:function(a){for(var b in this.collection_models)if(this.collection_models.hasOwnProperty(b)){var c=this.collection_models[b].find(a);if(c)return c}},hasUserCollections:function(){return 0<this.collection_models.my_collections.length||0<this.collection_models.followed_collections.length}});
ETM.CalendarDiet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/calendar/",relations:[{type:Backbone.One,key:"diet",relatedModel:"ETM.Diet",customSerialize:function(a){return null==a?null:null==a.attributes.resource_uri?a:a.attributes.resource_uri}}],initializeEvents:function(){var a=this;this.stopListening();null!=this.attributes.diet&&this.listenTo(this.attributes.diet,"deleteCalendarDiet",function(){delete ETM.calendar_list.date_index[a.attributes.date];a.destroy()})}});
ETM.CalendarDietList=Backbone.Collection.extend({url:ROOT+"/calendar/",model:ETM.CalendarDiet,buffer_range:7,selected_index:3,comparator:function(a){return Helper.parseDateString(a.get("date")).getTime()},initialize:function(a,b){this.date_index={};this.selected_date=b.selected_date;this.invalidate_selected_date=!1;this.end_date=this.start_date=null},hasDateString:function(a){return _.has(this.date_index,a)},findDiet:function(a){for(var b=0;b<this.models.length;b++){var c=this.models[b];if(c.attributes.diet.attributes.resource_uri===
a||c.attributes.diet.attributes.id==a)return c.attributes.diet}return null},getDietsFromStartAndEndDateForUser:function(a,b,c,d){this.getDietsFromStartAndEndDate(b,c,d,beforeSend=function(b){b.setRequestHeader("Use-Client-User-Id",a)})},getDietsFromStartAndEndDate:function(a,b,c,d){var e=this,f=[],g=0;for(a=new Date(a.getTime());a<=b&&1E3>g;a.setDate(a.getDate()+1)){var h=Helper.convertDateToString(a);_.has(this.date_index,h)||f.push(h);g++}if(0<f.length)return this.updateDietIndex("starting_download",
f),b=f.join(","),this.fetch({remove:!1,data:{date__in:b},beforeSend:d?d:null,success:function(a,b,d){e.updateDietIndex("add_list",f);null!=c&&c(a);e.trigger("finishedDownloading")}});null!=c&&c(this);e.trigger("finishedDownloading")},loadCalendarJson:function(a){var b=this,c=[];_.each(a,function(a){var e=b.findWhere({date:a.date});e?e.set(a):(b.add(a),c.push(a.date))});0<c.length&&this.updateDietIndex("add_list",c)},getDownloadedCalendarDiet:function(a){a=Helper.convertDateToString(a);return this.date_index[a]},
getCalendarDietData:function(a,b){var c=this,d=Helper.convertDateToString(a);_.has(this.date_index,d)&&"generating"!==this.date_index[d]&&"downloading"!==this.date_index[d]?b(this.date_index[d]):(this.updateDietIndex("starting_download",[d]),this.fetch({remove:!1,data:{date__in:d},success:function(a,f,g){c.updateDietIndex("add_list",[d]);b&&"undefined"!=typeof b&&b(c.date_index[d])}}))},getCalendarDietsData:function(a,b){var c=this;if(0<a.length){this.updateDietIndex("starting_download",a);var d=
a.join(",");return this.fetch({remove:!1,data:{date__in:d},success:function(d,f,g){c.updateDietIndex("add_list",a);null!=b&&b(d)}})}null!=b&&b()},getCalendarDietThen:function(a,b){var c=this,d=Helper.convertDateToString(a);_.has(this.date_index,d)?b(this.date_index[d]):(this.updateDietIndex("starting_download",[d]),this.fetch({remove:!1,data:{date__in:d},success:function(a,f,g){c.updateDietIndex("add_list",[d]);b(c.date_index[d])}}))},getCalendarDiet:function(a,b){var c=this,d=Helper.convertDateToString(a);
if(_.has(this.date_index,d))return this.date_index[d];this.updateDietIndex("starting_download",[d]);this.fetch({remove:!1,data:{date__in:d},success:function(a,f,g){c.updateDietIndex("add_list",[d]);b&&"undefined"!=typeof b&&b(a)}});return"downloading"},getCalendarDietWithBuffer:function(a,b){null!==this.start_date&&null!==this.end_date?this.getDietsFromStartAndEndDate(this.start_date,this.end_date,b):this.getDietsFromStartAndEndDate(Helper.addDays(this.selected_date,-3),Helper.addDays(this.selected_date,
3),b)},finishedWeeklyPlannerV2:function(a){var b=this;"string"===typeof a?(Backbone.trigger("flash",{message:"There was an error trying to regenerate: "+a,type:"danger"}),ETM.generator_status.trigger("finishedWeeklyPlannerAndDownloadedNewDiet",a)):(a.forEach(function(a){a=new ETM.CalendarDiet(a);b.add(a);b.date_index[a.attributes.date]=a;b.trigger(a.attributes.date,{status:"okay",diet_object:a.attributes.diet})}),ETM.generator_status.trigger("finishedWeeklyPlannerAndDownloadedNewDiet"))},regenerateWeeks:function(a){ETM.current_user_profile.triggered_regenerate_week=
!0;a.reset_groceries&&ETM.groceries_and_pantry&&(ETM.groceries_and_pantry.grocery_list&&ETM.groceries_and_pantry.grocery_list.reset([],{silent:!0}),ETM.groceries_and_pantry.listenToWeeklyPlannerComplete());this.clearDietsForGenerating(a.regenerate_weeks);this.listenToWeeklyPlannerComplete()},listenToWeeklyPlannerComplete:function(){var a=this;this.listenToOnce(ETM.generator_status,"finishedWeeklyPlanner",function(b){ETM.current_user_profile.triggered_regenerate_week=!1;var c=Object.keys(a.date_index);
_.each(c,function(b){"generating"===a.date_index[b]?delete a.date_index[b]:"object"===typeof a.date_index[b]&&a.date_index[b].attributes.currently_generating&&delete a.date_index[b]});"ERROR"===b&&Backbone.trigger("flash",{message:"There was an error trying to regenerate.  We've been notified and will look into it!",type:"danger"});"TIMEOUT"===b&&Backbone.trigger("flash",{message:"The regenerate request timed out.  This may be due to heavy load or a technical issue.  We've been notified and will look into it!  Please wait and try again.",
type:"danger"});"no scored plans were generated"===b&&Backbone.trigger("flash",{message:"The generator was unable to to generate any meal plans.  Please try loosening some of your contraints.",type:"danger"});"string"===typeof b&&10<b.length&&Backbone.trigger("flash",{message:b,type:"danger"});a.getCalendarDietWithBuffer(a.selected_date,function(){ETM.generator_status.trigger("finishedWeeklyPlannerAndDownloadedNewDiet",b)})})},clearDietsForGenerating:function(a){var b=this;a.forEach(function(a){var d=
a.split(",");a=d[0].split("-");var d=d[1].split("-"),d=new Date(d[0],d[1]-1,d[2]),e=0;for(a=new Date(a[0],a[1]-1,a[2]);a<=d&&1E3>e;a.setDate(a.getDate()+1)){var f=Helper.convertDateToString(a);b.date_index.hasOwnProperty(f)&&"object"===typeof b.date_index[f]&&b.remove(b.date_index[f],{silent:!0});b.date_index[f]="generating";b.trigger(f,{status:"generating"});e++}})},reloadDietsBetweenDates:function(a,b,c){for(var d=[],e=0;a<=b&&1E3>e;a.setDate(a.getDate()+1)){var f=Helper.convertDateToString(a);
d.push(f);e++}this.reloadDietsInDateList(d,c)},reloadDietsInRanges:function(a,b){var c=[];a.forEach(function(a){var b=a.split(",");a=b[0].split("-");var b=b[1].split("-"),b=new Date(b[0],b[1]-1,b[2]),f=0;for(a=new Date(a[0],a[1]-1,a[2]);a<=b&&1E3>f;a.setDate(a.getDate()+1)){var g=Helper.convertDateToString(a);c.push(g);f++}});this.reloadDietsInDateList(c,b)},reloadDietsInDateList:function(a,b){var c=this,d=[];a.forEach(function(a){"object"===typeof c.date_index[a]&&c.remove(c.date_index[a],{silent:!0});
d.push(a)});if(0<d.length){this.updateDietIndex("starting_download",d);var e=d.join(",");return this.fetch({remove:!1,data:{date__in:e},success:function(a,e,h){c.updateDietIndex("add_list",d);b&&"undefined"!=typeof b&&b()}})}},updateDietIndex:function(a,b){if("add_list"===a)for(var c=0;c<b.length;c++){var d=b[c],e=this.findWhere({date:d});e?e.attributes.currently_generating?(this.date_index[d]="generating",this.trigger(d,{status:"generating"})):null===e.attributes.diet?(this.date_index[d]="blank",
this.trigger(d,{status:"blank"})):(this.date_index[d]=e,this.trigger(d,{status:"okay",diet_object:e.attributes.diet})):(this.date_index[d]="blank",this.trigger(d,{status:"blank"}))}else if("starting_download"===a)for(c=0;c<b.length;c++)d=b[c],this.date_index[d]="downloading",this.trigger(d,{status:"downloading"})}});
var mapNutritionProfile=function(a){if(_.isObject(a))return a;var b=ETM.nutrition_profile_list&&ETM.nutrition_profile_list.find(function(b){return b.get(b.idAttribute)===a});b||(b=ETM.client_nutrition_profile_list&&ETM.client_nutrition_profile_list.find(function(b){return b.get(b.idAttribute)===a}));return b?b:{}},currently_generated_diet;
ETM.Diet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/diet/",defaults:{title:"My meal plan",num_meals:4,date_added:null,user:null,diet_key:null,sandbox:0,nutrition_profile:null},relations:[{type:Backbone.Many,key:"meals",relatedModel:"ETM.MealObject",collectionType:"ETM.MealList",customSerialize:function(a){if(!a.diet.update_nutrition_profile)return a.models.slice(0,a.diet.attributes.num_meals)}},{type:Backbone.One,key:"nutrition_profile",relatedModel:"ETM.NutritionProfile",map:mapNutritionProfile,
customSerialize:function(a){return null!=a.attributes.resource_uri?a.attributes.resource_uri:a}}],initialize:function(){this.parent=null;this.setParent();this.is_diet_set=!1;null!=this.attributes.meals&&(this.attributes.meals.diet=this);this.initializeEvents();this.calculateStats()},setupBlankDiet:function(){this.attributes.user||(this.attributes.user=new ETM.UserProfile,ETM.user_profiles_list.add(this.attributes.user));if(!this.attributes.nutrition_profile){var a=ETM.nutrition_profile_list.findWhere({title:"My Nutrition Targets"});
a||(a=ETM.nutrition_profile_list.findWhere({deleted:!1}),a||(a=new ETM.NutritionProfile,ETM.nutrition_profile_list.add(a),0==this.attributes.sandbox&&a.save(null,{async:!1,validate:!1})));this.attributes.nutrition_profile=a}"undefined"==typeof this.attributes.meals&&(this.attributes.meals=new ETM.MealList,0==this.attributes.sandbox&&this.attributes.meals.createMealsIfNeeded());this.attributes.meals.diet=this;this.calculateStats()},setParent:function(){_.has(this,"parents")&&1==this.parents.length&&
(this.parents[0]instanceof ETM.TemplateDiet||this.parents[0]instanceof ETM.CalendarDiet)?this.parent=this.parents[0]:_.has(this,"collection")&&_.has(this.collection,"parents")&&1==this.collection.parents.length&&this.collection.parents[0]instanceof ETM.DietPlanSet&&(this.parent=this.collection.parents[0])},isCalendar:function(){return this.hasParent()&&this.parent instanceof ETM.CalendarDiet},getParent:function(){return this.parent},hasParent:function(){return _.has(this,"parent")&&null!==this.parent},
initializeEvents:function(){var a=this;this.listenTo(this,"deleteDiet",function(){this.attributes.meals.forEach(function(a){a.set("delete_other_foods",!0);a.get("foods").reset()});this.save(null,{success:function(a){a.attributes.meals.each(function(a){delete a.attributes.delete_other_foods;delete a.attributes.delete_other_foods_except_leftovers})}})},this);this.listenTo(this,"updateStats:meals",function(b,c){a.calculateStats();a.trigger("updateStats")});this.listenTo(this,"remove:meals",function(b,
c){a.calculateStats();a.trigger("updateStats")});this.listenTo(this,"add:meals",function(b,c){a.calculateStats();b.parent=this;a.trigger("updateStats")});this.listenTo(this,"change:num_meals",function(){a.createMealsIfNeeded();a.calculateStats();a.trigger("updateStats")});this.listenTo(this,"change updateStats",function(){ETM.currently_generating||ETM.generator_results_cache.clearCache()},this)},createMealsIfNeeded:function(){var a=this.get("num_meals"),b=this.get("meals"),c=b.length;if(c<a){var d=
ETM.meal_type_list.findWhere({title:"Snack"});"undefined"===typeof d&&(d=new ETM.MealType,d.attributes.title="Snack",d.attributes.max_cooktime=0,d.attributes.max_preptime=15,d.attributes.max_totaltime=15,d.attributes.size_slider=75,ETM.meal_type_list.add(d),d.save(null,{async:!1}));for(c+=1;c<=a;c++){var e=new ETM.MealObject({meal_number:c-1,meal_type:d,diet_plan:this.id});b.add(e);e.parents=b.parents;e.setParentDiet()}this.save({num_meals:this.get("meals").length},{async:!1})}else this.save({num_meals:a},
{patch:!0,async:!1})},numberLockedMeals:function(){for(var a=0,b=0;b<this.attributes.num_meals;b++)this.meal(b).isLocked()&&a++;return a},meal:function(a){return this.attributes.meals.at(a)},loadDiet:function(a,b,c){var d=this,e=ROOT+"/diet/"+a+"/";d.id=e;d.attributes.id=a;d.attributes.resource_uri=e;d.fetch({reset:!0,silent:!0,success:function(){d.attributes.sandbox=0;Helper.clearIDs(d);d.attributes.meals.each(function(a){Helper.clearIDs(a);a.attributes.foods.each(function(a){Helper.clearIDs(a)})});
d.save(null,{success:function(){b()},error:function(a,b,d){c(b)}})},error:function(a,b,d){c(b)}})},setProgress:function(a,b){app?bridge.callHandler("singleDayGeneratorProgress",a-1):this.trigger("update-progress",a,b)},getV2GenerateJson:function(){var a=this,b=this.toJSONFull({serialize_keys:["id","resource_uri","num_meals","nutrition_profile"]});b.resource_uri=parseInt(b.resource_uri);delete b.meals;delete b.date_added;b.meals=[];this.attributes.meals.each(function(c){c.attributes.meal_number<a.attributes.num_meals&&
b.meals.push(c.getV2GenerateJson())});return b},getV2JsonId:function(){return parseInt(this.id)},getGenerateRequestObject:function(){var a;if(ETM.diet_plan_set&&ETM.diet_plan_set.managed_account){a=$.extend(!0,{},ETM.diet_plan_set.managed_account.attributes.client_user);var b=[];a.exclusions.split(",").forEach(function(a){a=a.trim().toLowerCase();b.push({value:a,label:a})});a.exclusions=b}else a=ETM.current_user_profile.toJSON();"string"!==typeof a.exclusions&&(a.exclusions=JSON.stringify(a.exclusions));
a={user_settings:a,meal_plan_dates:[{date:null,diet:this.toGeneratorJSON()}]};try{a.diet_user_id=this.getParent().attributes.user.id}catch(c){}return a},toGeneratorJSON:function(a){var b=this,c=this.toJSONFull({serialize_keys:["id","resource_uri","num_meals","nutrition_profile"]});delete c.meals;c.meals=[];this.attributes.meals.each(function(d){d.attributes.meal_number<b.attributes.num_meals&&c.meals.push(d.toGeneratorJSON(a))});return c},initV1Generator:function(){this.generator||(this.generator=
ETM.is_logged_in?this.is_diet_set?new ETM.GoGenerators.DayGeneratorDietSet(this):new ETM.GoGenerators.DayGenerator(this):new ETM.GoGenerators.DayGeneratorJson(this))},initV2Generator:function(){this.generator||(this.generator=ETM.is_logged_in?this.is_diet_set?new ETM.GoGenerators.V2DayGeneratorDietSet(this):new ETM.GoGenerators.V2DayGenerator(this):new ETM.GoGenerators.V2DayGeneratorJson(this))},generateOnServer:function(a){bugsnagClient.leaveBreadcrumb("Day generate",{num_meals:this.attributes.num_meals,
target_calories:this.attributes.nutrition_profile.attributes.calories});this.generator&&this.generator.algorithm!=ETM.current_user_profile.attributes.algorithm&&delete this.generator;ETM.current_user_profile.v2AlgorithmEnabled()?this.initV2Generator():this.initV1Generator();this.generator.run(a)},findFoodWithLeftovers:function(a){a=a||!0;if(!ETM.is_premium)return!1;for(var b=0;b<this.attributes.num_meals;b++){var c=this.attributes.meals.at(b);if(!c.attributes.eaten||!a)for(var c=c.attributes.foods.models,
d=0;d<c.length;d++){var e=c[d];if(e.attributes.has_leftovers)return e}}return!1},findFoodThatIsLeftovers:function(){if(!ETM.is_premium)return!1;for(var a=0;a<this.attributes.num_meals;a++)for(var b=this.attributes.meals.at(a).attributes.foods.models,c=0;c<b.length;c++){var d=b[c];if(d.attributes.is_leftovers)return d}return!1},findFoodObject:function(a){for(var b=0;b<this.attributes.num_meals;b++)for(var c=this.attributes.meals.at(b).attributes.foods.models,d=0;d<c.length;d++){var e=c[d];if(a==e.attributes.id)return e}return!1},
combineUnlocked:function(){for(var a=0;a<this.attributes.num_meals;a++){for(var b=[],c=this.meal(a).attributes.foods;0<c.length;){for(var d=0,e=c.shift({silent:!0}),f=0;f<b.length;f++){var g=b[f];if(e.attributes.food.attributes.id===g.attributes.food.attributes.id&&!1===e.isLocked()&&!1==g.isLocked()&&e.attributes.units===g.attributes.units){g.attributes.amount+=e.attributes.amount;g.calculateStats();d=1;break}}0===d&&b.push(e)}this.meal(a).attributes.foods.reset(b,{silent:!0})}},randomGeneratorMealOrder:function(a){for(var b=
[],c=[],d=0;d<this.attributes.num_meals;d++)!1===this.meal(d).isLocked()&&(0<a["meal_"+d].side_dishes.length||0<a["meal_"+d].main_dishes.length)&&(this.meal(d).attributes.meal_type.attributes.only_use_recurring?b.push(d):c.push(d));a=shuffle(b).concat(shuffle(c));return a.concat(a).concat(a)},clearMeal:function(a){a=this.meal(a);if(!a.isLocked()){var b=[];a.attributes.foods.forEach(function(a){a.isLocked()||b.push(a)});0<b.length&&a.attributes.foods.remove(b,{silent:!0})}},clearMealIncludingLocked:function(a){this.meal(a).attributes.foods.reset([],
{silent:!0})},clearMealExceptLeftovers:function(a){a=this.meal(a);var b=[];a.attributes.foods.forEach(function(a){a.attributes.is_leftovers||a.attributes.has_leftovers||b.push(a)});0<b.length&&a.attributes.foods.remove(b,{silent:!0})},addRecurringLockedFoods:function(a){var b=this,c=this.meal(a).attributes.meal_type,d=[];ETM.recurring_foods_list.byMealType(c.id).models.forEach(function(a){1==a.attributes.frequency&&_.has(a.attributes,"amount")&&_.has(a.attributes,"units")&&(a=new ETM.FoodObject({food:a.attributes.food,
amount:a.attributes.amount,units:a.attributes.units}),a.is_recurring_always=!0,d.push(a))});d.forEach(function(c){b.meal(a).attributes.foods.add(c,{silent:!0})});return!1},updateMealAfterGenerating:function(a,b){var c=this.meal(a);c.attributes.foods.models.forEach(function(a){a.attributes.meal=c.attributes.resource_uri});c.attributes.eaten||("undefined"!==typeof b&&!0===b?c.set("delete_other_foods",!0):c.set("delete_other_foods_except_leftovers",!0));c.calculateStats();ETM.use_local_storage&&(Helper.resetLocalFoodInfoIDs(this),
c.parent=this,c.attributes.foods.models.forEach(function(a){a.parent=c;a.save();a.id=parseInt(a.id);a.attributes.id=a.id}))},updateDietAfterGenerating:function(){ETM.use_local_storage&&(Helper.deleteLocalStorageKeysWithPrefix(ETM.MealObject.prototype.urlRoot),Helper.deleteLocalStorageKeysWithPrefix(ETM.FoodObject.prototype.urlRoot),this.attributes.meals.each(function(a){a.save()}));for(var a=0;a<this.attributes.num_meals;a++)this.updateMealAfterGenerating(a)},updateMeals:function(){var a=this;this.get("meals").each(function(b,
c){b.set({meal_number:c,diet_plan:a.id})})},calculateStats:function(){var a=this;a.stats=new ETM.NutritionStatsObject;ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=0});null!=this.attributes.meals&&this.attributes.meals.each(function(b,c){c>=a.get("num_meals")||ETM.NUTRIENT_LIST.forEach(function(c){a.stats[c]+=b.stats[c]})})},calculateAllStats:function(){var a=this;a.stats=new ETM.NutritionStatsObject;ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=0});this.attributes.meals.each(function(b,c){c>=
a.get("num_meals")||(b.calculateStats(),ETM.NUTRIENT_LIST.forEach(function(c){a.stats[c]+=b.stats[c]}))})},returnDietStatsWithoutMeal:function(a){var b=this;stats=new ETM.NutritionStatsObject;ETM.NUTRIENT_LIST.forEach(function(a){stats[a]=0});this.attributes.meals.each(function(c,d){d>=b.get("num_meals")||c.attributes.meal_number===a||(c.calculateStats(),ETM.NUTRIENT_LIST.forEach(function(a){stats[a]+=c.stats[a]}))});return stats},dietStatsMatchTargets:function(){var a=this.attributes.nutrition_profile.attributes.calories,
b=this.stats.calories;if(0.2<Math.abs(b-a)/a)return!1;if("grams"==this.attributes.nutrition_profile.attributes.macro_scheme){var b=this.attributes.nutrition_profile.attributes.min_proteins,a=this.attributes.nutrition_profile.attributes.max_proteins,c=this.attributes.nutrition_profile.attributes.min_fats,d=this.attributes.nutrition_profile.attributes.max_fats,e=this.attributes.nutrition_profile.attributes.min_carbs,f=this.attributes.nutrition_profile.attributes.max_carbs,g=this.stats.proteins,h=this.stats.fats,
m=this.stats.getPrimaryCarbs();if(g<b&&0.2<(b-g)/b||g>a&&0.2<(g-a)/a||h<c&&0.2<(c-h)/c||h>d&&0.2<(h-d)/d||m<e&&0.2<(e-m)/e||m>f&&0.2<(m-f)/f)return!1}else if(a=this.attributes.nutrition_profile.attributes.percent_fats,c=this.attributes.nutrition_profile.attributes.percent_carbs,d=900*this.stats.fats/b,e=400*this.stats.carbs/b,20<Math.abs(400*this.stats.proteins/b-this.attributes.nutrition_profile.attributes.percent_proteins)||20<Math.abs(d-a)||20<Math.abs(e-c))return!1;return!0},getNumberOfActiveMeals:function(){return Math.min(this.attributes.num_meals,
this.attributes.meals.size())},createMergedDietFromTemplate:function(a){a=ETM.template_diet_list.getTemplateDietAtIndex(a).attributes.diet.clone();a.attributes.sandbox=0;Helper.clearIDs(a);a.attributes.meals.each(function(a){Helper.clearIDs(a)});if(1>a.attributes.meals.length)return a;for(var b=0;b<a.attributes.num_meals;b++)for(var c=a.attributes.meals.at(b),d=0;d<this.attributes.num_meals;d++){var e=this.attributes.meals.at(d);c.attributes.meal_type.attributes.id===e.attributes.meal_type.attributes.id&&
(this.transferFoodsFromMeal(c,e),this.attributes.meals.remove(e),this.attributes.num_meals--,d--)}if(0<this.attributes.num_meals&&(c=this.getFirstBreakfastMeal(a.attributes.meals)))for(b=0;b<this.attributes.num_meals;b++)e=this.attributes.meals.at(b),e.attributes.meal_type.attributes.breakfast===ETM.MealType.prototype.breakfast_choices.ONLY_BREAKFAST_FOODS&&(this.transferFoodsFromMeal(c,e),this.attributes.meals.remove(e),this.attributes.num_meals--,b--);if(0<this.attributes.num_meals&&(c=this.getFirstSnackMeal(a.attributes.meals)))for(b=
0;b<this.attributes.num_meals;b++)e=this.attributes.meals.at(b),(d=e.attributes.meal_type.attributes.title)&&-1!==d.toLowerCase().indexOf(ETM.MealType.prototype.default_extra_meal_title.toLowerCase())&&(this.transferFoodsFromMeal(c,e),this.attributes.meals.remove(e),this.attributes.num_meals--,b--);if(0<this.attributes.num_meals)for(d=a.attributes.meals.length,b=0;b<this.attributes.num_meals;b++)e=this.attributes.meals.at(b),c=e.attributes.meal_number,c>=d&&(c=d-1),c=a.attributes.meals.at(c),this.transferFoodsFromMeal(c,
e);return a},transferFoodsFromMeal:function(a,b){for(var c=0;c<b.attributes.foods.length;c++){var d=b.attributes.foods.at(c);d.attributes.meal=a.attributes.resource_uri;a.attributes.foods.push(d)}},getFirstBreakfastMeal:function(a){for(var b=0;b<a.length;b++){var c=a.at(b);if(2===c.attributes.meal_type.attributes.breakfast)return c}},getFirstSnackMeal:function(a){for(var b=0;b<a.length;b++){var c=a.at(b),d=c.attributes.meal_type.attributes.title;if(d&&-1!==d.toLowerCase().indexOf("snack"))return c}},
printMealAndFoodIds:function(){this.attributes.meals.each(function(a){console.log("meal "+a.attributes.id);a.attributes.foods.each(function(a){console.log("    food obj "+a.attributes.id+"-> food info "+a.attributes.food.attributes.id+" "+a.attributes.food.attributes.food_name)});console.log("-----")})},printMealAndFoodResourceUris:function(){this.attributes.meals.each(function(a){console.log("meal "+a.attributes.resource_uri);a.attributes.foods.each(function(a){console.log("    food obj "+a.attributes.resource_uri+
"-> food info "+a.attributes.food.attributes.resource_uri+" "+a.attributes.food.attributes.food_name)});console.log("-----")})}});ETM.DietCollection=Backbone.Collection.extend({findDiet:function(a){var b=this.findWhere({resource_uri:a});null==b&&(b=this.get(a));return b}});ETM.LocalStorageDietList=ETM.DietCollection.extend({url:ROOT+"/diet/",model:ETM.Diet});ETM.DietList=ETM.DietCollection.extend({url:ROOT+"/dietlist/",model:ETM.Diet,comparator:function(a){return-1*moment(a.get("date_added")).valueOf()}});
ETM.DietPlanSetDietList=ETM.DietCollection.extend({url:ROOT+"/dietlist/",model:ETM.Diet});var mapDiet=function(a){if(_.isObject(a))return a;var b=new ETM.Diet({user:{},nutrition_profile:{},meals:{}});b.id=a;b.fetch({async:!1});return b};function roundNumber(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)}ETM.NutritionStatsObject=function(){};
ETM.NutritionStatsObject.prototype.getPrimaryCarbs=function(){if(ETM.current_user_profile.attributes.use_net_carbs){var a=this.carbs-this.fiber;return 0>a?0:a}return this.carbs};ETM.NutritionStatsObject.prototype.getSecondaryCarbs=function(){if(ETM.current_user_profile.attributes.use_net_carbs)return this.carbs;var a=this.carbs-this.fiber;return 0>a?0:a};
ETM.DietPlanSet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/publicdietset/",url:function(){var a=this.userIsOwner()?"fulldietset":"publicdietset";return ROOT+"/"+a+"/"+this.attributes.diet_key+""+this.attributes.id+"/"},userIsOwner:function(){return this.attributes.diet_set_owner_username===ETM.current_user_profile.attributes.username},relations:[{type:Backbone.Many,key:"diets",relatedModel:"ETM.Diet",collectionType:"ETM.DietPlanSetDietList"}],initialize:function(){this.selected_index=0;this.listenTo(this,
"sync",function(a){a.attributes.diets.each(function(a){a.is_diet_set=!0})})},confirmRegenerate:function(a,b){var c=this;Helper.confirmationPopover({element:a,title:"Are you sure you want to regenerate?",message:"<p>This will replace all foods in this plan.</p>",position:"bottom",cancel_text:"Cancel",confirm_text:"Yes",confirmCallback:function(){a.prop("disabled",!0);$("#main_container .plan_container").html(Helper.getLoadingSpinnerHTML());ETM.generator_results_cache&&ETM.generator_results_cache.clearCache();
if(ETM.current_user_profile.v2AlgorithmEnabled()){var d={diet_set_id:c.attributes.id,existing_food_info_ids:JSON.stringify(Helper.getExistingFoodInfoIds())};c.managed_account&&(d.client_user_id=c.managed_account.attributes.client_id);$.ajax({type:"POST",url:"/g/generate/week/",dataType:"json",data:d,success:function(a){Helper.displayIssues(a.issues);b(a)},error:function(){a.prop("disabled",!1);Backbone.trigger("flash",{message:"There was an error regenerating this saved plan.",type:"danger"});ETM.renderDietSet()}})}else $.ajax({type:"POST",
url:"/weeklyplanner/regenerate-diet-set/",data:{diet_set_id:c.attributes.id},success:function(a){b(a)},error:function(){a.prop("disabled",!1);Backbone.trigger("flash",{message:"There was an error regenerating this saved plan.",type:"danger"})}})}})},updateFromJson:function(a){var b=this;_.each(a,function(a){a=a.diet;var d=b.getDietFromID(a.id);d?d.set(a):bugsnagClient.notify(Error("Diet set id missing on regenerate"))})},getDietFromID:function(a){return this.attributes.diets.findWhere({id:a})},getIndexFromID:function(a){for(var b=
0;b<this.attributes.diets.length;b++)if(this.attributes.diets.models[b].attributes.id===a)return b;return-1},findDiet:function(a){return this.attributes.diets.findDiet(a)}});ETM.BasicDietPlanSet=Backbone.Model.extend({urlRoot:ROOT+"/dietplanset/",initialize:function(){this.on("change:title change:description change:tags",function(a,b){a.save(null,{patch:!0})})}});
ETM.BasicDietPlanSetList=Backbone.Collection.extend({url:ROOT+"/dietplanset/",model:ETM.BasicDietPlanSet,comparator:function(a){return-1*moment(a.get("created")).valueOf()}});ETM.UserSortedDietPlanSetList=Backbone.Collection.extend({url:ROOT+"/dietplanset/",model:ETM.BasicDietPlanSet,comparator:function(a){return a.attributes.client_user?-1*a.attributes.client_user.id-2:0}});ETM.Direction=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/directions/",sync:function(){return!1}});
ETM.DirectionsList=Backbone.Collection.extend({model:ETM.Direction,url:ROOT+"/directions/",sync:function(){return!1}});
ETM.FavoriteFood=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/favoritefood/",initialize:function(){Backbone.AssociatedModel.prototype.initialize.call(this);this.attributes.food_resource_uri="string"==typeof this.attributes.food?this.attributes.food:this.attributes.food.attributes.resource_uri},toJSONFull:function(){var a=Backbone.AssociatedModel.prototype.toJSONFull.apply(this,arguments);if("string"===typeof a.food||a.food instanceof String){var b=ETM.food_info_object_list.get(a.food);null!=b&&
(a.food=b.toJSONFull())}return a}});
ETM.FavoriteFoodList=Backbone.Collection.extend({model:ETM.FavoriteFood,url:ROOT+"/favoritefood/",loadFoodInfoObjects:function(){var a=$.Deferred(),b=this,c=[];this.forEach(function(a){c.push(a.attributes.food)});ETM.food_info_object_list.addAndFetchMissing(c,function(){b.listenTo(b,"add",function(a){ETM.food_info_object_list.get(a.attributes.food).trigger("addFavorite")},this);b.listenTo(b,"remove",function(a){ETM.food_info_object_list.get(a.attributes.food).trigger("removeFavorite")},this);a.resolve()});
return a.promise()}});ETM.FoodImage=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/image/"});ETM.FoodImageList=Backbone.Collection.extend({urlRoot:ROOT+"/image/",model:ETM.FoodImage});
ETM.default_icons={recipes:{1:"/images/food_icons_v3/kebab.png",2:"/images/food_icons_v3/cinnamon_roll.png",3:"/images/food_icons_v3/doughnut.png",4:"/images/food_icons_v3/drink.png",5:"/images/food_icons_v3/steak.png",6:"/images/food_icons_v3/smoothie.png",7:"/images/food_icons_v3/salad.png",8:"/images/food_icons_v3/wrap.png",9:"/images/food_icons_v3/spaghetti.png",10:"/images/food_icons_v3/noodles.png",11:"/images/food_icons_v3/salad.png",12:"/images/food_icons_v3/bento.png",13:"/images/food_icons_v3/kebab.png"},
basic_foods:{100:"/images/food_icons_v3/milk_bottle.png",200:"/images/food_icons_v3/salt.png",300:"/images/food_icons_v3/baby_bottle.png",400:"/images/food_icons_v3/bottle.png",500:"/images/food_icons_v3/chicken.png",600:"/images/food_icons_v3/noodles.png",700:"/images/food_icons_v3/sausage.png",800:"/images/food_icons_v3/cinnamon_roll.png",900:"/images/food_icons_v3/strawberry.png",1E3:"/images/food_icons_v3/sausage.png",1100:"/images/food_icons_v3/carrot.png",1200:"/images/food_icons_v3/soy.png",
1300:"/images/food_icons_v3/steak.png",1400:"/images/food_icons_v3/bottle.png",1500:"/images/food_icons_v3/fish.png",1600:"/images/food_icons_v3/soy.png",1700:"/images/food_icons_v3/steak.png",1800:"/images/food_icons_v3/bread.png",1900:"/images/food_icons_v3/ice_cream.png",2E3:"/images/food_icons_v3/spaghetti.png",2100:"/images/food_icons_v3/hamburger.png",2200:"/images/food_icons_v3/bento.png",2500:"/images/food_icons_v3/cookie.png",3500:"/images/food_icons_v3/food_basket.png",3600:"/images/food_icons_v3/wrap.png"}};
ETM.icon_search={recipes:{1:[["shake smoothie","/images/food_icons_v3/smoothie.png"],["bread toast","/images/food_icons_v3/bread.png"],["kebab","/images/food_icons_v3/kebab.png"]],2:[["egg omelet","/images/food_icons_v3/egg.png"],["shake smoothie","/images/food_icons_v3/smoothie.png"],["oatmeal porridge scramble","/images/food_icons_v3/porridge.png"],["fruit","/images/food_icons_v3/strawberry.png"],["bacon","/images/food_icons_v3/bacon.png"],["sausage","/images/food_icons_v3/sausage.png"],["yogurt",
"/images/food_icons_v3/milk_bottle.png"],["salad","/images/food_icons_v3/salad.png"],["pancake","/images/food_icons_v3/pancake.png"],["pancake roll","/images/food_icons_v3/cinnamon_roll.png"]],3:[["cake doughnut donut","/images/food_icons_v3/doughnut.png"],["honey","/images/food_icons_v3/honey.png"],["chocolate","/images/food_icons_v3/chocolate.png"],["cream","/images/food_icons_v3/ice_cream.png"]],4:[["drink","/images/food_icons_v3/drink.png"]],5:[["fish halibut salmon cod tuna","/images/food_icons_v3/fish.png"],
["chicken cornish","/images/food_icons_v3/chicken.png"],["lamb","/images/food_icons_v3/lamb.png"],["pizza","/images/food_icons_v3/pizza.png"],["burger","/images/food_icons_v3/hamburger.png"],["beef steak sirloin roast","/images/food_icons_v3/steak.png"]],6:[["shake smoothie","/images/food_icons_v3/smoothie.png"]],7:[["salad","/images/food_icons_v3/salad.png"]],8:[["burger","/images/food_icons_v3/hamburger.png"],["taco","/images/food_icons_v3/taco.png"],["sandwich","/images/food_icons_v3/sandwich.png"],
["wrap burrito quesadilla","/images/food_icons_v3/wrap.png"]],9:[["","/images/food_icons_v3/spaghetti.png"]],10:[["","/images/food_icons_v3/noodles.png"]],11:[["carrot","/images/food_icons_v3/carrot.png"],["steak","/images/food_icons_v3/steak.png"],["pizza","/images/food_icons_v3/pizza.png"],["burger","/images/food_icons_v3/hamburger.png"],["taco gordita","/images/food_icons_v3/taco.png"],["wrap burrito quesadilla","/images/food_icons_v3/wrap.png"],["fish halibut salmon cod tuna","/images/food_icons_v3/fish.png"],
["chicken cornish","/images/food_icons_v3/chicken.png"],["beef steak sirloin roast","/images/food_icons_v3/steak.png"],["sandwich","/images/food_icons_v3/sandwich.png"],["rice bake souffl","/images/food_icons_v3/porridge.png"],["potato","/images/food_icons_v3/potato.png"],["lamb","/images/food_icons_v3/lamb.png"],["shake smoothie","/images/food_icons_v3/smoothie.png"],["shrimp seafood","/images/food_icons_v3/prawn.png"],["","/images/food_icons_v3/noodles.png"]],12:[["","/images/food_icons_v3/bento.png"]],
13:[["","/images/food_icons_v3/kebab.png"]]},basic_foods:{100:[["cheese","/images/food_icons_v3/cheese.png"],["egg","/images/food_icons_v3/egg.png"],["","/images/food_icons_v3/milk_bottle.png"]],200:[["salt","/images/food_icons_v3/salt.png"],["","/images/food_icons_v3/pepper_shaker.png"]],300:[["","/images/food_icons_v3/baby_bottle.png"]],400:[["","/images/food_icons_v3/bottle.png"]],500:[["","/images/food_icons_v3/chicken.png"]],600:[["","/images/food_icons_v3/noodles.png"]],700:[["","/images/food_icons_v3/sausage.png"]],
800:[["","/images/food_icons_v3/porridge.png"]],900:[["avocado","/images/food_icons_v3/avocado.png"],["strawberr blueberr","/images/food_icons_v3/strawberry.png"],["watermelon","/images/food_icons_v3/watermelon.png"],["tomato","/images/food_icons_v3/tomato.png"],["apple","/images/food_icons_v3/apple.png"],["pear","/images/food_icons_v3/pear.png"],["grape","/images/food_icons_v3/grape.png"],["lemon","/images/food_icons_v3/lemon.png"],["","/images/food_icons_v3/apple.png"]],1E3:[["","/images/food_icons_v3/sausage.png"]],
1100:[["broccoli","/images/food_icons_v3/broccoli.png"],["tomato","/images/food_icons_v3/tomato.png"],["pepper","/images/food_icons_v3/red_pepper.png"],["mushroom","/images/food_icons_v3/mushroom.png"],["corn","/images/food_icons_v3/corn.png"],["carrot","/images/food_icons_v3/carrot.png"]],1200:[["peanut","/images/food_icons_v3/peanut.png"],["flour","/images/food_icons_v3/flour.png"],["hazel","/images/food_icons_v3/hazelnut.png"]],1300:[["","/images/food_icons_v3/steak.png"]],1400:[["","/images/food_icons_v3/drink.png"]],
1500:[["crab","/images/food_icons_v3/crab.png"],["shrimp prawn","/images/food_icons_v3/prawn.png"],["","/images/food_icons_v3/fish.png"]],1600:[["soy","/images/food_icons_v3/soy.png"],["peanut","/images/food_icons_v3/peanut.png"],["flour","/images/food_icons_v3/flour.png"],["","/images/food_icons_v3/soy.png"]],1700:[["","/images/food_icons_v3/steak.png"]],1800:[["","/images/food_icons_v3/bread.png"]],1900:[["drink","/images/food_icons_v3/smoothie.png"],["donut doughnut cake","/images/food_icons_v3/doughnut.png"],
["sugar splenda aspartame","/images/food_icons_v3/sugar.png"],["honey syrup","/images/food_icons_v3/honey.png"],["","/images/food_icons_v3/ice_cream.png"]],2E3:[["flour","/images/food_icons_v3/flour.png"],["","/images/food_icons_v3/spaghetti.png"]],2100:[["burger","/images/food_icons_v3/fast_food.png"],["wrap","/images/food_icons_v3/fast_food.png"],["","/images/food_icons_v3/fast_food.png"]],2200:[["pizza","/images/food_icons_v3/pizza.png"],["burger","/images/food_icons_v3/hamburger.png"],["chicken turkey",
"/images/food_icons_v3/chicken.png"],["sandwich hoagie ","/images/food_icons_v3/sandwich.png"],["","/images/food_icons_v3/bento.png"]],2500:[["pretzel","/images/food_icons_v3/pretzel.png"],["","/images/food_icons_v3/cookie.png"]],3500:[["","/images/food_icons_v3/bento.png"]],3600:[["","/images/food_icons_v3/wrap.png"]]}};
RESTAURANT_LOGOS={Dennys:"images/restaurant_logos/dennys_thumb.png","Starbucks Coffee":"images/restaurant_logos/starbucks_thumb.png",Starbucks:"images/restaurant_logos/starbucks_thumb.png","Subway Sandwiches":"images/restaurant_logos/subway_thumb.png","Carl's Jr.":"images/restaurant_logos/carls_jr_thumb.png","Chipotle Mexican Grill":"images/restaurant_logos/chipotle_thumb.png","Panda Express":"images/restaurant_logos/panda_express_thumb.png",Sbarro:"images/restaurant_logos/sbarro_thumb.png","Taco Bell":"images/restaurant_logos/taco_bell_thumb.png",
"Arby's":"images/restaurant_logos/arbys_thumb.png","Olive Garden":"images/restaurant_logos/olive_garden_thumb.png","Tim Hortons":"images/restaurant_logos/tim_hortons_thumb.png","McDonald's":"images/restaurant_logos/mcdonalds_thumb.png","Wendy's":"images/restaurant_logos/wendys_thumb.png",IHOP:"images/restaurant_logos/ihop_thumb.png","Pita Pit":"images/restaurant_logos/pita_pit_thumb.png","Jimmy John's":"images/restaurant_logos/jimmy_johns_thumb.png","Applebee's":"images/restaurant_logos/applebees_thumb.png",
"Panera Bread":"images/restaurant_logos/panera_thumb.png","Burger King":"images/restaurant_logos/burger_king_thumb.png","In-N-Out":"images/restaurant_logos/innout_thumb.png","IN-N-OUT Burger":"images/restaurant_logos/innout_thumb.png","Jack in the Box":"images/restaurant_logos/jackinthebox_thumb.png","El Pollo Loco":"images/restaurant_logos/el_pollo_loco_thumb.png","Trader Joe's":"images/restaurant_logos/trader_joes_thumb.png","My Fit Foods":"images/restaurant_logos/my_fit_foods_thumb.png","Jersey Mike's Subs":"images/restaurant_logos/jersey_mikes_thumb.png",
Boloco:"images/restaurant_logos/boloco_thumb.png","Bob Evans Farms Inc.":"images/restaurant_logos/bob_evans_thumb.png",Sonic:"images/restaurant_logos/sonic_thumb.png","Red Lobster":"images/restaurant_logos/red_lobster_thumb.png","Au Bon Pain":"images/restaurant_logos/au_bon_pain_thumb.png",Souplantation:"images/restaurant_logos/souplantation_thumb.png","Pizza Hut":"images/restaurant_logos/pizza_hut_thumb.png","Del Taco":"images/restaurant_logos/del_taco_thumb.png","Popeyes Chicken & Biscuits":"images/restaurant_logos/popeyes_thumb.png",
"KFC Chicken":"images/restaurant_logos/kfc_thumb.png","Papa John's Pizza":"images/restaurant_logos/papa_johns_thumb.png","White Castle":"images/restaurant_logos/white_castle_thumb.png","Veggie Grill":"images/restaurant_logos/veggie_grill_thumb.png"};
ETM.FoodInfoObject=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/food/",remote:!0,defaults:{major_ingredients:"",default_units:1,main_dish:!0,images:[],weights:[{amount:100,grams:100,description:"grams"},{amount:1,grams:100,description:"serving"}],description:""},relations:[{type:Backbone.Many,key:"ingredients",relatedModel:"ETM.IngredientObject",collectionType:"ETM.IngredientsList"},{type:Backbone.Many,key:"directions",relatedModel:"ETM.Direction",collectionType:"ETM.DirectionsList"},{type:Backbone.Many,
key:"images",relatedModel:"ETM.FoodImage",collectionType:"ETM.FoodImageList",customSerialize:function(a){a.models.forEach(function(a){delete a.attributes.resource_uri});return a}},{type:Backbone.One,key:"food_rating",relatedModel:"ETM.FoodRating"}],getDisplayImage:function(){var a=this.attributes.images,b=null;if(ETM.is_logged_in){var c=a.where({uploader:ETM.current_user_profile.attributes.username}),d=a.where({user_id:ETM.current_user_profile.attributes.user_id}),e=0;c.forEach(function(a){a.attributes.id>
e&&(e=a.attributes.id,b=a)});d.forEach(function(a){a.attributes.id>e&&(e=a.attributes.id,b=a)})}!b&&ETM.current_user_profile.isManaged()&&(c=a.where({uploader:ETM.current_user_profile.attributes.manager_username}),d=a.where({user_id:ETM.current_user_profile.attributes.manager_id}),e=0,c.forEach(function(a){a.attributes.id>e&&(e=a.attributes.id,b=a)}),d.forEach(function(a){a.attributes.id>e&&(e=a.attributes.id,b=a)}));b||(b=a.findWhere({is_primary_image:!0}));b||(b=a.findWhere({curated:!0}));b||(b=
{attributes:{thumbnail:this.findFoodIcon(),image:"images/recipe_image_placeholder.jpg",uploader:null}});return b},findFoodIcon:function(){var a,b;if("s"!==this.attributes.model&&"b"!==this.attributes.model&&"ub"!==this.attributes.model&&"nr"!==this.attributes.model&&"nb"!==this.attributes.model||!_.has(this.attributes,"manufactured_by")){this.attributes.is_recipe?(a="recipes",b=this.attributes.category_id):null!=this.attributes.nutrition&&(a="basic_foods",b=this.attributes.nutrition.food_group);if(null==
a||null==b||null==ETM.icon_search[a][b])return"missing_thumbnail1.jpg";for(var c=0;c<ETM.icon_search[a][b].length;c++){var d=ETM.icon_search[a][b][c];if(c+1==ETM.icon_search[a][b].length)return d[1].replace(/^\//,"");var e=d[0].split(" "),f=this.attributes.food_name.toLocaleLowerCase();if(0<e.length)for(var g=0;g<e.length;g++)if(-1!=f.indexOf(e[g]))return d[1].replace(/^\//,"")}return ETM.default_icons[a][b].replace(/^\//,"")}return _.has(RESTAURANT_LOGOS,this.attributes.manufactured_by)?RESTAURANT_LOGOS[this.attributes.manufactured_by]:
"missing_thumbnail1.jpg"},saveThumbRating:function(a,b){var c=!1;"undefined"==typeof this.attributes.food_rating||null==this.attributes.food_rating?this.attributes.food_rating=new ETM.FoodRating({user:this.user,food:this.attributes.resource_uri}):c=this.attributes.food_rating.attributes.rating;this.attributes.food_rating.save({rating:a},{success:function(a,c){ETM.food_rating_list.add(a,{merge:!0});b()},error:function(a,c){b()}});if(a===THUMB_RATINGS.THUMBS_DOWN)c=["u","c","b","s","ub"],(blocked_food_info=
ETM.food_info_object_list.get(this.attributes.resource_uri))&&_.contains(c,this.attributes.model)&&(ETM.reload_food_pool=!0),ETM.recently_blocked.push(this.attributes.id),ETM.generator_results_cache.clearCache();else{var d=ETM.recently_blocked.indexOf(this.attributes.id);-1!==d?ETM.recently_blocked.splice(d,1):c===THUMB_RATINGS.THUMBS_DOWN&&(ETM.reload_food_pool=!0)}this.trigger("updateRating");googleanalytics("send","event","button","click","rate_food");amplitude.logEvent("rate_food",{food_id:this.attributes.id,
rating:a})},downloadRecipeInfo:function(a,b){var c=this;"r"===this.attributes.model&&(_.has(this.attributes,"ingredients")&&_.has(this.attributes,"directions")&&"undefined"!==typeof this.attributes.ingredients?a():(new ETM.RecipeObject).fetch({url:ROOT+"/recipe/"+c.get("id")+"/",success:function(b,e,f){c.attributes.ingredients=b.get("ingredients");c.attributes.directions=b.get("directions");c.attributes.uploader=b.get("uploader");c.attributes.ingredients.each(function(a){a.attributes.original_recipe_amount=
a.get("amount")});a()},error:function(d,e,f){if("undefined"!=typeof b&&b)throw Error("Download recipe info url "+f.url+" encountered error: "+e.status+" : "+e.statusText);c.downloadRecipeInfo(a,!0)}}))},schema:{food_name:{type:"Text",editorAttrs:{maxlength:100}},description:{type:"Text",editorAttrs:{maxlength:400}},breakfast:"Checkbox",single_serving:"Checkbox",keeps_well:"Checkbox",main_dish:{type:"SegmentedRadio",value_type:"Boolean",options:[{val:!1,label:"Side dish"},{val:!0,label:"Main dish"}]},
category_id:{type:"Select",value_type:"Number",options:[{val:1,label:"Appetizers"},{val:2,label:"Breakfast foods"},{val:3,label:"Desserts"},{val:4,label:"Drinks"},{val:5,label:"Mostly meat"},{val:6,label:"Protein shakes"},{val:7,label:"Salads"},{val:8,label:"Sandwiches"},{val:9,label:"Pasta"},{val:10,label:"Soups"},{val:11,label:"Other"}]},prep_time:{type:"PositiveNumber",validators:["required"]},cook_time:{type:"PositiveNumber",validators:["required"]},number_servings:{type:"PositiveNumber",validators:[function(a,
b){var c={type:"number_servings",message:"Number servings must be more than 0"};if(0<!a)return c}]},changes_reason:{type:"Select",options:[{val:"low_carb",label:"I want fewer carbs"},{val:"high_protein",label:"I want more protein"},{val:"allergic",label:"I was allergic to an ingredient"},{val:"vegetarian",label:"I made it more vegetarian/vegan friendly"},{val:"other",label:"Other"}]},changes_description:"TextArea"}});
ETM.FoodInfoObjectList=Backbone.Collection.extend({model:ETM.FoodInfoObject,remote:!0,urlRoot:ROOT+"/food/",url:function(){var a=this.models,b=this.urlRoot,b=b&&addSlash(b);a&&a.length&&(a=_.map(a,function(a){a=_.compact(a.url().split("/"));return a[a.length-1]}),b+="set/"+a.join(";")+"/");return b||null},initialize:function(a,b){b&&b.url&&(this.url=function(){return b.url});this.listenTo(this,"imageAdded",function(a){var b=this.findWhere({id:a.attributes.food_id});b&&!b.attributes.images.get(a)&&
(b.attributes.images.add(a),b.trigger("imageUpdated",a))})},updateFoodInfo:function(a){if(food_to_update=this.get(ROOT+"/food/"+a.attributes.id+"/"))food_to_update.set(a.toJSON()),_.has(food_to_update.attributes,"ingredients")&&delete food_to_update.attributes.ingredients,_.has(food_to_update,"tooltip_ingredients")&&delete food_to_update.tooltip_ingredients,delete all_ingredients[food_to_update.attributes.id]},addAndFetchMissing:function(a,b){var c=[],d=this;a.forEach(function(a){ETM.food_info_object_list.get(a)||
(ETM.food_info_object_list.add({id:a}),(a=/\/(\d+)\/$/g.exec(a))&&a[1]&&c.push(a[1]))});0<c.length?500<c.length?(extra_ids=c.splice(500),ETM.food_info_object_list.fetch({remove:!1,url:this.urlRoot+"set/"+c.join(";")+"/",success:function(){ETM.food_info_object_list.fetch({remove:!1,url:d.urlRoot+"set/"+extra_ids.join(";")+"/",success:function(){b()},error:function(a,c,d){bugsnagClient.notify(Error("Food info fetch "+d.url+" encountered error: "+c.status+" : "+c.statusText),{metaData:{string_response:JSON.stringify(c),
string_options:JSON.stringify(d)}});b()}})}})):ETM.food_info_object_list.fetch({remove:!1,url:this.urlRoot+"set/"+c.join(";")+"/",success:function(){b()},error:function(a,c,d){bugsnagClient.notify(Error("Food info fetch "+d.url+" encountered error: "+c.status+" : "+c.statusText),{metaData:{string_response:JSON.stringify(c),string_options:JSON.stringify(d)}});b()}}):b()}});ETM.CustomFoodInfoObject=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/customfood/",defaults:{}});
ETM.CustomFoodInfoObjectList=Backbone.Collection.extend({url:function(){return this.options.url},model:ETM.CustomFoodInfoObject,initialize:function(a,b){this.options=b}});
var addSlash=function(a){return a+(0<a.length&&"/"===a.charAt(a.length-1)?"":"/")},mapFoodData=function(a){"undefined"!=typeof a.id&&1==Object.keys(a).length&&(a=a.id);if(_.isObject(a))return a;var b=ETM.food_info_object_list;return(b=b&&b.find(function(b){return b.get(b.idAttribute)===a||b.get(b.idAttribute)===ROOT+"/food/"+a+"/"}))?b:a},mapUsesLeftoversFrom=function(a){return"string"===typeof a?{id:parseIntIdFromResourceURI(a)}:a};
function add_food_info_objects(a){a.forEach(function(a){var c=new ETM.FoodInfoObject(a);c.id=ROOT+"/food/"+a.id+"/";c.images=new ETM.FoodImageList(a.images);ETM.food_info_object_list.add(c)})}
function add_v2_food_info_objects(a){null!=a&&a.forEach(function(a){var c=a.weights[0].amount,d=c/100,e=[];a.weights.forEach(function(d){"grams"===d.description?e.push({grams:100,amount:100,description:"grams"}):e.push({grams:c/a.number_servings,amount:null!=d.v1_scale?d.v1_scale:1,description:d.description})});a.weights=e;var f=new ETM.FoodInfoObject(a);f.attributes.nutrition.carbs=f.attributes.carbs;f.attributes.nutrition.proteins=f.attributes.proteins;f.attributes.nutrition.fats=f.attributes.fats;
f.attributes.nutrition.food_name=f.attributes.food_name;f.attributes.nutrition.description=f.attributes.description;f.attributes.nutrition.calories=f.attributes.calories;f.attributes.nutrition.price=f.attributes.price;for(var g in f.attributes.nutrition)f.attributes.nutrition.hasOwnProperty(g)&&(f.attributes.nutrition[g]/=d);f.id=ROOT+"/food/"+a.id+"/";f.images=new ETM.FoodImageList(a.images);ETM.food_info_object_list.add(f)})}
ETM.FoodObject=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/foodobject/",relations:app?[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodInfoObject",customSerialize:function(a){return a.attributes.resource_uri},map:mapFoodData},{type:Backbone.Many,key:"makes_leftovers_for",relatedModel:"ETM.LeftoversFoodObject",collectionType:"ETM.LeftoversFoodList",customSerialize:function(a,b){return b&&b.attributes.update_leftovers?a:null}},{type:Backbone.One,key:"uses_leftovers_from",relatedModel:"Backbone.AssociatedModel",
map:mapUsesLeftoversFrom,customSerialize:function(a){return null}}]:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodInfoObject",customSerialize:function(a){return a.attributes.resource_uri},map:mapFoodData},{type:Backbone.Many,key:"makes_leftovers_for",relatedModel:"ETM.LeftoversFoodObject",collectionType:"ETM.LeftoversFoodList",customSerialize:function(a,b){return b&&b.attributes.update_leftovers?a:null}}],destroy:function(a){this.stopListening();null!=a&&!0==a.silent||!this.attributes.is_leftovers&&
!this.attributes.has_leftovers||this.updateRelatedLeftovers("delete",!1);Backbone.AssociatedModel.prototype.destroy.apply(this,arguments)},setParentMeal:function(){_.has(this,"collection")&&_.has(this.collection,"parents")&&1==this.collection.parents.length&&this.collection.parents[0]instanceof ETM.MealObject&&(this.parent=this.collection.parents[0])},hasParentMeal:function(){return _.has(this,"parent")&&null!==this.parent},getParentMeal:function(){return this.parent},hasParentDiet:function(){return this.hasParentMeal()&&
this.getParentMeal().hasParentDiet()},getParentDiet:function(){return this.hasParentDiet()?this.getParentMeal().getParentDiet():!1},getCalendarDate:function(){return this.hasParentDiet()&&this.getParentDiet().isCalendar()?this.getParentDiet().getParent().attributes.date:!1},isInDietSet:function(){return this.hasParentDiet()&&this.getParentDiet().is_diet_set},getLeftoversOriginString:function(){if(this.attributes.is_leftovers)return this.isInDietSet()?"Day "+(ETM.diet_plan_set.attributes.diet_set_items.indexOf(this.attributes.leftovers_from)+
1):Helper.getWeekday(Helper.parseDateString(this.attributes.leftovers_from).getDay())},initialize:function(a,b){if(null==this.attributes.food||!(this.attributes.food instanceof ETM.FoodInfoObject))throw"Food object initialized without valid food info object";this.parent=this.save_timer=null;this.setParentMeal();"undefined"!=typeof b&&_.has(b,"skip_global")&&b.skip_global||this.combineFoodInfoPointers();this.initializeEvents();this.is_favorite=Boolean(ETM.favorite_foods_list.findWhere({food:this.attributes.food.id}));
this.is_blocked=Boolean(ETM.blocked_foods_list.findWhere({food:this.attributes.food.id}));this.is_from_collections=this.is_recurring_always=this.is_recurring=this.is_selected=!1;this.in_collections=null;this.leftovers_servings=0;this.family_scale=1;this.calculateStats()},initializeEvents:function(){var a=this;this.listenTo(this,"updateStats",this.calculateStats,this);this.listenTo(ETM.dispatcher,"update_food_info_"+this.attributes.food.attributes.id,function(){0<a.attributes.id&&this.fetch()},this);
this.listenTo(this.get("food"),"change",function(){this.trigger("updateStats");this.trigger("foodChanged")},this);this.listenTo(this,"change:food",function(){this.trigger("updateStats");this.trigger("foodChanged")},this);this.listenTo(this,"change:amount change:units",function(){this.trigger("updateStats");this.trigger("reRender")},this);this.listenTo(this,"change",function(){ETM.currently_generating||ETM.generator_results_cache.clearCache()},this);this.initializeLeftoverEvents()},initializeLeftoverEvents:function(){(this.attributes.is_leftovers||
this.attributes.has_leftovers)&&this.listenTo(ETM.dispatcher,"update_food_"+this.attributes.id,function(a,c){var d=this.sanitizeLeftoversJson(a);this.set(d)},this);if(this.attributes.is_leftovers&&this.isValidLeftovers()){var a=app?this.attributes.uses_leftovers_from.attributes.id:parseIntIdFromResourceURI(this.attributes.uses_leftovers_from);this.listenTo(ETM.dispatcher,"update_uses_leftovers_from_"+a,function(a,c,d){"delete"===a?(this.set("uses_leftovers_from",null),this.set("is_leftovers",!1)):
"update"===a&&this.set("uses_leftovers_from",c.attributes.resource_uri)},this)}else this.attributes.has_leftovers&&this.hasValidLeftovers()&&this.listenTo(ETM.dispatcher,"update_makes_leftovers_for_"+this.attributes.id,function(a,c,d){if("delete"===a){for(a=0;a<this.attributes.makes_leftovers_for.models.length;a++)if(d=this.attributes.makes_leftovers_for.models[a],d.attributes.id===c.attributes.id){this.attributes.makes_leftovers_for.remove(d);d.stopListening();break}0===this.attributes.makes_leftovers_for.models.length&&
this.set("has_leftovers",!1)}else if("update"===a)for(a=0;a<this.attributes.makes_leftovers_for.models.length;a++)if(d=this.attributes.makes_leftovers_for.models[a],d.attributes.id===c.attributes.id){d.set(c.toJSON());break}},this)},sanitizeLeftoversJson:function(a){a=jQuery.extend(!0,{},a);delete a.leftovers_family_scale;delete a.meal_type_id;return a},updateRelatedLeftovers:function(a,b){null==b&&(b=!0);if(this.attributes.is_leftovers&&this.isValidLeftovers()){var c=app?this.attributes.uses_leftovers_from.attributes.id:
parseIntIdFromResourceURI(this.attributes.uses_leftovers_from);ETM.dispatcher.trigger("update_makes_leftovers_for_"+c,a,this,b)}else this.attributes.has_leftovers&&this.hasValidLeftovers()&&ETM.dispatcher.trigger("update_uses_leftovers_from_"+this.attributes.id,a,this,b)},updateStaticAmountAndUnits:function(){this.static_amount=this.getStaticAmount();this.static_units=this.getStaticUnits()},updateRoundedStaticAmountAndUnits:function(){this.static_amount=this.getRoundedStaticAmount();this.static_units=
this.getStaticUnits()},updateStaticAmountAndUnitsWithConversion:function(){var a={cup:[[0.25,"tbsp"]],tbsp:[[0.34,"tsp"]]},b=this.attributes.food.attributes.weights[this.attributes.units].description,c=this.attributes.amount,d=this.attributes.units;if(_.has(a,b))for(var e=0;e<a[b].length;e++){var f=a[b][e];if(this.attributes.amount<f[0]){for(a=0;a<this.attributes.food.attributes.weights.length;a++)if(this.attributes.food.attributes.weights[a].description===f[1]){c=this.convertAmountToSpecifiedUnits(a);
d=a;break}break}}c*=this.attributes.food.attributes.weights[this.attributes.units].amount;this.static_units=this.attributes.food.attributes.weights[d].description;this.static_amount=Helper.getRoundedFractionFromDecimal(c)},convertAmountToSpecifiedUnits:function(a){return this.attributes.units===a?this.attribuntes.amount:this.attributes.food.attributes.weights[this.attributes.units].grams*this.attributes.amount/this.attributes.food.attributes.weights[a].grams},getStaticAmount:function(){return Fraction.getFractionFromDecimal(roundNumber(this.attributes.amount*
this.attributes.food.attributes.weights[this.attributes.units].amount,5))},getRoundedStaticAmount:function(){return Helper.getRoundedFractionFromDecimal(roundNumber(this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].amount,5))},getStaticAmountFloat:function(){return roundNumber(this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].amount,5)},getStaticUnits:function(){return this.attributes.food.attributes.weights[this.attributes.units].description},
getGramReadout:function(){if(this.attributes.food.attributes.is_basic_food&&this.attributes.food.attributes.accurate_grams){if(0!==this.attributes.units){var a=this.gram_amount,b="grams";999<a?(a=Helper.formatFoodAmount(a/1E3),b="kg"):a=Helper.formatFoodAmount(a);return a+" "+b}return""}},updateChildLeftovers:function(){this.hasValidLeftovers()&&this.attributes.makes_leftovers_for.forEach(function(a){ETM.dispatcher.trigger("update_food_"+a.attributes.id,a.toJSONFull())})},hasValidLeftovers:function(){return _.has(this.attributes,
"makes_leftovers_for")&&null!=this.attributes.makes_leftovers_for&&_.has(this.attributes.makes_leftovers_for,"models")&&0<this.attributes.makes_leftovers_for.models.length},isValidLeftovers:function(){return _.has(this.attributes,"uses_leftovers_from")&&null!=this.attributes.uses_leftovers_from},getCollectionListString:function(){var a="";if(null!==this.in_collections&&0<this.in_collections.length){var b=this.in_collections.length;_.each(this.in_collections,function(c,d){a+=c.attributes.food_collection.attributes.title;
d+1<b&&(a+=", ")})}return a},getV2GenerateJson:function(){var a=this.toJSON();a.food_id=parseIntIdFromResourceURI(a.food);a.meal_id=parseIntIdFromResourceURI(a.meal);a.id=parseInt(a.id);a.resource_uri=a.id;delete a.food;delete a.meal;delete a.date_added;return a},getV2JsonId:function(){return parseInt(this.id)},getGenerateRequestObject:function(){request_object=this.getParentMeal().getGenerateRequestObject();if(ETM.use_local_storage){var a=parseIdFromResourceURI(this.attributes.resource_uri);request_object.foods_to_regenerate=
a?[parseInt(a)]:[parseInt(this.attributes.resource_uri)]}else request_object.foods_to_regenerate=[this.attributes.id];return request_object},toGeneratorJSON:function(a){var b=this,c=this.toJSON();c.food_id=parseInt(parseIdFromResourceURI(c.food));delete c.food;delete c.date_added;delete c.meal;delete c.user;if(ETM.use_local_storage){var d=parseIdFromResourceURI(c.resource_uri);c.id=d?parseInt(d):parseInt(c.resource_uri);isNaN(c.id)&&!a&&(bugsnagClient.notify(Error("Bad food resource URI!"),{metaData:{food_json:JSON.stringify(c),
food_uri:String(c.resource_uri)}}),bugsnagClient.notify(Error("Bad food resource URI!"),{beforeSend:function(a){a.updateMetaData("dietInfo",{day_json:JSON.stringify(b.getParentDiet().toGeneratorJSON(!0))})}}))}return c},regenerateFoodServer:function(a){bugsnagClient.leaveBreadcrumb("Food generate",{num_meals:this.getParentDiet().attributes.num_meals,target_calories:this.getParentDiet().attributes.nutrition_profile.attributes.calories,meal_number:this.getParentMeal().attributes.meal_number,food_info_id:this.attributes.food.id,
resource_uri:String(this.attributes.resource_uri)});this.generator&&this.generator.algorithm!=ETM.current_user_profile.attributes.algorithm&&delete this.generator;ETM.current_user_profile.v2AlgorithmEnabled()?this.initV2Generator():this.initV1Generator();this.generator.run(a)},initV1Generator:function(){this.generator||(ETM.is_logged_in?this.hasParentDiet()&&this.getParentDiet().is_diet_set?this.generator=new ETM.GoGenerators.FoodGeneratorDietSet(this):this.generator=new ETM.GoGenerators.FoodGenerator(this):
this.generator=new ETM.GoGenerators.FoodGeneratorJson(this))},initV2Generator:function(){this.generator||(ETM.is_logged_in?this.hasParentDiet()&&this.getParentDiet().is_diet_set?this.generator=new ETM.GoGenerators.V2FoodGeneratorDietSet(this):this.generator=new ETM.GoGenerators.V2FoodGenerator(this):this.generator=new ETM.GoGenerators.V2FoodGeneratorJson(this))},getAmountToCook:function(){var a=this;current_serving_amount=this.getServingAmount();if(a.hasParentDiet()&&this.attributes.meal){var b=this.getParentMeal();
if(!b)return current_serving_amount;if(1<b.attributes.meal_type.attributes.family_scale||ETM.is_premium&&this.attributes.has_leftovers&&(ETM.calendar_list||ETM.diet_plan_set)){this.family_scale=b.attributes.meal_type.attributes.family_scale;var c=1,d=1,e=0;this.attributes.has_leftovers&&0<this.attributes.makes_leftovers_for.length&&(ETM.calendar_list||ETM.diet_plan_set)&&_.each(this.attributes.makes_leftovers_for.models,function(b){c=a.convertServingAmount(b.attributes.amount,b.attributes.units);
d=(a.isInDietSet()&&ETM.diet_plan_set.managed_account?ETM.client_meal_type_list.get(ROOT+"/mealtype/"+b.attributes.meal_type_id+"/"):ETM.meal_type_list.get(ROOT+"/mealtype/"+b.attributes.meal_type_id+"/")).attributes.family_scale;e+=c*d});this.leftovers_servings=e;return this.amount_to_cook=b=current_serving_amount*b.attributes.meal_type.attributes.family_scale+e}this.amount_to_cook=current_serving_amount;this.family_scale=1;return current_serving_amount}return _.has(this,"use_url_amounts")?this.amount_to_cook:
current_serving_amount},getServingAmount:function(){return 1==this.get("units")?this.attributes.amount:0==this.get("units")?this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].grams/this.attributes.food.attributes.weights[1].grams:this.attributes.amount},isLocked:function(){var a=!1;!0==this.attributes.is_leftovers||!0==this.attributes.has_leftovers?a=!0:this.is_recurring_always&&(a=!0);return a},convertServingAmount:function(a,b){return 1==b?a:0==b?a*this.attributes.food.attributes.weights[b].grams/
this.attributes.food.attributes.weights[1].grams:a},combineFoodInfoPointers:function(){var a=ETM.food_info_object_list.get(this.attributes.food.id);a?this.attributes.food=a:ETM.food_info_object_list.add(this.attributes.food)},addFoodInfoIfMissing:function(){ETM.food_info_object_list.get(this.attributes.food.id)||ETM.food_info_object_list.add(this.attributes.food)},updateFoodAmount:function(a){a/=this.attributes.food.attributes.weights[this.attributes.units].amount;a!==this.get("amount")&&(this.set({amount:a},
{silent:!0}),this.trigger("updateStats"),(this.attributes.is_leftovers||this.attributes.has_leftovers)&&this.updateRelatedLeftovers("update"))},saveAfterAmountUpdate:function(){if(null!=this.url()&&null!=this.id){clearTimeout(this.save_timer);var a=this;a.save_timer=setTimeout(function(){a.save({amount:a.attributes.amount},{patch:!0})},500)}},updateFoodUnits:function(a){this.set({amount:this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].grams/this.attributes.food.attributes.weights[a].grams,
units:a},{silent:!0});null!=this.url()&&null!=this.id&&this.save();(this.attributes.is_leftovers||this.attributes.has_leftovers)&&this.updateRelatedLeftovers("update")},convertUnitsDisplayAmount:function(a){return roundNumber(this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].grams/this.attributes.food.attributes.weights[a].grams*this.attributes.food.attributes.weights[a].amount,5)},calculateStats:function(){var a=this;a.stats=new ETM.NutritionStatsObject;var b;
try{if(_.has(a.attributes.food.attributes,"weights"))b=a.attributes.food.attributes.weights[a.attributes.units].grams*a.attributes.amount;else{ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=0});return}multiplier=b/100;ETM.NUTRIENT_LIST.forEach(function(b){null!=a.attributes.food.attributes.nutrition&&_.has(a.attributes.food.attributes.nutrition,b)?a.stats[b]=a.attributes.food.attributes.nutrition[b]*multiplier:a.stats[b]=0})}catch(c){throw bugsnagClient.leaveBreadCrumb("calc stats",{food:JSON.stringify(a.attributes.food),
food_object_id:a.attributes.id,user_id:ETM.current_user_profile.attributes.user_id}),c;}a.gram_amount=b},scaleIngredients:function(a){var b=this.get("food").get("number_servings"),c=a/b;try{this.get("food").attributes.ingredients.each(function(a){a.attributes.amount=a.attributes.original_recipe_amount*c;a.calculateStats()})}catch(d){throw bugsnagClient.leaveBreadCrumb("scale ingr",{food_id:this.get("food").attributes.id,food_obj_id:this.attributes.id,food:JSON.stringify(this.get("food"))}),d;}},toggleFavorite:function(a){a.prop("disabled",
!0);var b,c="string"==typeof this.attributes.food?this.attributes.food:this.attributes.food.id;if(this.is_favorite)this.is_favorite=!1,this.attributes.food.trigger("removeFavorite"),b=ETM.favorite_foods_list.where({food_resource_uri:c}),0<b.length?(b=b[0],b.destroy({success:function(){a.prop("disabled",!1)},error:function(){a.prop("disabled",!1)}}),googleanalytics("send","event","button","click","remove_favorite"),amplitude.logEvent("remove_favorite",{food_id:parseIdFromResourceURI(c)})):(console.log("FOUND NO FAVORITE ITEM (something broke - no longer syncronized with the favorites list)"),
a.prop("disabled",!1));else{this.is_favorite=!0;this.attributes.food.trigger("addFavorite");ETM.food_info_object_list.get(this.attributes.food)||ETM.food_info_object_list.add(this.attributes.food);var d=new ETM.FavoriteFood({food:c});d.save(null,{success:function(){ETM.favorite_foods_list.add(d,{at:0});a.prop("disabled",!1)},error:function(){a.prop("disabled",!1)}});googleanalytics("send","event","button","click","add_favorite");amplitude.logEvent("add_favorite",{food_id:parseIdFromResourceURI(c)})}},
toggleBlock:function(a){a.prop("disabled",!0);var b;b="string"==typeof this.attributes.food?this.attributes.food:this.attributes.food.id;if(this.is_blocked)this.is_blocked=!1,this.attributes.food.trigger("removeBlock"),b=ETM.blocked_foods_list.where({food_resource_uri:b}),0<b.length?(b=b[0],b.destroy({success:function(){a.prop("disabled",!1)},error:function(){a.prop("disabled",!1)}})):(console.log("FOUND NO BLOCKED ITEM (something broke - no longer syncronized with the block list)"),a.prop("disabled",
!1));else{this.is_blocked=!0;this.attributes.food.trigger("addBlock");var c=new ETM.BlockedFood({food:b});c.save(null,{success:function(){ETM.blocked_foods_list.add(c);a.prop("disabled",!1)},error:function(){a.prop("disabled",!1)}})}},customStats:function(a,b){self=this;var c=new ETM.NutritionStatsObject,d;if(_.has(self.attributes.food.attributes,"weights"))return d=self.attributes.food.attributes.weights[b].grams*a,multiplier=d/100,ETM.NUTRIENT_LIST.forEach(function(a){null!=self.attributes.food.attributes.nutrition&&
_.has(self.attributes.food.attributes.nutrition,a)?c[a]=self.attributes.food.attributes.nutrition[a]*multiplier:c[a]=0}),c;ETM.NUTRIENT_LIST.forEach(function(a){c[a]=0})}});
ETM.FoodList=Backbone.Collection.extend({model:ETM.FoodObject,url:ROOT+"/foodobject/",search:function(a,b){if(""==a)return this;try{var c=this.filter(function(b){return-1!=b.get("food").get("food_name").toLowerCase().indexOf(a.toLowerCase())});b(c)}catch(d){b([])}},useCustomAdd:function(a){return a.item.hasClass("foodbank_food")},customAdd:function(a,b){var c=a.find(".foodbank_food"),d=ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("show")?ETM.ingredients_search_model:ETM.search_model,e=c.data("modelCid"),
f=c.data("result_type"),g=c.data("food_id"),h=ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("show")?"ETM.ingredients_search_model":"ETM.search_model",m=!1,k,n,l;if("undefined"!==typeof b)m=!0,l=ETM.food_info_object_list.add(b.food),k=b,k.food=l,n=new ETM.FoodObject(k);else{f in d.search_results_model_dict?n=d.search_results_model_dict[f].results.get(e):_.has(d,"collection_foods_search_model")&&_.has(d.collection_foods_search_model.collection_results_models,f)&&(n=d.collection_foods_search_model.collection_results_models[f].results.get(e));
n?(m=!0,l=n.attributes.food,ETM.food_info_object_list.add(l)):_.each(d.result_types,function(a){!m&&_.has(d.search_results_model_dict,a)&&(n=d.search_results_model_dict[a].results.get(e))&&(m=!0,l=n.attributes.food,ETM.food_info_object_list.add(l),bugsnagClient.notify(Error("Error finding food model when dragging"),{metaData:{search_results_model:h,type_expected:f,type_found:a}}),console.log("found in different result type >_<"))});m||((n=f in d.search_results_model_dict?d.search_results_model_dict[f].results.findWhere({"food.id":g}):
ETM.search_model.collection_foods_search_model.collection_results_models[f].results.findWhere({"food.id":g}))?(m=!0,l=n.attributes.food,ETM.food_info_object_list.add(l),bugsnagClient.notify(Error("Error finding food model when dragging"),{metaData:{cid_expected:e,cid_found:n.get("cid"),food_id:g,result_type:f,search_results_model:h}}),console.log("found with different cid >_<")):_.each(d.result_types,function(a){!m&&_.has(d.search_results_model_dict,a)&&(n=d.search_results_model_dict[a].results.findWhere({"food.id":g}))&&
(m=!0,l=n.attributes.food,ETM.food_info_object_list.add(l),bugsnagClient.notify(Error("Error finding food model when dragging"),{metaData:{cid_expected:e,cid_found:n.get("cid"),food_id:g,type_expected:f,type_found:a,search_results_model:h}}),console.log("found with different cid AND different result type >_<"))}));if(!m)return c.remove(),ETM.toast.showNotification({message:"There was error adding the food to your plan :(<br/>Please try again, and if it keeps happening, refreshing the page should fix it. Sorry!!",
type:"error"}),console.log("error adding food >_<"),!1;k=n.toJSON();k.food=l}if(ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("show")){if(a.hasClass("meal_foods")||a.hasClass("meal_type_recurring_foods")||a.hasClass("grocery_foods_list"))return c.remove(),!1;if(n.get("food").get("is_recipe"))return c.remove(),this.trigger("addedRecipe"),!1;this.trigger("addedIngredient");k=new ETM.IngredientObject(k)}else k=new ETM.FoodObject(k);var p=a.children().index(c);c.remove();ETM.finish_profile_completeness_key("add_a_dish");
d===ETM.search_model&&(d.addToRecentList(k),k.attributes.user_chosen=!0);return{modelToAdd:k,newIndex:p}},returnFoodObject:function(a){return new ETM.FoodObject({food:a,amount:1,units:a.attributes.default_units,is_custom:!1},{skip_global:!0})}});
ETM.LeftoversFoodObject=ETM.FoodObject.extend({relations:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodInfoObject",customSerialize:function(a){return a.attributes.resource_uri},map:mapFoodData}],initialize:function(){"undefined"!=typeof options&&_.has(options,"skip_global")&&options.skip_global||this.combineFoodInfoPointers();this.initializeEvents();this.calculateStats();delete this.attributes.uses_leftovers_from},initializeEvents:function(){this.listenTo(this,"updateStats",this.calculateStats,
this);this.listenTo(this.get("food"),"change",function(){this.trigger("updateStats");this.trigger("foodChanged")},this);this.listenTo(this,"change:food",function(){this.trigger("updateStats");this.trigger("foodChanged")},this)}});ETM.LeftoversFoodList=ETM.FoodList.extend({model:ETM.LeftoversFoodObject});
ETM.SimpleFoodObject=ETM.FoodObject.extend({relations:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodInfoObject",customSerialize:function(a){return a.attributes.resource_uri},map:mapFoodData}],initialize:function(a,b){if(null==this.attributes.food||!(this.attributes.food instanceof ETM.FoodInfoObject))throw"Food object initialized without valid food info object";this.addFoodInfoIfMissing();this.initializeEvents();this.is_favorite=Boolean(ETM.favorite_foods_list.findWhere({food:this.attributes.food.id}));
this.is_blocked=Boolean(ETM.blocked_foods_list.findWhere({food:this.attributes.food.id}));this.is_recurring=this.is_selected=!1;this.leftovers_servings=0;this.family_scale=1;this.calculateStats()},initializeEvents:function(){this.listenTo(this,"updateStats",this.calculateStats,this);this.listenTo(this.get("food"),"change",function(){this.trigger("updateStats");this.trigger("foodChanged")},this);this.listenTo(this,"change:food",function(){this.trigger("updateStats");this.trigger("foodChanged")},this)}});
ETM.SimpleFoodList=ETM.FoodList.extend({model:ETM.SimpleFoodObject});ETM.FoodRating=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/foodrating/"});ETM.FoodRatingList=Backbone.Collection.extend({model:ETM.FoodRating,url:ROOT+"/foodrating/"});ETM.ReportFood=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/foodreport/"});
ETM.GroceryFoodObject=ETM.FoodObject.extend({urlRoot:ROOT+"/pantryfood/",destroy:function(a){if(this.attributes.owned)ETM.FoodObject.prototype.destroy.apply(this,arguments);else{this.updateFoodAmount(0);this.saveAfterAmountUpdate();try{this.collection.remove(this)}catch(b){throw bugsnagClient.leaveBreadCrumb("grocery destroy error",{collection_undefined:null==this.collection,resource_uri:this.attributes.resource_uri,food_resource_uri:this.attributes.food.attributes.resource_uri,in_grocery_list:null!=
ETM.groceries_and_pantry.grocery_list.get(this),in_pantry_list:null!=ETM.groceries_and_pantry.pantry_list.get(this)}),b;}}},toggleAmount:function(){if(!app||"undefined"===typeof app){var a=this.get("owned"),b=this.get("user_modified"),c=a?this.get("amount"):this.get("total_amount");a||!this.collection.includePantryAmountsInGroceries||b||(c-=this.get("amount_left"));if(0>c||"undefined"===typeof c||isNaN(c)||null===c)c=0;this.set("amount",c)}},updateFoodUnits:function(a){if(app)ETM.FoodObject.prototype.updateFoodUnits.apply(this,
arguments);else{var b=this.attributes.food.attributes.weights[this.attributes.units].grams,c=this.attributes.food.attributes.weights[a].grams;this.set({amount:this.attributes.amount*b/c,amount_left:this.attributes.amount_left*b/c,total_amount:this.attributes.total_amount*b/c,amount_eaten:this.attributes.amount_eaten*b/c,units:a},{silent:!0});null!=this.url()&&null!=this.id&&this.save();(this.attributes.is_leftovers||this.attributes.has_leftovers)&&this.updateRelatedLeftovers("update")}},updateFoodAmount:function(a){if(app)ETM.FoodObject.prototype.updateFoodAmount.apply(this,
arguments);else{var b=a/this.attributes.food.attributes.weights[this.attributes.units].amount,c=this.get("amount"),d=b-c;if(b!==c){if(0>b||isNaN(b)||"undefined"===typeof b||null===b)b=0;c=this.get("owned")?this.get("amount_left")+d:this.get("amount_left");if(0>c||isNaN(c)||"undefined"===typeof c||null===c)c=0;d=this.get("owned")?this.get("total_amount")+d:b;if(0>d||isNaN(d)||"undefined"===typeof d||null===d)d=0;this.set({amount:b,amount_left:c,total_amount:d},{silent:!0});this.trigger("updateStats");
this.toggleAmount();this.updateStaticAmountAndUnits();this.trigger("amountUpdated");(this.attributes.is_leftovers||this.attributes.has_leftovers)&&this.updateRelatedLeftovers("update")}}}});
ETM.GroceryFoodList=Backbone.Collection.extend({url:ROOT+"/pantry/",model:ETM.GroceryFoodObject,initialize:function(a,b){this.foods_are_owned=b.foods_are_owned;this.toggleAmount=!0},initializeEvents:function(){this.listenTo(this,"add",function(a,b){this.foods_are_owned&&(a.set("amount_left",a.attributes.amount),ETM.search_model.search_results_model_dict.pantry_recipes.triggerPantryUpdate());a.set("owned",this.foods_are_owned);a.save()},this);this.listenTo(this,"remove",function(a,b){this.foods_are_owned&&
ETM.search_model.search_results_model_dict.pantry_recipes.triggerPantryUpdate()});this.foods_are_owned&&!1===ETM.current_profile_completeness.get("add_food_to_pantry")&&this.listenToOnce(this,"add",function(){ETM.groceries_and_pantry.triggerPantryProfileCompleteness()})},useCustomAdd:function(a){return a.item.hasClass("foodbank_food")},customAdd:function(a,b){var c=a.find(".foodbank_food");if(ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("show"))c.remove();else{var d=c.data("modelCid"),e=c.data("result_type");
if("undefined"!==typeof b)e=ETM.food_info_object_list.add(b.food),b.food=e,d=new ETM.FoodObject(b);else{if(e in ETM.search_model.search_results_model_dict)d=ETM.search_model.search_results_model_dict[e].results.get(d);else if(_.has(ETM.search_model,"collection_foods_search_model")&&_.has(ETM.search_model.collection_foods_search_model.collection_results_models,e))d=ETM.search_model.collection_foods_search_model.collection_results_models[e].results.get(d);else return bugsnagClient.notify(Error("Error finding food to drag on groceries page"),
{metaData:{cid:d,result_type:d}}),c.remove(),ETM.toast.showNotification({message:"There was error adding the food :(<br/>Please try again, and if it keeps happening, refreshing the page should fix it. Sorry!!",type:"error"}),!1;e=d.attributes.food;ETM.food_info_object_list.add(e)}d=new ETM.GroceryFoodObject({food:e,amount:d.attributes.amount,total_amount:d.attributes.amount,amount_left:0,amount_eaten:0,units:d.attributes.units},{skip_global:!0});e=a.children().index(c);c.remove();return{modelToAdd:d,
newIndex:e}}},calculateStats:function(){var a=this;a.stats=new ETM.NutritionStatsObject;ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=0});this.each(function(b){ETM.NUTRIENT_LIST.forEach(function(c){a.stats[c]+=b.stats[c]})})},toggleAmounts:function(a,b,c){app&&"undefined"!==typeof app||(this.includePantryAmountsInGroceries=a,this.includeFutureMealsInPantry=b,this.models.forEach(function(a){a.toggleAmount();a.trigger("updateStats");a.updateStaticAmountAndUnits();a.trigger("amountUpdated",!0)}));
"undefined"!==typeof c&&c()}});
ETM.GroceriesAndPantry=Backbone.Model.extend({url:ROOT+"/pantry/",initialize:function(){},fetchFoods:function(a){this.fetch({success:function(b,c,d){_.each(b.attributes.foods,function(a){0===a.food.food_group&&(a.food.food_group=null)});"undefined"!=typeof a&&a()}})},listenToWeeklyPlannerComplete:function(){var a=this;this.listenToOnce(ETM.generator_status,"finishedWeeklyPlanner finishedWeeklyPlannerV2",function(b){a.trigger("reloadGroceryList")})},createFoodLists:function(){var a=_.filter(this.attributes.foods,
function(a){return app?!1==a.owned&&0<a.amount:!1==a.owned&&0<a.total_amount}),b=_.filter(this.attributes.foods,function(a){return!0==a.owned&&0<a.amount});this.pantry_list?this.pantry_list.reset(b):(this.pantry_list=new ETM.GroceryFoodList(b,{foods_are_owned:!0}),this.pantry_list.initializeEvents());this.grocery_list?this.grocery_list.reset(a):(this.grocery_list=new ETM.GroceryFoodList(a,{foods_are_owned:!1}),this.grocery_list.initializeEvents());this.attributes.foods=[]},loadFoods:function(a){var b=
this;this.fetchFoods(function(){b.createFoodLists();"undefined"!=typeof a&&a()})},toJSONFull:function(){return{grocery_list:this.grocery_list.toJSONFull(),pantry_list:this.pantry_list.toJSONFull(),current_start_date:this.attributes.current_start_date,current_end_date:this.attributes.current_end_date}},deleteFoods:function(a,b){var c,d=[];"grocery"===a?c=this.grocery_list:"pantry"===a&&(c=this.pantry_list);null==b?c.forEach(function(a){d.push(a)}):b.forEach(function(a){d.push(c.get(a))});if(0<d.length){var e=
"";_.each(d,function(a){a.is_selected=!1;""!=e&&(e+=",");e+=a.attributes.id.toString()});$.ajax({url:"/pantry/delete_set/",data:{ids:e},type:"POST",success:function(a){},error:function(a,b,c){console.log(b)}});c.remove(d,{silent:!0})}},moveFoods:function(a,b){var c,d,e=[];"grocery_to_pantry"===a?(!1===ETM.current_profile_completeness.get("add_food_to_pantry")&&ETM.groceries_and_pantry.triggerPantryProfileCompleteness(),c=this.grocery_list,d=this.pantry_list):"pantry_to_grocery"===a&&(c=this.pantry_list,
d=this.grocery_list);null==b?c.forEach(function(a){a.attributes.owned=d.foods_are_owned;e.push(a)}):b.forEach(function(a){a=c.get(a);a.attributes.owned=d.foods_are_owned;e.push(a)});if(0<e.length){var f="";_.each(e,function(a){a.is_selected=!1;""!=f&&(f+=",");f+=a.attributes.id.toString()});$.ajax({url:"/pantry/update_set/",data:{ids:f,foods_are_owned:d.foods_are_owned?1:0},type:"POST",success:function(a){},error:function(a,b,c){console.log(b)}});c.remove(e,{silent:!0});d.add(e,{silent:!0})}},triggerPantryProfileCompleteness:function(){ETM.current_profile_completeness.save({add_food_to_pantry:!0},
{patch:!0})},triggerPantryUpdateProfileCompleteness:function(){ETM.current_profile_completeness.save({remove_eaten_foods:!0},{patch:!0})}});ETM.IngredientObject=ETM.FoodObject.extend({sync:function(){return!1}});
ETM.IngredientsList=Backbone.Collection.extend({model:ETM.IngredientObject,url:ROOT+"/ingredients/",sync:function(){return!1},useCustomAdd:function(a){return a.item.hasClass("foodbank_food")},customAdd:function(a,b){var c=a.find(".foodbank_food"),d=c.data("modelCid"),e=c.data("result_type"),f;f=ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("show")?ETM.ingredients_search_model:ETM.search_model;if("undefined"!==typeof b)d=ETM.food_info_object_list.add(b.food),e=b,e.food=d,f=new ETM.FoodObject(e);
else{if(e in f.search_results_model_dict)f=f.search_results_model_dict[e].results.get(d);else if(_.has(f,"collection_foods_search_model")&&_.has(f.collection_foods_search_model.collection_results_models,e))f=f.collection_foods_search_model.collection_results_models[e].results.get(d);else return bugsnagClient.notify(Error("Error finding food to add as ingredient"),{metaData:{cid:d,result_type:d}}),c.remove(),ETM.toast.showNotification({message:"There was error adding the food :(<br/>Please try again, and if it keeps happening, refreshing the page should fix it. Sorry!!",
type:"error"}),!1;d=f.attributes.food;ETM.food_info_object_list.add(d);e=f.toJSON();e.food=d}if(ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("show")){if(f.get("food").get("is_recipe")){c.remove();this.trigger("addedRecipe");return}this.trigger("addedIngredient");d=new ETM.IngredientObject(e)}else d=new ETM.FoodObject(e);e=a.children().index(c);c.remove();return{modelToAdd:d,newIndex:e}}});
ETM.LeftoversChain=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/leftoverschain/",defaults:{user:null,parent_meal_type:null,child_meal_types:null,days_to_save_leftovers:1,repeat:!0,start_day:6,number_dishes:1},schema:{days_to_save_leftovers:{type:"Select",validators:["required"],value_type:"Number",options:[0,1,2,3,4,5,6]},number_dishes:{type:"Select",validators:["required"],value_type:"Number",options:[1,2,3]},repeat:{type:"Radio",value_type:"Boolean",options:[{val:"true",label:"Repeat pattern once leftovers are eaten"},
{val:"false",label:"Start on a specific day, no repeat"}]},start_day:{type:"Select",value_type:"Number",options:[{val:6,label:"Sunday"},{val:0,label:"Monday"},{val:1,label:"Tuesday"},{val:2,label:"Wednesday"},{val:3,label:"Thursday"},{val:4,label:"Friday"},{val:5,label:"Saturday"}]}},initialize:function(){!1===ETM.current_profile_completeness.get("setup_leftovers")&&this.listenToOnce(this,"change",function(){!1===ETM.current_profile_completeness.get("setup_leftovers")&&ETM.current_profile_completeness.save({setup_leftovers:!0},
{patch:!0})})}});ETM.LeftoversChainList=Backbone.Collection.extend({model:ETM.LeftoversChain,url:ROOT+"/leftoverschain/",findUnusedChainColorInt:function(){var a=[];a.length=COLOR_LIST.length;this.forEach(function(b){null!=b.chain_color_int&&b.chain_color_int<a.length&&(a[b.chain_color_int]=!0)});for(var b=0;b<a.length;b++)if(null==a[b])return b;return Helper.randomNumber(a.length)}});ETM.LOCAL_VARIABLES_URI="LOCAL_VARIABLES";
ETM.LocalVariables=Backbone.Model.extend({local:!0,remote:!1,urlRoot:ROOT+"/notifications/",defaults:{show_restaurant_availability_alert:!0,seen_refresh_leftovers_info:!1,dont_show_refresh_leftovers_info:!1,seen_draggable_sidebar_tooltip:!1,seen_meal_rating_info:!1,seen_food_rating_info:!1,seen_pantry_stocking_popover:!1,seen_collections_info:!1,seen_beta_algo_info:!1,seen_arrow_key_info:!1,seen_multi_day_view_info:!1,seen_thumbs_down_temp_tooltip:!1,resource_uri:ETM.LOCAL_VARIABLES_URI,sort_by_pantry:!1,
carousel_view:ETM.is_premium?ETM.MULTI_DAY_VIEW_LABEL:ETM.SINGLE_DAY_VIEW_LABEL,hide_apply_changes_dates:[],print_settings:{include_grocery_list:!0,include_meal_plans:!0,include_full_recipes:!0,include_links:!0,print_format:"standard"},foodbank_tab:"recent_foods",prefer_organic_groceries:!1,rated_meals:{}},addHiddenApplyChangesDate:function(a){a=Helper.convertDateToString(a);-1==$.inArray(a,this.attributes.hide_apply_changes_dates)&&(this.attributes.hide_apply_changes_dates.push(a),this.save())},
isApplyChangesHiddenForDate:function(a){a=Helper.convertDateToString(a);return-1<$.inArray(a,this.attributes.hide_apply_changes_dates)},initialize:function(){}});ETM.ManagedAccount=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/managedaccount/"});ETM.ManagedAccountList=Backbone.Collection.extend({model:ETM.ManagedAccount,url:ROOT+"/managedaccount/"});
ETM.getApprovedAccountsWithManager=function(){var a=new ETM.ManagedAccountList,b=new ETM.ManagedAccount({approved_date:"",client_email:ETM.current_user_profile.attributes.email,client_full_name:"You",client_user:$.extend({},ETM.current_user_profile.attributes),force_information_update:!0,id:ETM.current_user_profile.attributes.user_id,client_id:ETM.current_user_profile.attributes.user_id,link_deleted_date:null,manager_approved:!0,resource_uri:"",user:""});b.attributes.client_user.id=b.attributes.client_user.user_id;
b.attributes.client_user.is_current_user=!0;b.attributes.client_user.full_name=b.attributes.client_full_name;b.attributes.client_user.full_name_email=b.attributes.client_full_name+" "+b.attributes.client_email;b.attributes.client_user.exclusions=ETM.current_user_profile.getExclusionsString();a.add(b);ETM.managed_accounts.forEach(function(b){a.add(b)});return a};ETM.ManagedExternalAccount=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/managedexternalaccount/"});
ETM.ManagedExternalAccountList=Backbone.Collection.extend({model:ETM.ManagedExternalAccount,url:ROOT+"/managedexternalaccount/"});ETM.ManagerInvitedUser=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/managerinviteduser/"});ETM.ManagerInvitedUserList=Backbone.Collection.extend({model:ETM.ManagerInvitedUser,url:ROOT+"/managerinviteduser/"});DEFAULT_TRAINER_LOGO="https://images.eatthismuch.com/images/trainer-placeholder.png";DEFAULT_ADD_TRAINER_LOGO="https://images.eatthismuch.com/images/trainer-placeholder-add.png";
ETM.ManagerProfile=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/managerprofile/",getLogoUrl:function(a){a=a?DEFAULT_ADD_TRAINER_LOGO:DEFAULT_TRAINER_LOGO;return null!=this.attributes.logo_url?"https://images.eatthismuch.com/"+this.attributes.logo_url:a},remote:!0,getBrandDisplayOptions:function(){var a=[],b;for(b in this.attributes)this.attributes.hasOwnProperty(b)&&-1!=b.indexOf("display_")&&!0==this.attributes[b]&&a.push(b);return a}});
ETM.GooglePlacesMapDataObject=function(a){this.data=a;this.name=a.name;this.id=a.id;this.address=a.vicinity;this.category=null!=a.types&&0<a.types.length?a.types[0]:"";this.lat=a.geometry.location.lat();this.lng=a.geometry.location.lng()};
ETM.FourSquareMapDataObject=function(a){this.data=a;this.name=a.name;this.id=a.id;this.address=a.location.address;this.category="";var b=this;a.categories.forEach(function(a){b.category=""===b.category?a.name:b.category+(", "+a.name)});this.lat=a.location.lat;this.lng=a.location.lng};ETM.MealNote=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/mealnote/"});
var mapMealType=function(a){if(_.isObject(a))return a;var b=ETM.meal_type_list&&ETM.meal_type_list.find(function(b){return b.get(b.idAttribute)===a});b||(b=ETM.client_meal_type_list&&ETM.client_meal_type_list.find(function(b){return b.get(b.idAttribute)===a}));return b?b:{}};
ETM.MealObject=Backbone.AssociatedModel.extend({defaults:{meal_number:null,meal_type:null},urlRoot:ROOT+"/meal/",relations:[{type:Backbone.Many,key:"foods",relatedModel:"ETM.FoodObject",collectionType:"ETM.FoodList",customSerialize:function(a){a.models.forEach(function(a){delete a.attributes.is_custom});return a}},{type:Backbone.One,key:"meal_type",relatedModel:"ETM.MealType",map:mapMealType,customSerialize:function(a){return null==a.attributes.resource_uri?a:a.attributes.resource_uri}},{type:Backbone.One,
key:"meal_note",relatedModel:"ETM.MealNote"}],initialize:function(){"undefined"==typeof this.attributes.foods&&(this.attributes.foods=new ETM.FoodList);this.parent=null;this.setParentDiet();this.initializeEvents();this.calculateStats();this.profileCompletenessEvents()},initializeEvents:function(){var a=this;this.listenTo(this,"updateStats:foods",function(b,c){a.calculateStats();a.trigger("updateStats")});this.listenTo(this,"add:foods",function(b,c){a.calculateStats();a.trigger("updateStats");b.set("meal",
this.id);b.parent=this;null!=this.attributes.user&&b.set("user",this.attributes.user);(b.attributes.has_leftovers||b.attributes.is_leftovers)&&b.updateRelatedLeftovers("update");if(ETM.use_local_storage){var d=a.getParentDiet();Helper.resetLocalFoodInfoIDs(d);d.save()}a.trigger("checkRecurring")},this);this.listenTo(this,"sortReceive:foods",function(a){a.save()},this);this.listenTo(this,"remove:foods",function(b,c){a.calculateStats();a.trigger("updateStats");if(ETM.use_local_storage){var d=a.getParentDiet();
Helper.resetLocalFoodInfoIDs(d);d.save()}});this.listenTo(this,"reset:foods",function(b,c){a.calculateStats();a.trigger("updateStats")});this.listenTo(this,"change:eaten",function(a,c){ETM.analytics.logEatenMeal(a,c);ETM.generator_results_cache.clearCache()})},setParentDiet:function(){_.has(this,"collection")&&_.has(this.collection,"parents")&&1==this.collection.parents.length&&this.collection.parents[0]instanceof ETM.Diet&&(this.parent=this.collection.parents[0])},getParentDiet:function(){return this.parent},
hasParentDiet:function(){return _.has(this,"parent")&&null!==this.parent},getCalendarDate:function(){return this.hasParentDiet()&&this.getParentDiet().isCalendar()?this.getParentDiet().getParent().attributes.date:!1},profileCompletenessEvents:function(){"undefined"!=typeof ETM.current_profile_completeness&&!1===ETM.current_profile_completeness.attributes.mark_meal_as_eaten&&this.listenToOnce(this,"change:eaten",function(){this.get("eaten")&&!1===ETM.current_profile_completeness.attributes.mark_meal_as_eaten&&
ETM.current_profile_completeness.save({mark_meal_as_eaten:!0},{patch:!0})})},comparator:function(a){return a.get("meal_number")},isLocked:function(){return!0===this.attributes.eaten||this.allLockedRecurringFoods()?!0:!1},calculateTotalTime:function(){var a=0;this.attributes.foods.each(function(b){a+=b.attributes.food.attributes.total_time});return a},calculateTotalIngredients:function(){var a=0;this.attributes.foods.each(function(b){a+=b.attributes.food.attributes.number_of_ingredients});return a},
allLockedRecurringFoods:function(){var a=this.attributes.meal_type;if(!a.attributes.only_use_recurring||0<ETM.recurring_collections_list.where({meal_type:a.id}).length)return!1;for(var b=ETM.recurring_foods_list.byMealType(a.id),c=!0,d=0;d<b.models.length;d++)if(1!==b.models[d].attributes.frequency){c=!1;break}return c&&a.attributes.only_use_recurring},initV1Generator:function(){this.generator||(ETM.is_logged_in?this.hasParentDiet()&&this.getParentDiet().is_diet_set?this.generator=new ETM.GoGenerators.MealGeneratorDietSet(this):
this.generator=new ETM.GoGenerators.MealGenerator(this):this.generator=new ETM.GoGenerators.MealGeneratorJson(this))},initV2Generator:function(){this.generator||(ETM.is_logged_in?this.hasParentDiet()&&this.getParentDiet().is_diet_set?this.generator=new ETM.GoGenerators.V2MealGeneratorDietSet(this):this.generator=new ETM.GoGenerators.V2MealGenerator(this):this.generator=new ETM.GoGenerators.V2MealGeneratorJson(this))},regenerateMealServer:function(a){bugsnagClient.leaveBreadcrumb("Meal generate",{num_meals:this.getParentDiet().attributes.num_meals,
target_calories:this.getParentDiet().attributes.nutrition_profile.attributes.calories,meal_number:this.attributes.meal_number});this.generator&&this.generator.algorithm!=ETM.current_user_profile.attributes.algorithm&&delete this.generator;ETM.current_user_profile.v2AlgorithmEnabled()?this.initV2Generator():this.initV1Generator();this.generator.run(a)},getRestaurantSearchRequestObject:function(a,b){var c=this,d=this.getGenerateRequestObject(a),e=d.meal_plan_dates[0].diet;e.meals=e.meals.filter(function(a){return a.meal_number===
c.attributes.meal_number});e.meals[0].meal_number=0;e.num_meals=1;e.nutrition_profile=_.extend(e.nutrition_profile,b);return d},getV2GenerateJson:function(){var a=this.toJSONFull({serialize_keys:"id resource_uri eaten locked meal_type meal_number is_locked".split(" ")});a.resource_uri=parseInt(a.resource_uri);a.foods=[];this.attributes.foods.each(function(b){a.foods.push(b.getV2GenerateJson())});return a},getV2JsonId:function(){return parseInt(this.id)},getGenerateRequestObject:function(a){var b=
this;this.getParentDiet().attributes.meals.forEach(function(c){c.attributes.is_locked=c.attributes.meal_number!=b.attributes.meal_number;a&&c.attributes.meal_number===b.attributes.meal_number&&(c.attributes.meal_type.attributes.is_restaurant_meal=!0,c.attributes.meal_type.attributes.restaurant_meal_settings=a)});var c=this.getParentDiet().getGenerateRequestObject();this.getParentDiet().attributes.meals.forEach(function(a){delete a.attributes.is_locked;delete a.attributes.meal_type.attributes.is_restaurant_meal;
delete a.attributes.meal_type.attributes.restaurant_meal_settings});if(this.attributes.id)c.meals_to_regenerate=[this.attributes.id];else{var d=parseIdFromResourceURI(this.attributes.resource_uri);d||(d=this.attributes.resource_uri);c.meals_to_regenerate=[parseInt(d)]}return c},toGeneratorJSON:function(a){var b=this.toJSONFull({serialize_keys:"id resource_uri eaten locked meal_type meal_number is_locked".split(" ")});b.foods=[];this.attributes.foods.each(function(c){b.foods.push(c.toGeneratorJSON(a))});
if(!_.has(b,"id")){var c=parseIdFromResourceURI(b.resource_uri);b.id=c?parseInt(c):parseInt(b.resource_uri)}return b},clearFoodsRelatedLeftovers:function(){this.attributes.foods.each(function(a){a.attributes.is_leftovers&&(a.updateRelatedLeftovers("delete"),a.set({is_leftovers:!1}))})},updateFoodsChildLeftovers:function(){this.attributes.foods.each(function(a){a.attributes.has_leftovers&&a.updateChildLeftovers()})},calculateStats:function(){var a=this;a.stats=new ETM.NutritionStatsObject;ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=
0});this.attributes.foods.each(function(b){ETM.NUTRIENT_LIST.forEach(function(c){a.stats[c]+=b.stats[c]})})},getFoodIDString:function(){var a=[];this.get("foods").each(function(b){a.push(parseInt(b.attributes.food.attributes.id))});a.sort();return 0<a.length?a.join(","):""},getThumbRating:function(a){if(is_mobile&&!app||!ETM.is_logged_in)return 0;var b=this.getFoodIDString();a=a||this.attributes.meal_type.id;a=ETM.meal_rating_list.findWhere({meal_type:a,food_ids:b});return"undefined"===typeof a?0:
a.attributes.rating},saveThumbRating:function(a,b,c,d,e){var f=this.getFoodIDString();c=null!==c?0<=c?c:this.attributes.meal_number:this.attributes.meal_number;d=d||this.parent.attributes.num_meals;b=b||this.attributes.meal_type.id;0<f.length&&(new ETM.MealRating({food_ids:f,meal_type:b,rating:a,meal_number:c,num_meals:d})).save(null,{success:function(a,b){ETM.meal_rating_list.add(a,{merge:!0});e()},error:function(a,b){e()}})}});ETM.COMPLEXITY_CONSTANTS={SUPER_SIMPLE:0,SIMPLE:1,MODERATE:2,COMPLEX:3};
ETM.BREAKFAST_CONSTANTS={NO_BREAKFAST:0,ALLOW_BREAKFAST:1,ONLY_BREAKFAST:2};ETM.MEAL_SIZE_CONSTANTS={TINY_MEAL:50,SMALL_MEAL:75,NORMAL_MEAL:100,BIG_MEAL:125,HUGE_MEAL:150};
ETM.MealList=Backbone.Collection.extend({model:ETM.MealObject,url:ROOT+"/meal/",createMealsIfNeeded:function(){if(0==this.length)for(var a=0;4>a;a++){var b=new ETM.MealObject;b.attributes.meal_number=a;0==a?b.attributes.meal_type=ETM.MealType.setupBreakfastMealType():1==a?b.attributes.meal_type=ETM.MealType.setupLunchMealType():2==a?b.attributes.meal_type=ETM.MealType.setupDinnerMealType():3==a&&(b.attributes.meal_type=ETM.MealType.setupSnackMealType());this.listenToOnce(b.attributes.meal_type,"change",
function(){!1===ETM.current_profile_completeness.get("customized_meal_types")&&ETM.current_profile_completeness.save({customized_meal_types:!0},{patch:!0})});this.add(b)}}});ETM.MealRating=Backbone.Model.extend({urlRoot:ROOT+"/mealrating/",getHash:function(){for(var a=0,a=this.attributes.food_ids.split(","),b=0;b<a.length;b++)a[b]=parseInt(a[b],10);return a=this.attributes.meal_type?Helper.generateMealRatingHash(a,parseIdFromResourceURI(this.attributes.meal_type)):Helper.generateMealRatingHash(a)}});
ETM.MealRatingList=Backbone.Collection.extend({model:ETM.MealRating,url:ROOT+"/mealrating/",initialize:function(){this.on("add",this._onAdd,this);this.on("remove",this._onRemove,this);this.on("reset",this._onReset,this);this._onReset()},hasMealHash:function(a){return!0===this._idHashSet[a]},hasThumbsDownMeal:function(a){return!0===this._thumbsDownHashSet[a]},hasThumbsUpMeal:function(a){return!0===this._thumbsUpHashSet[a]},_onAdd:function(a){var b=a.getHash();this._idHashSet[b]=!0;a.attributes.rating===
THUMB_RATINGS.THUMBS_DOWN?this._thumbsDownHashSet[b]=!0:a.attributes.rating===THUMB_RATINGS.THUMBS_UP&&(this._thumbsUpHashSet[b]=!0)},_onRemove:function(a){delete this._idHashSet[a.getHash()];delete this._thumbsUpHashSet[a.getHash()];delete this._thumbsDownHashSet[a.getHash()]},_onReset:function(a){this._idHashSet={};this._thumbsUpHashSet={};this._thumbsDownHashSet={};this.each(this._onAdd)}});ETM.MealTag=Backbone.Model.extend({idAttribute:"bit_index",initialize:function(){}});
ETM.MealTagList=Backbone.Collection.extend({model:ETM.MealTag,url:ROOT+"/mealtag/"});var COMPLEXITY_CHOICES=["Super simple","Simple","Moderate","Complex"];
ETM.MealType=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/mealtype/",defaults:{title:null,size_slider:100,family_scale:1,breakfast:0,takeout:!1,min_preptime:0,max_preptime:30,min_cooktime:0,max_cooktime:30,max_totaltime:30,complexity:2,override_complexity:!1,only_use_recurring:!1,deleted:!1},breakfast_choices:{NO_BREAKFAST_FOODS:0,ALLOW_BREAKFAST_FOODS:1,ONLY_BREAKFAST_FOODS:2},default_extra_meal_title:"Snack",schema:{title:{type:"Text",editorAttrs:{maxlength:100},validators:["required"]},size_slider:{type:"Select",
value_type:"Number",validators:["required"],options:[{val:ETM.MEAL_SIZE_CONSTANTS.TINY_MEAL,label:"Tiny meal"},{val:ETM.MEAL_SIZE_CONSTANTS.SMALL_MEAL,label:"Small meal"},{val:ETM.MEAL_SIZE_CONSTANTS.NORMAL_MEAL,label:"Normal meal"},{val:ETM.MEAL_SIZE_CONSTANTS.BIG_MEAL,label:"Big meal"},{val:ETM.MEAL_SIZE_CONSTANTS.HUGE_MEAL,label:"Huge meal"}]},family_scale:{type:"Select",validators:["required"],value_type:"Number",options:[{val:1,label:"1 person"},{val:2,label:"2 people"},{val:3,label:"3 people"},
{val:4,label:"4 people"},{val:5,label:"5 people"},{val:6,label:"6 people"},{val:7,label:"7 people"},{val:8,label:"8 people"},{val:9,label:"9 people"}]},breakfast:{type:"Radio",value_type:"Number",options:[{val:0,label:"No breakfast foods"},{val:1,label:"Breakfast foods and other foods"},{val:2,label:"Only breakfast foods"}]},override_complexity:{type:"Checkbox"},complexity:{type:"Select",validators:["required"],value_type:"Number",options:[{val:0,label:"Super simple"},{val:1,label:"Simple"},{val:2,
label:"Moderate"},{val:3,label:"Complex"}]},max_totaltime:{type:"Select",validators:["required"],value_type:"Number",options:[{val:5,label:"No time (<5 min)"},{val:15,label:"Little time (<15 min)"},{val:30,label:"Some time (<30 min)"},{val:45,label:"More time (<45 min)"},{val:60,label:"Lots of time (<60 min)"},{val:1E3,label:"No limit"}]},only_use_recurring:{type:"AnimatedCheckbox",validators:[],value_type:"boolean",options:[{val:!0,label:"Use only recurring foods for this meal?"}]}},initialize:function(){this.fetched_recurring_foods=
!1;this.recurring_foods=[];this.fetched_collection_foods=!1;this.recurring_collections=[];this.recurring_collection_food_index={}},validate:function(a){var b=this,c={};0<ETM.meal_type_list.filter(function(c){return c.attributes.title===a.title&&!c.deleted&&(null==b.attributes.user_id||c.attributes.user_id==b.attributes.user_id)&&c.id!==b.id}).length&&(c.title={message:"A meal type with the title "+a.title+' already exists.  <button class="btn btn-secondary replace-button">Rename other meal types</button>'});
if(!$.isEmptyObject(c))return c},loadRecurringFoods:function(){ETM.is_logged_in&&(this.recurring_foods=ETM.recurring_foods_list.byMealType(this.id));this.fetched_recurring_foods=!0},loadRecurringCollectionFoods:function(){if(ETM.is_logged_in){var a=this,b=ETM.recurring_collections_list.where({meal_type:this.id});this.recurring_collections=new ETM.RecurringFoodCollectionList(b);this.recurring_collection_food_index={};0<this.recurring_collections.length&&this.recurring_collections.each(function(b){_.each(b.attributes.food_ids,
function(d){_.has(a.recurring_collection_food_index,d)?a.recurring_collection_food_index[d].push(b):a.recurring_collection_food_index[d]=[b]})})}this.fetched_collection_foods=!0},getRecurringFood:function(a){this.fetched_recurring_foods||this.loadRecurringFoods();return 0<this.recurring_foods.length?(a=this.recurring_foods.byFoodId(a),0<a.length?a[0]:!1):!1},getMealTypeDescription:function(){this.fetched_recurring_foods||this.loadRecurringFoods();this.fetched_collection_foods||this.loadRecurringCollectionFoods();
description_string=COMPLEXITY_CHOICES[this.attributes.complexity]+", "+TIME_DESCRIPTIONS[this.attributes.max_totaltime]+", "+SIZE_DESCRIPTIONS[this.attributes.size_slider]+" meal";1<this.attributes.family_scale&&(description_string=description_string+'&bull; <span class="fa fa-users" aria-hidden="true"></span> x '+this.attributes.family_scale);0<this.recurring_foods.length&&(description_string=description_string+" &bull; "+this.recurring_foods.length+" Recurring food",1<this.recurring_foods.length&&
(description_string+="s"));0<this.recurring_collections.length&&(description_string=description_string+" &bull; "+this.recurring_collections.length+" Collection",1<this.recurring_collections.length&&(description_string+="s"));return description_string},getRecurringCollectionsContainingFood:function(a){this.fetched_collection_foods||this.loadRecurringCollectionFoods();return _.has(this.recurring_collection_food_index,a)?this.recurring_collection_food_index[a]:[]}},{setupBreakfastMealType:function(){var a=
ETM.meal_type_list.findWhere({title:"Breakfast"});"undefined"==typeof a&&(a=new ETM.MealType,a.attributes.breakfast=ETM.BREAKFAST_CONSTANTS.ONLY_BREAKFAST,a.attributes.title="Breakfast",a.attributes.complexity=ETM.COMPLEXITY_CONSTANTS.MODERATE,ETM.meal_type_list.add(a,{silent:!0}),a.save(null,{async:!1}));return a},setupLunchMealType:function(){var a=ETM.meal_type_list.findWhere({title:"Lunch"});"undefined"==typeof a&&(a=new ETM.MealType,a.attributes.breakfast=ETM.BREAKFAST_CONSTANTS.NO_BREAKFAST,
a.attributes.max_cooktime=0,a.attributes.title="Lunch",a.attributes.complexity=ETM.COMPLEXITY_CONSTANTS.MODERATE,ETM.meal_type_list.add(a,{silent:!0}),a.save(null,{async:!1}));return a},setupDinnerMealType:function(){var a=ETM.meal_type_list.findWhere({title:"Dinner"});"undefined"==typeof a&&(a=new ETM.MealType,a.attributes.min_cooktime=1,a.attributes.title="Dinner",a.attributes.breakfast=ETM.BREAKFAST_CONSTANTS.NO_BREAKFAST,a.attributes.complexity=ETM.COMPLEXITY_CONSTANTS.MODERATE,a.attributes.size_slider=
ETM.MEAL_SIZE_CONSTANTS.BIG_MEAL,ETM.meal_type_list.add(a,{silent:!0}),a.save(null,{async:!1}));return a},setupSnackMealType:function(){var a=ETM.meal_type_list.findWhere({title:"Snack"});"undefined"==typeof a&&(a=new ETM.MealType,a.attributes.max_cooktime=0,a.attributes.title="Snack",a.attributes.breakfast=ETM.BREAKFAST_CONSTANTS.ALLOW_BREAKFAST,a.attributes.complexity=ETM.COMPLEXITY_CONSTANTS.SIMPLE,a.attributes.size_slider=ETM.MEAL_SIZE_CONSTANTS.TINY_MEAL,a.attributes.max_totaltime=15,ETM.meal_type_list.add(a,
{silent:!0}),a.save(null,{async:!1}));return a}});
ETM.MealTypeList=Backbone.Collection.extend({model:ETM.MealType,url:ROOT+"/mealtype/",comparator:function(a){var b=a.attributes.id+10;if(1<ETM.template_diet_list.length){var c=0,d=0;ETM.template_diet_list.each(function(b){if(b=b.attributes.diet.attributes.meals.findWhere({meal_type:a}))c++,d+=b.attributes.meal_number});0<c&&(b=d/c)}return b},getMealTypeNameAndIds:function(){var a=[];this.each(function(b){b.attributes.deleted||a.push({val:b.id,label:b.attributes.title})});return a}});
ETM.NutritionProfile=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/nutritionprofile/",defaults:{calories:null,cholesterol:300,date_made:null,deleted:!1,description:null,fiber:25,macro_scheme:"grams",max_carbs:1E3,max_fats:1E3,max_proteins:1E3,min_carbs:0,min_fats:0,min_proteins:0,percent_carbs:40,percent_fats:30,percent_proteins:30,sodium:2400,title:"My Nutrition Targets",watch_cholesterol:!1,watch_sodium:!1},schema:{title:{type:"Text",editorAttrs:{maxlength:110},validators:["required"]},description:"Text",
calories:{type:"PositiveNumber",editorAttrs:{step:50}},macro_scheme:{type:"SegmentedRadio",validators:["required"],options:[{val:"grams",label:"Within a range"},{val:"percents",label:"As a percentage of calories"}]},max_carbs:"PositiveNumber",max_fats:"PositiveNumber",max_proteins:"PositiveNumber",min_carbs:"PositiveNumber",min_fats:"PositiveNumber",min_proteins:"PositiveNumber",percent_carbs:"PositiveNumber",percent_fats:"PositiveNumber",percent_proteins:"PositiveNumber",sodium:{type:"PositiveNumber",
editorAttrs:{step:50}},fiber:"PositiveNumber",cholesterol:{type:"PositiveNumber",editorAttrs:{step:10}},watch_cholesterol:"Checkbox",watch_sodium:"Checkbox"},validate:function(a,b){var c=this,d={};"percents"===a.macro_scheme&&100!=a.percent_fats+a.percent_proteins+a.percent_carbs&&(d.macro_scheme={message:"Your macro proportions must equal 100 (currently "+(a.percent_fats+a.percent_proteins+a.percent_carbs)+")."});a.calories&&"undefined"!==typeof a.calories?200>a.calories?d.calories={message:"Calories must be at least 200."}:
2E4<a.calories&&(d.calories={message:"Calories must be at most 20000."}):d.calories={message:"A calorie number is required."};0<ETM.nutrition_profile_list.filter(function(b){return b.attributes.title===a.title&&!b.deleted&&(null==c.attributes.user_id||b.attributes.user_id==c.attributes.user_id)&&b.id!=c.id}).length&&(d.title={message:"A nutrition profile with the title "+a.title+' already exists.  <button class="btn btn-secondary replace-button">Rename other nutrition profiles</button>'});if(!$.isEmptyObject(d))return d},
scaleMacrosForPresetDiet:function(a){a=ETM.PRESET_DIET_TARGETS[a];var b=this.attributes.calories;this.save({min_carbs:roundNumber(a.min_carbs/100*b/4,0),max_carbs:roundNumber(a.max_carbs/100*b/4,0),min_fats:roundNumber(a.min_fats/100*b/9,0),max_fats:roundNumber(a.max_fats/100*b/9,0),min_proteins:roundNumber(a.min_proteins/100*b/4,0),max_proteins:roundNumber(a.max_proteins/100*b/4,0)})},scaleMacrosFromCalories:function(a,b){if(10<b)var c=a/b;else this.attributes.min_carbs=0<this.attributes.min_carbs?
this.attributes.min_carbs:a/4/5,this.attributes.min_fats=0<this.attributes.min_fats?this.attributes.min_fats:a/9/5,this.attributes.min_proteins=0<this.attributes.min_proteins?this.attributes.min_proteins:a/4/5,c=1;var d=roundNumber(a/4,0),e=roundNumber(a/9,0),f=roundNumber(a/4,0),g=roundNumber(this.attributes.max_carbs*c,0),h=roundNumber(this.attributes.max_fats*c,0),m=roundNumber(this.attributes.max_proteins*c,0),k=4*g+4*m+9*h<a;this.set({min_carbs:roundNumber(this.attributes.min_carbs*c,0),max_carbs:d<
g||0===g||k?roundNumber(d/2,0):g,min_fats:roundNumber(this.attributes.min_fats*c,0),max_fats:e<h||0===h||k?roundNumber(e/2,0):h,min_proteins:roundNumber(this.attributes.min_proteins*c,0),max_proteins:f<m||0===m||k?roundNumber(f/2,0):m})},changePresetDiet:function(a){a=Helper.calculateMacrosFromProfile(ETM.current_user_profile.clone().set("preset_diet",a));if(!a)return!1;delete a.capped_min_calories;return this.save(a)}});
ETM.NutritionProfileList=Backbone.Collection.extend({model:ETM.NutritionProfile,url:ROOT+"/nutritionprofile/"});
ETM.SimpleNutritionProfile=ETM.NutritionProfile.extend({local:!0,remote:!1,urlRoot:ROOT+"/simple-nutrition-targets/",schema:{calories:{type:"PositiveNumber"},max_carbs:"PositiveNumber",max_fats:"PositiveNumber",max_proteins:"PositiveNumber",min_carbs:"PositiveNumber",min_fats:"PositiveNumber",min_proteins:"PositiveNumber"},defaults:{resource_uri:"123456789",customized_targets:!1,calories:2E3,cholesterol:300,fiber:25,macro_scheme:"grams",max_carbs:1E3,max_fats:1E3,max_proteins:1E3,min_carbs:0,min_fats:0,
min_proteins:0,sodium:2400,watch_cholesterol:!1,watch_sodium:!1},validate:function(a,b){var c={};"percents"===a.macro_scheme&&100!=a.percent_fats+a.percent_proteins+a.percent_carbs&&(c.macro_scheme={message:"Your macro proportions must equal 100 (currently "+(a.percent_fats+a.percent_proteins+a.percent_carbs)+")."});a.calories&&"undefined"!==typeof a.calories?50>a.calories?c.calories={message:"Calories must be at least 50."}:2E4<a.calories&&(c.calories={message:"Calories must be at most 20000."}):
c.calories={message:"A calorie number is required."};if(!$.isEmptyObject(c))return c},initialize:function(){}});
ETM.PRESET_DIET_TARGETS={anything:{min_carbs:20,max_carbs:50,min_fats:20,max_fats:50,min_proteins:20,max_proteins:50},"atkins / ketogenic":{min_carbs:0,max_carbs:9,min_fats:60,max_fats:85,min_proteins:15,max_proteins:30},paleo:{min_carbs:10,max_carbs:30,min_fats:20,max_fats:70,min_proteins:10,max_proteins:35},mediterranean:{min_carbs:10,max_carbs:40,min_fats:20,max_fats:70,min_proteins:10,max_proteins:40},vegetarian:{min_carbs:10,max_carbs:100,min_fats:20,max_fats:100,min_proteins:10,max_proteins:100},
vegan:{min_carbs:10,max_carbs:100,min_fats:20,max_fats:100,min_proteins:10,max_proteins:100}};ETM.ProfileCompleteness=Backbone.AssociatedModel.extend({initialize:function(){},getCompletenessPercent:function(){var a=this,b=0,c=0;ETM.ALL_PROFILE_TODOS.forEach(function(d){d.premium?ETM.is_premium&&(b+=d.weight,!0===a.get(d.key)&&(c+=d.weight)):(b+=d.weight,!0===a.get(d.key)&&(c+=d.weight))});return roundNumber(100*c/b,0)}});
ETM.ProfileCompletenessList=Backbone.Collection.extend({model:ETM.ProfileCompleteness,url:ROOT+"/profilecompleteness/"});ETM.RecipeObject=Backbone.AssociatedModel.extend({remote:!0,urlRoot:ROOT+"/recipe/",relations:[{type:Backbone.Many,key:"ingredients",relatedModel:"ETM.IngredientObject",collectionType:"ETM.IngredientsList"},{type:Backbone.Many,key:"directions",relatedModel:"ETM.Direction",collectionType:"ETM.DirectionsList"}],initialize:function(){}});
var mapCollections=function(a){"undefined"!=typeof a.id&&1==Object.keys(a).length&&(a=a.id);if(_.isObject(a))return a;var b=ETM.browse_collections_model&&ETM.browse_collections_model.findCollection(function(b){return b.get(b.idAttribute)===a||b.get(b.idAttribute)===ROOT+"/foodcollection/"+a+"/"});!b&&ETM.single_collection_model&&ETM.single_collection_model.getShortURI()===a&&(b=ETM.single_collection_model);return b?b:a};
ETM.RecurringFoodCollection=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/recurringfoodcollection/",relations:[{type:Backbone.One,key:"food_collection",relatedModel:"ETM.SimpleFoodCollection",customSerialize:function(a){return a&&_.has(a,"attributes")?(_.has(a.attributes,"resource_uri")||bugsnagClient.notify(Error("Collection missing resource uri"),{metaData:{collection_obj:JSON.stringify(a)}}),a.attributes.resource_uri.replace("/fullfoodcollection/","/foodcollection/")):a},map:mapCollections}],
validate:function(a,b){var c={},d=a.food_collection;if(d){var e=ETM.recurring_collections_list.filter(function(b){return(b.get("food_collection")==d||b.get("food_collection").id===d)&&b.get("meal_type")===a.meal_type}),f=e.indexOf(this);-1<f&&e.splice(f,1);0<e.length&&(e=ETM.meal_type_list.get(a.meal_type),c.meal_type={message:"This collection is already recurring for "+e.attributes.title})}if(!$.isEmptyObject(c))return c}});
ETM.RecurringFoodCollectionList=Backbone.Collection.extend({model:ETM.RecurringFoodCollection,url:ROOT+"/recurringfoodcollection/",fetchMissingCollectionFoods:function(a){try{if(ETM.is_logged_in){var b={},c=[];this.each(function(a){a.attributes.food_ids.forEach(function(a){if(!_.has(b,a)){var d=ROOT+"/food/"+a+"/";ETM.food_info_object_list.get(d)||(ETM.food_info_object_list.add({id:d}),c.push(a),b[a]=!0)}})});var d=function(a,b){0<a.length?500<a.length?(extra_ids=a.splice(500),ETM.food_info_object_list.fetch({remove:!1,
url:ROOT+"/food/set/"+a.join(";")+"/",success:function(){d(extra_ids,b)}})):ETM.food_info_object_list.fetch({remove:!1,url:ROOT+"/food/set/"+a.join(";")+"/",success:function(){b()}}):b()};d(c,a)}else a()}catch(e){console.log("Error fetching collections..."),bugsnagClient.notify(e),a()}}});
ETM.GlobalRecurringFoodCollectionList=ETM.RecurringFoodCollectionList.extend({initialize:function(){ETM.RecurringFoodCollectionList.prototype.initialize.apply(this,arguments);this.listenTo(this,"add remove",function(a,b){var c=ETM.meal_type_list.findWhere({resource_uri:a.attributes.meal_type});c&&(c.fetched_collection_foods=!1);this.trigger("rerender",a.attributes.meal_type)},this)},deleteRecurringCollections:function(a){a=this.where({"food_collection.secret_url":a});for(var b=a.length-1;0<=b;b--)a[b].destroy()},
updateRecurringCollections:function(a){for(var b=this.where({"food_collection.secret_url":a.get("secret_url")}),c=0;c<b.length;c++)b[c].get("food_collection.title")!==a.get("title")&&b[c].set("food_collection.title",a.get("title")),b[c].get("food_collection.num_foods")!==a.get("num_foods")&&b[c].set("food_collection.num_foods",a.get("num_foods"))}});
ETM.RecurringFood=ETM.FoodObject.extend({urlRoot:ROOT+"/recurringfood/",defaults:{frequency:1,amount:1},relations:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodInfoObject",customSerialize:function(a){return a.attributes.resource_uri},map:mapFoodData}],initialize:function(){if(null==this.attributes.food||!(this.attributes.food instanceof ETM.FoodInfoObject))throw"Recurring food initialized without food info object";this.save_timer=null;this.combineFoodInfoPointers();if(null==this.attributes.units||
null==this.attributes.amount)this.attributes.units=this.attributes.food.attributes.default_units,this.attributes.amount=1;this.initializeEvents();this.calculateStats()},validate:function(a,b){var c={},d=this.attributes.food;if(d){var d=ETM.recurring_foods_list.where({food:d,meal_type:a.meal_type}),e=d.indexOf(this);-1<e&&d.splice(e,1);0<d.length&&(d=ETM.meal_type_list.get(a.meal_type),c.meal_type={message:"This food is already recurring for "+d.attributes.title})}if(!$.isEmptyObject(c))return c}});
ETM.RecurringFood.frequency_types=["often","always"];
ETM.RecurringFoodList=Backbone.Collection.extend({model:ETM.RecurringFood,url:ROOT+"/recurringfood/",useCustomAdd:function(a){return a.item.hasClass("foodbank_food")},initialize:function(){var a=this;this.listenTo(this,"add",function(b,c){if(_.has(a,"meal_type")&&b.get("meal_type")!==a.meal_type){if(b.get("meal_type")){var d=ETM.meal_type_list.findWhere({resource_uri:b.get("meal_type")});d&&(d.fetched_recurring_foods=!1)}if(d=ETM.meal_type_list.findWhere({resource_uri:a.meal_type}))d.fetched_recurring_foods=!1;
b.save({meal_type:a.meal_type},{patch:!0})}},this)},byDishType:function(a){"main_dishes"===a?filtered=this.filter(function(a){return!0==a.get("food").get("main_dish")}):"side_dishes"===a&&(filtered=this.filter(function(a){return!1==a.get("food").get("main_dish")}));return filtered},byMealType:function(a){filtered=this.filter(function(b){return b.get("meal_type")==a});return new ETM.RecurringFoodList(filtered)},byFoodId:function(a){return filtered=this.filter(function(b){return b.get("food").id==a})},
customAdd:function(a,b){var c=a.find(".foodbank_food");if(ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("show"))c.remove();else{var d=c.data("modelCid"),e=c.data("result_type");if("undefined"!==typeof b)d=ETM.food_info_object_list.add(b.food),b.food=d;else{if(e in ETM.search_model.search_results_model_dict)e=ETM.search_model.search_results_model_dict[e].results.get(d);else if(_.has(ETM.search_model,"collection_foods_search_model")&&_.has(ETM.search_model.collection_foods_search_model.collection_results_models,
e))e=ETM.search_model.collection_foods_search_model.collection_results_models[e].results.get(d);else return e=null,bugsnagClient.notify(Error("Error finding food to drag on recurring foods page"),{metaData:{cid:d,result_type:d}}),c.remove(),ETM.toast.showNotification({message:"There was error adding the food :(<br/>Please try again, and if it keeps happening, refreshing the page should fix it. Sorry!!",type:"error"}),!1;d=e.attributes.food;ETM.food_info_object_list.add(d)}d=new ETM.RecurringFood({food:d,
meal_type:this.meal_type,frequency:0});d.save(null,{success:function(a){ETM.recurring_foods_list.add(a);a.trigger("recurring_food_saved")}});e=a.children().index(c);c.remove();return(c=d.validate(d.attributes))?(this.trigger("dragError",c),!1):{modelToAdd:d,newIndex:e}}}});
ETM.GlobalRecurringFoodList=ETM.RecurringFoodList.extend({initialize:function(){ETM.RecurringFoodList.prototype.initialize.apply(this,arguments);this.listenTo(this,"add remove",function(a,b){var c=ETM.meal_type_list.findWhere({resource_uri:a.attributes.meal_type});c&&(c.fetched_recurring_foods=!1)},this)}});
ETM.RestaurantFoodAndMapData=function(a,b){this.restaurant_names=[];this.id_to_restaurant_map_result_dict={};this.brand_id_to_restaurant_dict={};this.restaurant_name_to_id_dict={};this.restaurant_name_to_color_dict={};this.only_show_restaurants_with_foods=b;this.restaurant_list=a;var c=this;this.restaurant_list.forEach(function(a){c.id_to_restaurant_map_result_dict[a.ID]=a;c.brand_id_to_restaurant_dict[a.brand_id]=a;var b=Helper.removePunctuationAndLowerCase(a.name);_.has(c.restaurant_name_to_id_dict,
b)?c.restaurant_name_to_id_dict[b].push(a.ID):(c.restaurant_name_to_id_dict[b]=[a.ID],c.restaurant_names.push(a.name))});this.addRestaurantMealDataGo=function(a,b,f){function g(){for(var a=0;a<c.meal_combos.length;a++){var d=c.meal_combos[a];0<d.foods.length&&(d=new ETM.SimpleFoodList(d.foods),null!=d.models[0].attributes.food.attributes.brand_id&&c.nutrition_sorted_meals.push(new ETM.MealObject({foods:d,meal_type:b,restaurant_name:c.brand_id_to_restaurant_dict[d.models[0].attributes.food.attributes.brand_id].name})))}}
function h(){for(var a=0;a<c.meal_combos.length;a++){var d=c.meal_combos[a];if(0!==d.foods.length){var d=new ETM.SimpleFoodList(d.foods),f=d.models[0].attributes.food.attributes.brand_id;null!=f&&(f=c.brand_id_to_restaurant_dict[f],_.has(f,"meals")||(f.meals=new ETM.MealList),f.meals.add(new ETM.MealObject({foods:d,meal_type:b,restaurant_name:f.name})))}}for(a=0;a<c.restaurant_list.length;a++)c.restaurant_list[a].meals&&c.restaurant_name_sorted_meal_lists.push(c.restaurant_list[a].meals)}c.nutrition_sorted_meals=
[];c.restaurant_name_sorted_meal_lists=[];c.meal_combos=a.result_list.filter(function(a){return a.meal_number===f});null!=this.restaurant_list&&"object"===typeof this.restaurant_list&&(g(),h())}};ETM.MAX_RECENT_FOOD_RESULTS=30;ETM.INGREDIENTS_ONLY_URI="INGREDIENTS_ONLY_SEARCH_BAR";ETM.SEARCH_BAR_URI="SEARCH_BAR";
ETM.SearchResultsList=Backbone.Collection.extend({model:ETM.FoodObject,initialize:function(a,b){if("undefined"!=typeof b)for(var c in b)this[c]=b[c];this.food_info_object_list=new ETM.FoodInfoObjectList(a,b)},sync:function(){return!1}});
ETM.SearchResultsModel=Backbone.Model.extend({initialize:function(a){if("undefined"!=typeof a)for(var b in a)this[b]=a[b];this.results=new ETM.SearchResultsList([]);this.search_query="";this.total_results=0;this.finishInit(a)},finishInit:function(a){},extendResults:function(a){var b=this;"undefined"==typeof a&&null!=a||_.each(a,function(a){a=new ETM.FoodInfoObject(a);b.results.food_info_object_list.add(a);a=b.returnFoodObject(a);b.results.add(a,{silent:!0})})},updateResults:function(a){var b=this;
if("undefined"!=typeof a||null==a)b.results.reset(),b.results.food_info_object_list.reset(),_.each(a,function(a){a=new ETM.FoodInfoObject(a);b.results.food_info_object_list.add(a);a=b.returnFoodObject(a);b.results.add(a,{silent:!0})})},tokenizeQuery:function(a){final_tokens=[];cleaned_query=a.replace(/[.,\/#!$%\^&\*;:{}=_`~()><\']+/g," ");q_tokens=cleaned_query.match(/\S+/g)||[];_.each(q_tokens,function(a){2<a.length&&final_tokens.push(a.toLowerCase())});return final_tokens},search:function(a,b){if("undefined"!==
typeof this.all_foods){var c=[];2<a.length&&(c=this.tokenizeQuery(a));if(0!==c.length)try{var d=this.all_foods.filter(function(a){var b=0;_.each(c,function(c){-1!=a.search_text.toLowerCase().indexOf(c)&&b++});a.search_score=b;return 0<b}).sort(function(a,b){return b.search_score-a.search_score});this.results.reset(d);this.total_results=this.results.size()}catch(e){bugsnagClient.notify(e),this.results.reset([]),this.total_results=this.results.size()}else this.results.reset(this.all_foods.models),this.total_results=
this.results.size()}},loadFoodInfoObjects:function(a){"undefined"!=typeof a&&this.fetch_complete&&a()},generateSearchText:function(a){search_text=[a.attributes.food_name,a.attributes.description,a.attributes.tag_cloud].join(" ");return search_text.replace(/\"/g,"")},returnFoodObject:function(a,b){var c=1,d=a.attributes.default_units;b&&(b.amount&&(c=b.amount),b.units&&(d=b.units));c=new ETM.FoodObject({food:a,amount:c,units:d,is_custom:!1},{skip_global:!0});c.search_text=this.generateSearchText(a);
return c}});
ETM.CollectionsFoodSearchResultsModel=Backbone.Model.extend({initialize:function(a){if("undefined"!=typeof a)for(var b in a)this[b]=a[b];this.collection_results_models={};this.current_collection_key=null},initCollectionResultsModels:function(a){var b=this;ETM.browse_collections_model||(ETM.browse_collections_model=new ETM.BrowseCollectionsModel);ETM.browse_collections_model.fetchDefaultCollections(function(){_.each(ETM.browse_collections_model.getUserCollectionsFormList(),function(a){var d=a.label;
a=Helper.parseSecretUrlFromResourceUri(a.val);b.collection_results_models[a]=new ETM.SearchResultsModel({collection_title:d})});b.all_model_keys=Object.keys(b.collection_results_models);b.listenTo(ETM.browse_collections_model.collection_models.my_collections,"add",b.syncCollectionResultsModels);b.listenTo(ETM.browse_collections_model.collection_models.my_collections,"remove",b.syncCollectionResultsModels);b.listenTo(ETM.browse_collections_model.collection_models.followed_collections,"add",b.syncCollectionResultsModels);
b.listenTo(ETM.browse_collections_model.collection_models.followed_collections,"remove",b.syncCollectionResultsModels);a()})},addToRecentList:function(a){this.trigger("addToRecentList",a)},syncCollectionResultsModels:function(){var a=this,b=[];_.each(ETM.browse_collections_model.getUserCollectionsFormList(),function(c){var e=c.label;c=Helper.parseSecretUrlFromResourceUri(c.val);a.collection_results_models[c]||(a.collection_results_models[c]=new ETM.SearchResultsModel({collection_title:e}),a.models_updated=
!0);b.push(c)});var c=Object.keys(a.collection_results_models);_.each(_.difference(c,b),function(b){a.collection_results_models[b].destroy();delete a.collection_results_models[b];a.models_updated=!0});a.all_model_keys=Object.keys(a.collection_results_models)},searchAllModels:function(a,b){var c=this,d={q:a},e=c.all_model_keys;this.current_collection_key&&(d.collection_id=this.current_collection_key,e=[this.current_collection_key]);0===e.length?b():(_.each(e,function(a){c.collection_results_models[a].loaded=
!1;c.collection_results_models[a].error_loading=!1}),this.listenTo(this,"done_loading",function(){var a=!0;_.each(e,function(b){c.collection_results_models[b].loaded||(a=!1)});a&&(c.stopListening(c,"done_loading"),b())}),$.ajax({type:"GET",url:"/food/collection_foods_search/",data:d,success:function(a){try{if(null!=a){var b=jQuery.parseJSON(a);c.updateSearchResultsModels(b)}}catch(d){bugsnagClient.notify(d,{metaData:{type_of_data:typeof a,search_data:a,search_query:""}}),c.setModelsToError(c.all_model_keys)}},
error:function(a,b,d){bugsnagClient.notify(d,{metaData:{status:a.status,msg:b}});c.setModelsToError(c.all_model_keys)}}))},updateSearchResultsModels:function(a){for(var b=Object.keys(a),c=0;c<b.length;c++)this.collection_results_models[b[c]].updateResults(a[b[c]].results),this.collection_results_models[b[c]].total_results=a[b[c]].total_results,this.collection_results_models[b[c]].loaded=!0,this.trigger("done_loading")},setModelsToError:function(a){var b=this;a.forEach(function(a){b.collection_results_models[a].updateResults([]);
b.collection_results_models[a].total_results=0;b.collection_results_models[a].loaded=!0;b.collection_results_models[a].error_loading=!0;b.trigger("done_loading")})}});
ETM.PantrySearchResultsModel=ETM.SearchResultsModel.extend({finishInit:function(){ETM.is_premium||(this.loaded=!0)},triggerPantryUpdate:function(){this.trigger("updated_pantry_foods")},updateRecipes:function(a,b){var c=this;c.error_loading=!1;ETM.is_premium?$.ajax({type:"GET",url:"/food/pantry_recipes/",data:{q:a},success:function(a){try{if(null!=a){var e=jQuery.parseJSON(a);c.updateResults(e.results);c.total_results=e.total_results;b()}}catch(f){c.updateResults([]),c.total_results=0,c.error_loading=
!0,bugsnagClient.notify(f,{metaData:{type_of_data:typeof a,search_data:a,search_query:""}})}},error:function(a,b,f){c.updateResults([]);c.total_results=0;c.error_loading=!0;bugsnagClient.notify(f,{metaData:{status:a.status,msg:b}})}}):b()}});
ETM.RecentSearchResultsModel=ETM.SearchResultsModel.extend({local:!0,remote:!1,url:ROOT+"/recent_foods/",defaults:{resource_uri:ETM.SEARCH_BAR_URI,recent_food_data:null},finishInit:function(a){this.all_foods=new ETM.SearchResultsList([]);null==this.attributes.recent_food_data&&(this.attributes.recent_food_data=[])},loadFoodInfoObjects:function(a){var b=this;this.fetch_complete?"undefined"!=typeof a&&a():$.when(this.fetch()).done(function(){if(0===b.attributes.recent_food_data.length)b.fetch_complete=
!0,"undefined"!=typeof a&&a();else{var c={};b.attributes.recent_food_data.forEach(function(a){b.all_foods.food_info_object_list.push({id:a.id});c[a.id]=a});b.all_foods.food_info_object_list.fetch({reset:!0}).done(function(){var d=[];b.all_foods.food_info_object_list.forEach(function(a){if(!0!==b.ingredients_only||"r"!==a.attributes.model)a=b.returnFoodObject(a,c[a.attributes.id],!0),d.push(a)});b.all_foods.reset(d);b.fetch_complete=!0;"undefined"!=typeof a&&a()})}})},addFood:function(a){if(!0!==this.ingredients_only||
"r"!==a.attributes.food.attributes.model){var b=a.attributes.food.attributes.id,c=-1;this.attributes.recent_food_data.forEach(function(a,d){a.id==b&&(c=d)});-1!==c&&this.all_foods.remove(this.all_foods.at(c),{silent:!0});var d=a.attributes.food;this.all_foods.food_info_object_list.add(d);new_food_obj=this.returnFoodObject(d,{amount:a.attributes.amount,units:a.attributes.units});this.all_foods.unshift(new_food_obj);this.all_foods.size()>ETM.MAX_RECENT_FOOD_RESULTS&&this.all_foods.pop();this.updateSavedRecentFoods(a,
c);this.trigger("render_recent_foods")}},updateSavedRecentFoods:function(a,b){-1!=b&&this.attributes.recent_food_data.splice(b,1);this.attributes.recent_food_data.unshift({id:a.attributes.food.attributes.id,amount:a.attributes.amount,units:a.attributes.units});this.attributes.recent_food_data.length>ETM.MAX_RECENT_FOOD_RESULTS&&this.attributes.recent_food_data.pop();this.save()}});
ETM.CustomSearchResultsModel=ETM.SearchResultsModel.extend({finishInit:function(a){var b=this;this.all_foods=new ETM.SearchResultsList([],a);this.listenTo(this.all_foods.food_info_object_list,"add",function(a,d){var e=b.returnFoodObject(a);e.is_custom=!0;var f=b.all_foods.food_info_object_list.indexOf(a);b.all_foods.add(e,{at:f});b.trigger("updatedCustom",!0,e)});this.listenTo(this.all_foods.food_info_object_list,"change",function(a){b.trigger("updatedCustom",!1)});this.listenTo(this.all_foods.food_info_object_list,
"remove",function(a,b){var e=this.returnFoodObject(a);e.is_custom=!0;this.all_foods.remove(e)},this);b.url===ROOT+"/customrecipe/"&&this.listenTo(ETM.dispatcher,"reload_custom_recipes",function(a){this.all_foods.food_info_object_list.fetch({data:{ingredients__food:a},success:function(a,b,c){a.each(function(a){ETM.food_info_object_list.updateFoodInfo(a);ETM.search_model.updateRecentFoodInfo(a)})}})},this)},loadFoodInfoObjects:function(a){var b=this;this.fetch_complete?"undefined"!=typeof a&&a():$.when(this.all_foods.food_info_object_list.fetch({reset:!0})).done(function(){var c=
[];b.all_foods.food_info_object_list.forEach(function(a){a=b.returnFoodObject(a);a.is_custom=!0;c.push(a)});b.all_foods.reset(c);b.fetch_complete=!0;"undefined"!=typeof a&&a()})}});
ETM.FavoritesSearchResultsModel=ETM.SearchResultsModel.extend({eventsInitialized:!1,finishInit:function(a){this.all_foods=new ETM.SearchResultsList([])},initializeEvents:function(){if(!this.eventsInitialized){var a=this;this.listenTo(ETM.favorite_foods_list,"add",function(b,c){var d=ETM.food_info_object_list.get(b.attributes.food);if(!0!==a.ingredients_only||"r"!==d.attributes.model)d=a.returnFoodObject(d),a.all_foods.add(d,{at:0}),a.trigger("addFavorite")});this.listenTo(ETM.favorite_foods_list,
"remove",function(b,c){var d=this.all_foods.find(function(a){return a.attributes.food.attributes.id==parseIdFromResourceURI(b.attributes.food_resource_uri)});null!=d&&(a.all_foods.remove(d),a.trigger("removeFavorite"))});this.eventsInitialized=!0}},loadFoodInfoObjects:function(a){var b=this,c=[];this.fetch_complete?"undefined"!=typeof a&&a():ETM.favorite_foods_list.loadFoodInfoObjects().done(function(){ETM.favorite_foods_list.forEach(function(a){try{var e=b.returnFoodObject(ETM.food_info_object_list.get(a.attributes.food));
if(!0!==b.ingredients_only||"r"!==e.attributes.food.attributes.model)e.is_favorite=!0,e.is_custom=!1,c.push(e)}catch(f){bugsnagClient.notify(f,{metaData:{fetch_fav_food:JSON.stringify(a)}})}});b.all_foods.reset(c);b.results.reset(c);b.fetch_complete=!0;"undefined"!=typeof a&&a()})}});
ETM.SearchBar=Backbone.Model.extend({local:!0,remote:!1,url:ROOT+"/prev_search_filters/",defaults:{resource_uri:ETM.SEARCH_BAR_URI,previous_filters:"recent_foods favorites custom_recipes custom_foods recipes pantry_recipes basic_foods restaurant_foods branded_foods".split(" ")},model_map:{c:"custom_foods",r:"custom_recipes",u:"usda_foods",b:"branded_foods",ub:"branded_foods",nb:"branded_foods",s:"restaurant_foods",nr:"restaurant_foods"},initialize:function(a){this.search_results_model_dict={basic_foods:new ETM.SearchResultsModel,
restaurant_foods:new ETM.SearchResultsModel,branded_foods:new ETM.SearchResultsModel,favorites:new ETM.FavoritesSearchResultsModel,custom_foods:new ETM.CustomSearchResultsModel({url:ROOT+"/customfood/"}),custom_recipes:new ETM.CustomSearchResultsModel({url:ROOT+"/customrecipe/"}),recent_foods:new ETM.RecentSearchResultsModel,pantry_recipes:new ETM.PantrySearchResultsModel,recipes:new ETM.SearchResultsModel,collection_foods:new ETM.SearchResultsModel};this.collection_foods_search_model=new ETM.CollectionsFoodSearchResultsModel;
this.result_types="recent_foods favorites custom_recipes custom_foods recipes pantry_recipes basic_foods restaurant_foods branded_foods collection_foods".split(" ");this.fetch_complete=this.default_fetched=!1;this.finishInit()},finishInit:function(){},updateFoodInfo:function(a){ETM.food_info_object_list.updateFoodInfo(a);var b=this.model_map[a.attributes.model];if(_.has(this.search_results_model_dict[b],"all_foods")){var c=this.search_results_model_dict[b].all_foods.food_info_object_list.get(a.id);
c?(c.set(a.toJSON()),_.has(c,"tooltip_ingredients")&&(delete c.tooltip_ingredients,delete all_ingredients[a.get("id")]),_.has(c.attributes,"ingredients")&&delete c.attributes.ingredients):this.search_results_model_dict[b].all_foods.food_info_object_list.add(a.toJSON(),{at:0})}this.updateRecentFoodInfo(a)},updateRecentFoodInfo:function(a){var b=this.search_results_model_dict.recent_foods.all_foods.food_info_object_list.get(a.id);b&&(b.set(a.toJSON()),_.has(b,"tooltip_ingredients")&&(delete b.tooltip_ingredients,
delete all_ingredients[a.get("id")]),_.has(b.attributes,"ingredients")&&delete b.attributes.ingredients)},setFiltersToError:function(a){var b=this;a.forEach(function(a){b.search_results_model_dict[a].updateResults([]);b.search_results_model_dict[a].total_results=0;b.search_results_model_dict[a].loaded=!0;b.search_results_model_dict[a].error_loading=!0;b.search_results_model_dict[a].trigger("done_loading")})},fetchFilters:function(){if(!this.fetch_complete){this.fetch();if(this.attributes.previous_filters)if(!0===
this.ingredients_only){var a=[];_.each(this.attributes.previous_filters,function(b){-1===b.indexOf("recipe")&&a.push(b)})}else this.result_types=this.attributes.previous_filters;this.fetch_complete=!0}},saveFilters:function(a){this.attributes.previous_filters=a;this.save({previous_filters:a})},updateSearchResultsModel:function(a){for(var b=Object.keys(a),c=0;c<b.length;c++)this.search_results_model_dict[b[c]].updateResults(a[b[c]].results),this.search_results_model_dict[b[c]].total_results=a[b[c]].total_results,
this.search_results_model_dict[b[c]].loaded=!0,this.trigger("done_loading")},searchAllModels:function(a,b,c,d){var e=this,f=_.intersection(["recipes","basic_foods","restaurant_foods","branded_foods","collection_foods"],b),g=-1!==b.indexOf("pantry_recipes")&&ETM.is_premium,h=_.intersection(["custom_recipes","custom_foods","favorites","recent_foods"],b);e.result_types=b;_.each(b,function(a){e.search_results_model_dict[a].loaded=!1;e.search_results_model_dict[a].error_loading=!1});this.listenTo(this,
"done_loading",function(){var a=!0;_.each(b,function(b){e.search_results_model_dict[b].loaded||"pantry_recipes"===b||(a=!1)});a&&(e.stopListening(e,"done_loading"),d())});if(1===e.result_types.length&&"collection_foods"===e.result_types[0])e.collection_foods_search_model.searchAllModels(a,function(){e.search_results_model_dict.collection_foods.loaded=!0;e.trigger("done_loading")});else if(g&&$.ajax({type:"GET",url:"/food/pantry_recipes/",data:{q:a,all_search:JSON.stringify(c)},success:function(a){try{if(null!=
a){var b=jQuery.parseJSON(a);e.search_results_model_dict.pantry_recipes.updateResults(b.results);e.search_results_model_dict.pantry_recipes.total_results=b.total_results;e.search_results_model_dict.pantry_recipes.loaded=!0;e.trigger("done_loading","pantry_recipes")}}catch(c){e.setFiltersToError(["pantry_recipes"]),bugsnagClient.notify(c,{metaData:{type_of_data:typeof a,search_data:a,search_query:""}})}},error:function(a,b,c){e.setFiltersToError(["pantry_recipes"]);bugsnagClient.notify(c,{metaData:{status:a.status,
msg:b}})}}),_.each(h,function(b){var c=e.search_results_model_dict[b];c.loadFoodInfoObjects(function(){c.search(a);c.loaded=!0;e.trigger("done_loading")})}),0!==f.length||0===b.length)g=JSON.stringify(f),$.ajax({type:"GET",url:"/food/search-json/",data:{q:a,filters:g,all_search:JSON.stringify(c)},success:function(a){try{null!=a&&e.updateSearchResultsModel(a)}catch(b){bugsnagClient.notify(b,{metaData:{type_of_data:typeof a,search_data:a,search_query:""}}),e.setFiltersToError(f)}},error:function(a,
b,c){e.setFiltersToError(f);bugsnagClient.notify(c,{metaData:{status:a.status,msg:b}})}})},addToRecentList:function(a){this.search_results_model_dict.recent_foods.addFood(a)},fetchRecentFoods:function(){this.search_results_model_dict.recent_foods.fetchFoods()}});
ETM.IngredientsOnlySearchBar=ETM.SearchBar.extend({defaults:{resource_uri:ETM.INGREDIENTS_ONLY_URI,previous_filters:["basic_foods","favorites","custom_foods","branded_foods"]},initialize:function(a){this.search_results_model_dict={basic_foods:new ETM.SearchResultsModel,restaurant_foods:new ETM.SearchResultsModel,branded_foods:new ETM.SearchResultsModel,favorites:new ETM.FavoritesSearchResultsModel,custom_foods:new ETM.CustomSearchResultsModel({url:ROOT+"/customfood/"}),recent_foods:new ETM.RecentSearchResultsModel};
this.result_types="recent_foods favorites custom_foods basic_foods restaurant_foods branded_foods".split(" ");this.fetch_complete=this.default_fetched=!1;this.finishInit()},finishInit:function(){this.search_results_model_dict.recent_foods.attributes.resource_uri=ETM.INGREDIENTS_ONLY_URI;this.result_types="recent_foods favorites custom_foods basic_foods restaurant_foods branded_foods".split(" ");this.search_results_model_dict.favorites.ingredients_only=!0;this.search_results_model_dict.recent_foods.ingredients_only=
!0}});
ETM.SidebarRecipeList=ETM.FoodList.extend({url:ROOT+"/food/search/",initialize:function(a,b){this.food_info_object_list=new ETM.FoodInfoObjectList(a)},sync:function(a,b,c){if("read"===a){var d=this;$.ajax({type:"GET",url:d.url,data:c.data,success:function(a){a.objects.forEach(function(a){a=new ETM.FoodInfoObject(a,{parse:!0});d.food_info_object_list.add(a);a=new ETM.FoodObject({food:a,amount:1,units:a.attributes.default_units},{skip_global:!0});a.is_custom=!1;d.add(a)});c.success(d.models)},error:function(){console.log("error with fetch")}})}},
search:function(a,b){$(".recipe_list",this.el).hide();$.get("/sidebarsearch/recipes/?q="+encodeURIComponent(a),function(c){try{if(null!=c){var d=jQuery.parseJSON(c);b(d);return}}catch(e){bugsnagClient.notify(e,{metaData:{type_of_data:typeof c,search_data:c,search_query:a}})}b([])})}});
ETM.SidebarBasicFoodList=ETM.FoodList.extend({initialize:function(a,b){this.structure={Proteins:{"Red Meats":[5423,1615,1797,5341,3773],Poultry:[453,582,561,934],Fish:[3458,3373,3341],"Dairy and Others":[65,67,70,73,5809,103,104,98,96,5811,15,3646]},Carbs:{Grains:[4802,4807,4846,1112,4879,4025,1006,4888],"Starchy Vegetables":[2313,2211,1947],Legumes:[2070,3506,3555,3721],Fruit:[1337,1300,1463,1416,1484,1558,1343,1547],Vegetables:[1885,1914,1927,1971,1869,2025,2440,2150,2013,2170,2226]},Fats:[2632,
3584,2684,266,3734,2700,1334,1,105],Beverages:[65,67,70,73,5812,1468,1419,3099]};var c=this.numberList(this.structure);this.fetch_complete=!1;this.food_info_object_list=new ETM.FoodInfoObjectList(c)},numberList:function(a){var b=[],c;for(c in a)if("[object Array]"===Object.prototype.toString.call(a[c]))_.each(a[c],function(a){b.push({id:a})});else for(var d in a[c])_.each(a[c][d],function(a){b.push({id:a})});return b},search:function(a,b,c){var d=encodeURIComponent(a)+"&"+$.param(b);$.get("/sidebarsearch/foods/?q="+
d,function(a){try{if(null!=a){var b=jQuery.parseJSON(a);c(b);return}}catch(g){bugsnagClient.notify(g,{metaData:{type_of_data:typeof a,search_data:a,search_query:d}})}c([])})},fetchFoodInfoObjects:function(a){var b=this;this.fetch_complete?a():$.when(this.food_info_object_list.fetch()).done(function(){var c=[];b.food_info_object_list.forEach(function(a){var e=b.returnFoodObject(a);a.sidebar_food_object=e;c.push(e)});b.reset(c);b.fetch_complete=!0;a()})}});
ETM.SidebarPantryList=ETM.SidebarBasicFoodList.extend({search:function(a,b,c){$.get("/sidebarsearch/pantry/recipes/?q="+encodeURIComponent(a),function(b){try{if(null!=b){var e=jQuery.parseJSON(b);c(e);return}}catch(f){bugsnagClient.notify(f,{metaData:{type_of_data:typeof b,search_data:b,search_query:a}})}c([])})}});
ETM.CustomFoodList=ETM.FoodList.extend({model:ETM.FoodObject,url:function(){return this.options.url},initialize:function(a,b){this.options=b;this.url=b.url;this.food_info_object_list=new ETM.FoodInfoObjectList(null!=a?a:[],b);var c=this;this.listenTo(this.food_info_object_list,"add",function(a,b){var f=c.returnFoodObject(a);f.is_custom=!0;var g=this.food_info_object_list.indexOf(a);c.add(f,{at:g})},this)},fetchFoodInfoObjects:function(a){var b=this;this.fetch_complete?a():$.when(this.food_info_object_list.fetch({reset:!0})).done(function(){var c=
[];b.food_info_object_list.forEach(function(a){a=b.returnFoodObject(a);a.is_custom=!0;c.push(a)});b.reset(c);b.fetch_complete=!0;a()})},returnFoodObject:function(a){return new ETM.FoodObject({food:a,amount:1,units:a.attributes.default_units,is_custom:!1},{skip_global:!1})}});ETM.CustomRecipeList=ETM.CustomFoodList.extend({});
ETM.SidebarFavoritesList=ETM.FoodList.extend({eventsInitialized:!1,initializeEvents:function(){if(!this.eventsInitialized){var a=this;this.listenTo(ETM.favorite_foods_list,"add",function(b,c){var d=ETM.food_info_object_list.get(b.attributes.food),d=a.returnFoodObject(d,b);d.is_favorite=!0;d.is_custom=!1;d.child=b;b.sidebar_food_object=d;a.add(d,{at:0});a.trigger("addFavorite")});this.listenTo(ETM.favorite_foods_list,"remove",function(b,c){b.sidebar_food_object.trigger("deleteItem");a.trigger("removeFavorite")});
this.eventsInitialized=!0}},fetchFoodInfoObjects:function(a){var b=this,c=[];this.fetch_complete?a():ETM.favorite_foods_list.loadFoodInfoObjects().done(function(){ETM.favorite_foods_list.forEach(function(a){try{var e=b.returnFoodObject(ETM.food_info_object_list.get(a.attributes.food),a);e.is_favorite=!0;e.is_custom=!1;e.child=a;a.sidebar_food_object=e;c.push(e)}catch(f){bugsnagClient.notify(f,{metaData:{fetch_fav_food:JSON.stringify(food)}})}});b.reset(c);b.fetch_complete=!0;a()})}});
ETM.Sidebar=Backbone.Model.extend({});ETM.SimilarRecipeList=Backbone.Collection.extend({model:ETM.FoodObject,url:ROOT+"/food/get_similar_recipes/",initialize:function(a,b){this.food_info_object_list=new ETM.FoodInfoObjectList(a)},sync:function(){return!1}});ETM.CuratorProfile=Backbone.Model.extend({initialize:function(){}});ETM.CuratorProfileList=Backbone.Collection.extend({model:ETM.CuratorProfile,url:ROOT+"/curator/"});
ETM.FoodObjectWithChanges=ETM.FoodObject.extend({urlRoot:ROOT+"/foodobjectwithchanges/",relations:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodWithChanges"}],initialize:function(a,b){this.initializeEvents();this.is_selected=!1;this.calculateStats()}});
ETM.FoodWithChanges=ETM.FoodInfoObject.extend({remote:!0,urlRoot:ROOT+"/foodwithchanges/",relations:[{type:Backbone.Many,key:"ingredients",relatedModel:"ETM.IngredientObject",collectionType:"ETM.IngredientsList"},{type:Backbone.Many,key:"directions",relatedModel:"ETM.Direction",collectionType:"ETM.DirectionsList"},{type:Backbone.Many,key:"images",relatedModel:"ETM.FoodImage",collectionType:"ETM.FoodImageList",customSerialize:function(a){a.models.forEach(function(a){delete a.attributes.resource_uri});
return a}},{type:Backbone.Many,key:"changes",relatedModel:"ETM.FoodChanges",collectionType:"ETM.FoodChangesList"},{type:Backbone.One,key:"food_rating",relatedModel:"ETM.FoodRating"}]});ETM.FoodWithChangesList=ETM.FoodInfoObjectList.extend({model:ETM.FoodWithChanges,remote:!0,urlRoot:ROOT+"/foodwithchanges/"});
ETM.FoodChanges=ETM.FoodInfoObject.extend({remote:!0,urlRoot:ROOT+"/foodchanges/",initialize:function(){this.schema.default_units={type:"Select",value_type:"Number",options:[]};for(var a=0;a<this.attributes.weights.length;a++){var b=this.attributes.weights[a];this.schema.default_units.options.push({val:a,label:b.amount+" "+b.description})}},relations:[{type:Backbone.Many,key:"mapped_meal_tags",relatedModel:"ETM.MealTag",collectionType:"ETM.MealTagList",map:function(a){var b=[];for(i=0;i<a.length;i++)if(1==
a[i]){var c=ETM.meal_tag_list.get(i);c&&b.push(c)}return b},customSerialize:function(a){var b="";for(i=0;64>i;i++)b+=a.get(i)?"1":"0";return b}}],addExtraFoodAttributesToChanges:function(a){this.attributes.serving_size_amount=a.get("food").attributes.weights[1].amount;this.attributes.serving_size_description=a.get("food").attributes.weights[1].description},schema:{food_name:"Text",description:"Text",breakfast:"Checkbox",single_serving:"Checkbox",keeps_well:"Checkbox",can_be_bulk:"Checkbox",is_snack:"Checkbox",
needs_blender:"Checkbox",needs_oven:"Checkbox",needs_stove:"Checkbox",needs_grill:"Checkbox",needs_slow_cooker:"Checkbox",needs_toaster:"Checkbox",needs_food_processor:"Checkbox",needs_microwave:"Checkbox",prep_time:{type:"PositiveNumber"},cook_time:{type:"PositiveNumber"},wait_time:{type:"PositiveNumber"},prep_day_before:"Checkbox",main_dish:{type:"SegmentedRadio",value_type:"Boolean",options:[{val:!1,label:"Side dish"},{val:!0,label:"Main dish"}]},category_id:{type:"Select",value_type:"Number",
options:[{val:1,label:"Appetizers"},{val:2,label:"Breakfast foods"},{val:3,label:"Desserts"},{val:4,label:"Drinks"},{val:5,label:"Mostly meat"},{val:6,label:"Protein shakes"},{val:7,label:"Salads"},{val:8,label:"Sandwiches"},{val:9,label:"Pasta"},{val:10,label:"Soups"},{val:11,label:"Other"}]},cuisine:"Text",tags:"Text",categories:"Text",number_servings:{type:"PositiveNumber"},blatantly_unhealthy:"Checkbox",curator_notes:"TextArea",rejection_notes:"TextArea",review_complete:"Checkbox",review_approved:"Checkbox",
review_rejected:"Checkbox",suggested_default_amount:{type:"PositiveNumber"},is_discrete:{type:"SegmentedRadio",value_type:"Boolean",options:[{val:!1,label:"Continuous"},{val:!0,label:"Discrete"}]},minimum_discrete_amount:{type:"PositiveNumber"},perishable:"Checkbox",expiration_time:{type:"PositiveNumber"},veggie_servings:{type:"PositiveNumber"},fruit_servings:{type:"PositiveNumber"},default_package_amount:{type:"PositiveNumber"},gram_weight_0:{type:"PositiveNumber"},gram_weight_0_amount:{type:"PositiveNumber"},
gram_weight_0_description:"Text",gram_weight_1:{type:"PositiveNumber"},gram_weight_1_amount:{type:"PositiveNumber"},gram_weight_1_description:"Text",gram_weight_2:{type:"PositiveNumber"},gram_weight_2_amount:{type:"PositiveNumber"},gram_weight_2_description:"Text",gram_weight_3:{type:"PositiveNumber"},gram_weight_3_amount:{type:"PositiveNumber"},gram_weight_3_description:"Text",gram_weight_4:{type:"PositiveNumber"},gram_weight_4_amount:{type:"PositiveNumber"},gram_weight_4_description:"Text",gram_weight_5:{type:"PositiveNumber"},
gram_weight_5_amount:{type:"PositiveNumber"},gram_weight_5_description:"Text",gram_weight_6:{type:"PositiveNumber"},gram_weight_6_amount:{type:"PositiveNumber"},gram_weight_6_description:"Text",gram_weight_7:{type:"PositiveNumber"},gram_weight_7_amount:{type:"PositiveNumber"},gram_weight_7_description:"Text",gram_weight_8:{type:"PositiveNumber"},gram_weight_8_amount:{type:"PositiveNumber"},gram_weight_8_description:"Text"}});
ETM.FoodChangesList=ETM.FoodInfoObjectList.extend({model:ETM.FoodChanges,url:ROOT+"/foodchanges/"});ETM.StripeInvoice=Backbone.Model.extend({remote:!0,urlRoot:"/payments/stripe-invoice-history/"});ETM.StripeInvoiceList=Backbone.Collection.extend({remote:!0,model:ETM.StripeInvoice,url:"/payments/stripe-invoice-history/"});
ETM.TemplateDiet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/dailytemplate/",relations:[{type:Backbone.One,key:"diet",relatedModel:"ETM.Diet"},{type:Backbone.One,key:"user",relatedModel:"ETM.UserProfile",isTransient:!0}]});
ETM.TemplateDietList=Backbone.Collection.extend({model:ETM.TemplateDiet,url:ROOT+"/dailytemplate/",SINGLE_TEMPLATE_WEEKDAY:6,SINGLE_TEMPLATE_INDEX:0,clearLeftoversMealAttributes:function(){_.each(this.models,function(a){_.each(a.attributes.diet.attributes.meals.models,function(a){a.parent_leftovers_meal=!1;a.child_leftovers_meal=!1;delete a.chain_color_int})})},setLeftoversGroup:function(a,b,c){var d=a[0];d.parent_leftovers_meal=!0;d.chain_color_int=b.chain_color_int;d.number_leftovers_dishes=b.attributes.number_dishes;
d.leftovers_order=0;d.group_number=c;for(d=1;d<a.length;d++){var e=a[d];e.child_leftovers_meal=!0;e.chain_color_int=b.chain_color_int;e.number_leftovers_dishes=b.attributes.number_dishes;e.leftovers_order=d;e.group_number=c}},linkLeftoversMeals:function(a){var b=this;this.clearLeftoversMealAttributes();for(var c=ETM.current_user_profile.get("shopping_day"),d=[],e=[],f=0;7>f;f++){var g=(c+f+1)%7;d.push(g);e.push(b.findWhere({weekday:g}))}var h=0;_.each(a.models,function(a,c){a.meal_groups=[];var f=
a.get("days_to_save_leftovers"),g=a.get("parent_meal_type"),p=a.get("child_meal_types"),v=-1,w=0,x=0,t=0;a.attributes.repeat||(t=d.indexOf(a.attributes.start_day));for(var q=0;7>q;q++){var z=e[q],y=!1;if(!(q<t)){var A=q,u=_.find(z.attributes.diet.attributes.meals.models,function(a){if(!(a.attributes.meal_type.attributes.resource_uri!==g||a.parent_leftovers_meal||a.child_leftovers_meal||A===w&&a.attributes.meal_number<=v))return a});if(u){for(var x=q,y=!0,s=[u],r=q;r<=q+f;r++)e.length>r&&_.each(e[r].attributes.diet.attributes.meals.models,
function(a){-1===p.indexOf(a.attributes.meal_type.attributes.resource_uri)||a.parent_leftovers_meal||a.child_leftovers_meal||r===q&&a.attributes.meal_number<=u.attributes.meal_number||(s.push(a),v=a.attributes.meal_number,w=r)});1<s.length&&(b.setLeftoversGroup(s,a,h),a.meal_groups.push(s),h++)}if(y)if(a.attributes.repeat)t=x+f;else break}}})},buildSingleTemplateDietList:function(){for(var a=new ETM.TemplateDietList,b=this.findWhere({weekday:this.SINGLE_TEMPLATE_WEEKDAY}),c=0;7>c;c++){var d=b.clone();
Helper.clearIDs(d);var e=(6+c)%7;d.attributes.weekday=e;var f=d.attributes.diet;Helper.clearIDs(f);f.attributes.meals.each(function(a){Helper.clearIDs(a);a.attributes.diet_plan=e});a.add(d)}return a},getTemplateDietList:function(){return ETM.current_user_profile.usingSingleTemplateDiet()?this.buildSingleTemplateDietList():this},getTemplateDietAtIndex:function(a){return ETM.current_user_profile.usingSingleTemplateDiet()?this.at(this.SINGLE_TEMPLATE_INDEX):this.at(a)},getTemplateDietForWeekday:function(a){return ETM.current_user_profile.usingSingleTemplateDiet()?
this.at(this.SINGLE_TEMPLATE_INDEX):this.findWhere({weekday:a})},getTemplateDietForResourceUri:function(a){return ETM.current_user_profile.usingSingleTemplateDiet()?this.at(this.SINGLE_TEMPLATE_INDEX):this.get(a)},findDiet:function(a){for(var b=0;b<this.models.length;b++){var c=this.models[b];if(c.attributes.diet.attributes.resource_uri===a||c.attributes.diet.attributes.id==a)return c.attributes.diet}return null}});
ETM.CombinedUserData=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/combineduserdata/",relations:[{type:Backbone.Many,key:"nutrition_profiles",relatedModel:"ETM.NutritionProfile",collectionType:"ETM.NutritionProfileList"},{type:Backbone.Many,key:"meal_types",relatedModel:"ETM.MealType",collectionType:"ETM.MealTypeList"},{type:Backbone.Many,key:"user_profile",relatedModel:"ETM.UserProfile",collectionType:"ETM.UserProfileList"},{type:Backbone.Many,key:"favorite_foods",relatedModel:"ETM.FavoriteFood",
collectionType:"ETM.FavoriteFoodList"},{type:Backbone.One,key:"profile_completeness",relatedModel:"ETM.ProfileCompleteness",collectionType:"ETM.ProfileCompletenessList"},{type:Backbone.Many,key:"recurring_foods",relatedModel:"ETM.RecurringFood",collectionType:"ETM.GlobalRecurringFoodList"},{type:Backbone.Many,key:"recurring_collections",relatedModel:"ETM.RecurringFoodCollection",collectionType:"ETM.GlobalRecurringFoodCollectionList"},{type:Backbone.Many,key:"diet_sets",relatedModel:"ETM.BasicDietPlanSet",
collectionType:"ETM.BasicDietPlanSetList"},{type:Backbone.One,key:"manager_profile",relatedModel:"ETM.ManagerProfile"},{type:Backbone.Many,key:"meal_ratings",relatedModel:"ETM.MealRating",collectionType:"ETM.MealRatingList"},{type:Backbone.Many,key:"food_ratings",relatedModel:"ETM.FoodRating",collectionType:"ETM.FoodRatingList"},{type:Backbone.Many,key:"custom_foods",relatedModel:"ETM.FoodInfoObject",collectionType:"ETM.FoodInfoObjectList"},{type:Backbone.Many,key:"custom_recipes",relatedModel:"ETM.FoodInfoObject",
collectionType:"ETM.FoodInfoObjectList"}]});Date.prototype.stdTimezoneOffset=function(){var a=new Date(this.getFullYear(),0,1),b=new Date(this.getFullYear(),6,1);return Math.max(a.getTimezoneOffset(),b.getTimezoneOffset())};
function determine_utc_offset(){var a=(new Date).stdTimezoneOffset()/-60;return-11.5>a?"-12":-10.5>a?"-11":-9.5>a?"-10":-8.5>a?"-9":-7.5>a?"-8":-6.5>a?"-7":-5.5>a?"-6":-4.5>a?"-5":-3.75>a?"-4":-3.25>a?"-3.5":-2.5>a?"-3":-1.5>a?"-2":-0.5>a?"-1":0.5>a?"0":1.5>a?"1":2.5>a?"2":3.25>a?"3":3.75>a?"3.5":4.25>a?"4":4.75>a?"4.5":5.25>a?"5":5.65>a?"5.5":5.85>a?"5.75":6.5>a?"6":7.5>a?"7":8.5>a?"8":9.25>a?"9":9.75>a?"9.5":10.5>a?"10":11.5>a?"11":"12"}
ETM.UserProfile=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/userprofile/",defaults:{activity_level:"1.2",algorithm:0.5>Math.random()?1:2,age:null,bodyfat:null,beta_user:!0,todays_weight:null,use_weight_goal:!1,use_net_carbs:!1,weight_goal:null,weight_goal_weekly_rate:null,custom_exclusions:"",daily_price_limit:0,exclusions:"",friend_signups:0,friend_successes:0,gender:null,goal:null,hide_gender:!0,limit_price:!1,link_clicks:0,months_saved_up:0,number_curated_recipes:0,preset_diet:"anything",total_months_earned:0,
units:"I",use_leftovers:!1,complexity_level:1,generator_focus:0,show_walkthrough_prompt:!0,single_template_diet:!0,timezone:determine_utc_offset(),shopping_day:5,use_partial_servings:!1},schema:{goal:{type:"SegmentedRadio",validators:["required"],options:[{val:"L",label:"Lose weight"},{val:"M",label:"Maintain"},{val:"G",label:"Build muscle"}]},units:{type:"SegmentedRadio",validators:["required"],options:[{val:"I",label:"U.S. Standard"},{val:"M",label:"Metric"}]},gender:{type:"SegmentedRadio",validators:["required"],
options:[{val:"M",label:"Male"},{val:"F",label:"Female"}]},age:{type:"PositiveNumber"},weight:{type:"PositiveNumber"},bodyfat:{type:"SegmentedRadio",value_type:"Number",validators:["required"],options:[{val:10,label:"Low"},{val:20,label:"Medium"},{val:30,label:"High"}]},activity_level:{type:"Select",validators:["required"],options:[{val:"1.2",label:"Sedentary"},{val:"1.375",label:"Lightly Active"},{val:"1.55",label:"Moderately Active"},{val:"1.725",label:"Very Active"},{val:"1.9",label:"Extremely Active"}]},
shopping_day:{type:"Select",value_type:"Number",options:[{val:6,label:"Sunday"},{val:0,label:"Monday"},{val:1,label:"Tuesday"},{val:2,label:"Wednesday"},{val:3,label:"Thursday"},{val:4,label:"Friday"},{val:5,label:"Saturday"}]},timezone:{type:"Select",value_type:"Number",options:[{val:-12,label:"(GMT -12:00) Eniwetok, Kwajalein"},{val:-11,label:"(GMT -11:00) Midway Island, Samoa"},{val:-10,label:"(GMT -10:00) Hawaii"},{val:-9,label:"(GMT -9:00) Alaska"},{val:-8,label:"(GMT -8:00) Pacific Time (US &amp; Canada)"},
{val:-7,label:"(GMT -7:00) Mountain Time (US &amp; Canada)"},{val:-6,label:"(GMT -6:00) Central Time (US &amp; Canada), Mexico City"},{val:-5,label:"(GMT -5:00) Eastern Time (US &amp; Canada), Bogota, Lima"},{val:-4,label:"(GMT -4:00) Atlantic Time (Canada), Caracas, La Paz"},{val:-3.5,label:"(GMT -3:30) Newfoundland"},{val:-3,label:"(GMT -3:00) Brazil, Buenos Aires, Georgetown"},{val:-2,label:"(GMT -2:00) Mid-Atlantic"},{val:-1,label:"(GMT -1:00 hour) Azores, Cape Verde Islands"},{val:0,label:"(GMT) Western Europe Time, London, Lisbon, Casablanca"},
{val:1,label:"(GMT +1:00 hour) Brussels, Copenhagen, Madrid, Paris"},{val:2,label:"(GMT +2:00) Kaliningrad, South Africa"},{val:3,label:"(GMT +3:00) Baghdad, Riyadh, Moscow, St. Petersburg"},{val:3.5,label:"(GMT +3:30) Tehran"},{val:4,label:"(GMT +4:00) Abu Dhabi, Muscat, Baku, Tbilisi"},{val:4.5,label:"(GMT +4:30) Kabul"},{val:5,label:"(GMT +5:00) Ekaterinburg, Islamabad, Karachi, Tashkent"},{val:5.5,label:"(GMT +5:30) Bombay, Calcutta, Madras, New Delhi"},{val:5.75,label:"(GMT +5:45) Kathmandu"},
{val:6,label:"(GMT +6:00) Almaty, Dhaka, Colombo"},{val:7,label:"(GMT +7:00) Bangkok, Hanoi, Jakarta"},{val:8,label:"(GMT +8:00) Beijing, Perth, Singapore, Hong Kong"},{val:9,label:"(GMT +9:00) Tokyo, Seoul, Osaka, Sapporo, Yakutsk"},{val:9.5,label:"(GMT +9:30) Adelaide, Darwin"},{val:10,label:"(GMT +10:00) Eastern Australia, Guam, Vladivostok"},{val:11,label:"(GMT +11:00) Magadan, Solomon Islands, New Caledonia"},{val:12,label:"(GMT +12:00) Auckland, Wellington, Fiji, Kamchatka"}]}},weight_goal_schema:function(){return _.extend({},
this.schema,{use_weight_goal:{type:"SegmentedRadio",value_type:"Boolean",options:[{val:!1,label:"No thanks"},{val:!0,label:"Yeah let's do it!"}]},todays_weight:{type:"ImperialNumber",current_units:ETM.current_user_profile.attributes.units,conversion:"lbs-kgs"},weight_goal:{type:"ImperialNumber",current_units:ETM.current_user_profile.attributes.units,conversion:"lbs-kgs"},weight_goal_weekly_rate:{type:"ImperialNumber",current_units:ETM.current_user_profile.attributes.units,conversion:"lbs-kgs",editorAttrs:{step:"0.1"}}})},
v2AlgorithmEnabled:function(){return 2==this.attributes.algorithm},getWeightGoalDate:function(){if(this.attributes.weight&&this.attributes.weight_goal_weekly_rate&&this.attributes.weight_goal&&this.attributes.use_weight_goal){var a=this.attributes.weight_goal-this.attributes.weight,b=0>a?-1*Math.abs(this.attributes.weight_goal_weekly_rate):Math.abs(this.attributes.weight_goal_weekly_rate),a=a/(b/7);return moment().add(a,"days")}return!1},getWeightString:function(){return"I"===this.attributes.units?
roundNumber(this.attributes.weight,1)+" lbs":roundNumber(this.attributes.weight/2.2046,1)+" kg"},getWeightGoalString:function(){return"I"===this.attributes.units?roundNumber(this.attributes.weight_goal,1)+" lbs":roundNumber(this.attributes.weight_goal/2.2046,1)+" kg"},getExclusionsString:function(){var a=[];try{var b;b="string"===typeof this.attributes.exclusions&&""!=this.attributes.exclusions?JSON.parse(this.attributes.exclusions):this.attributes.exclusions;"object"===typeof b&&null!=b&&b.forEach(function(b){a.push(b.label)})}catch(c){bugsnagClient.notify(c)}return a.join(", ")},
getProfilePicUrl:function(){return null!=this.attributes.profile_pic_url?"https://images.eatthismuch.com/"+this.attributes.profile_pic_url:"/static_files/images/food-characters/OrangeProfilePic.jpg"},getHeightString:function(){if("I"===this.attributes.units){var a=Math.floor(this.attributes.height/12),b=roundNumber(this.attributes.height%12,1);return a+"' "+b+'"'}return roundNumber(this.attributes.height/0.393701,1)+" cm"},getPrimaryCarbsTitle:function(){return this.attributes.use_net_carbs?"Net carbs":
"Carbs"},getSecondaryCarbsTitle:function(){return this.attributes.use_net_carbs?"Total carbs":"Net carbs"},premium_signup_schema:function(){return _.extend({},this.schema,{generator_focus:{type:"SegmentedRadio",value_type:"Number",options:[{val:0,label:"Balanced"},{val:1,label:"Variety"},{val:2,label:"Macros"},{val:3,label:"Groceries"}]}})},usingSingleTemplateDiet:function(){return!ETM.is_premium||this.attributes.single_template_diet},initialize:function(){this.get("timezone")&&"undefined"!==typeof this.get("timezone")||
this.set("timezone",determine_utc_offset());if(null==this.complexity_level||isNaN(this.complexity_level))this.complexity_level=1;if(null==this.daily_price_limit||isNaN(this.daily_price_limit))this.daily_price_limit=0},isSubscriber:function(){return null!=this.attributes.subscription&&-1!==this.attributes.subscription.plan.toLowerCase().indexOf("pro")},isWebMonthly:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.plan.toLowerCase().indexOf("web_monthly")},isWebYearly:function(){return this.isSubscriber()&&
-1!==this.attributes.subscription.plan.toLowerCase().indexOf("web_yearly")},hasProSubscription:function(){return this.isSubscriber()&&"pro"===this.attributes.subscription.plan.toLowerCase()},hasManagerSubscription:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.plan.toLowerCase().indexOf("manager")},hasManagerV2Subscription:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.plan.toLowerCase().indexOf("manager")&&2==this.attributes.manager_version},isManaged:function(){return _.has(ETM.current_user_profile.attributes,
"manager_username")&&null!=ETM.current_user_profile.attributes.manager_username},hasIosSubscription:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.price.toLowerCase().indexOf("ios")},hasAndroidSubscription:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.price.toLowerCase().indexOf("android")},isImperialUnits:function(){return"I"===this.attributes.units},getManagerBrandDisplayOptions:function(){var a=[],b;for(b in this.attributes)this.attributes.hasOwnProperty(b)&&
-1!=b.indexOf("manager_display_")&&!0==this.attributes[b]&&a.push(b);return a},generator_focus_toolip_text:function(){return'<p align="left"><strong>Balanced</strong><br/>Default that focuses on variety, macros, and groceries evenly.</p><p align="left"><strong>Variety</strong><br/>Focuses on increasing variety in the plans as much as possible, at the expense of always hitting macros and keeping the grocery list short.</p><p align="left"><strong>Macros</strong><br/>Focuses on hitting the macro targets exactly, at the expense of variety and the grocery list.</p><p align="left"><strong>Groceries</strong><br/>Focuses on keeping the grocery list short and using up known package sizes of foods exactly, at the expense of variety and hitting macros.  Expect to see more identical or similar foods throughout the week.</p>'},
shopping_day_tooltip_text:function(){return"<p align=\"left\">Select when you can go grocery shopping. Your weekly plan will be sent the day before your shopping day, and the first meal plan will start the day after the shopping day (e.g. receive email on Saturday, go shopping on Sunday, meal plans start Monday).<br/><br/>As soon as you finish signing up, you will also receive an emailed meal plan for the days leading up to your first shopping day. If your shopping day is within the next 3 days, you'll receive next week's plan as well.</p>"},
regenerate_week_shopping_day_text:function(){return'<div class="text-left"><p>Select a day you can usually go grocery shopping.</p> <p><strong>The weekly meal plans start the day after your shopping day</strong>. So change this to control when the weekly plans start and end.</p> <p>If you want a fresh week of meal plans that start today, switch your grocery shopping day to yesterday (this also lets you generate the next two full weeks of plans).</p><p>Changing the setting here will switch it in your profile as well, and the weekly generator will continue to automatically run the day before your grocery shopping day.</p></div>'},
activity_level_tooltip_text:function(){return"<strong>Sedentary</strong><br/><p>Little or no exercise and desk job</p><strong>Lightly Active</strong><br/><p>Light daily activity & some exercise 1-3 days a week </p><strong>Moderately Active</strong><br/><p>Moderately active daily life & exercise 3-5 days a week</p><strong>Very Active</strong><br/><p>Physically demanding lifestyle & Hard exercise or sports 6-7 days a week</p><strong>Extremely Active</strong><br/><p>Hard daily exercise or sports and physical job</p>"},
bodyfat_tooltip_text:function(){return'<p align="left">Body fat percentage is the total mass of fat divided by total body mass.  The typical bodyfat percentage is 18\u201324% for an average male and 25-31% for an average female according to wikipedia.  </p><p align="left">If you don\'t know yours it\'s not a big deal - we only use it to estimate your lean body mass and change the minimum amount of protein recommended in the nutrition calculator.</p>'},goal_tooltip_text:function(){return'<p align="left">The calorie target we suggest will be based on your goals. If you select "Lose", the target will be 20% below your maintenance calories, or if you select "Gain", the target calories will be 15% above maintenance.</p><p align="left">You can further adjust your targets by setting a specific weight goal (below), or ignore our suggestions and set your own custom targets in the Nutrition Profile.</p>'},
validationErrorsForCalculator:function(a){var b=!0,c=[];0<!this.attributes.height&&(c.push("Height must be greater than zero"),b=!1);0<!this.attributes.weight&&(c.push("Weight must be greater than zero"),b=!1);0<!this.attributes.age&&(c.push("Age must be greater than zero"),b=!1);0<!this.attributes.bodyfat&&(c.push("Body fat must be greater than zero"),b=!1);b||null==a||a({valid:b,errors:c.join("\n")});return c},printAllowedFeatures:function(){console.log("Allow week regenerates: "+this.attributes.allow_week_regenerate);
console.log("Allow day regenerates: "+this.attributes.allow_day_regenerate);console.log("Allow meal regenerates: "+this.attributes.allow_meal_regenerate);console.log("Allow food refresh: "+this.attributes.allow_food_refresh);console.log("Allow adding/deleting foods: "+this.attributes.allow_add_delete);console.log("Allow saving/loading plans: "+this.attributes.allow_save_load_plan);console.log("Allow creating plans: "+this.attributes.allow_create_plan);console.log("Allow allow less used features: "+
this.attributes.allow_less_used_features);console.log("Allow settings edit: "+this.attributes.allow_settings_edit)},nutrition_calculator_schema:function(){var a=this.weight_goal_schema();delete a.shopping_day;delete a.timezone;return a}});ETM.UserProfileList=Backbone.Collection.extend({model:ETM.UserProfile,url:ROOT+"/userprofile/"});
ETM.getV2UserProfileJson=function(){var a;if(ETM.diet_plan_set&&ETM.diet_plan_set.managed_account){a=$.extend(!0,{},ETM.diet_plan_set.managed_account.attributes.client_user);var b=[];a.exclusions.split(",").forEach(function(a){a=a.trim().toLowerCase();b.push({value:a,label:a})});a.exclusions=b}else a=ETM.current_user_profile.toJSON();"string"!==typeof a.exclusions&&(a.exclusions=JSON.stringify(a.exclusions));return a};
ETM.WeightEntry=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/weightentry/",getWeightForCurrentUnits:function(){return"M"==ETM.current_user_profile.attributes.units?0.453592*this.attributes.weight:this.attributes.weight}});
ETM.WeightEntryList=Backbone.Collection.extend({url:ROOT+"/weightentry/",model:ETM.WeightEntry,initialize:function(){this.listenTo(ETM.current_user_profile,"change:weight",function(a){var b=this.findWhere({date:Helper.convertDateToString(new Date)});null!=b?b.attributes.weight=a.attributes.weight:(b=new ETM.WeightEntry({date:Helper.convertDateToString(new Date),weight:a.attributes.weight}),this.add(b))},this)},comparator:function(a){return Helper.parseDateString(a.get("date")).getTime()},minWeightEntry:function(){if(0==
this.length)return null;var a=this.at(0);this.forEach(function(b){b.attributes.weight<a.attributes.weight&&(a=b)});return a},maxWeightEntry:function(){if(0==this.length)return null;var a=this.at(0);this.forEach(function(b){b.attributes.weight>a.attributes.weight&&(a=b)});return a}});ETM.DayActivity=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/dayactivity/",relations:[{type:Backbone.Many,key:"workouts",relatedModel:"ETM.Workout",collectionType:"ETM.WorkoutList"}]});
ETM.DayActivityList=Backbone.Collection.extend({url:ROOT+"/dayactivity/",model:ETM.DayActivity});ETM.Workout=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/workout/"});ETM.WorkoutList=Backbone.Collection.extend({url:ROOT+"/workout/",model:ETM.Workout});
ETM.CustomFoodBrowserResultsModel=ETM.CustomSearchResultsModel.extend({notifyError:function(){this.total_results=0;this.loading=!1;this.error_loading=!0;this.trigger("done_loading")},search:function(a,b,c,d){if("undefined"!==typeof this.all_foods){var e=[];2<a.length&&(e=this.tokenizeQuery(a));if(0!==e.length||b)try{var f=this.all_foods.filter(function(a){var d=1;a.search_score=1;var f=!0;0!==e.length&&(d=0,_.each(e,function(b){-1!==a.search_text.toLowerCase().indexOf(b)&&d++}),a.search_score=d);
b&&(delete b.calories,_.each(Object.keys(b),function(d){var e=d.split("_"),g=e[0],e=e[1];d=b[d];var m=a.attributes.food.attributes.calculated_nutrition;"max"===g?m[c+e]>d&&(f=!1):"min"===g&&m[c+e]<d&&(f=!1)}));return f&&0<d}).sort(function(a,b){return b.search_score-a.search_score});this.results.reset(f)}catch(g){bugsnagClient.notify(g),this.results.reset([])}else this.results.reset(this.all_foods.models);"undefined"!==typeof d&&d()}},updateComparator:function(a,b,c){if("relevance"===a)this.results.comparator=
null;else{var d="-"===c?-1:1;this.results.comparator=function(c,f){return d*(c.attributes.food.attributes.calculated_nutrition[b+a]-f.attributes.food.attributes.calculated_nutrition[b+a])}}},triggerDoneLoading:function(){this.total_results=this.results.size();this.error_loading=this.loading=!1;this.trigger("done_loading")},applyCalculatedNutrition:function(a,b){this.all_foods.food_info_object_list.forEach(function(b,d){b.attributes.calculated_nutrition=a[d]});b()},getCalculatedNutrition:function(a){var b=
this,c=[];b.all_foods.food_info_object_list.forEach(function(a){c.push(parseIdFromResourceURI(a.attributes.id))});$.ajax({type:"POST",url:"/food-browser/custom_nutrition/",data:{food_ids:JSON.stringify(c)},success:function(c){try{if(null!=c){var e=jQuery.parseJSON(c);b.applyCalculatedNutrition(e,a)}}catch(f){b.notifyError(),bugsnagClient.notify(f)}},error:function(a,c,f){b.notifyError();bugsnagClient.notify(f,{metaData:{status:a.status,msg:c}})}})},loadFoodInfoObjects:function(a){var b=this;this.fetch_complete?
"undefined"!==typeof a&&a():$.when(this.all_foods.food_info_object_list.fetch({reset:!0})).done(function(){b.getCalculatedNutrition(function(){var c=[];b.all_foods.food_info_object_list.forEach(function(a){a=b.returnFoodObject(a);a.is_custom=!0;c.push(a)});b.all_foods.reset(c);b.fetch_complete=!0;"undefined"!==typeof a&&a()})})}});
ETM.FoodBrowserModel=Backbone.Model.extend({initialize:function(a){if("undefined"!=typeof a)for(var b in a)this[b]=a[b];this.result_model={basic_foods:new ETM.SearchResultsModel,branded_foods:new ETM.SearchResultsModel,custom_foods:new ETM.CustomFoodBrowserResultsModel({url:ROOT+"/customfood/"}),custom_recipes:new ETM.CustomFoodBrowserResultsModel({url:ROOT+"/customrecipe/"}),recipes:new ETM.SearchResultsModel,restaurant_foods:new ETM.SearchResultsModel};for(var c in this.result_model)this.result_model[c].total_results=
0},setLoadingListener:function(a,b){var c=this;this.listenTo(this,"done_loading",function(){var d=!0;_.each(a,function(a){c.result_model[a].loading&&(d=!1)});d&&(c.stopListening(c,"done_loading"),b())})},markLoadingModels:function(a){var b=this;_.each(a,function(a){b.result_model[a].loading=!0;b.result_model[a].error_loading=!1})},setFiltersToError:function(a){var b=this;_.each(a,function(a){b.result_model[a].updateResults([]);b.result_model[a].total_results=0;b.result_model[a].loading=!1;b.result_model[a].error_loading=
!0;b.trigger("done_loading")})},updateAllModels:function(a){for(var b=Object.keys(a),c=0;c<b.length;c++){var d=b[c];this.result_model[d].updateResults(a[d].results);this.result_model[d].total_results=a[d].total_results;this.result_model[d].loading=!1;this.result_model[d].error_loading=!1;this.trigger("done_loading")}},load_more_results:function(a,b,c,d,e,f,g,h,m){var k=this,n=b[0];$.ajax({type:"GET",url:"/food-browser/search/",data:{q:a,filters:JSON.stringify(b),category_filters:JSON.stringify(c),
sort_nutrient:d,sort_order:e,display_option:f,page:g,nutrition_targets:JSON.stringify(h)},success:function(a){try{if(null!=a){var c=jQuery.parseJSON(a);k.result_model[b[0]].extendResults(c[n].results);m()}}catch(d){bugsnagClient.notify(d,{metaData:{type_of_data:typeof a,search_data:a,search_query:""}}),k.setFiltersToError(b)}},error:function(a,c,d){k.setFiltersToError(b);bugsnagClient.notify(d,{metaData:{status:a.status,msg:c}})}})},run_search:function(a,b,c,d,e,f,g,h){var m=this,k=_.intersection(["recipes",
"basic_foods","restaurant_foods","branded_foods"],b),n=_.intersection(["custom_recipes","custom_foods"],b);m.markLoadingModels(b);m.setLoadingListener(b,h);_.each(n,function(b){var c=m.result_model[b];m.listenToOnce(c,"done_loading",function(){m.trigger("done_loading")});c.loadFoodInfoObjects(function(){c.updateComparator(d,f,e);c.search(a,g,f,function(){c.triggerDoneLoading()})})});0<k.length&&$.ajax({type:"GET",url:"/food-browser/search/",data:{q:a,filters:JSON.stringify(k),category_filters:JSON.stringify(c),
sort_nutrient:d,sort_order:e,display_option:f,nutrition_targets:JSON.stringify(g)},success:function(a){try{if(null!=a){var c=jQuery.parseJSON(a);m.updateAllModels(c)}}catch(d){bugsnagClient.notify(d,{metaData:{type_of_data:typeof a,search_data:a,search_query:""}}),m.setFiltersToError(b)}},error:function(a,c,d){m.setFiltersToError(b);bugsnagClient.notify(d,{metaData:{status:a.status,msg:c}})}})}});
ETM.FoodCollectionItem=ETM.SimpleFoodObject.extend({remote:!0,userIsOwner:function(){return ETM.single_collection_model.userIsOwner()},urlRoot:ROOT+"/foodcollectionitem/"});
ETM.FoodCollectionItemList=Backbone.Collection.extend({remote:!0,userIsOwner:function(){return ETM.single_collection_model.userIsOwner()},url:ROOT+"/foodcollectionitem/",model:ETM.FoodCollectionItem,useCustomAdd:function(a){return a.item.hasClass("foodbank_food")},customAdd:function(a,b){if(this.userIsOwner()){var c=a.find(".foodbank_food");if(ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("show"))c.remove();else{var d=c.data("modelCid"),e=c.data("result_type");if("undefined"!==typeof b)e=ETM.food_info_object_list.add(b.food),
b.food=e,d=new ETM.FoodObject(b);else{if(e in ETM.search_model.search_results_model_dict)d=ETM.search_model.search_results_model_dict[e].results.get(d);else if(_.has(ETM.search_model,"collection_foods_search_model")&&_.has(ETM.search_model.collection_foods_search_model.collection_results_models,e))d=ETM.search_model.collection_foods_search_model.collection_results_models[e].results.get(d);else return bugsnagClient.notify(Error("Error finding food to drag into collection"),{metaData:{cid:d,result_type:d}}),
c.remove(),ETM.toast.showNotification({message:"There was error adding the food :(<br/>Please try again, and if it keeps happening, refreshing the page should fix it. Sorry!!",type:"error"}),!1;e=d.attributes.food;ETM.food_info_object_list.add(e)}d=new ETM.FoodCollectionItem({food:e.attributes.resource_uri,amount:d.attributes.amount,units:d.attributes.units,food_collection_id:ETM.single_collection_model.attributes.id});d.save();e=a.children().index(c);c.remove();return{modelToAdd:d,newIndex:e}}}}});
ETM.FoodCollection=Backbone.AssociatedModel.extend({remote:!0,userIsOwner:function(){return this.attributes.original_author===ETM.current_user_profile.attributes.username},urlRoot:ROOT+"/fullfoodcollection/",url:function(){return ROOT+"/fullfoodcollection/"+this.attributes.secret_url+"/"},relations:[{type:Backbone.Many,key:"foods",relatedModel:"ETM.FoodCollectionItem",collectionType:"ETM.FoodCollectionItemList"}],initialize:function(){var a=this;this.listenTo(this,"sync:foods destroyFinished",function(b,
c,d){a.updateNumItems()})},updateNumItems:function(){ETM.single_collection_model===this&&(this.attributes.num_foods=this.attributes.foods.length,this.trigger("updateNumFoods"))},fetchFollowing:function(a){var b=this;this.is_followed=!1;this.following_model=null;ETM.is_logged_in&&!this.userIsOwner()?$.ajax({type:"GET",url:"/collections/is_followed/",data:{collection_id:this.attributes.id},success:function(c){c=jQuery.parseJSON(c);c.id&&(b.following_model=new ETM.FoodCollectionFollowerModel({id:c.id}),
b.following_model.fetch({async:!1}),b.is_followed=!0);a()},error:function(c,d,e){b.is_followed=!1;bugsnagClient.notify(e,{metaData:{status:c.status,msg:d}});a()}}):a()},getShortURI:function(){return ROOT+"/foodcollection/"+this.attributes.secret_url+"/"},getCollectionImageUrl:function(){return null!==this.attributes.image_url?"https://images.eatthismuch.com/"+this.attributes.image_url:0<this.attributes.num_foods?"/weeklyplanner/collection-image/"+this.attributes.secret_url+"-"+this.attributes.num_foods+
".jpg":"https://images.eatthismuch.com/missing_thumbnail1.jpg"},setCollectionImageUrlForMobile:function(){this.set("collection_image_url",this.getCollectionImageUrl())}});ETM.SimpleFoodCollectionFoodList=ETM.SimpleFoodList.extend({parse:function(a,b){var c=[];_.each(a,function(a){a=new ETM.FoodInfoObject(a.food);c.push({food:a,amount:1,units:1})});return c}});
ETM.SimpleFoodCollection=ETM.FoodCollection.extend({urlRoot:ROOT+"/foodcollection/",url:function(){return ROOT+"/foodcollection/"+this.attributes.secret_url+"/"},relations:[{type:Backbone.Many,key:"foods",relatedModel:"ETM.SimpleFoodObject",collectionType:"ETM.SimpleFoodCollectionFoodList"}]});ETM.FoodCollectionList=Backbone.Collection.extend({url:ROOT+/foodcollection/,model:ETM.SimpleFoodCollection});
ETM.FollowedFoodCollectionList=ETM.FoodCollectionList.extend({url:ROOT+/followedfoodcollection/,parse:function(a,b){var c=[];_.each(a.objects,function(a){c.push(a.food_collection)});return c}});ETM.FoodCollectionFollowerModel=Backbone.Model.extend({urlRoot:ROOT+/followedfoodcollection/});ETM.FeaturedFoodCollectionList=ETM.FoodCollectionList.extend({url:ROOT+/featuredfoodcollection/});
ETM.TrainerFoodCollectionList=ETM.FoodCollectionList.extend({url:ROOT+/trainerfoodcollection/,parse:function(a,b){var c=[];_.each(a.objects,function(a){a.resource_uri=a.resource_uri.replace("/trainerfoodcollection/","/foodcollection/");c.push(a)});return c}});
